generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
  schemas   = ["public", "marketplace"]
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Core enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum PartyType {
  CONTACT
  ORGANIZATION

  @@schema("public")
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER

  @@schema("public")
}

enum AnimalStatus {
  ACTIVE
  BREEDING
  UNAVAILABLE
  RETIRED
  DECEASED
  PROSPECT

  @@schema("public")
}

enum Species {
  DOG
  CAT
  HORSE
  GOAT
  RABBIT
  SHEEP

  @@schema("public")
}

enum TenantOperationType {
  HOBBY
  COMMERCIAL
  PERFORMANCE

  @@schema("public")
}

enum HorseIntendedUse {
  BREEDING
  SHOW
  RACING

  @@schema("public")
}

enum HorseValuationSource {
  PRIVATE_SALE
  AUCTION
  APPRAISAL
  INSURANCE
  OTHER

  @@schema("public")
}

enum OwnershipChangeKind {
  SALE
  SYNDICATION
  TRANSFER
  LEASE
  DEATH
  OTHER

  @@schema("public")
}

// P2.1: Enhanced Ownership - Role clarification for multi-owner scenarios
enum OwnerRole {
  SOLE_OWNER // 100% owner, full control
  CO_OWNER // Shared ownership with decision rights
  MANAGING_PARTNER // Day-to-day management responsibility
  SILENT_PARTNER // Owns percentage but no management involvement
  BREEDING_RIGHTS // Has breeding rights only (may not own physically)
  INVESTOR // Financial interest only, no operational role

  @@schema("public")
}

enum PaymentIntentStatus {
  PLANNED
  EXTERNAL
  COMPLETED
  CANCELED

  @@schema("public")
}

enum PaymentIntentPurpose {
  DEPOSIT
  PURCHASE
  STUD_FEE
  BOARDING
  TRAINING
  OTHER

  @@schema("public")
}

enum Sex {
  FEMALE
  MALE
  UNKNOWN

  @@schema("public")
}

enum TagModule {
  CONTACT
  ORGANIZATION
  ANIMAL
  WAITLIST_ENTRY
  OFFSPRING_GROUP
  OFFSPRING
  MESSAGE_THREAD
  DRAFT
  BREEDING_PLAN
  BUYER
  DEAL

  @@schema("public")
}

enum OwnerPartyType {
  Organization
  Contact

  @@schema("public")
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
  VIEWER

  @@schema("public")
}

// New enums for unified tenant membership model (STAFF vs CLIENT)
enum TenantMembershipRole {
  STAFF // Staff member (maps from OWNER/ADMIN/MEMBER/BILLING/VIEWER)
  CLIENT // Portal client (created via invite acceptance)

  @@schema("public")
}

enum TenantMembershipStatus {
  INVITED // Invite sent, not yet accepted
  ACTIVE // Full access
  SUSPENDED // Access revoked

  @@schema("public")
}

enum ShareScope {
  VIEW
  BREED_PLAN

  @@schema("public")
}

enum ShareStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED

  @@schema("public")
}

enum VerificationPurpose {
  VERIFY_EMAIL
  RESET_PASSWORD
  INVITE
  OTHER

  @@schema("public")
}

enum PortalAccessStatus {
  NO_ACCESS
  INVITED
  ACTIVE
  SUSPENDED

  @@schema("public")
}

// User entitlement enums for marketplace and other feature access
enum EntitlementKey {
  // Surface access
  MARKETPLACE_ACCESS // Access to marketplace surface
  PLATFORM_ACCESS // Access to platform
  PORTAL_ACCESS // Access to portal

  // Feature access
  BREEDING_PLANS
  FINANCIAL_SUITE
  DOCUMENT_MANAGEMENT
  HEALTH_RECORDS
  WAITLIST_MANAGEMENT
  ADVANCED_REPORTING
  API_ACCESS
  MULTI_LOCATION
  E_SIGNATURES
  DATA_EXPORT // Blocked during free trial to prevent data cleaning abuse

  // Genetics tier features
  GENETICS_STANDARD // Basic genetics features (Punnett, trait predictions, etc.)
  GENETICS_PRO // Advanced genetics (COI, best match, breeding goals, etc.)

  // Quotas (use ProductEntitlement.limitValue for the actual number)
  ANIMAL_QUOTA
  CONTACT_QUOTA
  PORTAL_USER_QUOTA
  BREEDING_PLAN_QUOTA
  MARKETPLACE_LISTING_QUOTA
  STORAGE_QUOTA_GB
  SMS_QUOTA

  @@schema("public")
}

enum FeatureModule {
  GENETICS
  MARKETPLACE
  FINANCIAL
  ANIMALS
  CONTACTS
  BREEDING
  DOCUMENTS
  HEALTH
  SCHEDULING
  PORTAL
  REPORTING
  SETTINGS
  DASHBOARD // Horse MVP - stallion revenue dashboard features

  @@schema("public")
}

enum EntitlementStatus {
  ACTIVE // Entitlement granted and active
  REVOKED // Entitlement revoked

  @@schema("public")
}

// Subscription & Billing enums
enum ProductType {
  SUBSCRIPTION // Recurring subscription plan
  ADD_ON // Add-on to subscription
  ONE_TIME // One-time purchase

  @@schema("public")
}

enum BillingInterval {
  MONTHLY
  YEARLY
  QUARTERLY

  @@schema("public")
}

enum SubscriptionStatus {
  TRIAL // In trial period
  ACTIVE // Paid and active
  PAST_DUE // Payment failed, in grace period
  CANCELED // Canceled by user
  EXPIRED // Trial or subscription expired
  INCOMPLETE // Stripe payment pending
  PAUSED // Paused (future feature)

  @@schema("public")
}

enum UsageMetricKey {
  ANIMAL_COUNT
  CONTACT_COUNT
  PORTAL_USER_COUNT
  BREEDING_PLAN_COUNT
  MARKETPLACE_LISTING_COUNT
  STORAGE_BYTES
  SMS_SENT
  API_CALLS

  @@schema("public")
}

enum AnimalCategory {
  RABBIT
  SMALL_RODENT // Hamster, guinea pig, etc.
  BIRD
  CAT
  SMALL_DOG // Under 25 lbs
  LARGE_DOG // Over 25 lbs
  HORSE
  LIVESTOCK // Cattle, sheep, goats
  EXOTIC // Reptiles, etc.
  OTHER

  @@schema("public")
}

enum ListingType {
  BREEDING_PROGRAM // Breeder's main program profile
  STUD_SERVICE // Stud/breeding services
  TRAINING // Training services
  VETERINARY // Vet services
  PHOTOGRAPHY // Photo/video services
  GROOMING // Grooming services
  TRANSPORT // Transport/shipping
  BOARDING // Boarding/kennel
  PRODUCT // Equipment, supplies
  OTHER_SERVICE

  @@schema("public")
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  EXPIRED
  REMOVED

  @@schema("public")
}

enum ListingTier {
  FREE // Basic listing
  PREMIUM // Featured, more photos
  BUSINESS // Top placement, analytics

  @@schema("public")
}

enum CommChannel {
  EMAIL
  SMS
  PHONE
  MAIL
  WHATSAPP

  @@schema("public")
}

enum PreferenceLevel {
  ALLOW
  NOT_PREFERRED
  NEVER

  @@schema("public")
}

enum ComplianceStatus {
  SUBSCRIBED
  UNSUBSCRIBED

  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Buyer CRM Enums (P4)
// ─────────────────────────────────────────────────────────────────────────────

enum BuyerStatus {
  LEAD // Initial contact
  ACTIVE // Actively looking
  QUALIFIED // Budget confirmed, serious buyer
  NEGOTIATING // In deal discussions
  PURCHASED // Completed a purchase
  INACTIVE // Gone cold
  ARCHIVED // No longer relevant

  @@schema("public")
}

enum InterestLevel {
  BROWSING // Just looking
  INTERESTED // Wants more info
  SERIOUS // Ready to discuss
  OFFERED // Made an offer
  DECLINED // Passed on this horse

  @@schema("public")
}

enum DealStage {
  INQUIRY // Initial contact
  VIEWING // Scheduled/completed viewing
  NEGOTIATION // Price discussions
  VET_CHECK // Pre-purchase exam
  CONTRACT // Paperwork stage
  CLOSED_WON // Sale completed
  CLOSED_LOST // Did not purchase

  @@schema("public")
}

enum DealOutcome {
  WON
  LOST
  CANCELLED

  @@schema("public")
}

enum DealActivityType {
  CALL
  EMAIL
  MEETING
  VIEWING
  NOTE
  STATUS_CHANGE
  OFFER_MADE
  OFFER_RECEIVED
  CONTRACT_SENT
  CONTRACT_SIGNED

  @@schema("public")
}

enum BuyerEmailTemplateCategory {
  GENERAL // Generic responses
  INITIAL_CONTACT // First response to inquiry
  FOLLOW_UP // Follow-up emails
  VIEWING // Related to viewings/visits
  NEGOTIATION // Price/deal discussions
  CLOSING // Final steps of sale

  @@schema("public")
}

enum BuyerTaskType {
  FOLLOW_UP // General follow-up
  CALL // Phone call needed
  EMAIL // Send email
  SCHEDULE_VIEWING // Arrange a viewing
  SEND_INFO // Send information/media
  VET_CHECK // Coordinate vet check
  CONTRACT // Contract-related task
  PAYMENT // Payment follow-up
  OTHER // Miscellaneous

  @@schema("public")
}

enum BuyerTaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT

  @@schema("public")
}

enum BuyerTaskStatus {
  PENDING // Not started
  IN_PROGRESS // Being worked on
  COMPLETED // Done
  CANCELLED // No longer needed
  DEFERRED // Postponed

  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Trait system enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum TraitValueType {
  BOOLEAN
  ENUM
  NUMBER
  DATE
  TEXT
  JSON

  @@schema("public")
}

enum TraitSource {
  SELF_REPORTED
  VET
  LAB
  REGISTRY

  @@schema("public")
}

enum TraitStatus {
  NOT_PROVIDED
  PROVIDED
  PENDING
  PASS
  FAIL

  @@schema("public")
}

enum DocVisibility {
  PRIVATE
  BUYERS
  PUBLIC

  @@schema("public")
}

enum DocStatus {
  PLACEHOLDER
  UPLOADING
  READY
  FAILED

  @@schema("public")
}

// ────────────────────────────────────────────────────────────────────────────
// Document Watermarking Enums
// ────────────────────────────────────────────────────────────────────────────

enum MediaAccessType {
  VIEW
  DOWNLOAD
  SHARE

  @@schema("public")
}

enum MediaAccessActor {
  OWNER
  BUYER
  PUBLIC
  PORTAL

  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding additions: enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum BreedingPlanStatus {
  PLANNING
  CYCLE // New: renamed from COMMITTED - tracking the dam's heat cycle
  COMMITTED // Deprecated: use CYCLE instead (kept for migration compatibility)
  CYCLE_EXPECTED // Sub-status: waiting for cycle to start
  HORMONE_TESTING // Sub-status: progesterone testing in progress
  BRED
  PREGNANT
  BIRTHED
  WEANED
  PLACEMENT
  COMPLETE
  CANCELED
  UNSUCCESSFUL // Terminal: breeding was attempted but failed (distinct from CANCELED)
  ON_HOLD // Semi-terminal: plan is paused but can be resumed

  @@schema("public")
}

// ────────────────────────────────────────────────────────────────────────────
// Anchor Mode System Enums (Ovulation Anchor Breeding System)
// ────────────────────────────────────────────────────────────────────────────

/// User-selected primary anchor mode for a breeding plan
enum ReproAnchorMode {
  CYCLE_START // Traditional: heat/cycle observation only
  OVULATION // Professional: hormone-tested ovulation
  BREEDING_DATE // For induced ovulators (cats/rabbits)

  @@schema("public")
}

/// Anchor type used for timeline calculations
enum AnchorType {
  CYCLE_START // Primary calculation from cycle start
  OVULATION // Primary calculation from ovulation
  BREEDING_DATE // For induced ovulators (cats/rabbits)
  BIRTH // Post-birth timeline
  LOCKED_CYCLE // Legacy fallback

  @@schema("public")
}

/// How the ovulation date was determined
enum OvulationMethod {
  CALCULATED // Derived from cycle start + species offset
  PROGESTERONE_TEST // Blood progesterone testing (day 5-14 of cycle)
  LH_TEST // Luteinizing hormone test
  ULTRASOUND // Veterinary ultrasound (common for horses)
  VAGINAL_CYTOLOGY // Microscopic cell analysis
  PALPATION // Physical exam for horses
  AT_HOME_TEST // Consumer ovulation test kit
  VETERINARY_EXAM // Physical examination by vet
  BREEDING_INDUCED // For cats/rabbits

  @@schema("public")
}

/// Confidence level for date accuracy
enum ConfidenceLevel {
  HIGH // Hormone-tested ovulation (±1-2 days)
  MEDIUM // Observed cycle start (±2-5 days)
  LOW // Estimated/guessed dates (±5+ days)

  @@schema("public")
}

/// How a date was determined (observed vs calculated)
enum DataSource {
  OBSERVED // Breeder directly observed (cycle start, breeding date)
  DERIVED // Calculated from another date (cycle start derived from ovulation)
  ESTIMATED // User's best guess (low confidence)

  @@schema("public")
}

enum BreedingMethod {
  NATURAL
  AI_TCI
  AI_SI
  AI_FROZEN

  @@schema("public")
}

enum PregnancyCheckMethod {
  PALPATION
  ULTRASOUND
  RELAXIN_TEST
  XRAY
  OTHER

  @@schema("public")
}

enum BreedingGuaranteeType {
  NO_GUARANTEE
  LIVE_FOAL
  STANDS_AND_NURSES
  SIXTY_DAY_PREGNANCY
  CERTIFIED_PREGNANT

  @@schema("public")
}

enum GuaranteeResolution {
  NOT_TRIGGERED
  RETURN_BREEDING_GRANTED
  PARTIAL_REFUND
  FULL_REFUND
  WAIVED

  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Semen Inventory (P7)
// ─────────────────────────────────────────────────────────────────────────────

enum SemenCollectionMethod {
  AV // Artificial vagina
  EE // Electroejaculation
  MANUAL

  @@schema("public")
}

enum SemenStorageType {
  FRESH // Same-day use
  COOLED // Extended, 24-72 hour viability
  FROZEN // Cryopreserved, long-term storage

  @@schema("public")
}

enum SemenQualityGrade {
  EXCELLENT // >70% motility, >70% morphology
  GOOD // 50-70% motility
  FAIR // 30-50% motility
  POOR // <30% motility

  @@schema("public")
}

enum SemenInventoryStatus {
  AVAILABLE // In inventory, can be used
  RESERVED // Reserved for a specific breeding
  DEPLETED // All doses used
  EXPIRED // Past expiration date
  DISCARDED // Removed from inventory (quality issues, etc.)

  @@schema("public")
}

enum SemenUsageType {
  BREEDING_ON_SITE // Used for breeding at the station
  BREEDING_SHIPPED // Shipped to mare owner for AI
  TRANSFERRED // Moved to another storage facility
  SAMPLE_TESTING // Used for quality testing
  DISCARDED // Disposed (quality degradation, etc.)

  @@schema("public")
}

enum GeneticSnoozeType {
  ANIMAL // Don't remind me about this animal
  TEST // Don't remind me about this test type
  ANIMAL_TEST // Don't remind me about this test for this animal

  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Supplement Tracking
// ─────────────────────────────────────────────────────────────────────────────

enum SupplementTriggerType {
  BREEDING_CYCLE_RELATIVE // Relative to breeding plan event
  AGE_BASED // Relative to animal's birth date
  MANUAL // User sets start date manually

  @@schema("public")
}

enum BreedingCycleAnchorEvent {
  CYCLE_START
  BREED_DATE
  BIRTH_DATE
  WEANED_DATE

  @@schema("public")
}

enum SupplementFrequency {
  ONCE
  DAILY
  EVERY_OTHER_DAY
  EVERY_3_DAYS
  WEEKLY
  ONGOING // No end date

  @@schema("public")
}

enum SupplementScheduleMode {
  BREEDING_LINKED // Dates calculated from breeding plan
  STANDALONE // Manual start date

  @@schema("public")
}

enum SupplementScheduleStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
  CANCELLED

  @@schema("public")
}

enum WaitlistStatus {
  INQUIRY
  APPROVED
  DEPOSIT_DUE
  DEPOSIT_PAID
  READY
  ALLOCATED
  COMPLETED
  CANCELED
  REJECTED

  @@schema("public")
}


enum BreedingPlanBuyerStage {
  POSSIBLE_MATCH
  INQUIRY
  ASSIGNED
  MATCHED_TO_OFFSPRING

  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Breeding Discovery (Phase 2)
// ─────────────────────────────────────────────────────────────────────────────

enum BreedingListingIntent {
  OFFERING // Offering an animal for breeding (stud/dam services)
  SEEKING // Looking for a breeding partner
  LEASE // Offering/seeking a breeding lease
  ARRANGEMENT // Open to negotiated arrangements

  @@schema("public")
}

enum BreedingListingStatus {
  DRAFT
  PUBLISHED
  PAUSED
  CLOSED

  @@schema("public")
}

enum BreedingListingFeeDirection {
  I_RECEIVE // Listing owner receives the fee
  I_PAY // Listing owner pays the fee
  SPLIT // Fee split between parties
  NEGOTIABLE // Fee is negotiable

  @@schema("public")
}

enum BreedingInquiryStatus {
  NEW
  READ
  REPLIED
  CONVERTED
  ARCHIVED
  SPAM

  @@schema("public")
}

enum BreedingBookingStatus {
  INQUIRY
  PENDING_REQUIREMENTS
  APPROVED
  DEPOSIT_PAID
  CONFIRMED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@schema("public")
}

enum BreedingBookingType {
  STUD_SERVICE // Traditional stud service
  LEASE_BREEDING // Leased breeding arrangement
  CO_OWN // Co-ownership breeding
  AI_SHIPPED // Shipped semen AI
  NATURAL_COVER // Natural mating on-site

  @@schema("public")
}

enum BreedingProgramStatus {
  ACTIVE
  PAUSED
  ARCHIVED

  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Cross-tenant animal linking enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum ParentType {
  SIRE
  DAM

  @@schema("public")
}

enum LinkRequestStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
  REVOKED

  @@schema("public")
}

enum LinkMethod {
  GAID
  EXCHANGE_CODE
  REGISTRY_MATCH
  MICROCHIP_MATCH
  BREEDER_REQUEST
  OFFSPRING_DERIVED

  @@schema("public")
}

enum RevokedBy {
  CHILD_OWNER
  PARENT_OWNER
  SYSTEM

  @@schema("public")
}

/**
 * Offspring Group linking state
 */
enum OffspringLinkState {
  linked
  orphan
  pending

  @@schema("public")
}

enum OffspringLinkReason {
  legacy_import
  rescue
  accidental
  third_party
  cobreeder
  placeholder
  historical
  other

  @@schema("public")
}

/**
 * Offspring lifecycle
 */
enum OffspringStatus {
  NEWBORN
  ALIVE
  WEANED
  PLACED
  DECEASED

  @@schema("public")
}

enum OffspringLifeState {
  ALIVE
  DECEASED

  @@schema("public")
}

enum OffspringPlacementState {
  UNASSIGNED
  OPTION_HOLD
  RESERVED
  PLACED
  RETURNED
  TRANSFERRED

  @@schema("public")
}

enum OffspringKeeperIntent {
  AVAILABLE
  UNDER_EVALUATION
  WITHHELD
  KEEP

  @@schema("public")
}

enum OffspringFinancialState {
  NONE
  DEPOSIT_PENDING
  DEPOSIT_PAID
  PAID_IN_FULL
  REFUNDED
  CHARGEBACK

  @@schema("public")
}

enum OffspringPaperworkState {
  NONE
  SENT
  SIGNED
  COMPLETE

  @@schema("public")
}

/**
 * Animal marketplace listing enums
 */
enum AnimalListingIntent {
  STUD
  BROOD_PLACEMENT
  REHOME
  GUARDIAN
  TRAINED
  WORKING
  STARTED
  CO_OWNERSHIP

  @@schema("public")
}

// DEPRECATED: Use MarketplaceListingStatus instead
enum AnimalListingStatus {
  DRAFT
  LIVE
  PAUSED

  @@schema("public")
}

// Unified status enum for all marketplace listings
enum MarketplaceListingStatus {
  DRAFT // Not yet published
  LIVE // Published and visible to public
  PAUSED // Temporarily hidden

  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Notification System Enums
 * ────────────────────────────────────────────────────────────────────────────
 */
enum NotificationType {
  vaccination_expiring_7d
  vaccination_expiring_3d
  vaccination_expiring_1d
  vaccination_overdue
  breeding_heat_cycle_expected
  breeding_hormone_testing_due
  breeding_window_approaching
  pregnancy_check_14d
  pregnancy_check_30d
  pregnancy_check_overdue
  foaling_270d
  foaling_300d
  foaling_320d
  foaling_330d
  foaling_30d
  foaling_14d
  foaling_7d
  foaling_approaching
  foaling_overdue
  marketplace_inquiry
  marketplace_waitlist_signup
  system_announcement
  // Contract / E-Signature notifications
  contract_sent
  contract_reminder_7d
  contract_reminder_3d
  contract_reminder_1d
  contract_signed
  contract_declined
  contract_voided
  contract_expired
  // Breeding Guarantee notifications (P3.3 - Horse MVP)
  guarantee_expiring_30d // 30 days before guarantee expires
  guarantee_expiring_7d // 7 days before guarantee expires
  guarantee_expired // Guarantee has expired, no resolution recorded

  // Microchip renewal notifications
  microchip_renewal_30d // 30 days before registration expires
  microchip_renewal_14d // 14 days before registration expires
  microchip_renewal_7d // 7 days before registration expires
  microchip_renewal_3d // 3 days before registration expires
  microchip_expired // Registration has expired

  // Genetic Test Notifications
  genetic_test_missing // Animal has no genetic panel on file
  genetic_test_incomplete // Animal has partial testing (missing key markers)
  genetic_test_prebreeding // About to breed without required tests
  genetic_test_carrier_warning // Carrier × Carrier pairing detected (URGENT)
  genetic_test_registration // Registry requires tests before deadline
  genetic_test_recommended // Recommended tests for breed/discipline

  // Supplement tracking notifications
  supplement_starting_7d
  supplement_starting_3d
  supplement_starting_1d
  supplement_due_today
  supplement_overdue
  supplement_schedule_complete

  @@schema("public")
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT

  @@schema("public")
}

enum NotificationStatus {
  UNREAD
  READ
  DISMISSED

  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Users & Auth
 * ────────────────────────────────────────────────────────────────────────────
 */

model User {
  id        String  @id @default(cuid())
  email     String  @unique @db.Citext
  name      String?
  firstName String
  lastName  String
  nickname  String?
  image     String?

  // auth
  passwordHash         String?
  passwordUpdatedAt    DateTime?
  mustChangePassword   Boolean   @default(false)
  passwordSetAt        DateTime?
  lastPasswordChangeAt DateTime?
  isSuperAdmin         Boolean   @default(false)
  emailVerifiedAt      DateTime?
  role                 String    @default("user")
  twoFactorEnabled     Boolean   @default(false)

  // profile / contact fields (user-scoped)
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)
  street       String?
  street2      String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @db.Char(2)

  // Party migration step 5: unified party reference for user profile
  partyId Int?
  party   Party? @relation("UserParty", fields: [partyId], references: [id], onDelete: SetNull)

  // org/tenant membership
  memberships       Membership[]
  tenantMemberships TenantMembership[]
  defaultTenantId   Int?
  defaultTenant     Tenant?            @relation(fields: [defaultTenantId], references: [id], onDelete: SetNull)

  // auth ancillaries
  Passkey           Passkey[]
  RecoveryCode      RecoveryCode[]
  Session           Session[]
  VerificationToken VerificationToken[]

  // auth/activity timestamps
  lastLoginAt DateTime?

  // breeding events authored
  BreedingPlanEvent BreedingPlanEvent[]

  // committed plans (optional backref)
  committedPlans BreedingPlan[] @relation("CommittedByUser")

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  Attachment          Attachment[]
  LitterEvent         LitterEvent[]
  OffspringGroupEvent OffspringGroupEvent[]
  OffspringEvent      OffspringEvent[]
  Task                Task[]
  HealthEvent         HealthEvent[]
  ContractParty       ContractParty[]

  // Portal access management
  portalAccesses          PortalAccess[] @relation("PortalAccessUser")
  portalAccessesCreatedBy PortalAccess[] @relation("PortalAccessCreatedBy")
  portalAccessesUpdatedBy PortalAccess[] @relation("PortalAccessUpdatedBy")
  portalInvites           PortalInvite[] @relation("PortalInviteUser")
  portalInvitesSentBy     PortalInvite[] @relation("PortalInviteSentBy")

  // User entitlements (marketplace access, etc.)
  entitlements UserEntitlement[]

  // Legal - Terms of Service acceptances
  tosAcceptances TosAcceptance[]

  // Legal - Genetics Lab disclaimer acceptances
  geneticsDisclaimerAcceptances GeneticsDisclaimerAcceptance[]

  // Marketplace blocklist
  marketplaceBlocks MarketplaceUserBlock[] @relation("BlockedMarketplaceUser")
  marketplaceFlag   MarketplaceUserFlag?   @relation("MarketplaceUserFlagUser")

  // Breeder reports (user as reporter or reviewer)
  breederReportsSubmitted BreederReport[] @relation("BreederReportReporter")
  breederReportsReviewed  BreederReport[] @relation("BreederReportReviewedBy")

  // Service provider profile (for non-breeders listing services)
  serviceProviderProfile ServiceProviderProfile?

  // Cross-tenant lineage
  lineageRequestsSent LineageInfoRequest[] @relation("LineageRequestFromUser")

  // Cross-tenant animal linking
  animalLinkRequestsSent AnimalLinkRequest[] @relation("LinkRequestFromUser")

  // Communications Hub
  drafts Draft[] @relation("DraftCreatedBy")

  // Marketplace saved listings
  savedListings MarketplaceSavedListing[] @relation("UserSavedListings")

  // Breeding program inquiry assignments
  assignedInquiries BreedingProgramInquiry[]

  // Notifications
  notifications           Notification[]
  notificationPreferences UserNotificationPreferences?

  // Genetic notification preferences (granular in-app/email control)
  geneticNotificationPreferences GeneticNotificationPreference[]
  geneticNotificationSnoozes     GeneticNotificationSnooze[]

  // Contract templates created by this user
  contractTemplatesCreated ContractTemplate[] @relation("ContractTemplateCreatedBy")

  // Buyer CRM (P4)
  dealActivities      DealActivity[]
  // Buyer CRM (P5)
  buyerTasksAssigned  BuyerTask[]    @relation("BuyerTaskAssignee")
  buyerTasksCompleted BuyerTask[]    @relation("BuyerTaskCompleter")

  // Registry integration (P6)
  registryVerifications RegistryVerification[] @relation("RegistryVerificationVerifier")
  registrySyncLogs      RegistrySyncLog[]      @relation("RegistrySyncLogInitiator")

  // Neonatal care
  neonatalCareEntries   NeonatalCareEntry[]
  neonatalInterventions NeonatalIntervention[]

  @@index([partyId])
  @@index([defaultTenantId])
  @@index([phoneE164])
  @@index([whatsappE164])
  @@index([country])
  @@schema("public")
}

/**
 * TosAcceptance - Terms of Service acceptance records
 * Stores a history of ToS acceptances for audit/compliance.
 */
model TosAcceptance {
  id         Int      @id @default(autoincrement())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  version    String   @db.VarChar(16)
  acceptedAt DateTime @default(now())
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.Text
  surface    String?  @db.VarChar(32) // marketplace, platform, portal
  flow       String?  @db.VarChar(32) // register, invite_signup, portal_activate

  @@index([userId])
  @@index([version])
  @@schema("public")
}

/**
 * UserEntitlement - Per-user feature access grants
 * Used for marketplace access and other user-level permissions.
 */
model UserEntitlement {
  id              Int               @id @default(autoincrement())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  key             EntitlementKey
  status          EntitlementStatus @default(ACTIVE)
  grantedAt       DateTime          @default(now())
  revokedAt       DateTime?
  grantedByUserId String?

  @@unique([userId, key])
  @@index([userId])
  @@index([key, status])
  @@schema("public")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@schema("public")
}

model VerificationToken {
  identifier String
  token      String? @unique
  tokenHash  String  @unique

  purpose VerificationPurpose @default(VERIFY_EMAIL)
  expires DateTime
  userId  String?
  User    User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@id([identifier, tokenHash])
  @@index([identifier, purpose])
  @@schema("public")
}

model Passkey {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId String   @unique
  publicKey    String
  counter      Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@schema("public")
}

model RecoveryCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String   @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@schema("public")
}

model Invitation {
  id             String         @id @default(cuid())
  email          String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  token          String         @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime       @default(now())
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organizationId])
  @@schema("public")
}

model Invite {
  id             Int       @id @default(autoincrement())
  email          String
  organizationId Int?
  role           String    @default("STAFF")
  token          String    @unique
  expiresAt      DateTime
  consumedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([email])
  @@index([token])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Multi-tenancy & Orgs
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tenant {
  id           Int     @id @default(autoincrement())
  name         String
  slug         String? @unique
  primaryEmail String?

  // Location
  city    String?
  region  String?
  country String? @db.Char(2)

  operationType TenantOperationType @default(HOBBY)

  // Marketplace payment settings
  marketplacePaymentMode          String  @default("manual")
  stripeConnectAccountId          String? @unique
  stripeConnectOnboardingComplete Boolean @default(false)
  stripeConnectPayoutsEnabled     Boolean @default(false)

  memberships              TenantMembership[]
  organizations            Organization[]
  contacts                 Contact[]
  parties                  Party[]
  animals                  Animal[]
  billing                  BillingAccount?
  sharesSent               AnimalShare[]                @relation("ShareFromTenant")
  sharesReceived           AnimalShare[]                @relation("ShareToTenant")
  individualAnimalListings MktListingIndividualAnimal[] @relation("TenantIndividualAnimalListings")
  animalPrograms           MktListingAnimalProgram[]    @relation("TenantAnimalPrograms")
  User                     User[]
  tags                     Tag[]
  CustomBreed              CustomBreed[]

  // breeding additions
  breedingPlans             BreedingPlan[]
  reproductiveCycles        ReproductiveCycle[]
  planSharesSent            BreedingPlanShare[]       @relation("PlanShareFromTenant")
  planSharesReceived        BreedingPlanShare[]       @relation("PlanShareToTenant")
  planEvents                BreedingPlanEvent[]
  testResults               TestResult[]
  breedingAttempts          BreedingAttempt[]
  pregnancyChecks           PregnancyCheck[]
  litters                   Litter[]
  offspringGroups           OffspringGroup[]
  offspring                 Offspring[]
  waitlist                  WaitlistEntry[]
  attachments               Attachment[]
  planParties               PlanParty[]
  planCodeCounters          PlanCodeCounter[]
  foalingOutcomes           FoalingOutcome[]
  breedingMilestones        BreedingMilestone[]
  mareReproductiveHistories MareReproductiveHistory[]

  // Semen inventory (P7)
  semenInventory SemenInventory[]
  semenUsage     SemenUsage[]

  availabilityPrefs Json?

  settings TenantSetting[]

  programBreeds TenantProgramBreed[]

  // Breeding Programs (marketplace)
  breedingPrograms         MktListingBreedingProgram[]
  breedingProgramMedia     BreedingProgramMedia[]
  breedingProgramInquiries BreedingProgramInquiry[]
  breedingProgramRules     BreedingProgramRule[]

  // Stud listing visibility rules
  studVisibilityRules StudVisibilityRule[]

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  LitterEvent            LitterEvent[]
  OffspringGroupEvent    OffspringGroupEvent[]
  OffspringEvent         OffspringEvent[]
  OffspringGroupBuyer    OffspringGroupBuyer[]
  BreedingPlanBuyer      BreedingPlanBuyer[]
  Invoice                Invoice[]
  InvoiceLineItem        InvoiceLineItem[]
  Payment                Payment[]
  Expense                Expense[]
  Sequence               Sequence[]
  IdempotencyKey         IdempotencyKey[]
  Campaign               Campaign[]
  CampaignAttribution    CampaignAttribution[]
  EmailSendLog           EmailSendLog[]
  MessageThread          MessageThread[]
  Task                   Task[]
  HealthEvent            HealthEvent[]
  VaccinationRecord      VaccinationRecord[]
  Document               Document[]
  ContractTemplate       ContractTemplate[]
  Contract               Contract[]
  ContractParty          ContractParty[]
  SignatureEvent         SignatureEvent[]
  OffspringDocument      OffspringDocument[]
  OffspringContract      OffspringContract[]
  OffspringInvoiceLink   OffspringInvoiceLink[]
  accountingIntegrations AccountingIntegration[]
  AnimalOwnershipChange  AnimalOwnershipChange[]
  PaymentIntent          PaymentIntent[]
  AnimalTraitValue       AnimalTraitValue[]
  AnimalTraitEntry       AnimalTraitEntry[]
  Template               Template[]
  AutoReplyRule          AutoReplyRule[]
  AutoReplyLog           AutoReplyLog[]
  portalAccesses         PortalAccess[]          @relation("PortalAccessTenant")
  portalInvites          PortalInvite[]          @relation("PortalInviteTenant")

  // Scheduling
  schedulingEventTemplates     SchedulingEventTemplate[]
  schedulingAvailabilityBlocks SchedulingAvailabilityBlock[]
  schedulingSlots              SchedulingSlot[]
  schedulingBookings           SchedulingBooking[]

  // Business hours for messaging availability
  // JSON structure: { monday: { open: "09:00", close: "17:00", enabled: true }, ... }
  // If null, system defaults apply (Mon-Fri 9am-5pm)
  businessHours Json?
  timeZone      String? // IANA timezone e.g. "America/New_York"

  // Quick Responder badge tracking
  // Badge is earned when avgBusinessHoursResponseTime <= 4 hours (14400 seconds)
  // Badge is lost when it exceeds that threshold
  quickResponderBadge          Boolean   @default(false)
  avgBusinessHoursResponseTime Int? // Average response time in seconds (business hours only)
  totalResponseCount           Int       @default(0) // Number of responses used in average
  lastBadgeEvaluatedAt         DateTime?

  // Marketplace blocklist
  marketplaceUserBlocks MarketplaceUserBlock[]

  // Breeder report system (marketplace users reporting this breeder)
  breederReports    BreederReport[]    @relation("BreederReports")
  breederReportFlag BreederReportFlag? @relation("BreederReportFlag")

  // Subscription & Billing
  subscriptions       Subscription[]
  usageRecords        UsageRecord[]
  usageSnapshots      UsageSnapshot[]
  paymentMethods      PaymentMethod[]
  referralCodesOwned  ReferralCode[]             @relation("ReferralCodeOwner")
  referralsMade       Referral[]                 @relation("ReferralsMade")
  referralsReceived   Referral[]                 @relation("ReferralsReceived")
  unifiedListings     MktListingService[]        // Unified marketplace listings
  featureChecks       FeatureCheck[]

  // Cross-tenant lineage
  contributedIdentifiers  GlobalAnimalIdentifier[]
  lineageRequestsSent     LineageInfoRequest[]     @relation("LineageRequestFrom")
  lineageRequestsReceived LineageInfoRequest[]     @relation("LineageRequestTo")

  // Cross-tenant animal linking
  linkRequestsFrom         AnimalLinkRequest[]     @relation("LinkRequestFrom")
  linkRequestsTo           AnimalLinkRequest[]     @relation("LinkRequestTo")
  crossTenantLinksAsChild  CrossTenantAnimalLink[] @relation("LinkChildTenant")
  crossTenantLinksAsParent CrossTenantAnimalLink[] @relation("LinkParentTenant")

  // Title & Competition tracking
  titleDefinitions   TitleDefinition[]
  animalTitles       AnimalTitle[]
  competitionEntries CompetitionEntry[]

  // CRM
  partyNotes      PartyNote[]
  partyEvents     PartyEvent[]
  partyMilestones PartyMilestone[]
  partyEmails     PartyEmail[]
  partyActivity   PartyActivity[]
  unlinkedEmails  UnlinkedEmail[]

  // Buyer CRM (P4)
  buyers              Buyer[]
  deals               Deal[]
  dealActivities      DealActivity[]
  // Buyer CRM (P5)
  buyerEmailTemplates BuyerEmailTemplate[]
  buyerTasks          BuyerTask[]

  // Client profile change requests
  contactChangeRequests ContactChangeRequest[]
  emailChangeRequests   EmailChangeRequest[]

  // Communications Hub
  drafts          Draft[]
  documentBundles DocumentBundle[]
  emailFilters    EmailFilter[]
  blockedEmails   BlockedEmail[]

  // Notifications
  notifications           Notification[]
  notificationPreferences UserNotificationPreferences[]

  // Genetic notification preferences (granular in-app/email control)
  geneticNotificationPreferences GeneticNotificationPreference[]
  geneticNotificationSnoozes     GeneticNotificationSnooze[]

  // Microchip registrations
  microchipRegistrations AnimalMicrochipRegistration[]

  // Inbound email address slug (e.g., "sunny-acres" for sunny-acres@mail.breederhq.com)
  inboundEmailSlug String? @unique

  // Demo tenant configuration
  // Demo tenants can be reset to a known state via the reset endpoint
  isDemoTenant  Boolean @default(false)
  demoResetType String? // 'fresh' | 'lived-in' - determines which seed script to run on reset

  // Registry integration (P6)
  registryConnections RegistryConnection[]
  registrySyncLogs    RegistrySyncLog[]


  // Supplement Tracking
  supplementProtocols       SupplementProtocol[]
  supplementSchedules       SupplementSchedule[]
  supplementAdministrations SupplementAdministration[]

  // Nutrition & Food Tracking
  foodProducts   FoodProduct[]
  feedingPlans   FeedingPlan[]
  feedingRecords FeedingRecord[]
  foodChanges    FoodChange[]

  // Document Watermarking & Access Tracking
  watermarkSettings Json? // WatermarkSettings type
  mediaAccessEvents MediaAccessEvent[]
  watermarkedAssets WatermarkedAsset[]

  // Breeding Discovery (Phase 2)
  breederProfile            BreederProfile?
  breedingDiscoveryPrograms BreedingDiscoveryProgram[]
  breedingListings          BreedingListing[]
  breedingInquiries         BreedingInquiry[]
  breedingBookingsOffering  BreedingBooking[]             @relation("OfferingBookings")
  breedingBookingsSeeking   BreedingBooking[]             @relation("SeekingBookings")

  // Neonatal Care
  neonatalCareEntries   NeonatalCareEntry[]
  neonatalInterventions NeonatalIntervention[]

  // Animal Breeding Profile (user-entered preferences)
  animalBreedingProfiles  AnimalBreedingProfile[]
  animalIncompatibilities AnimalIncompatibility[]
  breedingEventsLog       BreedingEvent[]

  @@index([name])
  @@index([quickResponderBadge])
  @@schema("public")
}

model TenantMembership {
  userId   String
  tenantId Int
  role     TenantRole @default(MEMBER)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // New fields for unified membership model
  membershipRole   TenantMembershipRole   @default(STAFF)
  membershipStatus TenantMembershipStatus @default(ACTIVE)
  partyId          Int? // Links CLIENT memberships to their Party record

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, tenantId])
  @@index([tenantId])
  @@index([partyId])
  @@index([membershipRole, membershipStatus])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Notification System
 * ────────────────────────────────────────────────────────────────────────────
 */

/**
 * Notification - Stores all user notifications (in-app, email, SMS)
 * MVP: Focus on vaccination and breeding timeline alerts
 */
model Notification {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String? // Target user (null = all tenant users)
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification content
  type    NotificationType
  title   String
  message String           @db.Text
  linkUrl String? // Deep link to relevant entity (e.g., /animals/123)

  // Priority & status
  priority NotificationPriority @default(MEDIUM)
  status   NotificationStatus   @default(UNREAD)

  // Status timestamps
  readAt      DateTime?
  dismissedAt DateTime?

  // Idempotency: prevent duplicate notifications
  // Format: "{type}:{entityType}:{entityId}:{date}"
  // Example: "vaccination_expiring_1d:VaccinationRecord:456:2026-01-14"
  idempotencyKey String? @unique

  // Metadata for context (e.g., animal name, dates, etc.)
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, userId, status])
  @@index([tenantId, status, createdAt])
  @@index([type])
  @@index([createdAt])
  @@schema("public")
}

/**
 * UserNotificationPreferences - User settings for notification delivery
 * MVP: Focus on toggles for alert types (email channel for Phase 2)
 */
model UserNotificationPreferences {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ─── Vaccination Alerts ────────────────────────────────────────
  vaccinationExpiring Boolean @default(true) // 7d, 3d, 1d warnings
  vaccinationOverdue  Boolean @default(true) // Overdue alerts

  // ─── Breeding Timeline Alerts ──────────────────────────────────
  breedingTimeline   Boolean @default(true) // Heat cycle, hormone testing
  pregnancyCheck     Boolean @default(true) // Pregnancy check reminders
  foalingApproaching Boolean @default(true) // Foaling countdown (30d, 14d, 7d)
  heatCycleExpected  Boolean @default(true) // Heat cycle prediction

  // ─── Marketplace Alerts (Future) ───────────────────────────────
  marketplaceInquiry Boolean @default(true) // New inquiries
  waitlistSignup     Boolean @default(true) // Waitlist signups

  // ─── Microchip Alerts ──────────────────────────────────────────
  microchipRenewal Boolean @default(true) // Microchip renewal reminders (30d, 14d, 7d, 3d)

  // ─── Genetic Test Alerts ─────────────────────────────────────────
  geneticCarrierWarning Boolean @default(true) // URGENT: Carrier × Carrier lethal pairing
  geneticPrebreeding    Boolean @default(true) // HIGH: Pre-breeding test reminders
  geneticRegistration   Boolean @default(true) // MEDIUM: Registry requirement reminders
  geneticMissing        Boolean @default(false) // LOW: Missing genetic panel (off by default)
  geneticIncomplete     Boolean @default(false) // LOW: Incomplete testing (off by default)
  geneticRecommended    Boolean @default(false) // LOW: Recommended tests (off by default, no email)

  // ─── Channel Preferences (Phase 2) ─────────────────────────────
  emailEnabled Boolean @default(true) // Email delivery
  smsEnabled   Boolean @default(false) // SMS delivery (Phase 2)
  pushEnabled  Boolean @default(true) // Push notifications (Phase 2)

  // ─── Phone Verification (Phase 2 - SMS) ───────────────────────
  phoneNumber     String?
  phoneVerified   Boolean   @default(false)
  phoneVerifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@schema("public")
}

/**
 * GeneticNotificationPreference - Granular user preferences for genetic test notifications
 * Provides separate in-app and email toggles for each notification type.
 * IMPORTANT: Carrier warnings (inAppCarrier) cannot be disabled for lethal genes.
 */
model GeneticNotificationPreference {
  id       Int    @id @default(autoincrement())
  userId   String
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // In-app notifications
  inAppMissing     Boolean @default(true)
  inAppIncomplete  Boolean @default(true)
  inAppCarrier     Boolean @default(true) // Cannot disable lethal warnings - enforced at API level
  inAppPrebreeding Boolean @default(true)
  inAppRegistry    Boolean @default(true)
  inAppRecommended Boolean @default(false) // Off by default

  // Email notifications
  emailMissing     Boolean @default(false) // Off by default
  emailIncomplete  Boolean @default(false)
  emailCarrier     Boolean @default(true) // ON by default for lethal warnings
  emailPrebreeding Boolean @default(true)
  emailRegistry    Boolean @default(true)
  emailRecommended Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@schema("public")
}

/**
 * GeneticNotificationSnooze - "Don't remind me" functionality for genetic notifications
 * Users can snooze notifications for specific animals, tests, or animal+test combinations.
 */
model GeneticNotificationSnooze {
  id       Int    @id @default(autoincrement())
  userId   String
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What is snoozed
  snoozeType GeneticSnoozeType // ANIMAL, TEST, ANIMAL_TEST
  animalId   Int? // Snooze all notifications for this animal
  testCode   String? // Snooze notifications for this test (e.g., "HYPP", "OLWS")

  // Duration
  snoozedUntil DateTime? // null = permanent snooze

  createdAt DateTime @default(now())

  @@unique([userId, tenantId, snoozeType, animalId, testCode])
  @@index([tenantId, userId])
  @@index([animalId])
  @@schema("public")
}

model BillingAccount {
  id       Int    @id @default(autoincrement())
  tenantId Int    @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Stripe customer
  stripeCustomerId String? @unique

  // Billing contact
  billingEmail String?
  companyName  String?
  taxId        String? // VAT/EIN

  // Billing address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @db.VarChar(2)

  // Legacy fields (deprecated, keep for backward compatibility)
  provider         String?
  subscriptionId   String?
  plan             String?
  status           String?
  currentPeriodEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stripeCustomerId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Subscription & Billing System
 * ────────────────────────────────────────────────────────────────────────────
 */

model Product {
  id Int @id @default(autoincrement())

  // Product details
  name            String
  description     String?          @db.Text
  type            ProductType
  billingInterval BillingInterval?

  // Stripe integration
  stripeProductId String? @unique
  stripePriceId   String?

  // Status
  active Boolean @default(true)

  // Pricing
  priceUSD Int // Price in cents
  currency String @default("USD") @db.VarChar(3)

  // Display
  sortOrder Int   @default(0)
  features  Json? // Feature bullets for display

  // Relations
  entitlements  ProductEntitlement[]
  subscriptions Subscription[]
  addOns        SubscriptionAddOn[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, active])
  @@index([active, sortOrder])
  @@schema("public")
}

model ProductEntitlement {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  entitlementKey EntitlementKey
  limitValue     Int? // Quota limit (null = unlimited)
  metadata       Json?

  createdAt DateTime @default(now())

  @@unique([productId, entitlementKey])
  @@index([productId])
  @@index([entitlementKey])
  @@schema("public")
}

model Subscription {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  status SubscriptionStatus @default(TRIAL)

  // Stripe references
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?

  // Billing cycle
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Trial tracking
  trialStart DateTime?
  trialEnd   DateTime?

  // Pricing snapshot
  amountCents     Int
  currency        String          @default("USD") @db.VarChar(3)
  billingInterval BillingInterval

  // Metadata
  metadata Json?

  // Relations
  addOns SubscriptionAddOn[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([currentPeriodEnd])
  @@schema("public")
}

model SubscriptionAddOn {
  id             Int          @id @default(autoincrement())
  subscriptionId Int
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity    Int @default(1)
  amountCents Int

  // Stripe reference
  stripeItemId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([productId])
  @@schema("public")
}

model UsageRecord {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  metricKey  UsageMetricKey
  value      Int
  recordedAt DateTime       @default(now())

  // Optional context
  userId     String?
  resourceId Int?
  metadata   Json?

  @@index([tenantId, metricKey, recordedAt])
  @@index([recordedAt])
  @@schema("public")
}

model UsageSnapshot {
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  metricKey    UsageMetricKey
  currentValue Int
  limit        Int? // null = unlimited

  lastUpdatedAt DateTime @default(now())

  @@id([tenantId, metricKey])
  @@index([tenantId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Feature Registry & Analytics
 * ────────────────────────────────────────────────────────────────────────────
 * Features are individual platform capabilities that can be gated by subscription.
 * Each feature maps to an entitlement key for access control.
 */

model Feature {
  id Int @id @default(autoincrement())

  // Unique identifier used in code: "GENETICS_COI_CALCULATIONS"
  key String @unique @db.VarChar(100)

  // Display info
  name        String  @db.VarChar(100) // "COI Calculations"
  description String? @db.Text // Longer description for admin reference

  // Categorization
  module FeatureModule // GENETICS, MARKETPLACE, etc.

  // Access control - which entitlement key grants access to this feature
  entitlementKey EntitlementKey

  // Admin reference - where this feature appears in UI
  uiHint String? @db.VarChar(200) // "Genetics Lab > Analysis Tools"

  // Kill switch - allows disabling feature platform-wide
  isActive Boolean @default(true)

  // Soft delete
  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([module])
  @@index([entitlementKey])
  @@index([isActive])
  @@schema("public")
}

/**
 * Feature check telemetry - logs when features are checked in the UI.
 * Used for analytics: which features are used, denied access attempts, etc.
 * Raw events - aggregated daily into FeatureCheckDaily for long-term storage.
 */
model FeatureCheck {
  id BigInt @id @default(autoincrement())

  featureKey String @db.VarChar(100) // "GENETICS_COI_CALCULATIONS"

  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String? // Optional - which user triggered the check

  granted Boolean // Did they have access?

  // Where in UI this was checked (e.g., "genetics-lab", "dashboard")
  context String? @db.VarChar(100)

  timestamp DateTime @default(now())

  @@index([featureKey, timestamp])
  @@index([tenantId, timestamp])
  @@index([timestamp])
  @@index([granted, timestamp])
  @@schema("public")
}

/**
 * Aggregated daily feature check statistics.
 * Raw FeatureCheck events older than 30 days should be aggregated here then deleted.
 */
model FeatureCheckDaily {
  id Int @id @default(autoincrement())

  date       DateTime @db.Date
  featureKey String   @db.VarChar(100)
  tenantId   Int

  checkCount Int @default(0) // Total checks
  grantCount Int @default(0) // Checks where granted=true
  denyCount  Int @default(0) // Checks where granted=false

  @@unique([date, featureKey, tenantId])
  @@index([date])
  @@index([featureKey])
  @@index([tenantId])
  @@schema("public")
}

model PaymentMethod {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  stripePaymentMethodId String @unique
  type                  String // "card", "us_bank_account"

  // Card details
  cardBrand    String?
  cardLast4    String?
  cardExpMonth Int?
  cardExpYear  Int?

  // Bank details
  bankName  String?
  bankLast4 String?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, isDefault])
  @@schema("public")
}

model ReferralCode {
  id Int @id @default(autoincrement())

  code String @unique

  referrerTenantId Int
  referrer         Tenant @relation("ReferralCodeOwner", fields: [referrerTenantId], references: [id], onDelete: Cascade)

  // Reward structure
  refereeDiscountStripeCouponId String?
  referrerCreditCents           Int?

  // Tracking
  usedCount Int       @default(0)
  maxUses   Int?
  expiresAt DateTime?
  active    Boolean   @default(true)

  // Relations
  referrals Referral[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referrerTenantId])
  @@index([code])
  @@index([active, expiresAt])
  @@schema("public")
}

model Referral {
  id Int @id @default(autoincrement())

  codeId Int
  code   ReferralCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  referrerTenantId Int
  referrer         Tenant @relation("ReferralsMade", fields: [referrerTenantId], references: [id], onDelete: Cascade)

  refereeTenantId Int
  referee         Tenant @relation("ReferralsReceived", fields: [refereeTenantId], references: [id], onDelete: Cascade)

  // Reward tracking
  refereeDiscountApplied Boolean @default(false)
  refereeStripeCouponId  String?

  referrerCreditApplied Boolean   @default(false)
  referrerCreditCents   Int?
  referrerCreditedAt    DateTime?

  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([codeId, refereeTenantId])
  @@index([referrerTenantId])
  @@index([refereeTenantId])
  @@index([codeId])
  @@schema("public")
}

model ServiceProviderProfile {
  id Int @id @default(autoincrement())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business details
  businessName String
  email        String
  phone        String?
  website      String?

  // Location
  city    String?
  state   String?
  country String  @default("US") @db.VarChar(2)

  // Subscription
  plan ListingTier @default(FREE)

  // Stripe references
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique

  // Relations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([plan])
  @@schema("public")
}

model SystemConfig {
  key         String   @id
  value       String
  type        String // "number", "boolean", "string", "json"
  description String?  @db.Text
  updatedBy   String?
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@schema("public")
}

model Organization {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  partyId Int   @unique
  party   Party @relation("OrganizationParty", fields: [partyId], references: [id], onDelete: Cascade)

  name     String
  email    String?
  phone    String?
  website  String?
  street   String?
  street2  String?
  city     String?
  state    String?
  zip      String?
  country  String?
  archived Boolean @default(false)

  // Marketplace MVP: public program profile fields
  programSlug        String?
  isPublicProgram    Boolean @default(false)
  programBio         String? @db.Text
  publicContactEmail String?

  contacts            Contact[]
  animals             Animal[]       @relation("OrgAnimals")
  memberships         Membership[]
  createdCustomBreeds CustomBreed[]  @relation("CreatedByOrganization")
  breedingPlans       BreedingPlan[]
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  Invitation          Invitation[]
  externalProvider    String?
  externalId          String?

  @@unique([id, tenantId])
  @@unique([tenantId, name])
  @@unique([tenantId, programSlug])
  @@index([archived])
  @@index([name])
  @@index([tenantId])
  @@index([isPublicProgram])
  @@schema("public")
}

model Membership {
  userId         String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([organizationId])
  @@schema("public")
}

model Party {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  type PartyType

  // Unified list label
  name String

  // Shared comms
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Shared address
  street     String?
  street2    String?
  city       String?
  state      String?
  postalCode String?
  country    String? @db.Char(2)

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization          Organization?              @relation("OrganizationParty")
  contact               Contact?                   @relation("ContactParty")
  users                 User[]                     @relation("UserParty")
  attachments           Attachment[]               @relation("AttachmentParty")
  tagAssignments        TagAssignment[]            @relation("TagAssignmentTaggedParty")
  breedingAttempts      BreedingAttempt[]          @relation("BreedingAttemptStudOwner")
  planParties           PlanParty[]                @relation("PlanPartyRole")
  waitlistEntries       WaitlistEntry[]            @relation("WaitlistParty")
  offspringGroupBuyers  OffspringGroupBuyer[]      @relation("OffspringGroupBuyerParty")
  breedingPlanBuyers    BreedingPlanBuyer[]        @relation("BreedingPlanBuyerParty")
  offspringBuyers       Offspring[]                @relation("OffspringBuyerParty")
  invoiceParties        Invoice[]                  @relation("InvoiceParty")
  contractParties       ContractParty[]            @relation("ContractPartyRole")
  offspringContracts    OffspringContract[]        @relation("OffspringContractBuyerParty")
  animalBuyers          Animal[]                   @relation("AnimalBuyerParty")
  animalOwnerships      AnimalOwner[]              @relation("AnimalOwnerParty")
  expenseVendors        Expense[]                  @relation("ExpenseVendor")
  commPreferences       PartyCommPreference[]
  commPreferenceEvents  PartyCommPreferenceEvent[]
  messageParticipants   MessageParticipant[]       @relation("MessageParticipantParty")
  sentMessages          Message[]                  @relation("MessageSenderParty")
  createdTemplates      Template[]                 @relation("TemplateCreatedBy")
  autoReplyLogs         AutoReplyLog[]             @relation("AutoReplyLogParty")
  autoReplyRulesCreated AutoReplyRule[]            @relation("AutoReplyRuleCreatedBy")
  portalAccess          PortalAccess?              @relation("PortalAccessParty")
  portalInvites         PortalInvite[]             @relation("PortalInviteParty")
  schedulingBookings    SchedulingBooking[]        @relation("SchedulingBookingParty")

  // Marketplace blocklist (who blocked, who lifted)
  marketplaceBlocksCreated MarketplaceUserBlock[] @relation("MarketplaceBlockCreator")
  marketplaceBlocksLifted  MarketplaceUserBlock[] @relation("MarketplaceBlockLifter")

  // CRM relations
  notes      PartyNote[]      @relation("PartyNotes")
  events     PartyEvent[]     @relation("PartyEvents")
  milestones PartyMilestone[] @relation("PartyMilestones")
  emails     PartyEmail[]     @relation("PartyEmails")
  activity   PartyActivity[]  @relation("PartyActivity")

  // Buyer CRM relations (P4)
  buyer Buyer? @relation("BuyerParty")

  // Communications Hub relations
  emailSendLogs EmailSendLog[] @relation("EmailSendLogParty")
  drafts        Draft[]        @relation("DraftParty")

  // MessagingHub - unlinked emails that were later linked to this party
  unlinkedEmailsLinked UnlinkedEmail[] @relation("UnlinkedEmailsLinked")


  // Breeding Discovery (Phase 2) - seeking party on bookings
  breedingBookings BreedingBooking[]

  @@index([tenantId, type])
  @@index([tenantId, name])
  @@index([tenantId, email])
  @@schema("public")
}

model PartyCommPreference {
  id               Int               @id @default(autoincrement())
  partyId          Int
  channel          CommChannel
  preference       PreferenceLevel   @default(ALLOW)
  compliance       ComplianceStatus?
  complianceSetAt  DateTime?
  complianceSource String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  party            Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, channel])
  @@index([partyId])
  @@index([channel, compliance])
  @@schema("public")
}

model PartyCommPreferenceEvent {
  id             Int               @id @default(autoincrement())
  partyId        Int
  channel        CommChannel
  prevPreference PreferenceLevel?
  newPreference  PreferenceLevel?
  prevCompliance ComplianceStatus?
  newCompliance  ComplianceStatus?
  actorPartyId   Int?
  reason         String?
  source         String?
  createdAt      DateTime          @default(now())
  party          Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([partyId, createdAt])
  @@index([channel, createdAt])
  @@schema("public")
}

model Contact {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  tenant         Tenant        @relation(fields: [tenantId], references: [id])

  partyId Int?   @unique
  party   Party? @relation(name: "ContactParty", fields: [partyId], references: [id], onDelete: Restrict)

  // Names
  display_name String
  first_name   String?
  last_name    String?
  nickname     String?

  // Contact info
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Address
  street  String?
  street2 String?
  city    String?
  state   String?
  zip     String?
  country String? @db.Char(2)

  // Relations

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  externalProvider String?
  externalId       String?

  // Marketplace integration
  marketplaceUserId            Int?
  marketplaceFirstContactedAt  DateTime?
  marketplaceTotalTransactions Int       @default(0)
  marketplaceTotalSpentCents   BigInt    @default(0)

  // Soft delete
  deletedAt DateTime?

  // Profile change requests from client portal
  changeRequests      ContactChangeRequest[]
  emailChangeRequests EmailChangeRequest[]

  // Microchip registrations where this contact is the registered owner
  microchipRegistrations AnimalMicrochipRegistration[] @relation("MicrochipRegisteredTo")

  @@unique([tenantId, email])
  @@unique([marketplaceUserId, tenantId])
  @@index([organizationId])
  @@index([tenantId])
  @@index([display_name])
  @@index([archived])
  @@index([last_name])
  @@index([first_name])
  @@index([nickname])
  @@index([tenantId, partyId])
  @@index([deletedAt])
  @@index([tenantId, deletedAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Party CRM (Notes, Events, Milestones, Emails, Activity)
 * ────────────────────────────────────────────────────────────────────────────
 */

enum PartyEventKind {
  FOLLOW_UP
  MEETING
  CALL
  VISIT
  CUSTOM

  @@schema("public")
}

enum PartyEventStatus {
  SCHEDULED
  COMPLETED
  CANCELLED

  @@schema("public")
}

enum PartyMilestoneKind {
  BIRTHDAY
  CUSTOMER_ANNIVERSARY
  PLACEMENT_ANNIVERSARY
  CUSTOM

  @@schema("public")
}

enum PartyActivityKind {
  NOTE_ADDED
  NOTE_UPDATED
  EMAIL_SENT
  EVENT_CREATED
  EVENT_COMPLETED
  MILESTONE_OCCURRED
  STATUS_CHANGED
  TAG_ADDED
  TAG_REMOVED
  INVOICE_CREATED
  PAYMENT_RECEIVED
  MESSAGE_SENT
  MESSAGE_RECEIVED
  // Client profile changes
  PROFILE_UPDATED_BY_CLIENT // Client self-updated address/phone
  NAME_CHANGE_REQUESTED // Client requested name change
  NAME_CHANGE_APPROVED // Breeder approved name change
  NAME_CHANGE_REJECTED // Breeder rejected name change
  EMAIL_CHANGE_REQUESTED // Client requested email change
  EMAIL_CHANGE_VERIFIED // Client verified new email
  EMAIL_CHANGE_EXPIRED // Email change request expired

  @@schema("public")
}

model PartyNote {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int
  party    Party  @relation("PartyNotes", fields: [partyId], references: [id], onDelete: Cascade)

  content   String   @db.Text
  pinned    Boolean  @default(false)
  createdBy Int? // userId who created
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, partyId])
  @@index([partyId, pinned])
  @@schema("public")
}

model PartyEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int
  party    Party  @relation("PartyEvents", fields: [partyId], references: [id], onDelete: Cascade)

  kind        PartyEventKind   @default(FOLLOW_UP)
  title       String
  notes       String?          @db.Text
  scheduledAt DateTime
  status      PartyEventStatus @default(SCHEDULED)
  completedAt DateTime?
  createdBy   Int? // userId who created
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([tenantId, partyId])
  @@index([partyId, scheduledAt])
  @@index([tenantId, status, scheduledAt])
  @@schema("public")
}

model PartyMilestone {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int
  party    Party  @relation("PartyMilestones", fields: [partyId], references: [id], onDelete: Cascade)

  kind      PartyMilestoneKind @default(CUSTOM)
  label     String // e.g., "Birthday", "1st Placement Anniversary"
  date      DateTime           @db.Date // The actual date (month/day matters for annual)
  annual    Boolean            @default(true) // If true, recurs yearly
  notes     String?            @db.Text
  createdBy Int? // userId who created
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([tenantId, partyId])
  @@index([partyId, date])
  @@index([tenantId, annual])
  @@schema("public")
}

model PartyEmail {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int
  party    Party  @relation("PartyEmails", fields: [partyId], references: [id], onDelete: Cascade)

  subject   String
  body      String   @db.Text
  toEmail   String // recipient email at time of send
  sentAt    DateTime @default(now())
  status    String   @default("sent") // sent, delivered, bounced, failed
  isRead    Boolean  @default(false) // whether user has acknowledged this sent email
  messageId String? // external mail provider message ID
  createdBy Int? // userId who sent
  createdAt DateTime @default(now())

  @@index([tenantId, partyId])
  @@index([partyId, sentAt])
  @@schema("public")
}

/// UnlinkedEmail - Emails sent to addresses not associated with a contact/org
/// Used by MessagingHub to store emails that can later be linked when contacts are created
model UnlinkedEmail {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Recipient info (no party association initially)
  toAddresses String[] // array of email addresses
  fromAddress String // sender email

  // Email content
  subject     String
  bodyText    String? @db.Text
  bodyHtml    String? @db.Text
  bodyPreview String? // First ~200 chars for list display

  // Status tracking
  status    String  @default("sent") // queued, sent, delivered, bounced, failed
  direction String  @default("outbound") // outbound, inbound
  isRead    Boolean @default(false) // whether user has acknowledged this sent email

  // Timestamps
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // For later reconciliation - link to party when contact is created
  linkedPartyId Int?
  linkedParty   Party?    @relation("UnlinkedEmailsLinked", fields: [linkedPartyId], references: [id], onDelete: SetNull)
  linkedAt      DateTime?

  // Metadata
  messageId   String? // external mail provider message ID
  templateKey String? // template used if any
  category    String  @default("transactional") // transactional, marketing
  metadata    Json? // flexible store for additional data
  createdBy   Int? // userId who sent

  @@index([tenantId])
  @@index([tenantId, linkedPartyId])
  @@index([tenantId, createdAt])
  @@index([toAddresses])
  @@schema("public")
}

model PartyActivity {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int
  party    Party  @relation("PartyActivity", fields: [partyId], references: [id], onDelete: Cascade)

  kind      PartyActivityKind
  title     String
  detail    String?           @db.Text
  metadata  Json? // flexible store for entity IDs, etc.
  actorId   Int? // userId who performed action
  createdAt DateTime          @default(now())

  @@index([tenantId, partyId])
  @@index([partyId, createdAt])
  @@index([tenantId, kind])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Animals & Ownership
 * ────────────────────────────────────────────────────────────────────────────
 */

model Animal {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organizationId Int?
  organization   Organization? @relation("OrgAnimals", fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  name           String
  species        Species
  sex            Sex
  status         AnimalStatus  @default(ACTIVE)

  // Horse asset metadata (nullable for non-horse species)
  intendedUse           HorseIntendedUse?
  declaredValueCents    Int?
  declaredValueCurrency String?               @db.VarChar(3)
  valuationDate         DateTime?
  valuationSource       HorseValuationSource?
  forSale               Boolean               @default(false)
  inSyndication         Boolean               @default(false)
  isLeased              Boolean               @default(false)

  ownershipChanges AnimalOwnershipChange[]
  birthDate        DateTime?
  microchip        String?
  notes            String?
  breed            String?

  photoUrl String? @db.Text

  canonicalBreedId Int?
  canonicalBreed   Breed? @relation(fields: [canonicalBreedId], references: [id], onDelete: SetNull)

  customBreedId Int?
  customBreed   CustomBreed? @relation(fields: [customBreedId, tenantId], references: [id, tenantId], onDelete: Restrict)

  breeds AnimalBreed[]

  reproductiveCycles  ReproductiveCycle[]
  breedingPlansAsDam  BreedingPlan[]      @relation("PlanDam")
  breedingPlansAsSire BreedingPlan[]      @relation("PlanSire")

  // Breeding attempts: stored with animal for historical persistence
  breedingAttemptsAsDam  BreedingAttempt[] @relation("BreedingAttemptDam")
  breedingAttemptsAsSire BreedingAttempt[] @relation("BreedingAttemptSire")

  // Cycle Length Override v1: Animal-level override for female cycle length calculation
  // Valid range: 30-730 days. NULL means use automatic calculation from history/biology.
  femaleCycleLenOverrideDays Int?

  // Breeding availability: Manual toggle for whether animal is available for breeding
  // Values: "open" (available) | "resting" (recovery/not available) | null (default = open)
  // Applies to all species, for females indicates reproductive readiness
  breedingAvailability String?

  // Breeding Discovery: Line type classification
  lineTypes       String[] // e.g., ["show", "working", "field", "pet"]
  primaryLineType String? // Primary classification for filtering
  lineDescription String? @db.Text // Free-text description of breeding lines

  // Breeding Discovery: Relations
  breedingListings BreedingListing[]

  // legacy links
  litterId         Int?
  litter           Litter?         @relation(fields: [litterId], references: [id], onDelete: SetNull)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation("OffspringGroupPuppiesLegacy", fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // parent backrefs to groups
  offspringGroupsAsDam  OffspringGroup[] @relation("OffspringDam")
  offspringGroupsAsSire OffspringGroup[] @relation("OffspringSire")

  // parent backrefs to individual offspring
  offspringAsDam  Offspring[] @relation("OffspringIndividualDam")
  offspringAsSire Offspring[] @relation("OffspringIndividualSire")

  // ─────────────────────────────────────────────────────────────────────────────
  // Lineage: Direct parent references for pedigree tracking
  // These allow setting parents for animals not born in-system (imports, purchases)
  // ─────────────────────────────────────────────────────────────────────────────
  damId  Int?
  dam    Animal? @relation("AnimalDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   Animal? @relation("AnimalSire", fields: [sireId], references: [id], onDelete: SetNull)

  // Reverse relations: offspring where this animal is a parent
  childrenAsDam  Animal[] @relation("AnimalDam")
  childrenAsSire Animal[] @relation("AnimalSire")

  // Cached COI (coefficient of inbreeding) - recalculated when pedigree changes
  coiPercent      Float? // 0.0 to 1.0 (display as percentage)
  coiGenerations  Int? // number of generations used in calculation
  coiCalculatedAt DateTime? // when COI was last computed

  // ─────────────────────────────────────────────────────────────────────────────
  // Cross-tenant linking: Exchange codes for quick breeder-to-breeder sharing
  // ─────────────────────────────────────────────────────────────────────────────
  exchangeCode          String?   @unique // Short-lived shareable code (e.g., "DUKE-8472")
  exchangeCodeExpiresAt DateTime? // When the code expires (7 days from generation)

  // Cross-tenant lineage identity link
  identityLink    AnimalIdentityLink?
  privacySettings AnimalPrivacySettings?

  waitlistAllocations WaitlistEntry[] @relation("WaitlistAllocation")
  waitlistSirePrefs   WaitlistEntry[] @relation("WaitlistSirePref")
  waitlistDamPrefs    WaitlistEntry[] @relation("WaitlistDamPref")

  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  // Party migration step 6G: unified party reference for animal buyer (party-only)
  buyerPartyId       Int?
  buyerParty         Party?    @relation("AnimalBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)
  priceCents         Int?
  depositCents       Int?
  saleInvoiceId      String?
  contractId         String?
  contractSignedAt   DateTime?
  paidInFullAt       DateTime?
  healthCertAt       DateTime?
  microchipAppliedAt DateTime?
  pickupAt           DateTime?
  placedAt           DateTime?

  tagAssignments           TagAssignment[]
  owners                   AnimalOwner[]
  registryIds              AnimalRegistryIdentifier[]
  microchipRegistrations   AnimalMicrochipRegistration[] @relation("AnimalMicrochipRegistrations")
  shares                   AnimalShare[]                 @relation("ShareAnimal")
  individualAnimalListings MktListingIndividualAnimal[]  @relation("AnimalIndividualAnimalListings")
  programParticipants      AnimalProgramParticipant[]    @relation("AnimalProgramParticipants")
  createdAt                DateTime                      @default(now())
  updatedAt                DateTime                      @updatedAt
  archived                 Boolean                       @default(false)

  // Soft delete
  deletedAt         DateTime?
  TestResult        TestResult[]
  Attachment        Attachment[]
  Offspring         Offspring[]         @relation("PromotedAnimal")
  PaymentIntent     PaymentIntent[]
  AnimalTraitValue  AnimalTraitValue[]
  AnimalTraitEntry  AnimalTraitEntry[]
  VaccinationRecord VaccinationRecord[]
  Document          Document[]
  Invoice           Invoice[]
  Expense           Expense[]
  genetics          AnimalGenetics?

  // Title & Competition tracking
  titles             AnimalTitle[]
  competitionEntries CompetitionEntry[]

  // Cached title strings for display (computed and stored on title changes)
  titlePrefix String? // "GCH CH" - prefix titles in display order
  titleSuffix String? // "CD CGC" - suffix titles in display order

  // Contracts (e.g., sales agreements for this animal)
  contracts Contract[] @relation("ContractAnimal")

  // Buyer CRM relations (P4)
  buyerInterests BuyerInterest[] @relation("BuyerInterestAnimal")
  deals          Deal[]          @relation("DealAnimal")
  // Buyer CRM relations (P5)
  buyerTasks     BuyerTask[]     @relation("BuyerTaskAnimal")

  // Mare reproductive history (horses only)
  mareReproductiveHistory MareReproductiveHistory?

  // Semen inventory (stallions only) - P7
  semenInventory SemenInventory[] @relation("StallionSemenInventory")


  // Breeding Discovery bookings (Phase 2)
  breedingBookingsOffering BreedingBooking[] @relation("OfferingAnimal")
  breedingBookingsSeeking  BreedingBooking[] @relation("SeekingAnimal")

  // ─────────────────────────────────────────────────────────────────────────────
  // Cross-tenant animal linking relations
  // ─────────────────────────────────────────────────────────────────────────────
  linkRequestsAsSource     AnimalLinkRequest[]     @relation("LinkSource")
  linkRequestsAsTarget     AnimalLinkRequest[]     @relation("LinkTarget")
  crossTenantLinksAsChild  CrossTenantAnimalLink[] @relation("LinkedChild")
  crossTenantLinksAsParent CrossTenantAnimalLink[] @relation("LinkedParent")

  // Registry pedigree links (P6)
  registryPedigrees RegistryPedigree[] @relation("RegistryPedigreeLinkedAnimal")

  // Supplement Tracking
  supplementSchedules       SupplementSchedule[]
  supplementAdministrations SupplementAdministration[]

  // Nutrition & Food Tracking
  feedingPlans   FeedingPlan[]
  feedingRecords FeedingRecord[]
  foodChanges    FoodChange[]

  // Breeding Profile (user-entered preferences and history)
  breedingProfile          AnimalBreedingProfile?
  breedingEvents           BreedingEvent[]           @relation("BreedingEvents")
  partnerBreedingEvents    BreedingEvent[]           @relation("PartnerBreedingEvents")
  incompatibleWithProfiles AnimalIncompatibility[]   @relation("IncompatibleWith")

  @@unique([tenantId, microchip])
  @@index([organizationId])
  @@index([tenantId])
  @@index([species])
  @@index([status])
  @@index([archived])
  @@index([canonicalBreedId])
  @@index([tenantId, customBreedId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([tenantId, placedAt])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([damId])
  @@index([sireId])
  @@index([tenantId, species, primaryLineType])
  @@schema("public")
}

model AnimalGenetics {
  id                 Int       @id @default(autoincrement())
  animalId           Int       @unique
  animal             Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  testProvider       String?   @db.VarChar(255)
  testDate           DateTime? @db.Date
  testId             String?   @db.VarChar(255)
  coatColorData      Json?     @db.JsonB
  healthGeneticsData Json?     @db.JsonB
  coatTypeData       Json?     @db.JsonB // Furnishings, Curly, Long Hair, Shedding
  physicalTraitsData Json?     @db.JsonB // Size (IGF1), Bobtail, Dewclaws, etc.
  eyeColorData       Json?     @db.JsonB // Eye color genetics
  otherTraitsData    Json?     @db.JsonB // Breed-specific traits

  // Extended Embark data
  breedComposition     Json?   @db.JsonB // Array of { breed: string, percentage: number }
  coi                  Json?   @db.JsonB // { coefficient, percentage, riskLevel, source }
  mhcDiversity         Json?   @db.JsonB // { drb1Alleles, dqa1Dqb1Alleles, diversityScore }
  lineage              Json?   @db.JsonB // { mtHaplotype, mtHaplogroup, yHaplotype, yHaplogroup }
  predictedAdultWeight Json?   @db.JsonB // { value, unit }
  lifeStage            String? @db.VarChar(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([animalId])
  @@schema("public")
}

model AnimalOwner {
  id        Int     @id @default(autoincrement())
  animalId  Int
  percent   Int
  isPrimary Boolean @default(false)
  animal    Animal  @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // Party migration step 6H: unified party reference for co-owner (party-only)
  partyId Int
  party   Party @relation("AnimalOwnerParty", fields: [partyId], references: [id], onDelete: SetNull)

  // P2.2: Role clarification (defaults to CO_OWNER for migration compatibility)
  role OwnerRole @default(CO_OWNER)

  // P2.3: Temporal tracking
  effectiveDate DateTime  @default(now())
  endDate       DateTime?

  // P2.4: Communication preferences
  isPrimaryContact     Boolean @default(false)
  receiveNotifications Boolean @default(true)

  // P2.5: Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([animalId, partyId])
  @@index([animalId])
  @@index([partyId])
  @@schema("public")
}

model Registry {
  id                Int                        @id @default(autoincrement())
  name              String
  code              String?                    @unique
  url               String?
  country           String?
  species           Species?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  identifiers       AnimalRegistryIdentifier[]
  BreedRegistryLink BreedRegistryLink[]
  connections       RegistryConnection[]

  @@schema("public")
}

model AnimalRegistryIdentifier {
  id                Int       @id @default(autoincrement())
  animalId          Int
  animal            Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  registryId        Int
  registry          Registry  @relation(fields: [registryId], references: [id], onDelete: Cascade)
  identifier        String
  registrarOfRecord String?
  issuedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // P6: Verification and pedigree relations
  verification RegistryVerification?
  pedigrees    RegistryPedigree[]

  @@unique([registryId, identifier])
  @@index([animalId])
  @@index([registryId])
  @@schema("public")
}

model AnimalShare {
  id           Int         @id @default(autoincrement())
  animalId     Int
  animal       Animal      @relation("ShareAnimal", fields: [animalId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant      @relation("ShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant      @relation("ShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope  @default(VIEW)
  status       ShareStatus @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([animalId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Individual Animal Listings
 * ────────────────────────────────────────────────────────────────────────────
 */

model MktListingIndividualAnimal {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation("TenantIndividualAnimalListings", fields: [tenantId], references: [id], onDelete: Cascade)
  animalId Int
  animal   Animal @relation("AnimalIndividualAnimalListings", fields: [animalId], references: [id], onDelete: Cascade)

  // Template & Identity
  templateType String  @db.VarChar(32) // STUD_SERVICES, GUARDIAN, TRAINED, REHOME, CO_OWNERSHIP, CUSTOM
  slug         String  @unique
  headline     String? @db.VarChar(120)
  title        String? @db.VarChar(100) // Override animal name

  // Content
  summary     String? @db.Text
  description String? @db.Text

  // Data Drawer Configuration (which data points to show)
  dataDrawerConfig Json @db.JsonB // { identity: {...}, media: {...}, healthTesting: {...}, ... }

  // Template-specific content
  listingContent Json? @db.JsonB // Template-specific fields (e.g., stud fee, guardian terms)

  // Pricing
  priceModel    String @db.VarChar(32) // "fixed" | "range" | "inquire"
  priceCents    Int?
  priceMinCents Int?
  priceMaxCents Int?

  // Location override (null = use storefront location)
  locationCity    String? @db.VarChar(100)
  locationRegion  String? @db.VarChar(100)
  locationZip     String? @db.VarChar(20)
  locationCountry String? @db.VarChar(2)

  // Publishing
  status      MarketplaceListingStatus @default(DRAFT)
  listed      Boolean                  @default(true) // true = public listing, false = unlisted (direct link only)
  publishedAt DateTime?
  pausedAt    DateTime?

  // Metadata
  viewCount     Int       @default(0)
  inquiryCount  Int       @default(0)
  lastViewedAt  DateTime?
  lastInquiryAt DateTime?

  // ─── Stud Service Fields (P1 Sprint) ────────────────────────────────
  // Applied when templateType = "STUD_SERVICES"
  // For standalone individual animal stud service listings

  // Season Management
  seasonName  String?   @db.VarChar(100)
  seasonStart DateTime?
  seasonEnd   DateTime?

  // Breeding Details
  breedingMethods      String[]               @default([])
  defaultGuaranteeType BreedingGuaranteeType?

  // Booking Management
  bookingFeeCents  Int?
  maxBookings      Int?
  bookingsReceived Int     @default(0)
  bookingsClosed   Boolean @default(false)

  // Mare Requirements
  healthCertRequired Boolean  @default(false)
  requiredTests      String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, status])
  @@index([tenantId, templateType])
  @@index([animalId])
  @@index([status])
  @@index([slug])
  @@map("direct_animal_listing")
  @@schema("public")
}

model MktListingAnimalProgram {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation("TenantAnimalPrograms", fields: [tenantId], references: [id], onDelete: Cascade)

  // Program Identity
  name         String  @db.VarChar(100)
  slug         String  @unique
  templateType String  @db.VarChar(32) // STUD_SERVICES, GUARDIAN, TRAINED, REHOME, CO_OWNERSHIP, CUSTOM
  headline     String? @db.VarChar(120)
  description  String? @db.Text

  // Media
  coverImageUrl String?              @db.VarChar(500)
  media         AnimalProgramMedia[]

  // Data Drawer Configuration (shared by all participants)
  dataDrawerConfig Json @db.JsonB

  // Template-specific shared content
  programContent Json? @db.JsonB

  // Default Pricing (can be overridden per participant)
  defaultPriceModel    String @default("inquire") @db.VarChar(32)
  defaultPriceCents    Int?
  defaultPriceMinCents Int?
  defaultPriceMaxCents Int?

  // Location override (null = use storefront location)
  locationCity    String? @db.VarChar(100)
  locationRegion  String? @db.VarChar(100)
  locationZip     String? @db.VarChar(20)
  locationCountry String? @db.VarChar(2)

  // Publishing
  status      MarketplaceListingStatus @default(DRAFT)
  listed      Boolean                  @default(true) // true = public, false = unlisted
  publishedAt DateTime?

  // Settings
  acceptInquiries Boolean @default(true)
  openWaitlist    Boolean @default(false)

  // Participants
  participants AnimalProgramParticipant[]

  // Metadata
  viewCount     Int       @default(0)
  inquiryCount  Int       @default(0)
  lastViewedAt  DateTime?
  lastInquiryAt DateTime?

  // ─── Stud Service Program Defaults (P1 Sprint) ──────────────────────
  // Applied when templateType = "STUD_SERVICES"
  // These are program-level defaults that can be overridden per animal

  // Season Management
  seasonName  String?   @db.VarChar(100)
  seasonStart DateTime?
  seasonEnd   DateTime?

  // Breeding Details
  breedingMethods      String[]               @default([])
  defaultGuaranteeType BreedingGuaranteeType?

  // Default Booking Settings (per animal)
  defaultBookingFeeCents      Int?
  defaultMaxBookingsPerAnimal Int?

  // Mare Requirements
  healthCertRequired Boolean  @default(false)
  requiredTests      String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, status])
  @@index([tenantId, templateType])
  @@index([slug])
  @@map("mkt_listing_animal_program")
  @@schema("public")
}

model AnimalProgramParticipant {
  id        Int                     @id @default(autoincrement())
  programId Int
  program   MktListingAnimalProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  animalId  Int
  animal    Animal                  @relation("AnimalProgramParticipants", fields: [animalId], references: [id], onDelete: Cascade)

  // Per-participant visibility settings
  status   String  @default("ACTIVE") // ACTIVE, PAUSED
  listed   Boolean @default(true)
  featured Boolean @default(false)

  // Per-participant overrides
  headlineOverride    String? @db.VarChar(120)
  descriptionOverride String? @db.Text
  dataDrawerOverride  Json?   @db.JsonB // Overrides for specific data drawer settings
  contentOverride     Json?   @db.JsonB // Template-specific content overrides

  // Per-participant pricing overrides
  priceModel    String? @db.VarChar(32)
  priceCents    Int?
  priceMinCents Int?
  priceMaxCents Int?

  // Display order
  sortOrder Int @default(0)

  // Metadata
  viewCount     Int       @default(0)
  inquiryCount  Int       @default(0)
  lastViewedAt  DateTime?
  lastInquiryAt DateTime?

  // ─── Stud Service Per-Animal Tracking & Overrides (P1 Sprint) ───────
  // Applied when program templateType = "STUD_SERVICES"

  // Booking tracking (per animal in program)
  bookingsReceived Int     @default(0)
  bookingsClosed   Boolean @default(false)

  // Optional overrides for program defaults
  maxBookingsOverride Int?
  bookingFeeOverride  Int? // In cents

  addedAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([programId, animalId])
  @@index([programId, status])
  @@index([animalId])
  @@schema("public")
}

model AnimalProgramMedia {
  id        Int                     @id @default(autoincrement())
  programId Int
  program   MktListingAnimalProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  type      String  @db.VarChar(32) // "image" | "video"
  url       String  @db.VarChar(500)
  caption   String? @db.Text
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([programId, sortOrder])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Trait System Models
 * ────────────────────────────────────────────────────────────────────────────
 */

model TraitDefinition {
  id                        Int                @id @default(autoincrement())
  tenantId                  Int?
  species                   Species
  key                       String
  displayName               String
  category                  String
  valueType                 TraitValueType
  enumValues                Json?
  requiresDocument          Boolean            @default(false)
  marketplaceVisibleDefault Boolean            @default(false)
  supportsHistory           Boolean            @default(false) // If true, trait supports multiple historical entries
  sortOrder                 Int?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  animalTraitValues         AnimalTraitValue[]
  animalTraitEntries        AnimalTraitEntry[]

  @@unique([species, key, tenantId])
  @@index([species])
  @@index([tenantId, species])
  @@schema("public")
}

model AnimalTraitValue {
  id                 Int                        @id @default(autoincrement())
  tenantId           Int
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId           Int
  traitDefinitionId  Int
  valueBoolean       Boolean?
  valueNumber        Float?
  valueText          String?
  valueDate          DateTime?
  valueJson          Json?
  status             TraitStatus?
  performedAt        DateTime?
  source             TraitSource?
  verified           Boolean                    @default(false)
  verifiedAt         DateTime?
  marketplaceVisible Boolean?
  networkVisible     Boolean? // Cross-tenant sharing visibility (when enableHealthSharing is on)
  notes              String?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  traitDefinition    TraitDefinition            @relation(fields: [traitDefinitionId], references: [id])
  animal             Animal                     @relation(fields: [animalId], references: [id], onDelete: Cascade)
  documents          AnimalTraitValueDocument[]

  @@unique([tenantId, animalId, traitDefinitionId])
  @@index([tenantId, animalId])
  @@index([tenantId, traitDefinitionId])
  @@schema("public")
}

model AnimalTraitValueDocument {
  id                 Int              @id @default(autoincrement())
  tenantId           Int
  animalId           Int
  animalTraitValueId Int
  documentId         Int
  createdAt          DateTime         @default(now())
  animalTraitValue   AnimalTraitValue @relation(fields: [animalTraitValueId], references: [id], onDelete: Cascade)
  document           Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([tenantId, animalTraitValueId, documentId])
  @@index([tenantId, animalId])
  @@index([tenantId, animalTraitValueId])
  @@index([tenantId, documentId])
  @@schema("public")
}

// Historical entries for traits that support multiple records over time
// (e.g., Vet Wellness Exams, Weight measurements, Body Condition Scores)
model AnimalTraitEntry {
  id                Int             @id @default(autoincrement())
  tenantId          Int
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId          Int
  animal            Animal          @relation(fields: [animalId], references: [id], onDelete: Cascade)
  traitDefinitionId Int
  traitDefinition   TraitDefinition @relation(fields: [traitDefinitionId], references: [id])

  // The recorded date/time of this entry (when the measurement/exam occurred)
  recordedAt DateTime

  // Flexible JSON storage for entry data (structure depends on trait type)
  // e.g., { lbs: 45, oz: 8 } for weight, { outcome: "Normal", notes: "..." } for wellness exam
  data Json

  // Optional metadata
  performedBy String? @db.VarChar(255) // Who performed (vet name, clinic, etc.)
  location    String? @db.VarChar(255) // Where it was performed
  notes       String? @db.Text

  // Optional document attachment
  documentId Int?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, animalId])
  @@index([tenantId, animalId, traitDefinitionId])
  @@index([tenantId, animalId, recordedAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Vaccination Records
 * ────────────────────────────────────────────────────────────────────────────
 */

model VaccinationRecord {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  protocolKey    String    @db.VarChar(100) // "rabies", "dhpp", "bordetella", etc.
  administeredAt DateTime
  expiresAt      DateTime? // Calculated or manual override

  veterinarian   String? @db.VarChar(255)
  clinic         String? @db.VarChar(255)
  batchLotNumber String? @db.VarChar(100)
  notes          String? @db.Text

  documentId Int?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, animalId])
  @@index([tenantId, protocolKey])
  @@index([animalId, protocolKey])
  @@index([administeredAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Tags
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tag {
  id          Int             @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  module      TagModule
  color       String?
  isArchived  Boolean         @default(false)
  archivedAt  DateTime?
  assignments TagAssignment[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([tenantId, module, name])
  @@index([tenantId, module])
  @@index([tenantId, isArchived, module])
  @@schema("public")
}

model TagAssignment {
  id    Int @id @default(autoincrement())
  tagId Int
  tag   Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  // Step 6B: Party-only storage for Contact/Organization tags
  taggedPartyId Int?
  taggedParty   Party? @relation("TagAssignmentTaggedParty", fields: [taggedPartyId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: Cascade)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  // Communications Hub: Message threads and drafts
  messageThreadId Int?
  messageThread   MessageThread? @relation(fields: [messageThreadId], references: [id], onDelete: Cascade)

  draftId Int?
  draft   Draft? @relation(fields: [draftId], references: [id], onDelete: Cascade)

  // Breeding Plans
  breedingPlanId Int?
  breedingPlan   BreedingPlan? @relation(fields: [breedingPlanId], references: [id], onDelete: Cascade)

  // Buyer CRM (P4)
  buyerId Int?
  buyer   Buyer? @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  dealId Int?
  deal   Deal? @relation(fields: [dealId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([tagId, taggedPartyId])
  @@unique([tagId, animalId])
  @@unique([tagId, waitlistEntryId])
  @@unique([tagId, offspringGroupId])
  @@unique([tagId, offspringId])
  @@unique([tagId, messageThreadId])
  @@unique([tagId, draftId])
  @@unique([tagId, breedingPlanId])
  @@unique([tagId, buyerId])
  @@unique([tagId, dealId])
  @@index([taggedPartyId])
  @@index([animalId])
  @@index([waitlistEntryId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([messageThreadId])
  @@index([draftId])
  @@index([breedingPlanId])
  @@index([buyerId])
  @@index([dealId])
  @@index([tagId, taggedPartyId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeds
 * ────────────────────────────────────────────────────────────────────────────
 */

model Breed {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  species   Species
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  registries         BreedRegistryLink[]
  Animal             Animal[]
  AnimalBreeds       AnimalBreed[]
  TenantProgramBreed TenantProgramBreed[]

  @@index([species])
  @@schema("public")
}

model AnimalBreed {
  id         Int      @id @default(autoincrement())
  animalId   Int
  animal     Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  breedId    Int
  breed      Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  percentage Float    @default(100)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([animalId, breedId])
  @@index([animalId])
  @@index([breedId])
  @@schema("public")
}

model BreedRegistryLink {
  breedId    Int
  registryId Int

  statusText  String?
  registryRef String?
  url         String?
  primary     Boolean?
  since       Int?
  notes       String?
  proofUrl    String?

  breed    Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  registry Registry @relation(fields: [registryId], references: [id], onDelete: Cascade)

  @@id([breedId, registryId])
  @@index([registryId])
  @@schema("public")
}

model CustomBreed {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdByOrganizationId Int?
  createdByOrganization   Organization? @relation("CreatedByOrganization", fields: [createdByOrganizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  species     Species
  name        String
  composition Json?

  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  Animal             Animal[]
  TenantProgramBreed TenantProgramBreed[]

  @@unique([id, tenantId])
  @@unique([tenantId, species, name])
  @@index([tenantId, species])
  @@index([tenantId, createdByOrganizationId])
  @@schema("public")
}

/// Breeds selected for a tenant's breeding program (displayed on marketplace listings)
model TenantProgramBreed {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  species Species

  /// Reference to canonical breed (mutually exclusive with customBreedId)
  breedId Int?
  breed   Breed? @relation(fields: [breedId], references: [id], onDelete: Cascade)

  /// Reference to custom breed (mutually exclusive with breedId)
  customBreedId Int?
  customBreed   CustomBreed? @relation(fields: [customBreedId, tenantId], references: [id, tenantId], onDelete: Cascade)

  /// Whether this is the primary breed for the species
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, breedId])
  @@unique([tenantId, customBreedId])
  @@index([tenantId, species])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding Programs (Marketplace)
 * ────────────────────────────────────────────────────────────────────────────
 */

model MktListingBreedingProgram {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Identity
  slug         String // URL-friendly identifier, unique per tenant
  name         String // "Goldendoodle Program"
  description  String? @db.Text
  programStory String? @db.Text // Extended story/narrative about the program
  species      Species
  breedText    String? // "Goldendoodle", "Bernedoodle (F1b)", etc.
  breedId      Int? // Optional link to Breed record for structured breed data

  // Cover Image
  coverImageUrl  String? // Primary cover image URL
  showCoverImage Boolean @default(true) // Visibility toggle for cover image

  // Marketplace Settings
  status             MarketplaceListingStatus @default(DRAFT)
  acceptInquiries    Boolean                  @default(true)
  openWaitlist       Boolean                  @default(false)
  acceptReservations Boolean                  @default(false) // Auto-accept deposits vs manual waitlist
  comingSoon         Boolean                  @default(false) // Coming Soon badge for programs in development

  // Pricing & Details
  pricingTiers      Json? // [{tier: "Pet", priceRange: "$2,500", description: "..."}]
  whatsIncluded     String? @db.Text // What comes with each animal
  showWhatsIncluded Boolean @default(true) // Visibility toggle
  typicalWaitTime   String? // "3-6 months"
  showWaitTime      Boolean @default(true) // Visibility toggle

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  breedingPlans   BreedingPlan[]
  media           BreedingProgramMedia[]
  inquiries       BreedingProgramInquiry[]
  waitlistEntries WaitlistEntry[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([status])
  @@index([species])
  @@map("mkt_listing_breeding_program")
  @@schema("public")
}

model BreedingProgramMedia {
  id        Int                       @id @default(autoincrement())
  programId Int
  program   MktListingBreedingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  tenantId  Int
  tenant    Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  assetUrl  String
  caption   String?
  sortOrder Int     @default(0)
  isPublic  Boolean @default(true) // Visibility toggle

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([programId])
  @@index([tenantId])
  @@schema("public")
}

model BreedingProgramInquiry {
  id        Int                       @id @default(autoincrement())
  programId Int
  program   MktListingBreedingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  tenantId  Int // Breeder's tenant
  tenant    Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Buyer information
  buyerName  String
  buyerEmail String
  buyerPhone String?

  // Inquiry details
  subject String
  message String @db.Text

  // What they're interested in
  interestedIn String? // "Next litter", "Specific horse", "General info"
  priceRange   String? // "Under $5K", "$5K-$10K", "$10K+"
  timeline     String? // "Immediate", "Next 3 months", "6+ months", "Just researching"

  // Internal tracking
  status           InquiryStatus @default(NEW)
  assignedToUserId String?
  assignedToUser   User?         @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)

  // Communication
  responded   Boolean   @default(false)
  respondedAt DateTime?
  notes       String?   @db.Text

  // Marketing tracking
  source      String? // "Marketplace", "Google", "Facebook", "Referral"
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([programId, status])
  @@index([tenantId, status])
  @@index([buyerEmail])
  @@index([createdAt])
  @@schema("public")
}

enum InquiryStatus {
  NEW
  CONTACTED
  QUALIFIED
  SCHEDULED_VISIT
  CONVERTED
  NOT_INTERESTED
  SPAM

  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding core
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlan {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  // Breeding Program linkage (for marketplace)
  programId Int?
  program   MktListingBreedingProgram? @relation(fields: [programId], references: [id], onDelete: SetNull)

  code      String?
  name      String
  nickname  String?
  species   Species
  breedText String?

  damId  Int?
  dam    Animal? @relation("PlanDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId Int?
  sire   Animal? @relation("PlanSire", fields: [sireId], references: [id], onDelete: SetNull)

  lockedCycleKey           String?
  lockedCycleStart         DateTime?
  lockedOvulationDate      DateTime?
  lockedDueDate            DateTime?
  lockedPlacementStartDate DateTime?

  // ──────────────────────────────────────────────────────────────────────────
  // Anchor Mode System (Ovulation Anchor Breeding System)
  // Stores BOTH cycle start AND ovulation when available for validation/ML
  // ──────────────────────────────────────────────────────────────────────────

  /// User-selected primary anchor mode for this plan
  reproAnchorMode ReproAnchorMode @default(CYCLE_START)

  /// Cycle start tracking (observed or derived from ovulation)
  cycleStartObserved   DateTime? // When breeder observed heat signs
  cycleStartSource     DataSource? // How cycle start was determined
  cycleStartConfidence ConfidenceLevel?

  /// Ovulation tracking (confirmed via hormone test or calculated)
  ovulationConfirmed       DateTime? // When ovulation was hormone-confirmed
  ovulationConfirmedMethod OvulationMethod?
  ovulationTestResultId    Int?
  ovulationTestResult      TestResult?      @relation("OvulationAnchor", fields: [ovulationTestResultId], references: [id], onDelete: SetNull)
  ovulationConfidence      ConfidenceLevel?

  /// System-determined primary anchor based on data quality
  primaryAnchor AnchorType @default(CYCLE_START)

  /// Variance tracking for machine learning and validation
  expectedOvulationOffset Int? // Species default offset (e.g., 12 days for dogs)
  actualOvulationOffset   Int? // Calculated: ovulationConfirmed - cycleStartObserved
  varianceFromExpected    Int? // actualOffset - expectedOffset (e.g., +2 = 2 days late)

  /// General date confidence metadata
  dateConfidenceLevel ConfidenceLevel? @default(MEDIUM)
  dateSourceNotes     String?

  expectedCycleStart          DateTime?
  expectedHormoneTestingStart DateTime?
  expectedBreedDate           DateTime?
  expectedBirthDate           DateTime?
  expectedWeaned              DateTime?
  expectedPlacementStart      DateTime?
  expectedPlacementCompleted  DateTime?

  cycleStartDateActual          DateTime?
  hormoneTestingStartDateActual DateTime?
  breedDateActual               DateTime?
  birthDateActual               DateTime?
  weanedDateActual              DateTime?
  placementStartDateActual      DateTime?
  placementCompletedDateActual  DateTime?
  completedDateActual           DateTime?

  /// Unknown date flags - for surprise pregnancies where breeder doesn't know exact dates
  /// When true, the corresponding date is unknown and phase can progress without it
  cycleStartDateUnknown Boolean @default(false)
  ovulationDateUnknown  Boolean @default(false)
  breedDateUnknown      Boolean @default(false)

  status BreedingPlanStatus @default(PLANNING)
  notes  String?

  /// For ON_HOLD status: stores the previous status so plan can resume
  statusBeforeHold BreedingPlanStatus?

  /// Optional reason for terminal status (CANCELED, UNSUCCESSFUL, ON_HOLD)
  statusReason String?

  /// User intent flag: breeder has mentally committed to this plan (set during PLANNING phase)
  /// This is separate from the CYCLE phase - indicates serious intent without locking cycle dates
  isCommittedIntent Boolean @default(false)

  committedAt       DateTime?
  committedByUserId String?
  committedByUser   User?     @relation("CommittedByUser", fields: [committedByUserId], references: [id], onDelete: SetNull)

  depositsCommittedCents Int?
  depositsPaidCents      Int?
  depositRiskScore       Int?

  // Buyer capacity tracking
  expectedLitterSize Int?

  // Deposit overrides (null = inherit from program)
  depositOverrideRequired    Boolean?
  depositOverrideAmountCents Int?

  Litter             Litter?
  offspringGroup     OffspringGroup?
  Events             BreedingPlanEvent[]
  Waitlist           WaitlistEntry[]
  buyers             BreedingPlanBuyer[]
  Shares             BreedingPlanShare[]
  TestResults        TestResult[]
  BreedingAttempts   BreedingAttempt[]
  PregnancyChecks    PregnancyCheck[]
  Attachments        Attachment[]
  Parties            PlanParty[]
  Invoice            Invoice[]
  Expense            Expense[]
  TagAssignments     TagAssignment[]
  foalingOutcome     FoalingOutcome?
  breedingMilestones BreedingMilestone[]

  // Breeding booking that originated this plan
  breedingBooking BreedingBooking?

  // Breeding events linked to this plan
  breedingEventsLog BreedingEvent[]

  // Supplement Tracking
  supplementSchedules SupplementSchedule[]

  archived      Boolean   @default(false)
  archiveReason String? /// Optional reason/note provided when archiving the plan
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([organizationId])
  @@index([programId])
  @@index([damId])
  @@index([sireId])
  @@index([status])
  @@index([deletedAt])
  @@index([committedAt])
  @@index([expectedWeaned])
  @@index([expectedPlacementCompleted])
  @@index([expectedPlacementStart])
  @@index([placementStartDateActual])
  @@index([placementCompletedDateActual])
  @@index([expectedBirthDate])
  @@index([expectedCycleStart])
  @@index([expectedHormoneTestingStart])
  @@index([expectedBreedDate])
  @@index([cycleStartDateActual])
  // Anchor Mode System indexes
  @@index([reproAnchorMode])
  @@index([ovulationConfirmed])
  @@index([cycleStartObserved])
  @@index([primaryAnchor])
  @@index([ovulationTestResultId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding Plan Buyers - Manage buyer assignments at plan level
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlanBuyer {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Buyer Reference (one of these should be set)
  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation(fields: [waitlistEntryId], references: [id], onDelete: SetNull)
  partyId         Int?
  party           Party?         @relation("BreedingPlanBuyerParty", fields: [partyId], references: [id], onDelete: SetNull)

  // P4/P5: Link to Buyer CRM for unified buyer management
  buyerId Int?
  buyer   Buyer? @relation("BreedingPlanBuyerCRM", fields: [buyerId], references: [id], onDelete: SetNull)

  // Stage
  stage BreedingPlanBuyerStage @default(POSSIBLE_MATCH)

  // Match Metadata
  matchScore   Int?
  matchReasons Json?

  // Assignment Metadata
  assignedAt        DateTime?
  assignedByPartyId Int?
  priority          Int?

  // Offspring Connection
  offspringGroupBuyerId Int?
  offspringId           Int?

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId])
  @@index([planId, stage])
  @@index([waitlistEntryId])
  @@index([partyId])
  @@index([buyerId])
  @@schema("public")
}

model ReproductiveCycle {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  femaleId Int
  female   Animal @relation(fields: [femaleId], references: [id], onDelete: Cascade)

  cycleStart         DateTime
  ovulation          DateTime?
  dueDate            DateTime?
  placementStartDate DateTime?

  status String?
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([femaleId])
  @@index([cycleStart])
  @@schema("public")
}

model BreedingPlanShare {
  id           Int          @id @default(autoincrement())
  planId       Int
  plan         BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant       @relation("PlanShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant       @relation("PlanShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope   @default(BREED_PLAN)
  status       ShareStatus  @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([planId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding plug-ins
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlanEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  type String

  occurredAt DateTime
  label      String?
  notes      String?
  data       Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, type, occurredAt])
  @@schema("public")
}

model TestResult {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  kind    String
  method  String?
  labName String?

  valueNumber    Float?
  valueText      String?
  units          String?
  referenceRange String?

  collectedAt DateTime
  resultAt    DateTime?
  notes       String?
  data        Json?

  // Anchor Mode System: track which plans use this test for ovulation anchor
  anchoredPlans          BreedingPlan[] @relation("OvulationAnchor")
  indicatesOvulationDate DateTime? // When test indicates ovulation occurred

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([animalId])
  @@index([planId])
  @@index([kind, collectedAt])
  @@schema("public")
}

model BreedingAttempt {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Plan link (optional - attempt survives plan deletion for historical records)
  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  // Animal links (primary ownership - for historical persistence and animal-level queries)
  damId  Int?
  dam    Animal? @relation("BreedingAttemptDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   Animal? @relation("BreedingAttemptSire", fields: [sireId], references: [id], onDelete: SetNull)

  method      BreedingMethod
  attemptAt   DateTime?
  windowStart DateTime?
  windowEnd   DateTime?

  // Party migration step 5: unified party reference for stud owner
  studOwnerPartyId Int?
  studOwnerParty   Party? @relation("BreedingAttemptStudOwner", fields: [studOwnerPartyId], references: [id], onDelete: SetNull)

  semenBatchId Int?

  success  Boolean?
  notes    String?
  location String?  @db.VarChar(255) // Where the breeding occurred (e.g., "ABC Vet Clinic")
  data     Json?

  // ─────────────────────────────────────────────────────────────────────────────
  // Guarantee Tracking (P1 Sprint - P1.3)
  // Per spec: 08-STALLION-REVENUE-MANAGEMENT-SPEC.md Section 3.2
  // ─────────────────────────────────────────────────────────────────────────────
  guaranteeType        BreedingGuaranteeType?
  guaranteeExpiresAt   DateTime?
  guaranteeTriggered   Boolean                @default(false)
  guaranteeTriggeredAt DateTime?
  guaranteeReason      String? // "Stillborn", "Failed to conceive"
  guaranteeResolution  GuaranteeResolution?

  // Return Breeding (if guarantee triggered)
  returnBreedingGranted   Boolean   @default(false)
  returnBreedingExpiresAt DateTime?
  returnBreedingUsedAt    DateTime?

  // Fee snapshot at time of breeding
  agreedFeeCents Int?
  feePaidCents   Int? @default(0)

  // Semen usage link (P7 - for AI breedings)
  semenUsage SemenUsage?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId])
  @@index([damId])
  @@index([sireId])
  @@index([studOwnerPartyId])
  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Semen Inventory Management (P7)
// Tracks frozen and cooled semen at the dose level for stallion stations
// ─────────────────────────────────────────────────────────────────────────────

model SemenInventory {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Stallion
  stallionId Int
  stallion   Animal @relation("StallionSemenInventory", fields: [stallionId], references: [id])

  // Batch identification
  batchNumber      String
  collectionDate   DateTime
  collectionMethod SemenCollectionMethod @default(AV)

  // Storage
  storageType     SemenStorageType
  storageLocation String? // "Tank A, Canister 3, Cane 2"
  storageFacility String? // External facility name if off-site

  // Quantity
  initialDoses   Int // Doses from this collection
  availableDoses Int // Current available (decrements on use)
  doseVolumeMl   Decimal? @db.Decimal(5, 2) // Volume per dose

  // Quality assessment
  concentration Int? // Million sperm/ml
  motility      Int? // Percentage (0-100)
  morphology    Int? // Percentage normal (0-100)
  qualityGrade  SemenQualityGrade?

  // Expiration
  expiresAt DateTime? // For cooled/extended semen
  isExpired Boolean   @default(false)

  // Status
  status SemenInventoryStatus @default(AVAILABLE)
  notes  String?              @db.Text

  // Audit
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  createdBy  Int?
  archivedAt DateTime?

  // Relations
  usages SemenUsage[]

  @@unique([tenantId, batchNumber])
  @@index([tenantId, stallionId])
  @@index([tenantId, status])
  @@schema("public")
}

model SemenUsage {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Source batch
  inventoryId Int
  inventory   SemenInventory @relation(fields: [inventoryId], references: [id])

  // Usage details
  usageType SemenUsageType
  usageDate DateTime       @default(now())
  dosesUsed Int            @default(1)

  // Destination (one of these should be set based on usageType)
  breedingAttemptId Int?             @unique
  breedingAttempt   BreedingAttempt? @relation(fields: [breedingAttemptId], references: [id])

  // For shipped semen
  shippedToName    String?
  shippedToAddress String? @db.Text
  shippingCarrier  String?
  trackingNumber   String?

  // For transfers between facilities
  transferredToFacility String?

  // Notes
  notes String? @db.Text

  // Audit
  recordedBy Int?
  createdAt  DateTime @default(now())

  // Link to breeding booking
  breedingBooking BreedingBooking?

  @@index([tenantId, inventoryId])
  @@index([tenantId, usageDate])
  @@schema("public")
}




model PregnancyCheck {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method    PregnancyCheckMethod
  result    Boolean
  checkedAt DateTime
  notes     String?
  data      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, checkedAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Foaling Automation
 * ────────────────────────────────────────────────────────────────────────────
 */

model FoalingOutcome {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  breedingPlanId Int          @unique
  breedingPlan   BreedingPlan @relation(fields: [breedingPlanId], references: [id], onDelete: Cascade)

  // Veterinary details
  hadComplications    Boolean @default(false)
  complicationDetails String? @db.Text
  veterinarianCalled  Boolean @default(false)
  veterinarianName    String?
  veterinarianNotes   String? @db.Text

  // Post-foaling physiology
  placentaPassed        Boolean?
  placentaPassedMinutes Int?
  mareCondition         MarePostFoalingCondition?

  // Post-foaling reproductive cycle
  postFoalingHeatDate  DateTime?
  postFoalingHeatNotes String?
  readyForRebreeding   Boolean   @default(false)
  rebredDate           DateTime?

  // Media
  foalPhotoUrls Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([breedingPlanId])
  @@schema("public")
}

enum MarePostFoalingCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  VETERINARY_CARE_REQUIRED

  @@schema("public")
}

model MareReproductiveHistory {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  mareId Int    @unique
  mare   Animal @relation(fields: [mareId], references: [id], onDelete: Cascade)

  // Lifetime Statistics
  totalFoalings                Int @default(0)
  totalLiveFoals               Int @default(0)
  totalComplicatedFoalings     Int @default(0)
  totalVeterinaryInterventions Int @default(0)
  totalRetainedPlacentas       Int @default(0)

  // Last Foaling Information
  lastFoalingDate          DateTime?
  lastFoalingComplications Boolean?
  lastMareCondition        String?
  lastPlacentaPassed       Boolean?
  lastPlacentaMinutes      Int?

  // Post-Foaling Heat Patterns (averages)
  avgPostFoalingHeatDays Float?
  minPostFoalingHeatDays Int?
  maxPostFoalingHeatDays Int?

  // Breeding Readiness Tracking
  lastPostFoalingHeatDate DateTime?
  lastReadyForRebreeding  Boolean?
  lastRebredDate          DateTime?

  // Risk Indicators (derived from history)
  riskScore   Int      @default(0)
  riskFactors String[]

  // Manual Status Overrides
  isBarren Boolean @default(false) // Permanently barren mare
  // NOTE: Breeding availability (open/resting) now uses Animal.breedingAvailability (generic for all species)

  // Notes and metadata
  notes                    String?
  lastUpdatedFromPlanId    Int?
  lastUpdatedFromBreedYear Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([mareId])
  @@index([riskScore])
  @@schema("public")
}

model BreedingMilestone {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  breedingPlanId Int
  breedingPlan   BreedingPlan @relation(fields: [breedingPlanId], references: [id], onDelete: Cascade)

  milestoneType      MilestoneType
  scheduledDate      DateTime
  completedDate      DateTime?
  isCompleted        Boolean       @default(false)
  notificationSent   Boolean       @default(false)
  notificationSentAt DateTime?
  notes              String?       @db.Text
  vetAppointmentId   Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([breedingPlanId, scheduledDate])
  @@index([scheduledDate, isCompleted])
  @@schema("public")
}

enum MilestoneType {
  // Horse-specific (340-day gestation) - legacy
  VET_PREGNANCY_CHECK_15D
  VET_ULTRASOUND_45D
  VET_ULTRASOUND_90D
  BEGIN_MONITORING_300D
  PREPARE_FOALING_AREA_320D
  DAILY_CHECKS_330D
  DUE_DATE_340D
  OVERDUE_VET_CALL_350D

  // Species-generic scheduled milestones (all species)
  PREGNANCY_CONFIRMATION
  ULTRASOUND_HEARTBEAT
  ULTRASOUND_COUNT
  XRAY_COUNT
  BEGIN_MONITORING
  DAILY_CHECKS
  PREPARE_BIRTH_AREA
  DUE_DATE
  OVERDUE_VET_CALL

  // Pre-birth physical signs (user-recorded observations)
  // Universal signs
  TEMPERATURE_DROP
  NESTING_BEHAVIOR
  LOSS_OF_APPETITE
  RESTLESSNESS
  VULVAR_CHANGES
  MILK_PRESENT

  // Horse/ruminant-specific signs
  UDDER_DEVELOPMENT
  UDDER_FULL
  WAX_APPEARANCE
  VULVAR_RELAXATION
  TAILHEAD_RELAXATION
  MILK_CALCIUM_TEST
  LIGAMENT_SOFTENING
  UDDER_TIGHT

  // Rabbit-specific signs
  FUR_PULLING
  NEST_BUILDING

  @@schema("public")
}

enum FoalHealthStatus {
  HEALTHY
  MINOR_ISSUES
  VETERINARY_CARE
  CRITICAL
  DECEASED

  @@schema("public")
}

enum FoalNursingStatus {
  UNKNOWN
  NURSING_WELL
  ASSISTED
  BOTTLE_FED
  ORPHANED

  @@schema("public")
}

/**
 * Neonatal health status for intensive care tracking
 */
enum NeonatalHealthStatus {
  THRIVING
  WATCH
  CRITICAL
  DECEASED

  @@schema("public")
}

/**
 * Feeding method for neonates
 */
enum NeonatalFeedingMethod {
  NURSING
  SUPPLEMENTAL
  BOTTLE
  TUBE
  ORPHANED

  @@schema("public")
}

/**
 * Stool quality for neonate monitoring
 */
enum StoolQuality {
  NORMAL
  SOFT
  DIARRHEA
  CONSTIPATED
  NONE

  @@schema("public")
}

/**
 * Activity level for neonate monitoring
 */
enum ActivityLevel {
  VIGOROUS
  NORMAL
  WEAK
  LETHARGIC

  @@schema("public")
}

/**
 * Neonatal intervention types
 */
enum NeonatalInterventionType {
  PLASMA_TRANSFUSION
  COLOSTRUM_SUPPLEMENT
  SERUM_IMMUNOGLOBULIN
  SUBQ_FLUIDS
  IV_FLUIDS
  DEXTROSE_GLUCOSE
  TUBE_FEEDING
  IRON_SUPPLEMENT
  CALCIUM_SUPPLEMENT
  OXYGEN_THERAPY
  DOXAPRAM
  NALOXONE
  NEBULIZER
  ANTIBIOTIC
  PROBIOTIC
  DEWORMER
  VITAMIN_K
  UMBILICAL_CARE
  EYE_CARE
  SKIN_TREATMENT
  OTHER

  @@schema("public")
}

/**
 * Intervention administration route
 */
enum InterventionRoute {
  ORAL
  SUBCUTANEOUS
  INTRAVENOUS
  INTRAMUSCULAR
  TOPICAL
  INHALATION

  @@schema("public")
}

/**
 * Who administered the intervention
 */
enum AdministeredBy {
  SELF
  VET
  VET_TECH

  @@schema("public")
}

/**
 * Response to intervention
 */
enum InterventionResponse {
  IMPROVED
  NO_CHANGE
  WORSENED

  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group, Offspring, legacy Litter, Waitlist
 * ────────────────────────────────────────────────────────────────────────────
 */

model OffspringGroup {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  linkState  OffspringLinkState   @default(linked)
  linkReason OffspringLinkReason?

  species Species
  damId   Int?
  dam     Animal? @relation("OffspringDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId  Int?
  sire    Animal? @relation("OffspringSire", fields: [sireId], references: [id], onDelete: SetNull)
  name    String?

  expectedBirthOn DateTime?
  actualBirthOn   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  status        MarketplaceListingStatus @default(DRAFT)
  coverImageUrl String?
  themeName     String?

  // Marketplace MVP: public listing fields
  listingSlug                  String?
  listingTitle                 String?
  listingDescription           String? @db.Text
  marketplaceDefaultPriceCents Int?

  notes String?
  data  Json?

  // Phase 6: Placement scheduling policy for scheduling fairness
  placementSchedulingPolicy Json?

  // children as Offspring, not Animals
  Offspring Offspring[] @relation("GroupOffspring")

  // legacy Animal linkage retained for compatibility
  AnimalsLegacy Animal[] @relation("OffspringGroupPuppiesLegacy")

  Waitlist         WaitlistEntry[]
  Tags             TagAssignment[]
  Events           OffspringGroupEvent[]
  Attachment       Attachment[]
  groupBuyerLinks  OffspringGroupBuyer[]         @relation("GroupBuyerGroup")
  schedulingBlocks SchedulingAvailabilityBlock[] @relation("GroupSchedulingBlocks")

  // Nutrition tracking
  FeedingPlan   FeedingPlan[]
  FeedingRecord FeedingRecord[]
  FoodChange    FoodChange[]

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  archivedAt DateTime?
  deletedAt  DateTime?
  Invoice    Invoice[]
  Campaign   Campaign[]
  Task       Task[]
  Document   Document[]
  Contract   Contract[]
  Expense    Expense[]

  @@unique([planId])
  @@unique([tenantId, listingSlug])
  @@index([tenantId])
  @@index([tenantId, species, expectedBirthOn])
  @@index([tenantId, damId, actualBirthOn])
  @@index([sireId])
  @@index([linkState])
  @@index([placementStartAt])
  @@index([placementCompletedAt])
  @@index([status])
  @@index([deletedAt])
  @@schema("public")
}

model OffspringGroupBuyer {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  groupId Int
  group   OffspringGroup @relation("GroupBuyerGroup", fields: [groupId], references: [id], onDelete: Cascade)

  // Step 6C: Party-only storage for buyer identity
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringGroupBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation("GroupBuyerWaitlistEntry", fields: [waitlistEntryId], references: [id], onDelete: SetNull)

  // Phase 6: Placement rank for scheduling fairness (lower rank = earlier pick)
  placementRank Int?

  // P4/P5: Link to Buyer CRM for unified buyer management
  buyerId Int?
  buyer   Buyer? @relation("OffspringGroupBuyerCRM", fields: [buyerId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, buyerPartyId])
  @@unique([groupId, waitlistEntryId])
  @@index([tenantId])
  @@index([groupId])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([waitlistEntryId])
  @@index([buyerId])
  @@schema("public")
}

model Offspring {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  groupId Int
  group   OffspringGroup @relation("GroupOffspring", fields: [groupId], references: [id], onDelete: Cascade)

  // identity
  name    String?
  species Species
  breed   String?
  sex     Sex?
  bornAt  DateTime?
  diedAt  DateTime?
  status  OffspringStatus @default(NEWBORN)
  color   String?

  // health outcome tracking (foaling automation)
  birthWeight     Float?
  healthStatus    FoalHealthStatus  @default(HEALTHY)
  healthNotes     String?           @db.Text
  nursingStatus   FoalNursingStatus @default(UNKNOWN)
  standingMinutes Int?
  nursingMinutes  Int?
  requiredVetCare Boolean           @default(false)
  vetCareDetails  String?

  // Neonatal care tracking (for litter species)
  isExtraNeeds          Boolean                @default(false)
  neonatalHealthStatus  NeonatalHealthStatus?
  neonatalFeedingMethod NeonatalFeedingMethod?
  birthWeightOz         Float?

  // orthogonal lifecycle dimensions (production canonical state)
  lifeState      OffspringLifeState      @default(ALIVE)
  placementState OffspringPlacementState @default(UNASSIGNED)
  keeperIntent   OffspringKeeperIntent   @default(AVAILABLE)
  financialState OffspringFinancialState @default(NONE)
  paperworkState OffspringPaperworkState @default(NONE)

  // parents as of creation time
  damId  Int?
  dam    Animal? @relation("OffspringIndividualDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   Animal? @relation("OffspringIndividualSire", fields: [sireId], references: [id], onDelete: SetNull)

  // collar
  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  // Step 6D: Party-only storage for buyer identity
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  // finance and placement
  priceCents       Int?
  depositCents     Int?
  contractId       String?
  contractSignedAt DateTime?
  paidInFullAt     DateTime?
  pickupAt         DateTime?
  placedAt         DateTime?

  // marketplace listing control
  marketplaceListed     Boolean @default(false)
  marketplacePriceCents Int?

  // promotion link
  promotedAnimalId Int?
  promotedAnimal   Animal? @relation("PromotedAnimal", fields: [promotedAnimalId], references: [id], onDelete: SetNull)

  notes String?
  data  Json?

  // Archive (soft delete for individual offspring)
  archivedAt    DateTime?
  archiveReason String?   @db.Text

  Tags                   TagAssignment[]
  Attachments            Attachment[]
  Events                 OffspringEvent[]
  WaitlistAllocations    WaitlistEntry[]               @relation("WaitlistAllocationOffspring")
  microchipRegistrations AnimalMicrochipRegistration[] @relation("OffspringMicrochipRegistrations")

  // Neonatal care relations
  NeonatalCareEntries   NeonatalCareEntry[]
  NeonatalInterventions NeonatalIntervention[]

  // finance, tasks, health, documents, contracts
  Invoices   Invoice[]
  Tasks      Task[]
  HealthLogs HealthEvent[]
  Documents  Document[]
  Contracts  Contract[]

  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  InvoiceLinks             OffspringInvoiceLink[]
  CampaignAttribution      CampaignAttribution[]
  OffspringDocument        OffspringDocument[]
  OffspringContract        OffspringContract[]
  schedulingEventTemplates SchedulingEventTemplate[]

  @@index([tenantId])
  @@index([groupId])
  @@index([tenantId, status])
  @@index([tenantId, lifeState])
  @@index([tenantId, placementState])
  @@index([tenantId, keeperIntent])
  @@index([tenantId, financialState])
  @@index([tenantId, paperworkState])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([placedAt])
  @@index([tenantId, damId])
  @@index([tenantId, sireId])
  @@schema("public")
}

model OffspringEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  // NOTE, CHANGE, HEALTH, PROMOTION
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId, type, occurredAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Neonatal Care - Daily care tracking for litter species
 * ────────────────────────────────────────────────────────────────────────────
 */

model NeonatalCareEntry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  recordedAt   DateTime
  recordedBy   String?
  recordedById String?
  recordedUser User?    @relation(fields: [recordedById], references: [id], onDelete: SetNull)

  // Weight tracking
  weightOz            Decimal? @db.Decimal(6, 2)
  weightChangePercent Decimal? @db.Decimal(5, 2)

  // Temperature (critical for fading syndrome)
  temperatureF Decimal? @db.Decimal(4, 1)

  // Feeding
  feedingMethod   NeonatalFeedingMethod?
  feedingVolumeMl Decimal?               @db.Decimal(5, 1)
  feedingNotes    String?

  // Elimination
  urinated     Boolean?
  stoolQuality StoolQuality?

  // Activity
  activityLevel ActivityLevel?

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, offspringId, recordedAt])
  @@index([offspringId, recordedAt])
  @@schema("public")
}

model NeonatalIntervention {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  occurredAt DateTime

  type  NeonatalInterventionType
  route InterventionRoute?
  dose  String?

  administeredBy AdministeredBy?
  vetClinic      String?

  reason   String? @db.Text
  response InterventionResponse?

  followUpNeeded Boolean   @default(false)
  followUpDate   DateTime?

  cost  Decimal? @db.Decimal(10, 2)
  notes String?  @db.Text

  recordedById String?
  recordedUser User?   @relation(fields: [recordedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, offspringId, occurredAt])
  @@index([offspringId, type])
  @@schema("public")
}

/**
 * Legacy Litter retained
 */
model Litter {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int          @unique
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  identifier     String?
  birthedStartAt DateTime?
  birthedEndAt   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  statusOverride       String?
  statusOverrideReason String?

  marketplaceStatus MarketplaceListingStatus @default(DRAFT)
  coverImageUrl     String?
  themeName         String?

  notes String?
  data  Json?

  Animals    Animal[]
  Waitlist   WaitlistEntry[]
  Attachment Attachment[]
  Events     LitterEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, weanedAt])
  @@index([tenantId, placementStartAt])
  @@index([tenantId, placementCompletedAt])
  @@schema("public")
}

model WaitlistEntry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // Direct program link (for matching buyers to breeding plans)
  programId Int?
  program   MktListingBreedingProgram? @relation(fields: [programId], references: [id], onDelete: SetNull)

  // Step 6E: Party-only storage for client identity
  clientPartyId Int?
  clientParty   Party? @relation("WaitlistParty", fields: [clientPartyId], references: [id], onDelete: SetNull)

  speciesPref Species?
  breedPrefs  Json?
  sirePrefId  Int?
  sirePref    Animal?  @relation("WaitlistSirePref", fields: [sirePrefId], references: [id], onDelete: SetNull)
  damPrefId   Int?
  damPref     Animal?  @relation("WaitlistDamPref", fields: [damPrefId], references: [id], onDelete: SetNull)

  status               WaitlistStatus @default(INQUIRY)
  priority             Int?
  depositInvoiceId     Int?
  depositInvoice       Invoice?       @relation("WaitlistDepositInvoice")
  balanceInvoiceId     String?
  depositPaidAt        DateTime?
  depositRequiredCents Int?
  depositPaidCents     Int?
  balanceDueCents      Int?

  // legacy allocation to Animal
  animalId Int?
  animal   Animal? @relation("WaitlistAllocation", fields: [animalId], references: [id], onDelete: SetNull)

  // canonical allocation to Offspring
  offspringId Int?
  offspring   Offspring? @relation("WaitlistAllocationOffspring", fields: [offspringId], references: [id], onDelete: SetNull)

  groupBuyerLinks OffspringGroupBuyer[] @relation("GroupBuyerWaitlistEntry")
  planBuyerLinks  BreedingPlanBuyer[]

  // Contracts tied to this waitlist entry (e.g., deposit agreements)
  contracts Contract[]

  // P4/P5: Link to Buyer CRM for unified buyer management
  buyerId Int?
  buyer   Buyer? @relation("WaitlistEntryCRM", fields: [buyerId], references: [id], onDelete: SetNull)

  skipCount  Int?
  lastSkipAt DateTime?

  // Approval/rejection tracking
  approvedAt     DateTime?
  rejectedAt     DateTime?
  rejectedReason String?

  notes String?

  // Origin tracking for conversion attribution
  originSource      String? // "direct" | "utm" | "referrer" | "embed" | "social"
  originReferrer    String? // Full referrer URL or source name
  originUtmSource   String? // utm_source parameter
  originUtmMedium   String? // utm_medium parameter
  originUtmCampaign String? // utm_campaign parameter
  originPagePath    String? // Page path where conversion occurred
  originProgramSlug String? // Breeding program slug if applicable

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  TagAssignment TagAssignment[]

  @@index([tenantId])
  @@index([planId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([programId])
  @@index([clientPartyId])
  @@index([tenantId, clientPartyId])
  @@index([tenantId, speciesPref])
  @@index([sirePrefId])
  @@index([damPrefId])
  @@index([animalId])
  @@index([tenantId, depositPaidAt])
  @@index([buyerId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model OffspringGroupEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringGroupId Int
  offspringGroup   OffspringGroup @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)

  // CHANGE, NOTE, STATUS_OVERRIDE, BUYER_MOVE, LINK, UNLINK
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringGroupId, type, occurredAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Litter audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model LitterEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  litterId Int
  litter   Litter @relation(fields: [litterId], references: [id], onDelete: Cascade)

  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([litterId, type, occurredAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Attachments, Parties, Counters
 * ────────────────────────────────────────────────────────────────────────────
 */

model Attachment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // Step 6A: Party-only attachment ownership. Legacy contactId removed, use attachmentParty instead.
  attachmentPartyId Int?
  attachmentParty   Party? @relation("AttachmentParty", fields: [attachmentPartyId], references: [id], onDelete: SetNull)

  // Finance MVP: receipts and documents for invoices, payments, expenses
  invoiceId Int?
  invoice   Invoice? @relation("AttachmentInvoice", fields: [invoiceId], references: [id], onDelete: SetNull)
  paymentId Int?
  payment   Payment? @relation("AttachmentPayment", fields: [paymentId], references: [id], onDelete: SetNull)
  expenseId Int?
  expense   Expense? @relation("AttachmentExpense", fields: [expenseId], references: [id], onDelete: SetNull)

  kind            String
  storageProvider String
  storageKey      String
  filename        String
  mime            String
  bytes           Int

  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt         DateTime            @default(now())
  OffspringDocument OffspringDocument[]
  OffspringContract OffspringContract[]

  @@index([tenantId])
  @@index([planId])
  @@index([animalId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([attachmentPartyId])
  @@index([invoiceId])
  @@index([paymentId])
  @@index([expenseId])
  @@schema("public")
}

model PlanParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  role String

  // Step 6F: Party-only storage for role-based parties
  partyId Int?
  party   Party? @relation("PlanPartyRole", fields: [partyId], references: [id], onDelete: SetNull)

  notes String?

  @@index([tenantId])
  @@index([planId])
  @@index([partyId])
  @@index([tenantId, partyId, role])
  @@schema("public")
}

model PlanCodeCounter {
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  year Int
  seq  Int @default(0)

  @@id([tenantId, year])
  @@index([tenantId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Generic, namespaced tenant settings
 * ────────────────────────────────────────────────────────────────────────────
 */

model TenantSetting {
  tenantId  Int
  namespace String
  version   Int     @default(1)
  data      Json
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, namespace])
  @@index([tenantId])
  @@index([namespace])
  @@schema("public")
}

/**
 * Additive models: finance, marketing, tasks, health, documents, contracts
 */

enum FinanceScope {
  group
  offspring
  contact
  organization
  general
  waitlist

  @@schema("public")
}

enum InvoiceStatus {
  draft
  issued
  partially_paid
  paid
  void
  uncollectible
  refunded
  cancelled

  @@schema("public")
}

enum InvoiceCategory {
  DEPOSIT
  SERVICE
  GOODS
  MIXED
  OTHER

  @@schema("public")
}

enum LineItemKind {
  DEPOSIT
  SERVICE_FEE
  GOODS
  DISCOUNT
  TAX
  OTHER

  @@schema("public")
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
  disputed
  cancelled

  @@schema("public")
}

enum ExpenseCategory {
  VETERINARY
  FEED
  SUPPLIES
  BREEDING_FEE
  BOARDING
  TRAINING
  TRANSPORT
  MARKETING
  ADMINISTRATIVE
  FACILITIES
  INSURANCE
  OTHER

  @@schema("public")
}

enum CampaignChannel {
  email
  social
  ads
  marketplace
  website
  other

  @@schema("public")
}

enum TaskScope {
  group
  offspring

  @@schema("public")
}

enum TaskStatus {
  open
  in_progress
  done
  cancelled

  @@schema("public")
}

enum HealthType {
  weight
  vaccine
  deworm
  vet_visit
  treatment
  other

  @@schema("public")
}

enum DocumentScope {
  group
  offspring
  invoice
  contract
  animal

  @@schema("public")
}

enum DocumentKind {
  generic
  health_certificate
  registration
  contract_pdf
  invoice_pdf
  photo
  other
  bill_of_sale
  syndication_agreement
  lease_agreement
  insurance_policy
  vet_certificate

  @@schema("public")
}

enum SignatureProvider {
  internal
  docusign
  hellosign
  adobe
  other

  @@schema("public")
}

enum ContractStatus {
  draft
  sent
  viewed
  signed
  declined
  voided
  expired

  @@schema("public")
}

enum SignatureStatus {
  pending
  viewed
  signed
  declined
  voided
  expired

  @@schema("public")
}

enum ContractTemplateType {
  SYSTEM // Pre-built, read-only for tenants (tenantId = null)
  CUSTOM // User-created templates

  @@schema("public")
}

enum ContractTemplateCategory {
  SALES_AGREEMENT
  DEPOSIT_AGREEMENT
  CO_OWNERSHIP
  GUARDIAN_HOME
  STUD_SERVICE
  HEALTH_GUARANTEE
  CUSTOM

  @@schema("public")
}

// ---------- Finance ----------

/**
 * Sequence counter for server-side numbering (invoice numbers, etc.)
 * Tenant-scoped, per-year counter for generating unique sequential numbers
 */
model Sequence {
  id         Int      @id @default(autoincrement())
  tenantId   Int
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key        String // e.g., "invoice"
  year       Int
  nextNumber Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([tenantId, key, year])
  @@index([tenantId, key, year])
  @@schema("public")
}

/**
 * IdempotencyKey for preventing duplicate operations
 * Stores request hash and response for exact-match replay
 */
model IdempotencyKey {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key          String // Client-provided idempotency key
  requestHash  String // Hash of request body
  responseBody String? // Stored response payload
  createdAt    DateTime @default(now())

  @@unique([tenantId, key])
  @@index([tenantId, createdAt])
  @@schema("public")
}

model Invoice {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope   FinanceScope
  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // Party migration step 6J: unified party reference for invoice client/buyer
  clientPartyId Int?
  clientParty   Party? @relation("InvoiceParty", fields: [clientPartyId], references: [id], onDelete: SetNull)

  // Finance MVP anchor fields
  animalId       Int?
  animal         Animal?       @relation(fields: [animalId], references: [id], onDelete: SetNull)
  breedingPlanId Int?
  breedingPlan   BreedingPlan? @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)

  // Waitlist deposit invoice anchor
  waitlistEntryId Int?           @unique
  waitlistEntry   WaitlistEntry? @relation("WaitlistDepositInvoice", fields: [waitlistEntryId], references: [id], onDelete: SetNull)

  invoiceNumber String // Server-generated, format: INV-YYYY-NNNN
  number        String? // Legacy field, keep for compatibility
  currency      String          @default("USD")
  amountCents   BigInt
  balanceCents  BigInt
  depositCents  BigInt?
  status        InvoiceStatus   @default(draft)
  category      InvoiceCategory @default(OTHER)
  dueAt         DateTime?
  issuedAt      DateTime?
  paidAt        DateTime?
  voidedAt      DateTime?
  paymentTerms  String?

  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?

  notes String?
  data  Json?

  // Marketplace integration
  isMarketplaceInvoice     Boolean @default(false)
  marketplaceTransactionId Int?
  paymentModeSnapshot      String?
  stripeInvoiceId          String?
  stripePaymentIntentId    String?

  // Manual payment tracking
  buyerMarkedPaidAt     DateTime?
  buyerPaymentMethod    String?
  buyerPaymentReference String?
  providerConfirmedAt   DateTime?
  providerConfirmedBy   Int?

  // Partial refunds
  refundedCents BigInt @default(0)

  // Soft delete
  deletedAt DateTime?

  LineItems     InvoiceLineItem[]
  Payments      Payment[]
  Documents     Document[]
  Contract      Contract?
  Attachments   Attachment[]      @relation("AttachmentInvoice")
  EmailSendLogs EmailSendLog[]

  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  OffspringInvoiceLink OffspringInvoiceLink[]
  PaymentIntent        PaymentIntent[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([tenantId, clientPartyId, status])
  @@index([tenantId, offspringId])
  @@index([tenantId, groupId])
  @@index([tenantId, animalId])
  @@index([tenantId, breedingPlanId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status])
  @@index([clientPartyId])
  @@index([tenantId, status, createdAt(sort: Desc)])
  @@index([clientPartyId, status])
  @@index([deletedAt])
  @@index([tenantId, isMarketplaceInvoice, status])
  @@index([stripeInvoiceId])
  @@schema("public")
}

model InvoiceLineItem {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  kind          LineItemKind @default(OTHER)
  description   String
  qty           Int          @default(1)
  unitCents     Int
  discountCents Int?
  taxRate       Float?
  category      String?
  itemCode      String?
  totalCents    Int

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([invoiceId])
  @@schema("public")
}

model Payment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  status       PaymentStatus @default(pending)
  amountCents  BigInt
  receivedAt   DateTime // When payment was received
  methodType   String? // e.g., "card", "bank_transfer", "cash", "check"
  processor    String? // e.g., "stripe", "square", "manual"
  processorRef String? // Reference from payment processor
  method       String? // Legacy field
  reference    String? // Legacy field
  paidAt       DateTime? // Legacy field

  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?

  notes String?
  data  Json?

  Attachments Attachment[] @relation("AttachmentPayment")

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, invoiceId])
  @@index([tenantId, receivedAt])
  @@index([invoiceId])
  @@index([status])
  @@index([invoiceId, status])
  @@schema("public")
}

/**
 * Expense tracking for business operations
 * Can be anchored to breeding plans, offspring groups, animals, or general operations
 */
model Expense {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  amountCents Int
  currency    String          @default("USD")
  incurredAt  DateTime
  category    ExpenseCategory
  description String?

  // Optional vendor/supplier
  vendorPartyId Int?
  vendorParty   Party? @relation("ExpenseVendor", fields: [vendorPartyId], references: [id], onDelete: SetNull)

  // Anchor fields - expense can be linked to one of these
  breedingPlanId   Int?
  breedingPlan     BreedingPlan?   @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)
  animalId         Int?
  animal           Animal?         @relation(fields: [animalId], references: [id], onDelete: SetNull)

  // Optional link to food product (for FOOD category expenses)
  foodProductId Int?
  foodProduct   FoodProduct? @relation(fields: [foodProductId], references: [id], onDelete: SetNull)
  quantityValue Float?  // Quantity purchased (for FOOD category)
  quantityUnit  String? // Unit: OZ, LB, G, KG (for FOOD category)

  notes String?
  data  Json?

  Attachments Attachment[] @relation("AttachmentExpense")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, incurredAt])
  @@index([tenantId, breedingPlanId])
  @@index([tenantId, offspringGroupId])
  @@index([tenantId, animalId])
  @@index([tenantId, vendorPartyId])
  @@index([tenantId, category])
  @@index([tenantId, foodProductId])
  @@schema("public")
}

model AnimalOwnershipChange {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  kind          OwnershipChangeKind
  effectiveDate DateTime?
  occurredAt    DateTime            @default(now())

  valueCents Int?
  currency   String? @db.VarChar(3)

  // Immutable snapshots of ownership at time of change
  fromOwners Json
  toOwners   Json

  // Party migration step 5: party-based ownership snapshots
  fromOwnerParties Json?
  toOwnerParties   Json?

  notes     String?
  documents Document[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  PaymentIntent PaymentIntent[]

  @@index([tenantId])
  @@index([animalId])
  @@index([kind])
  @@index([occurredAt])
  @@schema("public")
}

model PaymentIntent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional links depending on what the payment represents
  invoiceId         Int?
  invoice           Invoice?               @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  animalId          Int?
  animal            Animal?                @relation(fields: [animalId], references: [id], onDelete: SetNull)
  ownershipChangeId Int?
  ownershipChange   AnimalOwnershipChange? @relation(fields: [ownershipChangeId], references: [id], onDelete: SetNull)

  purpose PaymentIntentPurpose
  status  PaymentIntentStatus  @default(PLANNED)

  amountCents Int
  currency    String @db.VarChar(3)

  externalProvider String?
  externalId       String?
  reference        String?

  data Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([invoiceId])
  @@index([animalId])
  @@index([ownershipChangeId])
  @@index([status])
  @@index([purpose])
  @@schema("public")
}

// ---------- Marketing ----------
model Campaign {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringGroupId Int?
  group            OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  name      String
  channel   CampaignChannel
  startedAt DateTime?
  endedAt   DateTime?

  budgetCents Int?
  spendCents  Int?

  impressions  Int?
  clicks       Int?
  inquiries    Int?
  reservations Int?
  conversions  Int?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  notes String?
  data  Json?

  Attributions CampaignAttribution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringGroupId])
  @@index([channel])
  @@schema("public")
}

model CampaignAttribution {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  campaignId Int
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  weight Float?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([campaignId])
  @@index([offspringId])
  @@schema("public")
}

enum EmailSendStatus {
  queued
  sent
  failed

  @@schema("public")
}

enum TemplateChannel {
  email
  dm
  social

  @@schema("public")
}

enum TemplateStatus {
  draft
  active
  archived

  @@schema("public")
}

enum TemplateCategory {
  auto_reply
  invoice_message
  birth_announcement
  waitlist_update
  general_follow_up
  custom

  @@schema("public")
}

enum EmailSendCategory {
  transactional
  marketing

  @@schema("public")
}

enum AutoReplyTriggerType {
  // Legacy triggers
  dm_first_message_from_party
  dm_after_hours

  // New comprehensive triggers
  email_received // Instant acknowledgment for emails
  time_based // Away messages with date range
  keyword_match // FAQ responses based on keywords
  business_hours // Out of office during non-business hours

  @@schema("public")
}

enum AutoReplyRuleStatus {
  active
  paused
  archived

  @@schema("public")
}

enum AutoReplyLogStatus {
  sent
  skipped
  failed

  @@schema("public")
}

model Template {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  key         String? // stable identifier for system templates
  channel     TemplateChannel
  category    TemplateCategory
  status      TemplateStatus   @default(draft)
  description String?          @db.Text

  createdByPartyId Int?
  createdByParty   Party? @relation("TemplateCreatedBy", fields: [createdByPartyId], references: [id], onDelete: SetNull)

  content        TemplateContent[]
  autoReplyRules AutoReplyRule[]
  drafts         Draft[]           @relation("DraftTemplate")

  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([tenantId, key])
  @@index([tenantId, channel])
  @@index([tenantId, status])
  @@index([tenantId, category])
  @@schema("public")
}

model TemplateContent {
  id         Int      @id @default(autoincrement())
  templateId Int
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  subject      String? // email only
  bodyText     String  @db.Text
  bodyHtml     String? @db.Text // email only
  metadataJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@schema("public")
}

model AutoReplyRule {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String?             @db.Text
  channel     TemplateChannel
  status      AutoReplyRuleStatus @default(active)

  // Legacy field (kept for backwards compatibility)
  enabled Boolean @default(true)

  templateId Int
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  triggerType AutoReplyTriggerType

  // Trigger configuration (stored as JSON)
  keywordConfigJson   Json? // KeywordMatchConfig for keyword_match trigger
  timeBasedConfigJson Json? // TimeBasedConfig for time_based trigger
  businessHoursJson   Json? // BusinessHoursConfig for business_hours trigger
  cooldownMinutes     Int   @default(60) // Legacy field

  // Execution tracking
  executionCount Int       @default(0)
  lastExecutedAt DateTime?

  // Audit fields
  createdByPartyId Int?
  createdByParty   Party? @relation("AutoReplyRuleCreatedBy", fields: [createdByPartyId], references: [id], onDelete: SetNull)

  logs AutoReplyLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, channel, status])
  @@index([tenantId, triggerType])
  @@index([templateId])
  @@schema("public")
}

model AutoReplyLog {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  channel TemplateChannel
  partyId Int
  party   Party           @relation("AutoReplyLogParty", fields: [partyId], references: [id], onDelete: Cascade)

  threadId Int?
  thread   MessageThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)

  ruleId Int?
  rule   AutoReplyRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  templateId Int?

  status AutoReplyLogStatus
  reason String?            @db.Text

  createdAt DateTime @default(now())

  @@index([tenantId, partyId])
  @@index([tenantId, channel, createdAt])
  @@index([threadId])
  @@index([ruleId])
  @@schema("public")
}

model EmailSendLog {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  to      String
  from    String
  subject String

  templateKey       String?
  templateId        Int?
  category          EmailSendCategory?
  provider          String             @default("resend")
  providerMessageId String?

  relatedInvoiceId Int?
  invoice          Invoice? @relation(fields: [relatedInvoiceId], references: [id], onDelete: SetNull)

  status   EmailSendStatus @default(queued)
  error    Json?
  metadata Json?

  // Communications Hub: archive and flag support
  archived   Boolean   @default(false)
  archivedAt DateTime?
  flagged    Boolean   @default(false)
  flaggedAt  DateTime?

  // Link to party for inbox aggregation
  partyId Int?
  party   Party? @relation("EmailSendLogParty", fields: [partyId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@unique([tenantId, templateKey, relatedInvoiceId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([providerMessageId])
  @@index([createdAt])
  @@index([relatedInvoiceId])
  @@index([templateId])
  @@index([tenantId, category])
  @@index([tenantId, archived])
  @@index([tenantId, flagged])
  @@index([tenantId, partyId])
  @@schema("public")
}

model MessageThread {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  subject  String?
  archived Boolean @default(false)

  // Communications Hub: flagging for starred/important threads
  flagged   Boolean   @default(false)
  flaggedAt DateTime?

  // Marketplace MVP: inquiry context fields
  inquiryType       String? // "MARKETPLACE" | "WAITLIST" | "GENERAL" | "ANIMAL_LISTING" | null
  sourceListingSlug String?
  guestEmail        String?
  guestName         String?

  // Origin tracking for conversion attribution
  originSource      String? // "direct" | "utm" | "referrer" | "embed" | "social"
  originReferrer    String? // Full referrer URL or source name
  originUtmSource   String? // utm_source parameter
  originUtmMedium   String? // utm_medium parameter
  originUtmCampaign String? // utm_campaign parameter
  originPagePath    String? // Page path where conversion occurred

  // Spam/security tracking
  spamScore          Int?     @default(0) // Calculated spam score (0-10)
  spamFlags          String[] @default([]) // Array of spam indicators detected
  isQuarantined      Boolean  @default(false) // Auto-quarantined for manual review
  authenticationPass Boolean? // SPF/DKIM/DMARC validation result

  participants   MessageParticipant[]
  messages       Message[]
  autoReplyLogs  AutoReplyLog[]
  tagAssignments TagAssignment[]

  lastMessageAt DateTime?

  // Response time tracking for "Quick Responder" badge
  // Time when first inbound message was received (from non-org party)
  firstInboundAt            DateTime?
  // Time when org/breeder first replied to inbound message
  firstOrgReplyAt           DateTime?
  // Calculated response time in seconds (null until org replies) - raw wall-clock time
  responseTimeSeconds       Int?
  // Calculated response time in seconds counting only business hours
  // This is the value used for Quick Responder badge calculation
  businessHoursResponseTime Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, updatedAt])
  @@index([inquiryType])
  @@index([tenantId, responseTimeSeconds])
  @@index([tenantId, businessHoursResponseTime])
  @@index([tenantId, flagged])
  @@index([tenantId, archived])
  @@schema("public")
}

model MessageParticipant {
  id       Int           @id @default(autoincrement())
  threadId Int
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  // Cascade delete is intentional: when party is deleted, remove their participant record
  // Thread will remain if it still has messages (Message.senderParty uses SetNull)
  partyId Int
  party   Party @relation("MessageParticipantParty", fields: [partyId], references: [id], onDelete: Cascade)

  lastReadAt DateTime?

  createdAt DateTime @default(now())

  @@unique([threadId, partyId])
  @@index([threadId])
  @@index([partyId])
  @@schema("public")
}

model Message {
  id       Int           @id @default(autoincrement())
  threadId Int
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  // Changed to nullable with SetNull to prevent orphaned threads when party deleted
  // When a party is deleted, their messages remain but senderPartyId becomes null
  // UI should display "Deleted User" for null senderPartyId
  senderPartyId Int?
  senderParty   Party? @relation("MessageSenderParty", fields: [senderPartyId], references: [id], onDelete: SetNull)

  body String @db.Text

  // Attachment fields (optional - null means text-only message)
  attachmentFilename String? // Original filename (e.g., "contract.pdf")
  attachmentMime     String? // MIME type (e.g., "application/pdf")
  attachmentBytes    Int? // File size in bytes
  attachmentKey      String? // Storage key/path (e.g., "messages/4/12345-contract.pdf")

  isAutomated      Boolean @default(false)
  automationRuleId Int?

  createdAt DateTime @default(now())

  @@index([threadId, createdAt])
  @@index([senderPartyId])
  @@schema("public")
}

// ---------- Communications Hub: Drafts ----------
enum DraftChannel {
  email
  dm

  @@schema("public")
}

model Draft {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  partyId Int?
  party   Party? @relation("DraftParty", fields: [partyId], references: [id], onDelete: SetNull)

  channel DraftChannel

  // Email-specific fields
  subject     String?
  toAddresses String[] // For emails when partyId not set

  // Content
  bodyText String  @db.Text
  bodyHtml String? @db.Text

  // Template reference
  templateId Int?
  template   Template? @relation("DraftTemplate", fields: [templateId], references: [id], onDelete: SetNull)

  // Metadata
  metadata Json?

  // Created by
  createdByUserId String?
  createdByUser   User?   @relation("DraftCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  tagAssignments TagAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, partyId])
  @@index([tenantId, channel])
  @@index([tenantId, updatedAt])
  @@schema("public")
}

// ---------- Tasks ----------
model Task {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope TaskScope

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  title  String
  notes  String?
  dueAt  DateTime?
  status TaskStatus @default(open)

  assignedToUserId String?
  assignedToUser   User?   @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status, dueAt])
  @@schema("public")
}

// ---------- Health ----------
model HealthEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  kind       HealthType
  occurredAt DateTime

  weightGrams Int?
  vaccineCode String?
  dose        String?
  vetClinic   String?
  result      String?
  notes       String?
  data        Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId, occurredAt])
  @@index([kind])
  @@schema("public")
}

// ---------- Documents & Contracts ----------
model Document {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope DocumentScope
  kind  DocumentKind  @default(generic)

  // Optional links for Animal and ownership transactions (horses)
  animalId          Int?
  animal            Animal?                @relation(fields: [animalId], references: [id], onDelete: SetNull)
  ownershipChangeId Int?
  ownershipChange   AnimalOwnershipChange? @relation(fields: [ownershipChangeId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  invoiceId Int?     @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  contractId Int?
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  title       String
  storageKey  String?
  externalUrl String?
  mimeType    String?
  bytes       Int?
  sha256      String?

  data             Json?
  // Prototype fields for trait document linking
  visibility       DocVisibility? @default(PRIVATE)
  status           DocStatus?     @default(PLACEHOLDER)
  sizeBytes        Int?
  originalFileName String?
  storageProvider  String?
  bucket           String?
  objectKey        String?
  url              String?

  // Watermarking
  watermarkEnabled Boolean @default(false)

  // Relation to trait values
  traitValueLinks AnimalTraitValueDocument[]

  // Title & Competition document links
  titleLinks       AnimalTitleDocument[]
  competitionLinks CompetitionEntryDocument[]

  // Vaccination record links
  vaccinationRecords VaccinationRecord[]

  // Trait history entry links
  traitEntries AnimalTraitEntry[]

  // Document bundle links
  bundleItems DocumentBundleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope, offspringId])
  @@index([scope, groupId])
  @@index([scope, invoiceId])
  @@index([scope, contractId])
  @@index([kind])
  @@schema("public")
}

// ────────────────────────────────────────────────────────────────────────────
// Document Bundles - Named collections of documents for email attachments
// ────────────────────────────────────────────────────────────────────────────

enum BundleStatus {
  active
  archived

  @@schema("public")
}

model DocumentBundle {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String // e.g., "Go Home Document Bundle"
  description String?      @db.Text
  status      BundleStatus @default(active)

  // Relations
  items DocumentBundleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, status])
  @@schema("public")
}

model DocumentBundleItem {
  id         Int            @id @default(autoincrement())
  bundleId   Int
  bundle     DocumentBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  documentId Int
  document   Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  sortOrder Int      @default(0)
  addedAt   DateTime @default(now())

  @@unique([bundleId, documentId]) // Prevent duplicate documents in same bundle
  @@index([bundleId])
  @@index([documentId])
  @@schema("public")
}

// ────────────────────────────────────────────────────────────────────────────
// Document Watermarking & Access Tracking
// ────────────────────────────────────────────────────────────────────────────

/// Track all document/media access events for audit trail
model MediaAccessEvent {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  documentId Int? // Optional link to Document (may track raw storage keys too)
  storageKey String // S3 key of accessed file

  actorType         MediaAccessActor
  userId            String?          @db.VarChar(36) // Internal user (UUID)
  marketplaceUserId Int? // Marketplace buyer/visitor
  partyId           Int? // Portal party

  accessType MediaAccessType

  ip        String? @db.VarChar(45) // IPv4 or IPv6
  userAgent String? @db.Text

  watermarked   Boolean @default(false)
  watermarkHash String? @db.VarChar(32) // MD5 hash of watermark settings used

  @@index([tenantId, createdAt])
  @@index([documentId])
  @@index([storageKey])
  @@schema("public")
}

/// Cache watermarked asset references to avoid re-processing
model WatermarkedAsset {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  originalKey    String // Original S3 key
  watermarkedKey String // Watermarked version S3 key
  settingsHash   String @db.VarChar(32) // MD5 hash of watermark settings

  mimeType  String
  sizeBytes Int

  createdAt DateTime @default(now())
  expiresAt DateTime // Cache expiration (7 days default)

  @@unique([tenantId, originalKey, settingsHash])
  @@index([expiresAt])
  @@schema("public")
}

model ContractTemplate {
  id       Int     @id @default(autoincrement())
  tenantId Int? // NULL for system templates
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Template identification
  name        String
  slug        String?                  @unique // Stable identifier for system templates (e.g., "sales-agreement-v1")
  type        ContractTemplateType     @default(CUSTOM)
  category    ContractTemplateCategory @default(CUSTOM)
  description String?                  @db.Text

  // Content storage
  bodyHtml String? @db.Text // Rendered HTML with merge fields ({{field.key}})
  bodyJson Json? // Structured content from rich editor (for editing state)

  // Legacy fields (for migration compatibility)
  body       String? // Deprecated: use bodyHtml
  storageKey String? // Optional: store as file instead of DB

  // Metadata
  version  Int     @default(1)
  isActive Boolean @default(true)

  // Merge field definitions used in this template
  mergeFields         Json? // Array of { key, label, namespace, required }
  conditionalSections Json? // Array of { id, condition, htmlContent }

  // Audit
  createdByUserId String?
  createdBy       User?   @relation("ContractTemplateCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  data Json? // Extensible metadata

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  Contract  Contract[]

  @@index([tenantId])
  @@index([type])
  @@index([category])
  @@index([isActive])
  @@schema("public")
}

model Contract {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  templateId Int?
  template   ContractTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Related entities - what this contract is for
  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  animalId Int? // For sales of existing animals (not offspring)
  animal   Animal? @relation("ContractAnimal", fields: [animalId], references: [id], onDelete: SetNull)

  waitlistEntryId Int? // For deposit agreements tied to waitlist
  waitlistEntry   WaitlistEntry? @relation(fields: [waitlistEntryId], references: [id], onDelete: SetNull)

  invoiceId Int?     @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  title  String
  status ContractStatus @default(draft)

  provider           SignatureProvider @default(internal)
  providerEnvelopeId String?
  providerDocId      String?

  issuedAt  DateTime?
  signedAt  DateTime?
  voidedAt  DateTime?
  expiresAt DateTime?

  // Relations
  content   ContractContent? // Immutable rendered content snapshot
  documents Document[]
  parties   ContractParty[]
  events    SignatureEvent[]

  data Json? // Extensible: reminderDays, customTerms, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([groupId])
  @@index([animalId])
  @@index([waitlistEntryId])
  @@index([invoiceId])
  @@index([status])
  @@index([expiresAt]) // For expiration scanning
  @@index([provider, providerEnvelopeId])
  @@schema("public")
}

model ContractParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contractId Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  partyId Int?
  party   Party? @relation("ContractPartyRole", fields: [partyId], references: [id], onDelete: SetNull)

  role   String?
  email  String?
  name   String?
  signer Boolean @default(true)
  order  Int?

  status   SignatureStatus @default(pending)
  signedAt DateTime?

  providerRecipientId String?

  data          Json?
  signatureData Json?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  SignatureEvent SignatureEvent[]

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([tenantId, partyId])
  @@index([status])
  @@schema("public")
}

model SignatureEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contractId Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  partyId Int?
  party   ContractParty? @relation(fields: [partyId], references: [id], onDelete: SetNull)

  status    SignatureStatus
  at        DateTime        @default(now())
  ipAddress String?
  userAgent String?
  message   String?
  data      Json?

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([status, at])
  @@schema("public")
}

/// Immutable snapshot of rendered contract content at time of creation/sending
/// Ensures contract terms are preserved even if template changes later
model ContractContent {
  id         Int      @id @default(autoincrement())
  contractId Int      @unique
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Snapshot of rendered content at time of creation
  renderedHtml String @db.Text // Final HTML with all merge fields substituted

  // Storage key for generated PDF (after signing)
  renderedPdfKey String? // S3/storage key for the signed PDF

  // Snapshot of merge field values used for rendering
  mergeData Json // The actual values substituted: { "buyer.name": "John", ... }

  // Version tracking - which template version was used
  templateVersion Int

  createdAt DateTime @default(now())

  @@schema("public")
}

enum InvoiceRole {
  RESERVATION
  DEPOSIT
  FINAL
  MISC

  @@schema("public")
}

enum EsignProvider {
  DOCUSIGN
  HELLOSIGN
  ADOBE
  OTHER

  @@schema("public")
}

enum EsignStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  DECLINED
  EXPIRED
  VOIDED

  @@schema("public")
}

model OffspringDocument {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  name       String
  templateId String?
  provider   EsignProvider?
  status     EsignStatus    @default(DRAFT)

  sentAt      DateTime?
  viewedAt    DateTime?
  completedAt DateTime?

  fileId Int?
  file   Attachment? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  metaJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([status])
  @@schema("public")
}

model OffspringContract {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  title    String
  version  String?
  provider EsignProvider?
  status   EsignStatus    @default(DRAFT)

  sentAt   DateTime?
  viewedAt DateTime?
  signedAt DateTime?

  fileId Int?
  file   Attachment? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  // Party migration step 6L: unified party reference for contract buyer (legacy columns removed)
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringContractBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  metaJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([status])
  @@schema("public")
}

model OffspringInvoiceLink {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  invoiceId Int?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  role        InvoiceRole @default(MISC)
  amountCents Int?
  currency    String?

  externalProvider String?
  externalId       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([offspringId, invoiceId, role])
  @@index([tenantId])
  @@index([offspringId])
  @@index([invoiceId])
  @@schema("public")
}

model AccountingIntegration {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider String // for example "quickbooks_online"
  realmId  String // external account or company id

  accessToken          String
  refreshToken         String
  accessTokenExpiresAt DateTime

  isActive       Boolean   @default(true)
  syncDirection  String    @default("outbound") // outbound, inbound, bidirectional
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastSyncError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, provider])
  @@schema("public")
}

/**
 * Portal Access Management
 * Controls client portal access per Party (Contact or Organization)
 */

model PortalAccess {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation("PortalAccessTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int    @unique
  party    Party  @relation("PortalAccessParty", fields: [partyId], references: [id], onDelete: Cascade)

  // UX state only - NOT used for authorization
  status PortalAccessStatus @default(NO_ACCESS)

  // Linked user (set when invite is accepted)
  userId String?
  user   User?   @relation("PortalAccessUser", fields: [userId], references: [id], onDelete: SetNull)

  // Denormalized pointer to TenantMembership (informational only, set after acceptance)
  // Note: Cannot add FK to composite PK, so this is just userId reference for traceability
  membershipUserId String?

  // Timestamps
  invitedAt   DateTime?
  activatedAt DateTime?
  suspendedAt DateTime?
  lastLoginAt DateTime?

  // Audit
  createdByUserId String?
  updatedByUserId String?
  createdBy       User?   @relation("PortalAccessCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedBy       User?   @relation("PortalAccessUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, partyId])
  @@index([tenantId])
  @@index([partyId])
  @@index([userId])
  @@index([status])
  @@schema("public")
}

model PortalInvite {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation("PortalInviteTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int
  party    Party  @relation("PortalInviteParty", fields: [partyId], references: [id], onDelete: Cascade)

  // Normalized email for lookup (lowercase, trimmed)
  emailNorm String @db.Citext

  // User reference (set if user exists at invite time, or after acceptance)
  userId String?
  user   User?   @relation("PortalInviteUser", fields: [userId], references: [id], onDelete: SetNull)

  // Role and status to grant upon acceptance (defaults to CLIENT/ACTIVE)
  roleToGrant   TenantMembershipRole   @default(CLIENT)
  statusToGrant TenantMembershipStatus @default(ACTIVE)

  // Token for activation link
  tokenHash String    @unique
  expiresAt DateTime
  sentAt    DateTime  @default(now())
  usedAt    DateTime?

  // Backfilled after acceptance for traceability
  membershipUserId String?

  // Audit
  sentByUserId String?
  sentBy       User?   @relation("PortalInviteSentBy", fields: [sentByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, partyId])
  @@index([tenantId, emailNorm])
  @@index([expiresAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Audit Event Log
 * Immutable security event log for auth, access control, and abuse monitoring
 * ────────────────────────────────────────────────────────────────────────────
 */

enum AuditOutcome {
  SUCCESS
  FAILURE

  @@schema("public")
}

enum AuditSurface {
  PLATFORM
  PORTAL
  MARKETPLACE

  @@schema("public")
}

enum AuditActorContext {
  STAFF
  CLIENT
  PUBLIC

  @@schema("public")
}

model AuditEvent {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // Request context
  requestId String? @db.VarChar(64)
  ip        String? @db.VarChar(45) // IPv4 or IPv6
  userAgent String? @db.Text

  // Actor context
  userId       String?            @db.VarChar(64)
  surface      AuditSurface
  actorContext AuditActorContext?
  tenantId     Int?

  // Event data
  action     String       @db.VarChar(64)
  outcome    AuditOutcome
  detailJson Json?

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([tenantId, createdAt])
  @@index([action, createdAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Scheduling System
 * Client-facing appointment booking (e.g., pickup, meet & greet, vet visits)
 * ────────────────────────────────────────────────────────────────────────────
 */

enum SchedulingEventStatus {
  DRAFT // Not yet published
  OPEN // Accepting bookings
  CLOSED // No longer accepting bookings
  CANCELLED // Event cancelled

  @@schema("public")
}

enum SchedulingSlotStatus {
  AVAILABLE // Open for booking
  FULL // Capacity reached
  CANCELLED // Slot cancelled

  @@schema("public")
}

enum SchedulingSlotMode {
  IN_PERSON
  VIRTUAL

  @@schema("public")
}

enum SchedulingBookingStatus {
  CONFIRMED
  CANCELLED
  RESCHEDULED
  NO_SHOW

  @@schema("public")
}

enum MarketplaceBlockLevel {
  LIGHT // Block waitlist requests only
  MEDIUM // Block waitlist + messages
  HEAVY // Block waitlist + messages + profile view

  @@schema("public")
}

/**
 * SchedulingEventTemplate - Reusable event configuration
 * Optional for MVP but provides future flexibility for recurring events
 */
model SchedulingEventTemplate {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String // e.g., "Pickup Appointment", "Meet and Greet"
  eventType   String // e.g., "pickup", "meet_greet", "vet_visit"
  description String?               @db.Text
  status      SchedulingEventStatus @default(DRAFT)

  // Booking rules (can be overridden per slot block)
  defaultDurationMinutes    Int     @default(60)
  defaultCapacity           Int     @default(1)
  canCancel                 Boolean @default(true)
  canReschedule             Boolean @default(true)
  cancellationDeadlineHours Int?
  rescheduleDeadlineHours   Int?

  // Optional next steps text shown after booking
  nextStepsText String? @db.Text

  // Subject context (what this event is about)
  // Links to offspring, placement, agreement, or transaction
  subjectType String? // "offspring" | "placement" | "agreement" | "transaction"
  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // Audit
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  availabilityBlocks SchedulingAvailabilityBlock[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, eventType])
  @@index([offspringId])
  @@schema("public")
}

/**
 * SchedulingAvailabilityBlock - A time block containing multiple slots
 * Represents a period during which the breeder is available for appointments
 */
model SchedulingAvailabilityBlock {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional template reference (can create ad-hoc blocks without template)
  templateId Int?
  template   SchedulingEventTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Optional offspring group link for buyer-specific scheduling
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation("GroupSchedulingBlocks", fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // Time range
  startAt  DateTime
  endAt    DateTime
  timezone String   @default("America/New_York") @db.VarChar(64)

  // Status
  status SchedulingEventStatus @default(OPEN)

  // Override rules from template
  canCancel                 Boolean?
  canReschedule             Boolean?
  cancellationDeadlineHours Int?
  rescheduleDeadlineHours   Int?
  nextStepsText             String?  @db.Text

  // Location for in-person slots in this block
  location String? @db.Text

  // Audit
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  slots SchedulingSlot[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startAt])
  @@index([templateId])
  @@index([offspringGroupId])
  @@schema("public")
}

/**
 * SchedulingSlot - Individual bookable time slot
 */
model SchedulingSlot {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Parent block
  blockId Int
  block   SchedulingAvailabilityBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  // Time range (UTC)
  startsAt DateTime
  endsAt   DateTime

  // Capacity
  capacity    Int @default(1)
  bookedCount Int @default(0)

  // Status (computed from bookedCount vs capacity)
  status SchedulingSlotStatus @default(AVAILABLE)

  // Mode and location
  mode     SchedulingSlotMode?
  location String?             @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings SchedulingBooking[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startsAt])
  @@index([blockId])
  @@index([blockId, startsAt])
  @@schema("public")
}

/**
 * SchedulingBooking - A confirmed booking for a slot
 * Links a party (client) to a slot
 */
model SchedulingBooking {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Slot reference
  slotId Int
  slot   SchedulingSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  // Party (the client making the booking)
  partyId Int
  party   Party @relation("SchedulingBookingParty", fields: [partyId], references: [id], onDelete: Cascade)

  // Event context (denormalized for query convenience)
  // eventId is the templateId or blockId (or synthetic ID for ad-hoc)
  eventId String @db.VarChar(64)

  // Status
  status SchedulingBookingStatus @default(CONFIRMED)

  // Timestamps
  bookedAt      DateTime  @default(now())
  cancelledAt   DateTime?
  rescheduledAt DateTime?

  // Notes from client or breeder
  clientNotes  String? @db.Text
  breederNotes String? @db.Text

  // Next steps text (copied from template/block at booking time)
  nextSteps String? @db.Text

  // Rescheduling linkage
  rescheduledFromId Int?
  rescheduledFrom   SchedulingBooking?  @relation("RescheduledBooking", fields: [rescheduledFromId], references: [id], onDelete: SetNull)
  rescheduledTo     SchedulingBooking[] @relation("RescheduledBooking")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Unique constraint: one active booking per event per party
  // (enforced in application layer - can't have @@unique with status filter)

  // Unique constraint: one booking per slot per party
  @@unique([slotId, partyId])
  @@index([tenantId])
  @@index([tenantId, partyId])
  @@index([tenantId, eventId])
  @@index([slotId])
  @@index([partyId])
  @@index([eventId, partyId])
  @@index([status])
  @@schema("public")
}

// ============================================================================
// Marketplace Blocklist System
// ============================================================================

/**
 * MarketplaceUserBlock - Per-tenant block records (breeder → marketplace user)
 * Allows breeders to block marketplace users at different levels
 */
model MarketplaceUserBlock {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // The blocked user (by their User ID from marketplace auth)
  blockedUserId String @db.VarChar(36)
  blockedUser   User   @relation("BlockedMarketplaceUser", fields: [blockedUserId], references: [id], onDelete: Cascade)

  level  MarketplaceBlockLevel
  reason String?               @db.Text // Optional reason for breeder's reference

  // Who blocked them (optional - for audit)
  blockedByPartyId Int?
  blockedByParty   Party? @relation("MarketplaceBlockCreator", fields: [blockedByPartyId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  // Block can be lifted (soft delete pattern)
  liftedAt        DateTime?
  liftedByPartyId Int?
  liftedByParty   Party?    @relation("MarketplaceBlockLifter", fields: [liftedByPartyId], references: [id], onDelete: SetNull)

  @@unique([tenantId, blockedUserId])
  @@index([blockedUserId])
  @@index([tenantId])
  @@index([tenantId, liftedAt]) // For finding active blocks
  @@schema("public")
}

/**
 * MarketplaceUserFlag - Platform-level aggregation for admin visibility
 * Tracks how many times a marketplace user has been blocked across all breeders
 */
model MarketplaceUserFlag {
  id     Int    @id @default(autoincrement())
  userId String @unique @db.VarChar(36)
  user   User   @relation("MarketplaceUserFlagUser", fields: [userId], references: [id], onDelete: Cascade)

  // Aggregated stats
  totalBlocks  Int @default(0) // Number of times blocked (any level, all-time)
  activeBlocks Int @default(0) // Current non-lifted blocks
  lightBlocks  Int @default(0)
  mediumBlocks Int @default(0)
  heavyBlocks  Int @default(0)

  // Waitlist history (platform-wide)
  totalApprovals  Int @default(0)
  totalRejections Int @default(0)

  // Admin action flags
  flaggedAt       DateTime? // When auto-flagged for review
  flagReason      String?   @db.Text
  suspendedAt     DateTime? // If account disabled by admin
  suspendedReason String?   @db.Text

  updatedAt DateTime @updatedAt

  @@index([flaggedAt])
  @@index([suspendedAt])
  @@index([activeBlocks])
  @@schema("public")
}

/**
 * PlatformSetting - Configurable platform-wide settings
 * Used for admin-configurable thresholds like blocklist thresholds
 */
model PlatformSetting {
  id        Int      @id @default(autoincrement())
  namespace String   @unique @db.VarChar(64) // e.g., "marketplace-abuse"
  data      Json
  updatedAt DateTime @updatedAt

  @@schema("public")
}

// ============================================================================
// Breeder Report System (Marketplace users → Breeders)
// ============================================================================

enum BreederReportReason {
  SPAM
  FRAUD
  HARASSMENT
  MISREPRESENTATION
  OTHER

  @@schema("public")
}

enum BreederReportSeverity {
  LIGHT
  MEDIUM
  HEAVY

  @@schema("public")
}

enum BreederReportStatus {
  PENDING
  REVIEWED
  DISMISSED
  ACTIONED

  @@schema("public")
}

// ============================================================================
// Marketplace Verification Enums
// ============================================================================

/**
 * BreederVerificationTier - Verification levels for breeders on the marketplace
 * Tier 0: SUBSCRIBER - Has active subscription (baseline)
 * Tier 1: MARKETPLACE_ENABLED - Phone verified
 * Tier 2: IDENTITY_VERIFIED - Stripe Identity verified
 * Tier 3: VERIFIED - Paid package (BreederHQ Verified)
 * Tier 4: ACCREDITED - Paid package (BreederHQ Accredited)
 */
enum BreederVerificationTier {
  SUBSCRIBER
  MARKETPLACE_ENABLED
  IDENTITY_VERIFIED
  VERIFIED
  ACCREDITED

  @@schema("marketplace")
}

/**
 * ServiceProviderVerificationTier - Verification levels for service providers
 * Tier 0: LISTED - Email verified + 2FA enabled
 * Tier 1: IDENTITY_VERIFIED - Stripe Identity or Stripe Connect verified
 * Tier 2: VERIFIED_PROFESSIONAL - Paid package (credentials verified)
 * Tier 3: ACCREDITED_PROVIDER - Paid package (license + insurance verified)
 */
enum ServiceProviderVerificationTier {
  LISTED
  IDENTITY_VERIFIED
  VERIFIED_PROFESSIONAL
  ACCREDITED_PROVIDER

  @@schema("marketplace")
}

/**
 * VerificationRequestStatus - Status of verification package requests
 */
enum VerificationRequestStatus {
  PENDING // Awaiting staff review
  IN_REVIEW // Staff actively reviewing
  NEEDS_INFO // Waiting for user to provide more info
  APPROVED // Verified, badge activated
  DENIED // Rejected

  @@schema("marketplace")
}

/**
 * TwoFactorMethod - Available 2FA methods for marketplace users
 */
enum TwoFactorMethod {
  PASSKEY // WebAuthn/Passkey (recommended)
  TOTP // Authenticator app
  SMS // SMS OTP (fallback)

  @@schema("marketplace")
}

/**
 * ServiceSourceType - Discriminator for unified service listings
 * PROVIDER: Service listing from marketplace provider
 * BREEDER: Service listing from breeder/tenant
 */
enum ServiceSourceType {
  PROVIDER
  BREEDER

  @@schema("marketplace")
}

/**
 * BreederReport - Individual reports from marketplace users against breeders
 * Reports require admin review before any action is taken
 */
model BreederReport {
  id Int @id @default(autoincrement())

  // The breeder being reported (by tenant)
  breederTenantId Int
  breederTenant   Tenant @relation("BreederReports", fields: [breederTenantId], references: [id], onDelete: Cascade)

  // Reporter info (masked for privacy in admin view)
  reporterUserId String @db.VarChar(36)
  reporterUser   User   @relation("BreederReportReporter", fields: [reporterUserId], references: [id], onDelete: Cascade)

  // Report details
  reason      BreederReportReason
  severity    BreederReportSeverity
  description String?               @db.Text

  // Status tracking
  status     BreederReportStatus @default(PENDING)
  adminNotes String?             @db.Text

  // Review tracking
  reviewedByUserId String?
  reviewedBy       User?     @relation("BreederReportReviewedBy", fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  reviewedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([breederTenantId])
  @@index([reporterUserId])
  @@index([status])
  @@index([createdAt])
  @@schema("public")
}

/**
 * BreederReportFlag - Platform-level aggregation for admin visibility
 * Tracks report counts per breeder for flagging and admin review
 */
model BreederReportFlag {
  id Int @id @default(autoincrement())

  breederTenantId Int    @unique
  breederTenant   Tenant @relation("BreederReportFlag", fields: [breederTenantId], references: [id], onDelete: Cascade)

  // Aggregated stats
  totalReports   Int @default(0)
  pendingReports Int @default(0)
  lightReports   Int @default(0)
  mediumReports  Int @default(0)
  heavyReports   Int @default(0)

  // Admin flags
  flaggedAt  DateTime?
  flagReason String?   @db.Text

  // Warning tracking
  warningIssuedAt DateTime?
  warningNote     String?   @db.Text

  // Marketplace suspension (soft - hides listing, not account ban)
  marketplaceSuspendedAt DateTime?
  suspendedReason        String?   @db.Text

  updatedAt DateTime @updatedAt

  @@index([flaggedAt])
  @@index([marketplaceSuspendedAt])
  @@index([pendingReports])
  @@schema("public")
}

/**
 * GeneticsDisclaimerAcceptance - Genetics Lab disclaimer acceptance records
 * Stores acceptance of genetics calculator disclaimers for legal protection.
 */
model GeneticsDisclaimerAcceptance {
  id         Int      @id @default(autoincrement())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  acceptedAt DateTime @default(now())
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.Text

  @@index([userId])
  @@schema("public")
}

// ═══════════════════════════════════════════════════════════════════════════════
// CROSS-TENANT LINEAGE TRACKING
// Global animal identity matching and pedigree sharing across tenants
// ═══════════════════════════════════════════════════════════════════════════════

/**
 * IdentifierType - Types of unique identifiers that can be used to match animals
 */
enum IdentifierType {
  MICROCHIP // ISO 15-digit microchip number
  AKC // American Kennel Club registration
  UKC // United Kennel Club registration
  CKC // Canadian Kennel Club registration
  KC // The Kennel Club (UK)
  FCI // Fédération Cynologique Internationale
  AQHA // American Quarter Horse Association
  JOCKEY_CLUB // The Jockey Club (thoroughbreds)
  USEF // US Equestrian Federation
  ADGA // American Dairy Goat Association
  AGS // American Goat Society
  ARBA // American Rabbit Breeders Association
  TICA // The International Cat Association
  CFA // Cat Fanciers Association
  EMBARK // Embark DNA test ID
  WISDOM_PANEL // Wisdom Panel DNA test ID
  DNA_PROFILE // Generic DNA profile identifier
  TATTOO // Tattoo ID (common in livestock/horses)
  EAR_TAG // Ear tag number (livestock)
  USDA_SCRAPIE // USDA Scrapie ID (sheep/goats)
  OTHER // Other registry or identifier

  @@schema("public")
}

/**
 * GlobalAnimalIdentity - A canonical identity cluster for an animal across all tenants
 * When we're confident animals across tenants are the same individual, they share one of these.
 */
model GlobalAnimalIdentity {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Global Animal ID - human-readable unique identifier (e.g., "DOG-7X4K-9M2P-QR8T")
  gaid String? @unique

  // Denormalized core identity (from highest-confidence source)
  species   Species
  sex       Sex?
  birthDate DateTime?
  name      String? // "Call name" - most commonly used name

  // All identifiers associated with this identity
  identifiers GlobalAnimalIdentifier[]

  // All tenant-local animals linked to this identity
  linkedAnimals AnimalIdentityLink[]

  // Cross-tenant parent relationships (the global pedigree)
  damId  Int?
  dam    GlobalAnimalIdentity? @relation("GlobalDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   GlobalAnimalIdentity? @relation("GlobalSire", fields: [sireId], references: [id], onDelete: SetNull)

  // Reverse: offspring in the global graph
  childrenAsDam  GlobalAnimalIdentity[] @relation("GlobalDam")
  childrenAsSire GlobalAnimalIdentity[] @relation("GlobalSire")

  // Lineage info requests targeting this identity
  infoRequests LineageInfoRequest[]

  @@index([species])
  @@index([damId])
  @@index([sireId])
  @@schema("public")
}

/**
 * GlobalAnimalIdentifier - A unique identifier attached to a global identity
 * Multiple identifiers can point to the same GlobalAnimalIdentity
 */
model GlobalAnimalIdentifier {
  id         Int                  @id @default(autoincrement())
  identityId Int
  identity   GlobalAnimalIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  type     IdentifierType
  value    String // The actual identifier value (normalized/uppercased)
  rawValue String? // Original value as entered (for display)

  // Confidence and provenance
  confidence Float     @default(1.0) // 0.0-1.0, how confident we are this is correct
  verifiedAt DateTime? // If manually verified
  verifiedBy String? // User ID who verified

  // Which tenant contributed this identifier
  sourceTenantId Int?
  sourceTenant   Tenant? @relation(fields: [sourceTenantId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@unique([type, value]) // Each identifier value is globally unique per type
  @@index([identityId])
  @@index([type, value])
  @@schema("public")
}

/**
 * AnimalIdentityLink - Links a tenant's local Animal record to a GlobalAnimalIdentity
 * This is how we know "Animal #123 in Tenant A" is the same as "Animal #456 in Tenant B"
 */
model AnimalIdentityLink {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // The tenant-local animal
  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // The global identity
  identityId Int
  identity   GlobalAnimalIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  // How confident are we in this link?
  confidence      Float     @default(1.0) // 0.0-1.0
  matchedOn       String[] // Which identifiers matched: ["MICROCHIP", "AKC", "NAME_DOB"]
  autoMatched     Boolean   @default(false) // Was this auto-matched or manually confirmed?
  confirmedAt     DateTime?
  confirmedByUser String? // User ID who confirmed

  @@unique([animalId]) // Each local animal links to at most one global identity
  @@index([identityId])
  @@schema("public")
}

/**
 * AnimalPrivacySettings - Per-animal controls over what's shared cross-tenant
 * Owner of the animal (tenant) controls visibility of their animal's data
 */
model AnimalPrivacySettings {
  id        Int      @id @default(autoincrement())
  animalId  Int      @unique
  animal    Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  updatedAt DateTime @updatedAt

  // Opt-in to cross-tenant matching at all
  allowCrossTenantMatching Boolean @default(true)

  // Field-level visibility controls
  showName         Boolean @default(true)
  showPhoto        Boolean @default(true)
  showFullDob      Boolean @default(true) // false = year only
  showRegistryFull Boolean @default(false) // false = last 4 digits only
  showBreeder      Boolean @default(true) // Show tenant/breeder name

  // Gate toggles for granular per-item sharing (enables networkVisible toggles in respective tabs)
  enableHealthSharing   Boolean @default(false) // Gate for per-test visibility in Health tab
  enableGeneticsSharing Boolean @default(false) // Gate for per-result visibility in Genetics tab
  enableDocumentSharing Boolean @default(false) // Gate for per-document visibility in Documents tab
  enableMediaSharing    Boolean @default(false) // Gate for per-item visibility in Media tab

  // Breeding visibility
  showBreedingHistory Boolean @default(false) // Show past matings, litter counts, offspring

  // Achievements visibility - controls what shows in cross-tenant pedigree views
  showTitles             Boolean @default(true) // Show title abbreviations (CH, GCH, etc.)
  showTitleDetails       Boolean @default(false) // Show event name, location, date where earned
  showCompetitions       Boolean @default(false) // Show competition entry count and placements
  showCompetitionDetails Boolean @default(false) // Show individual competition results

  // Contact preferences
  allowInfoRequests  Boolean @default(true) // Can others request more info?
  allowDirectContact Boolean @default(false) // Show contact info directly?

  @@schema("public")
}

/**
 * LineageInfoRequest - Request from one breeder to another for animal information
 * When you see a silhouette in your pedigree, you can request details from the owner
 */
model LineageInfoRequest {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Who is requesting
  requestingTenantId Int
  requestingTenant   Tenant @relation("LineageRequestFrom", fields: [requestingTenantId], references: [id], onDelete: Cascade)
  requestingUserId   String
  requestingUser     User   @relation("LineageRequestFromUser", fields: [requestingUserId], references: [id], onDelete: Cascade)

  // What animal they want info about
  targetIdentityId Int
  targetIdentity   GlobalAnimalIdentity @relation(fields: [targetIdentityId], references: [id], onDelete: Cascade)

  // Who owns that animal (resolved at request time)
  targetTenantId Int
  targetTenant   Tenant @relation("LineageRequestTo", fields: [targetTenantId], references: [id], onDelete: Cascade)

  // Request details
  message String? @db.Text // Optional message from requester
  purpose String? // "pedigree_research", "coi_calculation", "breeding_decision", etc.

  // Response
  status          LineageRequestStatus @default(PENDING)
  respondedAt     DateTime?
  responseMessage String?              @db.Text
  grantedAccess   LineageAccessLevel? // What level of access was granted

  // If granted, when does access expire?
  accessExpiresAt DateTime?

  @@index([requestingTenantId])
  @@index([targetTenantId])
  @@index([targetIdentityId])
  @@index([status])
  @@schema("public")
}

enum LineageRequestStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED

  @@schema("public")
}

enum LineageAccessLevel {
  LINEAGE_ONLY // Just position in pedigree, no details
  BASIC // Name, breed, DOB year
  STANDARD // Name, breed, full DOB, registry (partial)
  FULL // Everything the owner has made shareable

  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Cross-Tenant Animal Linking
 * Enables breeders to link their animals' pedigrees with animals owned by other breeders
 * ────────────────────────────────────────────────────────────────────────────
 */

/**
 * AnimalLinkRequest - Request from one breeder to link their animal's parent to another breeder's animal
 * Workflow: Create Request → Target Breeder Approves/Denies → Active Link Created
 */
model AnimalLinkRequest {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Requesting party (the breeder who wants to link a parent)
  requestingTenantId Int
  requestingTenant   Tenant @relation("LinkRequestFrom", fields: [requestingTenantId], references: [id], onDelete: Cascade)
  requestingUserId   String
  requestingUser     User   @relation("LinkRequestFromUser", fields: [requestingUserId], references: [id], onDelete: Cascade)

  // Source animal (the animal that needs a parent linked)
  sourceAnimalId   Int
  sourceAnimal     Animal     @relation("LinkSource", fields: [sourceAnimalId], references: [id], onDelete: Cascade)
  relationshipType ParentType // SIRE or DAM

  // Target discovery - how the target animal was found (at least one populated)
  targetAnimalId     Int? // Direct animal ID if known
  targetAnimal       Animal? @relation("LinkTarget", fields: [targetAnimalId], references: [id], onDelete: SetNull)
  targetGaid         String? // GAID if searched by global ID
  targetExchangeCode String? // Exchange code if shared directly
  targetRegistryId   Int? // Registry ID if searched by registry number
  targetRegistryNum  String? // Registry number
  targetTenantId     Int? // Target breeder if found via breeder search
  targetTenant       Tenant? @relation("LinkRequestTo", fields: [targetTenantId], references: [id], onDelete: SetNull)

  // Request details
  message String? @db.Text // Message from requester

  // Response
  status                  LinkRequestStatus @default(PENDING)
  respondedAt             DateTime?
  responseMessage         String?           @db.Text
  denialReason            String? // Reason if denied
  confirmedTargetAnimalId Int? // The actual animal ID selected by target breeder on approval

  // Link created from this request (if approved)
  resultingLink CrossTenantAnimalLink?

  @@index([requestingTenantId])
  @@index([targetTenantId])
  @@index([targetAnimalId])
  @@index([sourceAnimalId])
  @@index([status])
  @@schema("public")
}

/**
 * CrossTenantAnimalLink - An active link between a child animal and a parent animal across tenants
 * Created when a link request is approved
 */
model CrossTenantAnimalLink {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // Child animal (the animal with the linked parent)
  childAnimalId Int
  childAnimal   Animal @relation("LinkedChild", fields: [childAnimalId], references: [id], onDelete: Cascade)
  childTenantId Int
  childTenant   Tenant @relation("LinkChildTenant", fields: [childTenantId], references: [id], onDelete: Cascade)

  // Parent animal (the animal being linked as parent)
  parentAnimalId Int
  parentAnimal   Animal     @relation("LinkedParent", fields: [parentAnimalId], references: [id], onDelete: Cascade)
  parentTenantId Int
  parentTenant   Tenant     @relation("LinkParentTenant", fields: [parentTenantId], references: [id], onDelete: Cascade)
  parentType     ParentType // SIRE or DAM

  // Provenance
  linkRequestId Int?               @unique
  linkRequest   AnimalLinkRequest? @relation(fields: [linkRequestId], references: [id], onDelete: SetNull)
  linkMethod    LinkMethod // How the link was established

  // Status
  active           Boolean    @default(true)
  revokedAt        DateTime?
  revokedBy        RevokedBy?
  revocationReason String?

  @@unique([childAnimalId, parentType]) // Each animal can have only one sire and one dam linked cross-tenant
  @@index([parentAnimalId])
  @@index([childTenantId])
  @@index([parentTenantId])
  @@index([active])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Title & Competition Tracking
 * For show/performance breeders to track achievements and competition records
 * ────────────────────────────────────────────────────────────────────────────
 */

enum TitleCategory {
  CONFORMATION // CH, GCH, GCHB, etc.
  OBEDIENCE // CD, CDX, UD, OTCH
  AGILITY // MACH, PACH, etc.
  FIELD // FC, AFC, MH, etc.
  HERDING // HT, PT, HC, etc.
  TRACKING // TD, TDX, VST
  RALLY // RN, RA, RE, etc.
  PRODUCING // ROM, ROMX (breed club)
  BREED_SPECIFIC // Breed club awards
  PERFORMANCE // Racing, working, etc.
  OTHER

  @@schema("public")
}

enum TitleStatus {
  IN_PROGRESS // Working toward (optional tracking)
  EARNED // Title completed
  VERIFIED // Confirmed by registry/org

  @@schema("public")
}

enum CompetitionType {
  CONFORMATION_SHOW
  OBEDIENCE_TRIAL
  AGILITY_TRIAL
  FIELD_TRIAL
  HERDING_TRIAL
  TRACKING_TEST
  RALLY_TRIAL
  RACE
  PERFORMANCE_TEST
  BREED_SPECIALTY
  OTHER

  @@schema("public")
}

/**
 * TitleDefinition - Defines available titles (global or tenant-specific)
 * Global titles (tenantId=null) are seeded for common registries (AKC, UKC, etc.)
 * Tenants can create custom titles for breed clubs or internal awards
 */
model TitleDefinition {
  id       Int     @id @default(autoincrement())
  tenantId Int? // null = global, set = tenant-specific custom title
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  species  Species

  abbreviation String // "CH", "GCH", "MACH"
  fullName     String // "Champion", "Grand Champion"
  category     TitleCategory
  organization String? // "AKC", "UKC", "AQHA", breed club name

  // Title hierarchy (e.g., CH required before GCH)
  parentTitleId Int?
  parentTitle   TitleDefinition?  @relation("TitleHierarchy", fields: [parentTitleId], references: [id], onDelete: SetNull)
  childTitles   TitleDefinition[] @relation("TitleHierarchy")

  // Requirements (informational display)
  pointsRequired Int?
  description    String? @db.Text // "15 points + 2 majors under different judges"

  // Producing title flag (ROM, ROMX - based on offspring achievements)
  isProducingTitle Boolean @default(false)

  // Display position in title string
  prefixTitle  Boolean @default(true) // CH goes before name
  suffixTitle  Boolean @default(false) // CGC goes after name
  displayOrder Int     @default(0) // Sort order within prefix/suffix group

  createdAt DateTime @default(now())

  // Relation to earned titles
  animalTitles AnimalTitle[]

  @@unique([species, abbreviation, organization, tenantId])
  @@index([species])
  @@index([category])
  @@index([tenantId])
  @@schema("public")
}

/**
 * AnimalTitle - A title earned by a specific animal
 */
model AnimalTitle {
  id                Int             @id @default(autoincrement())
  tenantId          Int
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId          Int
  animal            Animal          @relation(fields: [animalId], references: [id], onDelete: Cascade)
  titleDefinitionId Int
  titleDefinition   TitleDefinition @relation(fields: [titleDefinitionId], references: [id], onDelete: Restrict)

  // When earned
  dateEarned DateTime?
  status     TitleStatus @default(EARNED)

  // Points/progress tracking
  pointsEarned Float? // Total points at time of earning
  majorWins    Int? // For conformation titles

  // Where the title was earned (event info)
  eventName     String? // "Westminster Kennel Club 2024"
  eventLocation String? // "New York, NY"
  handlerName   String? // Person who handled/showed the animal

  // Verification
  verified    Boolean   @default(false)
  verifiedAt  DateTime?
  verifiedBy  String? // User ID or "AKC Registry"
  registryRef String? // External reference number

  // Public visibility for cross-tenant pedigree views
  isPublic Boolean @default(false)

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Supporting documents
  documents AnimalTitleDocument[]

  @@unique([animalId, titleDefinitionId])
  @@index([tenantId])
  @@index([animalId])
  @@index([status])
  @@index([isPublic])
  @@schema("public")
}

/**
 * AnimalTitleDocument - Links documents to animal titles
 */
model AnimalTitleDocument {
  id            Int         @id @default(autoincrement())
  animalTitleId Int
  animalTitle   AnimalTitle @relation(fields: [animalTitleId], references: [id], onDelete: Cascade)
  documentId    Int
  document      Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([animalTitleId, documentId])
  @@schema("public")
}

/**
 * CompetitionEntry - Individual competition/show entries
 * Tracks placements, points, and results for performance analysis
 */
model CompetitionEntry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // Event info
  eventName       String // "Westminster Kennel Club", "Kentucky Derby"
  eventDate       DateTime
  location        String? // "New York, NY", "Churchill Downs"
  organization    String? // "AKC", "Jockey Club"
  competitionType CompetitionType

  // Class/division
  className String? // "Open Dogs", "Excellent B Standard", "G1 Stakes"

  // Results
  placement       Int? // 1, 2, 3, 4 or null if no placement
  placementLabel  String? // "Best of Breed", "Winners Dog", "High in Trial"
  pointsEarned    Float?
  isMajorWin      Boolean @default(false)
  qualifyingScore Boolean @default(false) // Q for agility, pass for tracking

  // Scores (for performance events)
  score    Float? // Agility time, obedience score, race time
  scoreMax Float? // Max possible score

  // Racing-specific fields
  prizeMoneyCents  Int? // Prize/purse won in cents (e.g., 100000 = $1,000.00)
  trackName        String? // "Churchill Downs", "Santa Anita", "Shelbourne Park"
  trackSurface     String? // "dirt", "turf", "synthetic", "sand"
  distanceFurlongs Float? // Race distance in furlongs (1 furlong = 1/8 mile)
  distanceMeters   Int? // Race distance in meters (for greyhounds/international)
  raceGrade        String? // "G1", "G2", "G3", "Listed", "A", "B", "Open"
  finishTime       String? // "1:59.40" or "29.45" - stored as string for display
  speedFigure      Int? // Beyer speed figure, Timeform, etc.

  // Handler/rider info
  handlerName String? // Jockey, driver, handler (person who competed with animal)
  trainerName String? // Trainer at time of event (if different from current)

  // Judge
  judgeName String?

  // Public visibility for cross-tenant pedigree views
  isPublic Boolean @default(false)

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Supporting documents (ribbons, photos, scoresheets)
  documents CompetitionEntryDocument[]

  @@index([tenantId])
  @@index([animalId])
  @@index([eventDate])
  @@index([competitionType])
  @@index([isPublic])
  @@schema("public")
}

/**
 * CompetitionEntryDocument - Links documents to competition entries
 */
model CompetitionEntryDocument {
  id                 Int              @id @default(autoincrement())
  competitionEntryId Int
  competitionEntry   CompetitionEntry @relation(fields: [competitionEntryId], references: [id], onDelete: Cascade)
  documentId         Int
  document           Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([competitionEntryId, documentId])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Client Profile Change Requests
 * ────────────────────────────────────────────────────────────────────────────
 */

enum ChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED // Client withdrew request

  @@schema("public")
}

/**
 * ContactChangeRequest - Tracks name change requests from clients
 * (firstName, lastName, nickname require breeder approval)
 */
model ContactChangeRequest {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contactId Int
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // What changed
  fieldName String // "firstName" | "lastName" | "nickname"
  oldValue  String? // Previous value (null if was empty)
  newValue  String // Requested new value

  // Request metadata
  status      ChangeRequestStatus @default(PENDING)
  requestedAt DateTime            @default(now())
  requestedBy String? // User ID of client who requested

  // Resolution
  resolvedAt     DateTime?
  resolvedBy     String? // User ID of breeder who resolved
  resolutionNote String? // Optional note from breeder (e.g., rejection reason)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, status])
  @@index([contactId])
  @@schema("public")
}

enum EmailChangeStatus {
  PENDING_VERIFICATION // Waiting for email verification
  VERIFIED // Email verified, change applied
  EXPIRED // Verification token expired
  CANCELLED // Client cancelled

  @@schema("public")
}

/**
 * EmailChangeRequest - Tracks email change requests with verification
 */
model EmailChangeRequest {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contactId Int
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Email change
  oldEmail String?
  newEmail String

  // Verification
  verificationToken String    @unique @default(cuid())
  verifiedAt        DateTime?

  // Status
  status      EmailChangeStatus @default(PENDING_VERIFICATION)
  requestedAt DateTime          @default(now())
  expiresAt   DateTime // Token expiry (e.g., 24 hours)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([contactId])
  @@index([verificationToken])
  @@schema("public")
}

// ============================================================================
// MARKETPLACE MODELS (marketplace schema)
// ============================================================================

model MarketplaceUser {
  id            Int     @id @default(autoincrement())
  email         String  @unique
  emailVerified Boolean @default(false) @map("email_verified")
  passwordHash  String  @map("password_hash")

  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  phone     String?

  // Shipping address
  addressLine1 String? @map("address_line1")
  addressLine2 String? @map("address_line2")
  city         String?
  state        String?
  zip          String?
  country      String? @default("US")

  userType String @default("buyer") @map("user_type")

  // Link to breeder account (if they're also a breeder)
  tenantId       Int?    @map("tenant_id")
  tenantVerified Boolean @default(false) @map("tenant_verified")

  stripeCustomerId String? @unique @map("stripe_customer_id")

  // Account status
  status          String    @default("active")
  suspendedAt     DateTime? @map("suspended_at")
  suspendedReason String?   @map("suspended_reason")

  // Email verification
  emailVerifyToken   String?   @unique @map("email_verify_token")
  emailVerifyExpires DateTime? @map("email_verify_expires")

  // Password reset
  passwordResetToken   String?   @unique @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // ============================================================================
  // Two-Factor Authentication (2FA)
  // ============================================================================
  twoFactorEnabled   Boolean          @default(false) @map("two_factor_enabled")
  twoFactorMethod    TwoFactorMethod? @map("two_factor_method")
  twoFactorEnabledAt DateTime?        @map("two_factor_enabled_at")

  // TOTP (Authenticator App)
  totpSecret     String?   @map("totp_secret")
  totpVerifiedAt DateTime? @map("totp_verified_at")

  // Passkey (WebAuthn) - marketplace-specific
  passkeyCredentialId     String?   @map("passkey_credential_id")
  passkeyPublicKey        Bytes?    @map("passkey_public_key")
  passkeyCounter          Int?      @map("passkey_counter")
  passkeyCreatedAt        DateTime? @map("passkey_created_at")
  passkeyChallenge        String?   @map("passkey_challenge")
  passkeyChallengeExpires DateTime? @map("passkey_challenge_expires")

  // SMS verification for 2FA
  smsPhoneNumber              String?   @map("sms_phone_number")
  smsVerifiedAt               DateTime? @map("sms_verified_at")
  smsVerificationToken        String?   @map("sms_verification_token")
  smsVerificationTokenExpires DateTime? @map("sms_verification_token_expires")

  // ============================================================================
  // Service Provider Verification
  // ============================================================================
  serviceProviderTier           ServiceProviderVerificationTier? @map("service_provider_tier")
  serviceProviderTierAchievedAt DateTime?                        @map("service_provider_tier_achieved_at")

  // Stripe Identity (for standalone $10 verification)
  stripeIdentitySessionId String?   @map("stripe_identity_session_id")
  stripeIdentityStatus    String?   @map("stripe_identity_status") // pending, verified, failed
  identityVerifiedAt      DateTime? @map("identity_verified_at")

  // Paid verification packages - Verified Professional
  verifiedProfessionalPurchasedAt DateTime? @map("verified_professional_purchased_at")
  verifiedProfessionalApprovedAt  DateTime? @map("verified_professional_approved_at")
  verifiedProfessionalApprovedBy  Int?      @map("verified_professional_approved_by")
  verifiedProfessionalExpiresAt   DateTime? @map("verified_professional_expires_at")

  // Paid verification packages - Accredited Provider
  accreditedProviderPurchasedAt DateTime? @map("accredited_provider_purchased_at")
  accreditedProviderApprovedAt  DateTime? @map("accredited_provider_approved_at")
  accreditedProviderApprovedBy  Int?      @map("accredited_provider_approved_by")
  accreditedProviderExpiresAt   DateTime? @map("accredited_provider_expires_at")

  // Platform-earned badges (service providers)
  quickResponderBadge      Boolean @default(false) @map("quick_responder_badge")
  establishedProviderBadge Boolean @default(false) @map("established_provider_badge")
  topRatedBadge            Boolean @default(false) @map("top_rated_badge")
  trustedProviderBadge     Boolean @default(false) @map("trusted_provider_badge")
  acceptsPaymentsBadge     Boolean @default(false) @map("accepts_payments_badge")

  // Relations
  provider             MarketplaceProvider?
  sentMessages         MarketplaceMessage[]
  clientThreads        MarketplaceMessageThread[] @relation("ClientThreads")
  clientTransactions   MarketplaceTransaction[]   @relation("ClientTransactions")
  clientInvoices       MarketplaceInvoice[]       @relation("ClientInvoices")
  reviews              MarketplaceReview[]        @relation("ReviewsByClient")
  verificationRequests VerificationRequest[]      @relation("UserVerificationRequests")

  @@index([email])
  @@index([tenantId])
  @@index([stripeCustomerId])
  @@index([deletedAt])
  @@index([status])
  @@index([twoFactorEnabled])
  @@index([serviceProviderTier])
  @@map("users")
  @@schema("marketplace")
}

model MarketplaceProvider {
  id     Int             @id @default(autoincrement())
  userId Int             @unique @map("user_id")
  user   MarketplaceUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  providerType String @map("provider_type")

  // Link to breeder tenant (if provider is a breeder)
  tenantId Int? @map("tenant_id")

  // Business info
  businessName        String  @map("business_name")
  businessDescription String? @map("business_description")
  logoUrl             String? @map("logo_url")
  coverImageUrl       String? @map("cover_image_url")

  // Contact
  publicEmail String? @map("public_email")
  publicPhone String? @map("public_phone")
  website     String?

  // Location
  city      String?
  state     String?
  zip       String?
  country   String?  @default("US")
  latitude  Decimal? @map("latitude") @db.Decimal(10, 8)
  longitude Decimal? @map("longitude") @db.Decimal(11, 8)

  // Stripe Connect for automated payouts
  stripeConnectAccountId          String? @unique @map("stripe_connect_account_id")
  stripeConnectOnboardingComplete Boolean @default(false) @map("stripe_connect_onboarding_complete")
  stripeConnectPayoutsEnabled     Boolean @default(false) @map("stripe_connect_payouts_enabled")
  stripeConnectDetailsSubmitted   Boolean @default(false) @map("stripe_connect_details_submitted")

  // Payment settings
  paymentMode         String  @default("manual") @map("payment_mode")
  paymentInstructions String? @map("payment_instructions")

  // Business hours (JSON)
  businessHours Json?   @map("business_hours")
  timeZone      String? @default("America/New_York") @map("time_zone")

  // Stats (updated by triggers/cron)
  totalListings         Int     @default(0) @map("total_listings")
  activeListings        Int     @default(0) @map("active_listings")
  totalTransactions     Int     @default(0) @map("total_transactions")
  completedTransactions Int     @default(0) @map("completed_transactions")
  totalRevenueCents     BigInt  @default(0) @map("total_revenue_cents")
  lifetimePayoutCents   BigInt  @default(0) @map("lifetime_payout_cents")
  averageRating         Decimal @default(0.00) @map("average_rating") @db.Decimal(3, 2)
  totalReviews          Int     @default(0) @map("total_reviews")

  // Badge flags (legacy - kept for backwards compatibility)
  verifiedProvider Boolean @default(false) @map("verified_provider")
  premiumProvider  Boolean @default(false) @map("premium_provider")
  quickResponder   Boolean @default(false) @map("quick_responder")

  // ============================================================================
  // Breeder Verification System
  // ============================================================================
  verificationTier           BreederVerificationTier @default(SUBSCRIBER) @map("verification_tier")
  verificationTierAchievedAt DateTime?               @map("verification_tier_achieved_at")

  // Phone verification (required for MARKETPLACE_ENABLED tier)
  phoneVerifiedAt               DateTime? @map("phone_verified_at")
  phoneVerificationToken        String?   @map("phone_verification_token")
  phoneVerificationTokenExpires DateTime? @map("phone_verification_token_expires")

  // Stripe Identity verification (for IDENTITY_VERIFIED tier)
  stripeIdentitySessionId String?   @map("stripe_identity_session_id")
  stripeIdentityStatus    String?   @map("stripe_identity_status") // pending, verified, failed
  identityVerifiedAt      DateTime? @map("identity_verified_at")

  // Paid verification packages - BreederHQ Verified
  verifiedPackagePurchasedAt DateTime? @map("verified_package_purchased_at")
  verifiedPackageApprovedAt  DateTime? @map("verified_package_approved_at")
  verifiedPackageApprovedBy  Int?      @map("verified_package_approved_by")
  verifiedPackageExpiresAt   DateTime? @map("verified_package_expires_at")

  // Paid verification packages - BreederHQ Accredited
  accreditedPackagePurchasedAt DateTime? @map("accredited_package_purchased_at")
  accreditedPackageApprovedAt  DateTime? @map("accredited_package_approved_at")
  accreditedPackageApprovedBy  Int?      @map("accredited_package_approved_by")
  accreditedPackageExpiresAt   DateTime? @map("accredited_package_expires_at")

  // Additional platform-earned badges
  establishedBadge         Boolean   @default(false) @map("established_badge")
  establishedBadgeEarnedAt DateTime? @map("established_badge_earned_at")
  topRatedBadge            Boolean   @default(false) @map("top_rated_badge")
  topRatedBadgeEarnedAt    DateTime? @map("top_rated_badge_earned_at")
  trustedBadge             Boolean   @default(false) @map("trusted_badge")
  trustedBadgeEarnedAt     DateTime? @map("trusted_badge_earned_at")

  // ============================================================================
  // Listing Fee Infrastructure (placeholder for future monetization)
  // ============================================================================
  listingTier           String?   @map("listing_tier") // e.g., "free", "basic", "premium"
  listingFeeExempt      Boolean   @default(true) @map("listing_fee_exempt") // True during free launch period
  listingFeeExemptUntil DateTime? @map("listing_fee_exempt_until") // When free period ends
  maxActiveListings     Int?      @map("max_active_listings") // Limit based on tier (null = unlimited)

  // Status
  status          String    @default("pending")
  activatedAt     DateTime? @map("activated_at")
  suspendedAt     DateTime? @map("suspended_at")
  suspendedReason String?   @map("suspended_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Relations
  unifiedListings      MktListingService[]         // Unified marketplace listings
  providerThreads      MarketplaceMessageThread[]  @relation("ProviderThreads")
  providerTransactions MarketplaceTransaction[]    @relation("ProviderTransactions")
  providerInvoices     MarketplaceInvoice[]        @relation("ProviderInvoices")
  reviews              MarketplaceReview[]         @relation("ReviewsForProvider")
  verificationRequests VerificationRequest[]       @relation("ProviderVerificationRequests")

  @@index([userId])
  @@index([tenantId])
  @@index([stripeConnectAccountId])
  @@index([status, activatedAt])
  @@index([city, state, status])
  @@index([deletedAt])
  @@index([verificationTier])
  @@map("providers")
  @@schema("marketplace")
}

/**
 * VerificationRequest - Staff queue for processing paid verification packages
 * Handles both Breeder and Service Provider verification requests
 */
model VerificationRequest {
  id Int @id @default(autoincrement())

  // Who is being verified (polymorphic - one of these will be set)
  userType          String               @map("user_type") // "BREEDER" or "SERVICE_PROVIDER"
  providerId        Int?                 @map("provider_id")
  provider          MarketplaceProvider? @relation("ProviderVerificationRequests", fields: [providerId], references: [id], onDelete: Cascade)
  marketplaceUserId Int?                 @map("marketplace_user_id")
  marketplaceUser   MarketplaceUser?     @relation("UserVerificationRequests", fields: [marketplaceUserId], references: [id], onDelete: Cascade)

  // What package was requested
  packageType   String @map("package_type") // "VERIFIED" or "ACCREDITED"
  requestedTier String @map("requested_tier") // Full tier name for reference

  // Request status
  status VerificationRequestStatus @default(PENDING)

  // User-submitted verification info (flexible JSON storage)
  // Breeders: { registryName, registryMemberId, animalsToVerify, vetClinicName, vetClinicPhone, ... }
  // Service Providers: { certifications, professionalLicenseType, insuranceCompany, ... }
  submittedInfo Json? @map("submitted_info")

  // Staff review
  reviewChecklist Json?     @map("review_checklist") // Completed checklist items
  reviewNotes     String?   @map("review_notes") // Internal notes
  reviewedAt      DateTime? @map("reviewed_at")
  reviewedBy      Int?      @map("reviewed_by") // Admin user ID

  // If more info needed from user
  infoRequestedAt DateTime? @map("info_requested_at")
  infoRequestNote String?   @map("info_request_note")
  infoProvidedAt  DateTime? @map("info_provided_at")

  // Payment tracking
  paymentIntentId String? @map("payment_intent_id") // Stripe PaymentIntent ID
  amountPaidCents Int?    @map("amount_paid_cents")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status, createdAt(sort: Desc)])
  @@index([userType, status])
  @@index([providerId])
  @@index([marketplaceUserId])
  @@index([reviewedBy])
  @@map("verification_requests")
  @@schema("marketplace")
}

/**
 * MktListingService - Unified service listings table
 * Consolidates provider and breeder service listings into single table
 * Uses source_type discriminator to distinguish between sources
 */
model MktListingService {
  id         Int               @id @default(autoincrement())
  sourceType ServiceSourceType @map("source_type")

  // Source references (one will be NULL based on source_type)
  providerId Int?                 @map("provider_id")
  provider   MarketplaceProvider? @relation(fields: [providerId], references: [id], onDelete: Cascade)

  tenantId Int?    @map("tenant_id")
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Listing details
  slug        String  @unique
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Service categorization
  category          String  @db.VarChar(100)
  subcategory       String? @db.VarChar(100)
  customServiceType String? @map("custom_service_type") @db.VarChar(50)

  // Pricing
  priceCents BigInt? @map("price_cents")
  priceType  String? @map("price_type") @db.VarChar(50)
  priceText  String? @map("price_text") @db.VarChar(100)

  // Media
  images        Json?
  coverImageUrl String? @map("cover_image_url") @db.VarChar(500)

  // Location
  city      String?  @db.VarChar(100)
  state     String?  @db.VarChar(50)
  zip       String?  @db.VarChar(20)
  country   String?  @db.VarChar(2)
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  // Service details
  duration     String? @db.VarChar(100)
  availability String? @db.Text

  // SEO
  metaDescription String? @map("meta_description") @db.Text
  keywords        String? @db.Text

  // Stats
  viewCount    Int @default(0) @map("view_count")
  inquiryCount Int @default(0) @map("inquiry_count")
  bookingCount Int @default(0) @map("booking_count")

  // Status
  status      MarketplaceListingStatus @default(DRAFT)
  publishedAt DateTime?                @map("published_at")
  pausedAt    DateTime?                @map("paused_at")

  // Moderation
  flagged   Boolean   @default(false)
  flaggedAt DateTime? @map("flagged_at")

  // Featured listing (for future paid promotion)
  isFeatured    Boolean   @default(false) @map("is_featured")
  featuredUntil DateTime? @map("featured_until")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  assignments    MarketplaceServiceTagAssignment[]
  transactions   MarketplaceTransaction[]
  messageThreads MarketplaceMessageThread[]

  @@index([providerId])
  @@index([tenantId])
  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([city, state])
  @@index([sourceType])
  @@index([deletedAt])
  @@index([isFeatured, featuredUntil])
  @@map("MktListingService")
  @@schema("marketplace")
}

model MarketplaceAbuseReport {
  id        Int                       @id @default(autoincrement())
  listingId Int                       @map("listing_id")

  reason        String
  details       String?   @db.Text
  reporterEmail String?   @map("reporter_email")
  status        String    @default("pending") // pending, reviewed, dismissed, action_taken
  adminNotes    String?   @map("admin_notes") @db.Text
  resolvedAt    DateTime? @map("resolved_at")
  resolvedById  Int?      @map("resolved_by_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([listingId])
  @@index([status])
  @@index([createdAt])
  @@map("abuse_reports")
  @@schema("marketplace")
}

model MarketplaceTransaction {
  id BigInt @id @default(autoincrement())

  clientId Int             @map("client_id")
  client   MarketplaceUser @relation("ClientTransactions", fields: [clientId], references: [id], onDelete: Restrict)

  providerId Int                 @map("provider_id")
  provider   MarketplaceProvider @relation("ProviderTransactions", fields: [providerId], references: [id], onDelete: Restrict)

  listingId Int?               @map("listing_id")
  listing   MktListingService? @relation(fields: [listingId], references: [id])

  // Transaction details
  serviceDescription String  @map("service_description")
  serviceNotes       String? @map("service_notes")

  // Pricing breakdown
  servicePriceCents   BigInt  @map("service_price_cents")
  platformFeeCents    BigInt  @default(0) @map("platform_fee_cents")
  stripeFeesCents     BigInt  @default(0) @map("stripe_fees_cents")
  totalCents          BigInt  @map("total_cents")
  providerPayoutCents BigInt? @map("provider_payout_cents")

  // Tax (if applicable)
  taxCents BigInt   @default(0) @map("tax_cents")
  taxRate  Decimal? @map("tax_rate") @db.Decimal(5, 4)

  // Invoice link (optional - can link to marketplace.invoices OR public.Invoice)
  invoiceType String? @map("invoice_type")
  tenantId    Int?    @map("tenant_id")
  invoiceId   Int?    @map("invoice_id")

  // Status workflow
  status String @default("pending")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  invoicedAt  DateTime? @map("invoiced_at")
  paidAt      DateTime? @map("paid_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")
  refundedAt  DateTime? @map("refunded_at")

  // Cancellation/refund
  cancellationReason String? @map("cancellation_reason")
  cancelledBy        String? @map("cancelled_by")
  refundAmountCents  BigInt  @default(0) @map("refund_amount_cents")
  refundReason       String? @map("refund_reason")

  // Relations
  marketplaceInvoice MarketplaceInvoice?
  threads            MarketplaceMessageThread[]
  review             MarketplaceReview?

  @@index([clientId, status, createdAt(sort: Desc)])
  @@index([providerId, status, createdAt(sort: Desc)])
  @@index([listingId, status])
  @@index([invoiceType, tenantId, invoiceId])
  @@index([status, paidAt])
  @@map("transactions")
  @@schema("marketplace")
}

model MarketplaceInvoice {
  id Int @id @default(autoincrement())

  transactionId BigInt                 @unique @map("transaction_id")
  transaction   MarketplaceTransaction @relation(fields: [transactionId], references: [id], onDelete: Restrict)

  providerId Int                 @map("provider_id")
  provider   MarketplaceProvider @relation("ProviderInvoices", fields: [providerId], references: [id], onDelete: Restrict)

  clientId Int             @map("client_id")
  client   MarketplaceUser @relation("ClientInvoices", fields: [clientId], references: [id], onDelete: Restrict)

  invoiceNumber String @unique @map("invoice_number")

  // Amounts
  subtotalCents BigInt @map("subtotal_cents")
  taxCents      BigInt @default(0) @map("tax_cents")
  totalCents    BigInt @map("total_cents")
  paidCents     BigInt @default(0) @map("paid_cents")
  balanceCents  BigInt @map("balance_cents")
  refundedCents BigInt @default(0) @map("refunded_cents")

  // Status
  status String @default("draft")

  // Payment
  paymentMode           String   @default("stripe") @map("payment_mode")
  paymentModeLockedAt   DateTime @default(now()) @map("payment_mode_locked_at")
  stripeInvoiceId       String?  @unique @map("stripe_invoice_id")
  stripePaymentIntentId String?  @unique @map("stripe_payment_intent_id")
  stripeChargeId        String?  @map("stripe_charge_id")

  // Stripe Invoice details (for direct provider invoices)
  stripeInvoiceUrl    String?   @map("stripe_invoice_url")     // Hosted invoice URL for client payment
  stripeInvoicePdfUrl String?   @map("stripe_invoice_pdf_url") // PDF download URL
  stripeInvoiceSentAt DateTime? @map("stripe_invoice_sent_at") // When Stripe sent the email

  // Manual payment confirmation
  manualPaymentMarkedAt    DateTime? @map("manual_payment_marked_at")
  manualPaymentMethod      String?   @map("manual_payment_method")
  manualPaymentReference   String?   @map("manual_payment_reference")
  manualPaymentConfirmedBy Int?      @map("manual_payment_confirmed_by")

  // Legacy fields (for backward compatibility)
  buyerMarkedPaidAt     DateTime? @map("buyer_marked_paid_at")
  buyerPaymentMethod    String?   @map("buyer_payment_method")
  buyerPaymentReference String?   @map("buyer_payment_reference")
  providerConfirmedAt   DateTime? @map("provider_confirmed_at")
  providerConfirmedById Int?      @map("provider_confirmed_by")

  // Dates
  issuedAt   DateTime? @map("issued_at")
  sentAt     DateTime? @map("sent_at")
  viewedAt   DateTime? @map("viewed_at")
  dueAt      DateTime? @map("due_at")
  paidAt     DateTime? @map("paid_at")
  refundedAt DateTime? @map("refunded_at")
  voidedAt   DateTime? @map("voided_at")

  // Notes
  notes         String?
  internalNotes String? @map("internal_notes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([transactionId])
  @@index([providerId, status, createdAt(sort: Desc)])
  @@index([clientId, status, createdAt(sort: Desc)])
  @@index([stripeInvoiceId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
  @@index([status, dueAt])
  @@map("invoices")
  @@schema("marketplace")
}

model MarketplaceMessageThread {
  id Int @id @default(autoincrement())

  clientId Int             @map("client_id")
  client   MarketplaceUser @relation("ClientThreads", fields: [clientId], references: [id], onDelete: Cascade)

  providerId Int                 @map("provider_id")
  provider   MarketplaceProvider @relation("ProviderThreads", fields: [providerId], references: [id], onDelete: Cascade)

  listingId Int?               @map("listing_id")
  listing   MktListingService? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  transactionId BigInt?                 @map("transaction_id")
  transaction   MarketplaceTransaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  subject String?
  status  String  @default("active")

  lastMessageAt DateTime @default(now()) @map("last_message_at")
  createdAt     DateTime @default(now()) @map("created_at")

  // Provider messaging enhancements
  archivedByProviderAt DateTime? @map("archived_by_provider_at")
  deletedByProviderAt  DateTime? @map("deleted_by_provider_at")

  // Response time tracking (for "Quick Responder" badge)
  firstClientMessageAt DateTime? @map("first_client_message_at")
  firstProviderReplyAt DateTime? @map("first_provider_reply_at")
  responseTimeSeconds  Int?      @map("response_time_seconds")

  // Relations
  messages MarketplaceMessage[]

  @@index([clientId, lastMessageAt(sort: Desc)])
  @@index([providerId, lastMessageAt(sort: Desc)])
  @@map("message_threads")
  @@schema("marketplace")
}

model MarketplaceMessage {
  id BigInt @id @default(autoincrement())

  threadId Int                      @map("thread_id")
  thread   MarketplaceMessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  senderId   Int             @map("sender_id")
  sender     MarketplaceUser @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderType String          @default("client") @map("sender_type") // "client" | "provider"

  messageText String    @map("message_text")
  readAt      DateTime? @map("read_at")

  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([threadId, createdAt(sort: Desc)])
  @@map("messages")
  @@schema("marketplace")
}

model MarketplaceReview {
  id Int @id @default(autoincrement())

  transactionId BigInt                 @unique @map("transaction_id")
  transaction   MarketplaceTransaction @relation(fields: [transactionId], references: [id], onDelete: Restrict)

  providerId Int                 @map("provider_id")
  provider   MarketplaceProvider @relation("ReviewsForProvider", fields: [providerId], references: [id], onDelete: Restrict)

  clientId Int             @map("client_id")
  client   MarketplaceUser @relation("ReviewsByClient", fields: [clientId], references: [id], onDelete: Restrict)

  listingId Int?                       @map("listing_id")

  // Rating & review
  rating     Int // 1-5 stars
  title      String?
  reviewText String? @map("review_text")

  // Response from provider
  providerResponse String?   @map("provider_response")
  respondedAt      DateTime? @map("responded_at")

  // Moderation
  status        String  @default("published") // "published" | "flagged" | "removed"
  flaggedReason String? @map("flagged_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([providerId, status, createdAt(sort: Desc)])
  @@index([clientId])
  @@index([listingId, status])
  @@index([rating, status])
  @@map("reviews")
  @@schema("marketplace")
}

model MarketplaceSavedListing {
  id Int @id @default(autoincrement())

  // BHQ User ID (CUID string from main User table)
  bhqUserId String @map("bhq_user_id") @db.VarChar(36)
  bhqUser   User   @relation("UserSavedListings", fields: [bhqUserId], references: [id], onDelete: Cascade)

  // Listing type: offspring_group, animal, service
  listingType String @map("listing_type") @db.VarChar(20)

  // Listing ID (references different tables based on listingType)
  listingId Int @map("listing_id")

  savedAt DateTime @default(now()) @map("saved_at")

  @@unique([bhqUserId, listingType, listingId])
  @@index([bhqUserId, savedAt(sort: Desc)])
  @@index([listingType, listingId])
  @@map("saved_listings")
  @@schema("marketplace")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Service Provider Portal - Tags, Reports, Verification
 * ────────────────────────────────────────────────────────────────────────────
 */

model MarketplaceServiceTag {
  id Int @id @default(autoincrement())

  name       String   @db.VarChar(100)
  slug       String   @unique @db.VarChar(100)
  usageCount Int      @default(0) @map("usage_count")
  suggested  Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  assignments MarketplaceServiceTagAssignment[]

  @@index([suggested])
  @@index([usageCount(sort: Desc)])
  @@index([name])
  @@map("service_tags")
  @@schema("marketplace")
}

model MarketplaceServiceTagAssignment {
  listingId Int               @map("listing_id")
  listing   MktListingService @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tagId     Int               @map("tag_id")
  tag       MarketplaceServiceTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([listingId, tagId])
  @@index([listingId])
  @@index([tagId])
  @@map("service_tag_assignments")
  @@schema("marketplace")
}

model MarketplaceListingReport {
  id Int @id @default(autoincrement())

  listingId      Int    @map("listing_id")
  reporterUserId Int?   @map("reporter_user_id")
  reason         String @db.VarChar(50)
  description    String @db.Text
  status         String @default("PENDING") @db.VarChar(50) // PENDING, REVIEWED, ACTIONED, DISMISSED

  // Review tracking
  reviewedBy  Int?      @map("reviewed_by")
  reviewedAt  DateTime? @map("reviewed_at")
  reviewNotes String?   @map("review_notes") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([listingId])
  @@index([reporterUserId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("listing_reports")
  @@schema("marketplace")
}

model StripeIdentitySession {
  id Int @id @default(autoincrement())

  userId          Int    @map("user_id")
  stripeSessionId String @unique @map("stripe_session_id") @db.VarChar(255)
  clientSecret    String @map("client_secret") @db.Text
  status          String @default("pending") @db.VarChar(50) // pending, verified, requires_input, canceled, failed

  verifiedAt     DateTime? @map("verified_at")
  stripeResponse Json?     @map("stripe_response")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("stripe_identity_sessions")
  @@schema("marketplace")
}

model AdminActionLog {
  id Int @id @default(autoincrement())

  adminUserId Int?     @map("admin_user_id")
  action      String   @db.VarChar(100)
  entityType  String?  @map("entity_type") @db.VarChar(50)
  entityId    Int?     @map("entity_id")
  details     Json?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([adminUserId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("admin_action_logs")
  @@schema("marketplace")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding Program Rules & Automation
 * ────────────────────────────────────────────────────────────────────────────
 */

enum BreedingRuleCategory {
  LISTING
  PRICING
  VISIBILITY
  BUYER_INTERACTION
  STATUS
  NOTIFICATIONS

  @@schema("public")
}

enum BreedingRuleLevel {
  PROGRAM
  PLAN
  GROUP
  OFFSPRING

  @@schema("public")
}

model BreedingProgramRule {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Rule identity
  category    BreedingRuleCategory
  ruleType    String               @db.VarChar(100) // Specific rule within category
  name        String               @db.VarChar(255)
  description String?              @db.Text
  enabled     Boolean              @default(true)

  // Configuration (varies by rule type)
  config Json @default("{}")

  // Hierarchy tracking
  level          BreedingRuleLevel
  levelId        String                @db.VarChar(50) // Program slug or entity ID
  inheritsFromId Int?
  inheritsFrom   BreedingProgramRule?  @relation("RuleInheritance", fields: [inheritsFromId], references: [id], onDelete: SetNull)
  overriddenBy   BreedingProgramRule[] @relation("RuleInheritance")

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  executions BreedingProgramRuleExecution[]

  @@unique([tenantId, level, levelId, ruleType])
  @@index([tenantId])
  @@index([level, levelId])
  @@index([inheritsFromId])
  @@index([ruleType])
  @@index([tenantId, enabled])
  @@schema("public")
}

model BreedingProgramRuleExecution {
  id       Int                 @id @default(autoincrement())
  tenantId Int
  ruleId   Int
  rule     BreedingProgramRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Execution context
  triggeredBy String @db.VarChar(50) // 'user_action', 'cron_job', 'webhook'
  entityType  String @db.VarChar(20) // 'offspring', 'group', 'plan'
  entityId    Int

  // Result
  success Boolean
  action  String? @db.VarChar(100) // 'set_marketplace_listed', 'update_price', etc.
  changes Json? // What actually changed
  error   String? @db.Text

  // Metadata
  executedAt DateTime @default(now())

  @@index([tenantId])
  @@index([ruleId])
  @@index([entityType, entityId])
  @@index([executedAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Stud Listing Visibility Rules
 * ────────────────────────────────────────────────────────────────────────────
 * Granular visibility control for stud listings with inheritance hierarchy:
 * TENANT (defaults) → PROGRAM (stud service program) → PARTICIPANT (individual stallion)
 */

enum StudVisibilityLevel {
  TENANT
  PROGRAM
  PARTICIPANT

  @@schema("public")
}

model StudVisibilityRule {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Hierarchy tracking
  level          StudVisibilityLevel
  levelId        String               @db.VarChar(50) // tenantId, programId, or participantId
  inheritsFromId Int?
  inheritsFrom   StudVisibilityRule?  @relation("StudVisibilityInheritance", fields: [inheritsFromId], references: [id], onDelete: SetNull)
  overriddenBy   StudVisibilityRule[] @relation("StudVisibilityInheritance")

  // Configuration (JSON with section toggles)
  config  Json    @default("{}")
  enabled Boolean @default(true)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int?
  updatedBy Int?

  @@unique([tenantId, level, levelId])
  @@index([tenantId])
  @@index([level, levelId])
  @@index([inheritsFromId])
  @@schema("public")
}

/**
 * EmailFilter - Tenant-level allowlist/blocklist for inbound email security
 * Allows tenants to block spam senders or ensure important contacts always get through
 */
model EmailFilter {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Email address or domain pattern to filter
  // Examples: "spam@example.com", "*@spammydomain.com", "*.tk"
  pattern String @db.VarChar(255)

  // Filter type
  type String @db.VarChar(20) // "ALLOW" | "BLOCK"

  // Why was this filter created?
  reason    String? @db.Text
  autoAdded Boolean @default(false) // System auto-added vs user-created

  // Metadata
  createdAt   DateTime  @default(now())
  createdBy   String? // User ID who created the filter
  lastMatched DateTime? // Last time this filter matched an email

  @@index([tenantId, pattern])
  @@index([tenantId, type])
  @@schema("public")
}

/**
 * Blocked/rejected inbound emails - audit log for troubleshooting
 * Tracks all emails that were blocked by security checks
 */
model BlockedEmail {
  id Int @id @default(autoincrement())

  // Tenant affected (who would have received this email)
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Email metadata
  fromEmail   String  @db.VarChar(255) // Who sent it
  toEmail     String  @db.VarChar(255) // Where it was sent
  subject     String  @db.VarChar(500)
  bodySnippet String? @db.Text // First 500 chars for context

  // Resend email ID (for cross-reference with Resend dashboard)
  resendEmailId String? @db.VarChar(100)

  // Why was it blocked?
  reason String @db.VarChar(50) // "malicious_content", "spam_detected", "rate_limit_exceeded", "sender_blocked"

  // Detailed context (JSON with specifics)
  // Examples:
  // - { "threats": ["http://phishing.com"], "threatTypes": ["SOCIAL_ENGINEERING"] }
  // - { "spamScore": 8, "flags": ["SPAM_KEYWORDS_SUBJECT", "ALL_CAPS_SUBJECT"] }
  // - { "count": 51, "limit": 50 }
  // - { "pattern": "*@spammer.com", "filterType": "BLOCK" }
  details Json?

  // When was it blocked?
  blockedAt DateTime @default(now())

  // Indexes for common queries
  @@index([tenantId, blockedAt])
  @@index([fromEmail, blockedAt])
  @@index([reason, blockedAt])
  @@index([blockedAt])
  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Buyer CRM (P4) - Sales pipeline to track prospective horse buyers
// ─────────────────────────────────────────────────────────────────────────────

/**
 * Buyer - A prospective horse purchaser
 * Links to Party for unified contact management (notes, events, activity all inherited)
 */
model Buyer {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Link to existing Party system for unified contact management
  partyId Int   @unique
  party   Party @relation("BuyerParty", fields: [partyId], references: [id], onDelete: Restrict)

  // Buyer-specific fields
  status         BuyerStatus @default(ACTIVE)
  source         String?     @db.VarChar(100) // "Referral", "Website", "Trade Show", etc.
  budget         Decimal?    @db.Decimal(12, 2)
  budgetCurrency String      @default("USD") @db.Char(3)
  notes          String?     @db.Text

  // Preferences
  preferredBreeds String[] // ["Thoroughbred", "Quarter Horse"]
  preferredUses   String[] // ["Racing", "Breeding", "Show"]
  preferredAgeMin Int?
  preferredAgeMax Int?
  preferredSex    Sex?

  // Relationships
  interests      BuyerInterest[]
  deals          Deal[]
  tagAssignments TagAssignment[]
  tasks          BuyerTask[]     @relation("BuyerTasks")

  // P4/P5: Links to old buyer systems for unified view
  breedingPlanBuyers   BreedingPlanBuyer[]   @relation("BreedingPlanBuyerCRM")
  offspringGroupBuyers OffspringGroupBuyer[] @relation("OffspringGroupBuyerCRM")
  waitlistEntries      WaitlistEntry[]       @relation("WaitlistEntryCRM")

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime?

  @@index([tenantId])
  @@index([partyId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, archivedAt])
  @@schema("public")
}

/**
 * BuyerInterest - Links buyers to specific horses they're interested in
 */
model BuyerInterest {
  id       Int    @id @default(autoincrement())
  buyerId  Int
  buyer    Buyer  @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  animalId Int
  animal   Animal @relation("BuyerInterestAnimal", fields: [animalId], references: [id], onDelete: Cascade)

  level InterestLevel @default(INTERESTED)
  notes String?       @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([buyerId, animalId])
  @@index([buyerId])
  @@index([animalId])
  @@index([level])
  @@schema("public")
}

/**
 * Deal - A sales opportunity in the pipeline
 */
model Deal {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  buyerId  Int
  buyer    Buyer   @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  animalId Int? // Optional - may be general inquiry
  animal   Animal? @relation("DealAnimal", fields: [animalId], references: [id], onDelete: SetNull)

  name  String    @db.VarChar(255) // "John Smith - Starlight Purchase"
  stage DealStage @default(INQUIRY)

  // Financials
  askingPrice Decimal? @db.Decimal(12, 2)
  offerPrice  Decimal? @db.Decimal(12, 2)
  finalPrice  Decimal? @db.Decimal(12, 2)
  currency    String   @default("USD") @db.Char(3)

  // Dates
  expectedCloseDate DateTime?
  closedAt          DateTime?

  // Outcome
  outcome    DealOutcome?
  lostReason String?      @db.VarChar(500)

  notes String? @db.Text

  // Relationships
  activities     DealActivity[]
  tagAssignments TagAssignment[]
  tasks          BuyerTask[]     @relation("DealTasks")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([buyerId])
  @@index([animalId])
  @@index([stage])
  @@index([tenantId, stage])
  @@index([tenantId, buyerId])
  @@index([outcome])
  @@schema("public")
}

/**
 * DealActivity - Log of interactions on a deal
 * Separate from PartyActivity since deals aren't parties
 */
model DealActivity {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  dealId Int
  deal   Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  type        DealActivityType
  title       String           @db.VarChar(255)
  description String?          @db.Text

  // For scheduled activities
  scheduledAt DateTime?
  completedAt DateTime?

  // Who performed the activity
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([dealId])
  @@index([type])
  @@index([dealId, createdAt])
  @@schema("public")
}

/**
 * BuyerEmailTemplate - Quick-response email templates for buyer communications
 * User-customizable templates (different from system Template model used for documents)
 */
model BuyerEmailTemplate {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name     String                     @db.VarChar(100) // "Initial Interest Response", "Follow-up After Viewing"
  subject  String                     @db.VarChar(255)
  bodyHtml String                     @db.Text
  bodyText String                     @db.Text
  category BuyerEmailTemplateCategory @default(GENERAL)

  // Usage tracking
  useCount   Int       @default(0)
  lastUsedAt DateTime?

  // Ordering and status
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, isActive])
  @@schema("public")
}

/**
 * BuyerTask - Tasks related to buyer/deal management
 * E.g., "Follow up with John Smith", "Schedule viewing for Starlight"
 */
model BuyerTask {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Task details
  title       String            @db.VarChar(255)
  description String?           @db.Text
  taskType    BuyerTaskType     @default(FOLLOW_UP)
  priority    BuyerTaskPriority @default(MEDIUM)
  status      BuyerTaskStatus   @default(PENDING)

  // Due date
  dueAt      DateTime?
  reminderAt DateTime? // When to send reminder notification

  // Relationships - at least one should be set
  buyerId  Int?
  buyer    Buyer?  @relation("BuyerTasks", fields: [buyerId], references: [id], onDelete: Cascade)
  dealId   Int?
  deal     Deal?   @relation("DealTasks", fields: [dealId], references: [id], onDelete: Cascade)
  animalId Int?
  animal   Animal? @relation("BuyerTaskAnimal", fields: [animalId], references: [id], onDelete: SetNull)

  // Assignment
  assignedToUserId String?
  assignedToUser   User?   @relation("BuyerTaskAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  // Completion tracking
  completedAt   DateTime?
  completedById String?
  completedBy   User?     @relation("BuyerTaskCompleter", fields: [completedById], references: [id], onDelete: SetNull)

  // Auto-generated task tracking (for automation)
  isAutoGenerated Boolean @default(false)
  automationRule  String? @db.VarChar(100) // e.g., "follow_up_after_inquiry"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, dueAt])
  @@index([buyerId])
  @@index([dealId])
  @@index([assignedToUserId])
  @@index([tenantId, status, dueAt])
  @@schema("public")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Registry Integration (P6 Sprint)
 * OAuth connections, verification, pedigree import
 * ────────────────────────────────────────────────────────────────────────────
 */

enum RegistryConnectionStatus {
  DISCONNECTED
  CONNECTING
  CONNECTED
  ERROR
  TOKEN_EXPIRED

  @@schema("public")
}

enum VerificationMethod {
  API // Verified via registry API
  MANUAL // Manually verified by user/admin
  DOCUMENT // Verified via uploaded document

  @@schema("public")
}

enum VerificationConfidence {
  HIGH // Strong match (API verification or document review)
  MEDIUM // Partial match (name similar but not exact)
  LOW // Weak match (only identifier format validated)
  NONE // Not verified

  @@schema("public")
}

// Registry API connection config per tenant
model RegistryConnection {
  id         Int      @id @default(autoincrement())
  tenantId   Int
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  registryId Int
  registry   Registry @relation(fields: [registryId], references: [id], onDelete: Cascade)

  status RegistryConnectionStatus @default(DISCONNECTED)

  // OAuth tokens (encrypted in production via application layer)
  accessToken    String?   @db.Text
  refreshToken   String?   @db.Text
  tokenExpiresAt DateTime?

  // API credentials (for non-OAuth registries)
  apiKey    String?
  apiSecret String?

  // Connection metadata
  connectedAt  DateTime?
  lastSyncAt   DateTime?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, registryId])
  @@index([tenantId])
  @@index([registryId])
  @@schema("public")
}

// Verification status for existing AnimalRegistryIdentifier
model RegistryVerification {
  id                         Int                      @id @default(autoincrement())
  animalRegistryIdentifierId Int                      @unique
  animalRegistryIdentifier   AnimalRegistryIdentifier @relation(fields: [animalRegistryIdentifierId], references: [id], onDelete: Cascade)

  verified   Boolean                @default(false)
  verifiedAt DateTime?
  method     VerificationMethod?
  confidence VerificationConfidence @default(NONE)

  // Data returned from registry (if API verification)
  registryData Json? @db.JsonB

  // Document evidence (if manual/document verification)
  documentUrl   String? @db.Text // S3/storage URL for uploaded document
  documentNotes String? @db.Text // Notes about verification

  // Who performed manual verification
  verifiedByUserId String?
  verifiedByUser   User?   @relation("RegistryVerificationVerifier", fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([verified])
  @@schema("public")
}

// Pedigree data from registry (separate from our lineage system)
model RegistryPedigree {
  id                         Int                      @id @default(autoincrement())
  animalRegistryIdentifierId Int
  animalRegistryIdentifier   AnimalRegistryIdentifier @relation(fields: [animalRegistryIdentifierId], references: [id], onDelete: Cascade)

  generation Int // 1 = parents, 2 = grandparents, etc.
  position   String // "sire", "dam", "sire_sire", "sire_dam", "dam_sire", "dam_dam", etc.

  // Registry data for ancestor
  registrationNumber String?
  name               String
  color              String?
  birthYear          Int?
  sex                String? // "M", "F", "G" (gelding)

  // Link to animal if exists in our system
  linkedAnimalId Int?
  linkedAnimal   Animal? @relation("RegistryPedigreeLinkedAnimal", fields: [linkedAnimalId], references: [id], onDelete: SetNull)

  // Raw data from registry
  rawData Json? @db.JsonB

  createdAt DateTime @default(now())

  @@unique([animalRegistryIdentifierId, position])
  @@index([animalRegistryIdentifierId])
  @@index([linkedAnimalId])
  @@schema("public")
}

// Audit log for registry operations
model RegistrySyncLog {
  id         Int    @id @default(autoincrement())
  tenantId   Int
  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  registryId Int

  action String // "verify", "import_pedigree", "refresh_token", "lookup"
  status String // "success", "error", "pending"

  // Optional references
  animalId   Int?
  identifier String?

  // Request/response data
  requestData  Json?   @db.JsonB
  responseData Json?   @db.JsonB
  errorMessage String? @db.Text

  // Performance tracking
  durationMs Int?

  // User who initiated the action
  initiatedByUserId String?
  initiatedByUser   User?   @relation("RegistrySyncLogInitiator", fields: [initiatedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, registryId])
  @@index([createdAt])
  @@index([action])
  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Microchip Registry Tracking
// ─────────────────────────────────────────────────────────────────────────────

enum MicrochipRenewalType {
  LIFETIME // No renewal needed (FreePetChipRegistry, AKC Reunite)
  ANNUAL // Yearly renewal (HomeAgain, 24PetWatch)
  UNKNOWN // User-entered registry, renewal unknown

  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Nutrition & Food Tracking Enums
// ─────────────────────────────────────────────────────────────────────────────

enum FoodType {
  DRY
  WET
  RAW
  FRESH
  FREEZE_DRIED
  SUPPLEMENT
  TREAT
  OTHER

  @@schema("public")
}

enum LifeStage {
  PUPPY // Young dogs, kittens, foals
  JUNIOR // Transitional stage
  ADULT
  SENIOR
  ALL_STAGES // Suitable for all life stages
  BREEDING // Breeding/gestation formula
  PERFORMANCE // High activity/working animals

  @@schema("public")
}

enum FoodChangeReason {
  LIFE_STAGE // Age-based transition
  HEALTH_ISSUE // Allergies, digestive issues, medical condition
  VET_RECOMMENDATION // Veterinary advice
  AVAILABILITY // Product discontinued or unavailable
  COST_OPTIMIZATION // Budget considerations
  PERFORMANCE // Athletic/working animal needs
  PREFERENCE // Animal preference or palatability
  OTHER

  @@schema("public")
}

enum SuccessRating {
  EXCELLENT // Perfect transition, no issues
  GOOD // Minor issues, overall success
  FAIR // Some problems but manageable
  POOR // Significant issues, may need to reconsider

  @@schema("public")
}

// Lookup table of known microchip registries (seeded data)
model MicrochipRegistry {
  id          Int                  @id @default(autoincrement())
  name        String // Display name: "HomeAgain", "AKC Reunite"
  slug        String               @unique // URL-safe: "homeagain", "akc-reunite"
  website     String? // "https://www.homeagain.com"
  renewalType MicrochipRenewalType @default(UNKNOWN)
  species     String[] // ["DOG", "CAT", "HORSE", "ALL"]
  isActive    Boolean              @default(true)
  sortOrder   Int                  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  registrations AnimalMicrochipRegistration[]

  @@index([isActive, sortOrder])
  @@schema("public")
}

// Tracks an animal's microchip registration with a specific registry
model AnimalMicrochipRegistration {
  id       Int @id @default(autoincrement())
  tenantId Int

  // Polymorphic link - one of these will be set
  animalId    Int? // FK to Animal (adult animals)
  offspringId Int? // FK to Offspring (litter offspring)

  microchipNumber String // The actual chip number (denormalized for display)
  registryId      Int // FK to MicrochipRegistry

  registrationDate      DateTime? // When registered with this registry
  expirationDate        DateTime? // Null for lifetime registrations
  accountNumber         String? // Registry's confirmation/account number
  registeredToContactId Int? // FK to Contact (current owner/buyer)
  notes                 String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animal       Animal?           @relation("AnimalMicrochipRegistrations", fields: [animalId], references: [id], onDelete: Cascade)
  offspring    Offspring?        @relation("OffspringMicrochipRegistrations", fields: [offspringId], references: [id], onDelete: Cascade)
  registry     MicrochipRegistry @relation(fields: [registryId], references: [id])
  registeredTo Contact?          @relation("MicrochipRegisteredTo", fields: [registeredToContactId], references: [id], onDelete: SetNull)

  @@unique([tenantId, animalId, registryId], name: "unique_animal_registry")
  @@unique([tenantId, offspringId, registryId], name: "unique_offspring_registry")
  @@index([tenantId, expirationDate])
  @@index([registeredToContactId])
  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Supplement Tracking
// ─────────────────────────────────────────────────────────────────────────────

/**
 * SupplementProtocol - Stores supplement protocol templates
 * Can be system benchmark protocols (tenantId = null) or tenant custom protocols
 */
model SupplementProtocol {
  id       Int     @id @default(autoincrement())
  tenantId Int? // null = system benchmark protocol
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Basic Info
  name        String
  description String?   @db.Text
  species     Species[]

  // Benchmark Metadata (for system protocols)
  isBenchmark     Boolean @default(false)
  benchmarkSource String? // e.g., "AAEP Guidelines", "Canine Reproduction Standards"
  benchmarkNotes  String? @db.Text

  // Dosage Information (informational only - requires disclaimer)
  dosageAmount        String? // e.g., "0.044 mg/kg"
  dosageUnit          String? // e.g., "ml", "mg/kg", "tablets"
  administrationRoute String? // e.g., "oral", "injection", "topical"

  // Trigger Configuration
  triggerType SupplementTriggerType

  // For BREEDING_CYCLE_RELATIVE triggers
  anchorEvent BreedingCycleAnchorEvent?
  offsetDays  Int? // Negative = before, Positive = after (e.g., -63 = 63 days before)

  // For AGE_BASED triggers
  ageTriggerWeeks Int?

  // Duration & Frequency
  durationDays Int? // null = single dose or ONGOING
  frequency    SupplementFrequency @default(DAILY)

  // Notification Settings
  reminderDaysBefore Int[] @default([7, 3, 1])

  // Status
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schedules SupplementSchedule[]

  @@index([tenantId])
  @@index([tenantId, active])
  @@index([isBenchmark])
  @@schema("public")
}

/**
 * SupplementSchedule - Links a protocol to an animal, optionally tied to a breeding plan
 */
model SupplementSchedule {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Links
  protocolId     Int
  protocol       SupplementProtocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  breedingPlanId Int? // null = standalone
  breedingPlan   BreedingPlan?      @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)
  animalId       Int
  animal         Animal             @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // Mode
  mode SupplementScheduleMode

  // Dates
  calculatedStartDate DateTime
  calculatedEndDate   DateTime?
  startDateOverride   DateTime? // User override
  nextDueDate         DateTime? // Calculated from frequency

  // Tracking
  status             SupplementScheduleStatus @default(NOT_STARTED)
  completedDoses     Int                      @default(0)
  totalDoses         Int? // null for ONGOING
  lastAdministeredAt DateTime?

  // Disclaimer Acknowledgment (CRITICAL for liability protection)
  disclaimerAcknowledgedAt DateTime?
  disclaimerAcknowledgedBy String? // userId

  // Metadata
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  administrations SupplementAdministration[]

  @@index([tenantId])
  @@index([breedingPlanId])
  @@index([animalId])
  @@index([status, calculatedStartDate])
  @@index([status, nextDueDate])
  @@schema("public")
}

/**
 * SupplementAdministration - Records individual supplement doses administered
 */
model SupplementAdministration {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Links
  scheduleId Int
  schedule   SupplementSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  animalId   Int
  animal     Animal             @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // Administration Details
  administeredAt DateTime
  actualDosage   String? // Override if different from protocol
  givenBy        String?
  doseNumber     Int? // e.g., "dose 3 of 7"

  // Metadata
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scheduleId])
  @@index([animalId])
  @@index([administeredAt])
  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Nutrition & Food Tracking
// ─────────────────────────────────────────────────────────────────────────────

/**
 * FoodProduct - Food products available for feeding animals
 * Stores nutritional info, cost data, and species compatibility
 */
model FoodProduct {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Basic Info
  name      String
  brand     String?
  sku       String? // Product SKU or barcode
  foodType  FoodType
  species   Species[] // Compatible species
  lifeStage LifeStage? // Target life stage (null = all stages)
  photoUrl  String?    @db.Text

  // Packaging & Cost (stored in cents for precision)
  bagSizeOz      Int? // Bag/package size in ounces
  costCents      Int? // Cost per bag in cents
  costPerOzCents Int? // Calculated: costCents / bagSizeOz
  servingSizeOz  Float? // Recommended serving size in ounces

  // Nutritional Information
  proteinPct     Float? // Protein percentage
  fatPct         Float? // Fat percentage
  fiberPct       Float? // Fiber percentage
  caloriesPerCup Int? // Calories per cup (for kibble)

  // Status
  isActive   Boolean @default(true) // Available for new plans
  isArchived Boolean @default(false) // Soft deleted

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  feedingPlans   FeedingPlan[]
  feedingRecords FeedingRecord[]
  expenses       Expense[] // Purchases linked to this product

  @@index([tenantId])
  @@index([tenantId, foodType])
  @@index([tenantId, isActive])
  @@index([tenantId, species])
  @@schema("public")
}

/**
 * FeedingPlan - Links a food product to an animal with feeding schedule
 * Tracks portion sizes, feeding times, and auto-expense settings
 */
model FeedingPlan {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Links - either animalId OR offspringGroupId (one required, not both)
  animalId         Int?
  animal           Animal?         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  foodProductId    Int
  foodProduct      FoodProduct     @relation(fields: [foodProductId], references: [id], onDelete: Restrict)

  // Feeding Configuration
  portionOz      Float // Portion size per feeding in ounces
  feedingsPerDay Int      @default(2) // Number of feedings per day
  feedingTimes   String[] // e.g., ["07:00", "18:00"]

  // Date Range
  startDate DateTime
  endDate   DateTime? // Null = ongoing/active

  // Settings
  autoCreateExpense Boolean @default(false) // Auto-create expense on feeding log
  isActive          Boolean @default(true) // Current active plan

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  feedingRecords  FeedingRecord[]
  foodChangesTo   FoodChange[]    @relation("FoodChangeNewPlan")
  foodChangesFrom FoodChange[]    @relation("FoodChangePrevPlan")

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([tenantId, animalId, isActive])
  @@index([tenantId, offspringGroupId])
  @@index([tenantId, offspringGroupId, isActive])
  @@index([animalId, startDate])
  @@index([offspringGroupId, startDate])
  @@schema("public")
}

/**
 * FeedingRecord - Individual feeding log entries
 * Tracks actual feedings, skipped meals, appetite scores
 */
model FeedingRecord {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Links - either animalId OR offspringGroupId (one required, not both)
  animalId         Int?
  animal           Animal?         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  feedingPlanId    Int? // May be null for ad-hoc feedings
  feedingPlan      FeedingPlan?    @relation(fields: [feedingPlanId], references: [id], onDelete: SetNull)
  foodProductId    Int? // Preserved if plan deleted
  foodProduct      FoodProduct?    @relation(fields: [foodProductId], references: [id], onDelete: SetNull)

  // Feeding Details
  fedAt     DateTime // When the feeding occurred
  portionOz Float? // Actual portion (may differ from plan)
  costCents Int? // Calculated cost for this feeding

  // Tracking
  skipped       Boolean @default(false) // Was the feeding skipped?
  skipReason    String? // Reason if skipped
  appetiteScore Int? // 1-5 scale (1=poor, 5=excellent)

  // Expense Integration
  expenseId Int? @unique // FK to Expense if auto-created

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([tenantId, animalId, fedAt])
  @@index([tenantId, offspringGroupId])
  @@index([tenantId, offspringGroupId, fedAt])
  @@index([fedAt])
  @@schema("public")
}

/**
 * FoodChange - Records food transitions with outcomes
 * Tracks why food changed, transition protocol, and success rating
 */
model FoodChange {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Links - either animalId OR offspringGroupId (one required, not both)
  animalId         Int?
  animal           Animal?         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  previousPlanId   Int? // Previous feeding plan (null if first food)
  previousPlan     FeedingPlan?    @relation("FoodChangePrevPlan", fields: [previousPlanId], references: [id], onDelete: SetNull)
  newPlanId        Int
  newPlan          FeedingPlan     @relation("FoodChangeNewPlan", fields: [newPlanId], references: [id], onDelete: Cascade)

  // Change Details
  changeDate    DateTime // When the change was made
  changeReason  FoodChangeReason
  reasonDetails String?          @db.Text // Additional details about reason

  // Transition Protocol
  transitionDays  Int? // Days for gradual transition
  transitionNotes String? @db.Text // How to transition (e.g., "25% new food days 1-3")

  // Outcomes (filled in after transition)
  reactions      String?        @db.Text // Any adverse reactions observed
  digestiveNotes String?        @db.Text // Stool quality, digestive issues
  overallSuccess SuccessRating? // Overall transition success

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([tenantId, offspringGroupId])
  @@index([animalId, changeDate])
  @@index([offspringGroupId, changeDate])
  @@schema("public")
}

// ─────────────────────────────────────────────────────────────────────────────
// Breeding Discovery (Phase 2): New Models
// ─────────────────────────────────────────────────────────────────────────────

model BreederProfile {
  id       Int    @id @default(autoincrement())
  tenantId Int    @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Attributes
  registryAffiliations String[]
  primaryRegistry      String?
  breedingLineTypes    String[]
  breedingPhilosophy   String?   @db.Text
  requiresHealthTesting Boolean  @default(false)
  requiresContract     Boolean   @default(false)
  requiredTests        String[]

  // Exclusions
  excludedRegistries String[]
  excludedLineTypes  String[]
  excludedAttributes String[]
  exclusionNotes     String? @db.Text

  // Visibility toggles
  showRegistryAffiliations Boolean @default(true)
  showBreedingLineTypes    Boolean @default(true)
  showRequirements         Boolean @default(true)

  // Public info
  publicBio  String? @db.Text
  websiteUrl String?
  socialLinks Json?  @db.JsonB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

model BreedingDiscoveryProgram {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  programNumber String @unique
  name          String
  description   String? @db.Text

  species     Species
  programType String // e.g., "stud_service", "breeding_program", "co_own"

  // Defaults inherited by listings
  defaultBreedingMethods       String[]
  defaultGuaranteeType         String?
  defaultGuaranteeTerms        String? @db.Text
  defaultRequiresHealthTesting Boolean  @default(false)
  defaultRequiredTests         String[]
  defaultRequiresContract      Boolean  @default(false)

  // Public marketplace settings
  publicEnabled     Boolean   @default(false)
  publicSlug        String?   @unique
  publicEnabledAt   DateTime?
  publicHeadline    String?
  publicDescription String?   @db.Text
  media             String[]

  // Location
  locationCity    String?
  locationState   String?
  locationCountry String?

  status BreedingProgramStatus @default(ACTIVE)

  // Relations
  listings BreedingListing[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, status])
  @@index([publicEnabled, status])
  @@index([publicSlug])
  @@schema("public")
}

model BreedingListing {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  listingNumber String @unique

  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id])

  programId Int?
  program   BreedingDiscoveryProgram? @relation(fields: [programId], references: [id], onDelete: SetNull)

  species Species
  breed   String?
  sex     Sex

  intent BreedingListingIntent

  headline    String
  description String? @db.Text
  media       String[]

  // Pricing
  feeCents     Int?
  feeDirection BreedingListingFeeDirection?
  feeNotes     String? @db.Text

  // Availability
  availableFrom   DateTime?
  availableTo     DateTime?
  seasonName      String?
  breedingMethods String[]
  maxBookings     Int?
  currentBookings Int @default(0)

  // Guarantee
  guaranteeType  String?
  guaranteeTerms String? @db.Text

  // Requirements
  requiresHealthTesting  Boolean  @default(false)
  requiredTests          String[]
  requiresContract       Boolean  @default(false)
  additionalRequirements String?  @db.Text

  // Lifecycle
  status      BreedingListingStatus @default(DRAFT)
  publishedAt DateTime?
  pausedAt    DateTime?
  closedAt    DateTime?
  closedReason String?

  // Public marketplace settings
  publicEnabled             Boolean   @default(false)
  publicSlug                String?   @unique
  publicEnabledAt           DateTime?
  publicShowPedigree        Boolean   @default(true)
  publicPedigreeDepth       Int       @default(2)
  publicShowTitles          Boolean   @default(true)
  publicShowHealthTesting   Boolean   @default(true)
  publicShowLineType        Boolean   @default(true)
  publicShowProducingStats  Boolean   @default(false)
  publicShowBreederName     Boolean   @default(true)
  publicShowBreederLocation Boolean   @default(true)
  publicShowFee             Boolean   @default(true)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Inquiry settings
  acceptInquiries    Boolean @default(true)
  inquiryEmail       String?
  inquiryPhone       String?
  inquiryInstructions String? @db.Text

  // Counters
  viewCount    Int @default(0)
  inquiryCount Int @default(0)
  bookingCount Int @default(0)

  // Location
  locationCity    String?
  locationState   String?
  locationCountry String?
  locationLat     Float?
  locationLng     Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int?

  // Relations
  inquiries BreedingInquiry[]
  bookings  BreedingBooking[]

  @@index([tenantId, status])
  @@index([species, breed, status])
  @@index([species, intent, status])
  @@index([publicEnabled, status])
  @@index([publicSlug])
  @@index([locationState, species])
  @@index([animalId])
  @@index([programId])
  @@schema("public")
}

model BreedingInquiry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  listingId Int
  listing   BreedingListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // Inquirer info
  inquirerName  String
  inquirerEmail String
  inquirerPhone String?
  inquirerType  String // e.g., "breeder", "owner", "agent"
  isBreeder     Boolean @default(false)

  // Content
  message            String @db.Text
  interestedInMethod String?

  // Status
  status    BreedingInquiryStatus @default(NEW)
  readAt    DateTime?
  repliedAt DateTime?

  // Conversion tracking
  convertedToUserId    Int?
  convertedToBookingId Int?
  convertedAt          DateTime?

  // Attribution
  referrerUrl String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  createdAt DateTime @default(now())

  @@index([tenantId, status])
  @@index([listingId])
  @@index([inquirerEmail])
  @@schema("public")
}

model BreedingBooking {
  id            Int    @id @default(autoincrement())
  bookingNumber String @unique

  // Source
  sourceListingId Int?
  sourceListing   BreedingListing? @relation(fields: [sourceListingId], references: [id], onDelete: SetNull)
  sourceInquiryId Int?

  // Offering side (the breeder offering the animal)
  offeringTenantId Int
  offeringTenant   Tenant @relation("OfferingBookings", fields: [offeringTenantId], references: [id])
  offeringAnimalId Int
  offeringAnimal   Animal @relation("OfferingAnimal", fields: [offeringAnimalId], references: [id])

  // Seeking side (the party requesting breeding)
  seekingPartyId  Int
  seekingParty    Party  @relation(fields: [seekingPartyId], references: [id])
  seekingTenantId Int?
  seekingTenant   Tenant? @relation("SeekingBookings", fields: [seekingTenantId], references: [id])
  seekingAnimalId Int?
  seekingAnimal   Animal? @relation("SeekingAnimal", fields: [seekingAnimalId], references: [id])

  // External animal info (when seeking animal not in system)
  externalAnimalName  String?
  externalAnimalReg   String?
  externalAnimalBreed String?
  externalAnimalSex   String?

  species     Species
  bookingType BreedingBookingType

  // Scheduling
  preferredMethod    String?
  preferredDateStart DateTime?
  preferredDateEnd   DateTime?
  scheduledDate      DateTime?

  // Shipping
  shippingRequired Boolean @default(false)
  shippingAddress  String? @db.Text

  // Pricing
  agreedFeeCents Int
  depositCents   Int @default(0)
  totalPaidCents Int @default(0)
  feeDirection   BreedingListingFeeDirection

  // Status
  status          BreedingBookingStatus @default(INQUIRY)
  statusChangedAt DateTime              @default(now())

  // Requirements
  requirements       Json? @db.JsonB
  requirementsConfig String?

  // Guarantee
  guaranteeType String?

  // Link to BreedingPlan
  breedingPlanId Int?          @unique
  breedingPlan   BreedingPlan? @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)

  // Semen inventory linkage (for shipped semen bookings)
  semenUsageId Int?         @unique
  semenUsage   SemenUsage?  @relation(fields: [semenUsageId], references: [id], onDelete: SetNull)

  // Outcome tracking
  outcomeRecordedAt DateTime?
  outcomeType       String?   @db.VarChar(50)

  // Notes
  notes         String? @db.Text
  internalNotes String? @db.Text

  // Audit
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  cancelledAt        DateTime?
  cancellationReason String?

  @@index([offeringTenantId, status])
  @@index([seekingTenantId, status])
  @@index([sourceListingId])
  @@index([seekingPartyId])
  @@index([offeringAnimalId])
  @@schema("public")
}

// ═══════════════════════════════════════════════════════════════════════════════
// Animal Breeding Profile - User-entered breeding preferences and history
// ═══════════════════════════════════════════════════════════════════════════════

model AnimalBreedingProfile {
  id       Int    @id @default(autoincrement())
  tenantId Int
  animalId Int    @unique

  // Status
  breedingStatus  String    @default("INTACT") // INTACT, PROVEN, RETIRED, NEUTERED, SUSPECTED_ISSUES, UNDER_EVALUATION
  statusNotes     String?   @db.Text
  statusChangedAt DateTime?

  // Preferences (all animals)
  environmentPreference String?  @db.VarChar(50) // INDOOR_ONLY, OUTDOOR_ONLY, EITHER, SPECIFIC_LOCATION
  environmentNotes      String?  @db.Text
  temperament           String?  @db.VarChar(50) // CALM, RECEPTIVE, EAGER, NERVOUS, AGGRESSIVE, REQUIRES_ASSISTANCE, VARIABLE
  temperamentNotes      String?  @db.Text
  specialRequirements   String?  @db.Text
  generalNotes          String?  @db.Text

  // Male-specific fields
  libido                  String?   @db.VarChar(20) // HIGH, MEDIUM, LOW, VARIABLE, UNKNOWN
  libidoNotes             String?   @db.Text
  serviceType             String?   @db.VarChar(20) // NATURAL_ONLY, AI_ONLY, BOTH, UNKNOWN
  collectionTrained       Boolean?
  collectionNotes         String?   @db.Text
  fertilityStatus         String?   @db.VarChar(20) // PROVEN, UNPROVEN, SUSPECTED_LOW, CONFIRMED_LOW, UNKNOWN
  lastFertilityTestDate   DateTime? @db.Date
  lastFertilityTestResult String?   @db.Text
  fertilityNotes          String?   @db.Text

  // Female-specific fields
  heatCycleRegularity    String?   @db.VarChar(20) // REGULAR, IRREGULAR, SILENT, SPLIT, UNKNOWN
  avgCycleLengthDays     Int?
  lastHeatDate           DateTime? @db.Date
  heatNotes              String?   @db.Text
  pregnancyComplications String?   @db.Text
  proneToComplications   Boolean   @default(false)
  naturalBirthCount      Int       @default(0)
  cSectionCount          Int       @default(0)
  cSectionNotes          String?   @db.Text
  lastBirthType          String?   @db.VarChar(20) // NATURAL, C_SECTION
  lastBirthDate          DateTime? @db.Date
  maternalRating         String?   @db.VarChar(20) // EXCELLENT, GOOD, FAIR, POOR, UNKNOWN
  maternalNotes          String?   @db.Text
  milkProduction         String?   @db.VarChar(20) // ABUNDANT, SUFFICIENT, INSUFFICIENT, NONE, UNKNOWN
  mastitisHistory        Boolean   @default(false)
  milkNotes              String?   @db.Text
  recoveryPattern        String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant            Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animal            Animal                  @relation(fields: [animalId], references: [id], onDelete: Cascade)
  incompatibilities AnimalIncompatibility[]

  @@index([tenantId, animalId])
  @@index([tenantId, breedingStatus])
  @@schema("public")
}

model AnimalIncompatibility {
  id                   Int      @id @default(autoincrement())
  tenantId             Int
  profileId            Int
  incompatibleAnimalId Int

  reason     String   @db.VarChar(500)
  severity   String   @default("AVOID") @db.VarChar(20) // AVOID, CAUTION
  recordedAt DateTime @default(now())
  recordedBy String?  @db.VarChar(255)

  // Relations
  tenant             Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profile            AnimalBreedingProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  incompatibleAnimal Animal                @relation("IncompatibleWith", fields: [incompatibleAnimalId], references: [id], onDelete: Cascade)

  @@unique([profileId, incompatibleAnimalId])
  @@index([tenantId])
  @@index([profileId])
  @@schema("public")
}

model BreedingEvent {
  id       Int @id @default(autoincrement())
  tenantId Int
  animalId Int

  eventType  String   @db.VarChar(50) // BREEDING_ATTEMPT, SUCCESSFUL_BREEDING, FAILED_BREEDING, PREGNANCY_CONFIRMED, PREGNANCY_LOSS, BIRTH_OUTCOME, FERTILITY_TEST, HEAT_CYCLE, BEHAVIORAL_NOTE, VET_CONSULTATION, INCOMPATIBILITY, OTHER
  occurredAt DateTime
  outcome    String?  @db.VarChar(30) // SUCCESSFUL, UNSUCCESSFUL, PARTIAL, PENDING, NOT_APPLICABLE

  // Related entities
  breedingPlanId  Int?
  partnerAnimalId Int?

  // Details
  title       String? @db.VarChar(200)
  description String? @db.Text

  // For breeding attempts
  serviceType        String? @db.VarChar(20) // NATURAL, AI
  tieDurationMinutes Int?

  // For birth outcomes
  totalBorn    Int?
  bornAlive    Int?
  stillborn    Int?
  deliveryType String? @db.VarChar(20) // NATURAL, C_SECTION, ASSISTED

  // For fertility tests
  testType   String? @db.VarChar(100)
  testResult String? @db.Text

  createdAt DateTime @default(now())
  createdBy String?  @db.VarChar(255)
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animal        Animal        @relation("BreedingEvents", fields: [animalId], references: [id], onDelete: Cascade)
  breedingPlan  BreedingPlan? @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)
  partnerAnimal Animal?       @relation("PartnerBreedingEvents", fields: [partnerAnimalId], references: [id], onDelete: SetNull)

  @@index([tenantId, animalId, occurredAt])
  @@index([tenantId, eventType])
  @@index([breedingPlanId])
  @@schema("public")
}
