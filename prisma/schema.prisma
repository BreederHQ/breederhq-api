generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Core enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum PartyType {
  CONTACT
  ORGANIZATION
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum AnimalStatus {
  ACTIVE
  BREEDING
  UNAVAILABLE
  RETIRED
  DECEASED
  PROSPECT
}

enum Species {
  DOG
  CAT
  HORSE
  GOAT
  RABBIT
  SHEEP
}

enum TenantOperationType {
  HOBBY
  COMMERCIAL
  PERFORMANCE
}

enum HorseIntendedUse {
  BREEDING
  SHOW
  RACING
}

enum HorseValuationSource {
  PRIVATE_SALE
  AUCTION
  APPRAISAL
  INSURANCE
  OTHER
}

enum OwnershipChangeKind {
  SALE
  SYNDICATION
  TRANSFER
  LEASE
  DEATH
  OTHER
}

enum PaymentIntentStatus {
  PLANNED
  EXTERNAL
  COMPLETED
  CANCELED
}

enum PaymentIntentPurpose {
  DEPOSIT
  PURCHASE
  STUD_FEE
  BOARDING
  TRAINING
  OTHER
}

enum Sex {
  FEMALE
  MALE
}

enum TagModule {
  CONTACT
  ORGANIZATION
  ANIMAL
  WAITLIST_ENTRY
  OFFSPRING_GROUP
  OFFSPRING
}

enum OwnerPartyType {
  Organization
  Contact
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
  VIEWER
}

// New enums for unified tenant membership model (STAFF vs CLIENT)
enum TenantMembershipRole {
  STAFF   // Staff member (maps from OWNER/ADMIN/MEMBER/BILLING/VIEWER)
  CLIENT  // Portal client (created via invite acceptance)
}

enum TenantMembershipStatus {
  INVITED    // Invite sent, not yet accepted
  ACTIVE     // Full access
  SUSPENDED  // Access revoked
}

enum ShareScope {
  VIEW
  BREED_PLAN
}

enum ShareStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum VerificationPurpose {
  VERIFY_EMAIL
  RESET_PASSWORD
  INVITE
  OTHER
}

enum PortalAccessStatus {
  NO_ACCESS
  INVITED
  ACTIVE
  SUSPENDED
}

// User entitlement enums for marketplace and other feature access
enum EntitlementKey {
  MARKETPLACE_ACCESS  // Access to marketplace surface
}

enum EntitlementStatus {
  ACTIVE   // Entitlement granted and active
  REVOKED  // Entitlement revoked
}

enum CommChannel {
  EMAIL
  SMS
  PHONE
  MAIL
  WHATSAPP
}

enum PreferenceLevel {
  ALLOW
  NOT_PREFERRED
  NEVER
}

enum ComplianceStatus {
  SUBSCRIBED
  UNSUBSCRIBED
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Trait system enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum TraitValueType {
  BOOLEAN
  ENUM
  NUMBER
  DATE
  TEXT
  JSON
}

enum TraitSource {
  SELF_REPORTED
  VET
  LAB
  REGISTRY
}

enum TraitStatus {
  NOT_PROVIDED
  PROVIDED
  PENDING
  PASS
  FAIL
}

enum DocVisibility {
  PRIVATE
  BUYERS
  PUBLIC
}

enum DocStatus {
  PLACEHOLDER
  UPLOADING
  READY
  FAILED
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding additions: enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum BreedingPlanStatus {
  PLANNING
  COMMITTED
  CYCLE_EXPECTED
  HORMONE_TESTING
  BRED
  PREGNANT
  BIRTHED
  WEANED
  PLACEMENT
  COMPLETE
  CANCELED
}

enum BreedingMethod {
  NATURAL
  AI_TCI
  AI_SI
  AI_FROZEN
}

enum PregnancyCheckMethod {
  PALPATION
  ULTRASOUND
  RELAXIN_TEST
  XRAY
  OTHER
}

enum WaitlistStatus {
  INQUIRY
  DEPOSIT_DUE
  DEPOSIT_PAID
  READY
  ALLOCATED
  COMPLETED
  CANCELED
}

/**
 * Offspring Group linking state
 */
enum OffspringLinkState {
  linked
  orphan
  pending
}

enum OffspringLinkReason {
  legacy_import
  rescue
  accidental
  third_party
  cobreeder
  placeholder
  historical
  other
}

/**
 * Offspring lifecycle
 */
enum OffspringStatus {
  NEWBORN
  ALIVE
  WEANED
  PLACED
  DECEASED
}

enum OffspringLifeState {
  ALIVE
  DECEASED
}

enum OffspringPlacementState {
  UNASSIGNED
  OPTION_HOLD
  RESERVED
  PLACED
  RETURNED
  TRANSFERRED
}

enum OffspringKeeperIntent {
  AVAILABLE
  UNDER_EVALUATION
  WITHHELD
  KEEP
}

enum OffspringFinancialState {
  NONE
  DEPOSIT_PENDING
  DEPOSIT_PAID
  PAID_IN_FULL
  REFUNDED
  CHARGEBACK
}

enum OffspringPaperworkState {
  NONE
  SENT
  SIGNED
  COMPLETE
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Users & Auth
 * ────────────────────────────────────────────────────────────────────────────
 */

model User {
  id        String  @id @default(cuid())
  email     String  @unique @db.Citext
  name      String?
  firstName String
  lastName  String
  nickname  String?
  image     String?

  // auth
  passwordHash         String?
  passwordUpdatedAt    DateTime?
  mustChangePassword   Boolean   @default(false)
  passwordSetAt        DateTime?
  lastPasswordChangeAt DateTime?
  isSuperAdmin         Boolean   @default(false)
  emailVerifiedAt      DateTime?

  // profile / contact fields (user-scoped)
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)
  street       String?
  street2      String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @db.Char(2)

  // Party migration step 5: unified party reference for user profile
  partyId Int?
  party   Party? @relation("UserParty", fields: [partyId], references: [id], onDelete: SetNull)

  // org/tenant membership
  memberships       Membership[]
  tenantMemberships TenantMembership[]
  defaultTenantId   Int?
  defaultTenant     Tenant?            @relation(fields: [defaultTenantId], references: [id], onDelete: SetNull)

  // auth ancillaries
  Passkey           Passkey[]
  RecoveryCode      RecoveryCode[]
  Session           Session[]
  VerificationToken VerificationToken[]

  // auth/activity timestamps
  lastLoginAt DateTime?

  // breeding events authored
  BreedingPlanEvent BreedingPlanEvent[]

  // committed plans (optional backref)
  committedPlans BreedingPlan[] @relation("CommittedByUser")

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  Attachment          Attachment[]
  LitterEvent         LitterEvent[]
  OffspringGroupEvent OffspringGroupEvent[]
  OffspringEvent      OffspringEvent[]
  Task                Task[]
  HealthEvent         HealthEvent[]
  ContractParty       ContractParty[]

  // Portal access management
  portalAccesses          PortalAccess[] @relation("PortalAccessUser")
  portalAccessesCreatedBy PortalAccess[] @relation("PortalAccessCreatedBy")
  portalAccessesUpdatedBy PortalAccess[] @relation("PortalAccessUpdatedBy")
  portalInvites           PortalInvite[] @relation("PortalInviteUser")
  portalInvitesSentBy     PortalInvite[] @relation("PortalInviteSentBy")

  @@index([partyId])
  @@index([defaultTenantId])
  @@index([phoneE164])
  @@index([whatsappE164])
  @@index([country])

  // User entitlements (marketplace access, etc.)
  entitlements UserEntitlement[]
}

/**
 * UserEntitlement - Per-user feature access grants
 * Used for marketplace access and other user-level permissions.
 */
model UserEntitlement {
  id              Int               @id @default(autoincrement())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  key             EntitlementKey
  status          EntitlementStatus @default(ACTIVE)
  grantedAt       DateTime          @default(now())
  revokedAt       DateTime?
  grantedByUserId String?

  @@unique([userId, key])
  @@index([userId])
  @@index([key, status])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String? @unique
  tokenHash  String  @unique

  purpose VerificationPurpose @default(VERIFY_EMAIL)
  expires DateTime
  userId  String?
  User    User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@id([identifier, tokenHash])
  @@index([identifier, purpose])
}

model Passkey {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId String   @unique
  publicKey    String
  counter      Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model RecoveryCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String   @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Invitation {
  id             String         @id @default(cuid())
  email          String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  token          String         @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime       @default(now())
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organizationId])
}

model Invite {
  id             Int       @id @default(autoincrement())
  email          String
  organizationId Int?
  role           String    @default("STAFF")
  token          String    @unique
  expiresAt      DateTime
  consumedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([email])
  @@index([token])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Multi-tenancy & Orgs
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tenant {
  id           Int     @id @default(autoincrement())
  name         String
  slug         String? @unique
  primaryEmail String?

  operationType TenantOperationType @default(HOBBY)

  memberships    TenantMembership[]
  organizations  Organization[]
  contacts       Contact[]
  parties        Party[]
  animals        Animal[]
  billing        BillingAccount?
  sharesSent     AnimalShare[]         @relation("ShareFromTenant")
  sharesReceived AnimalShare[]         @relation("ShareToTenant")
  publicListings AnimalPublicListing[]
  User           User[]
  tags           Tag[]
  CustomBreed    CustomBreed[]

  // breeding additions
  breedingPlans      BreedingPlan[]
  reproductiveCycles ReproductiveCycle[]
  planSharesSent     BreedingPlanShare[] @relation("PlanShareFromTenant")
  planSharesReceived BreedingPlanShare[] @relation("PlanShareToTenant")
  planEvents         BreedingPlanEvent[]
  testResults        TestResult[]
  breedingAttempts   BreedingAttempt[]
  pregnancyChecks    PregnancyCheck[]
  litters            Litter[]
  offspringGroups    OffspringGroup[]
  offspring          Offspring[]
  waitlist           WaitlistEntry[]
  attachments        Attachment[]
  planParties        PlanParty[]
  planCodeCounters   PlanCodeCounter[]

  availabilityPrefs Json?

  settings TenantSetting[]

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  LitterEvent            LitterEvent[]
  OffspringGroupEvent    OffspringGroupEvent[]
  OffspringEvent         OffspringEvent[]
  OffspringGroupBuyer    OffspringGroupBuyer[]
  Invoice                Invoice[]
  InvoiceLineItem        InvoiceLineItem[]
  Payment                Payment[]
  Expense                Expense[]
  Sequence               Sequence[]
  IdempotencyKey         IdempotencyKey[]
  Campaign               Campaign[]
  CampaignAttribution    CampaignAttribution[]
  EmailSendLog           EmailSendLog[]
  MessageThread          MessageThread[]
  Task                   Task[]
  HealthEvent            HealthEvent[]
  Document               Document[]
  ContractTemplate       ContractTemplate[]
  Contract               Contract[]
  ContractParty          ContractParty[]
  SignatureEvent         SignatureEvent[]
  OffspringDocument      OffspringDocument[]
  OffspringContract      OffspringContract[]
  OffspringInvoiceLink   OffspringInvoiceLink[]
  accountingIntegrations AccountingIntegration[]
  AnimalOwnershipChange  AnimalOwnershipChange[]
  PaymentIntent          PaymentIntent[]
  AnimalTraitValue       AnimalTraitValue[]
  Template               Template[]
  AutoReplyRule          AutoReplyRule[]
  AutoReplyLog           AutoReplyLog[]
  portalAccesses         PortalAccess[]  @relation("PortalAccessTenant")
  portalInvites          PortalInvite[]  @relation("PortalInviteTenant")

  @@index([name])
}

model TenantMembership {
  userId   String
  tenantId Int
  role     TenantRole       @default(MEMBER)
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // New fields for unified membership model
  membershipRole   TenantMembershipRole   @default(STAFF)
  membershipStatus TenantMembershipStatus @default(ACTIVE)
  partyId          Int?                   // Links CLIENT memberships to their Party record

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, tenantId])
  @@index([tenantId])
  @@index([partyId])
  @@index([membershipRole, membershipStatus])
}

model BillingAccount {
  id               Int       @id @default(autoincrement())
  tenantId         Int       @unique
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider         String?
  customerId       String?
  subscriptionId   String?
  plan             String?
  status           String?
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Organization {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  partyId Int   @unique
  party   Party @relation("OrganizationParty", fields: [partyId], references: [id], onDelete: Cascade)

  name     String
  email    String?
  phone    String?
  website  String?
  street   String?
  street2  String?
  city     String?
  state    String?
  zip      String?
  country  String?
  archived Boolean @default(false)

  // Marketplace MVP: public program profile fields
  programSlug        String?
  isPublicProgram    Boolean @default(false)
  programBio         String? @db.Text
  publicContactEmail String?

  contacts            Contact[]
  animals             Animal[]       @relation("OrgAnimals")
  memberships         Membership[]
  createdCustomBreeds CustomBreed[]  @relation("CreatedByOrganization")
  breedingPlans       BreedingPlan[]
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  Invitation          Invitation[]
  externalProvider    String?
  externalId          String?

  @@unique([id, tenantId])
  @@unique([tenantId, name])
  @@unique([tenantId, programSlug])
  @@index([archived])
  @@index([name])
  @@index([tenantId])
  @@index([isPublicProgram])
}

model Membership {
  userId         String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([organizationId])
}

model Party {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  type PartyType

  // Unified list label
  name String

  // Shared comms
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Shared address
  street     String?
  street2    String?
  city       String?
  state      String?
  postalCode String?
  country    String? @db.Char(2)

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization         Organization?              @relation("OrganizationParty")
  contact              Contact?                   @relation("ContactParty")
  users                User[]                     @relation("UserParty")
  attachments          Attachment[]               @relation("AttachmentParty")
  tagAssignments       TagAssignment[]            @relation("TagAssignmentTaggedParty")
  breedingAttempts     BreedingAttempt[]          @relation("BreedingAttemptStudOwner")
  planParties          PlanParty[]                @relation("PlanPartyRole")
  waitlistEntries      WaitlistEntry[]            @relation("WaitlistParty")
  offspringGroupBuyers OffspringGroupBuyer[]      @relation("OffspringGroupBuyerParty")
  offspringBuyers      Offspring[]                @relation("OffspringBuyerParty")
  invoiceParties       Invoice[]                  @relation("InvoiceParty")
  contractParties      ContractParty[]            @relation("ContractPartyRole")
  offspringContracts   OffspringContract[]        @relation("OffspringContractBuyerParty")
  animalBuyers         Animal[]                   @relation("AnimalBuyerParty")
  animalOwnerships     AnimalOwner[]              @relation("AnimalOwnerParty")
  expenseVendors       Expense[]                  @relation("ExpenseVendor")
  commPreferences      PartyCommPreference[]
  commPreferenceEvents PartyCommPreferenceEvent[]
  messageParticipants  MessageParticipant[]       @relation("MessageParticipantParty")
  sentMessages         Message[]                  @relation("MessageSenderParty")
  createdTemplates     Template[]                 @relation("TemplateCreatedBy")
  autoReplyLogs        AutoReplyLog[]             @relation("AutoReplyLogParty")
  portalAccess         PortalAccess?              @relation("PortalAccessParty")
  portalInvites        PortalInvite[]             @relation("PortalInviteParty")

  @@index([tenantId, type])
  @@index([tenantId, name])
  @@index([tenantId, email])
}

model PartyCommPreference {
  id               Int               @id @default(autoincrement())
  partyId          Int
  channel          CommChannel
  preference       PreferenceLevel   @default(ALLOW)
  compliance       ComplianceStatus?
  complianceSetAt  DateTime?
  complianceSource String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  party            Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, channel])
  @@index([partyId])
  @@index([channel, compliance])
}

model PartyCommPreferenceEvent {
  id             Int               @id @default(autoincrement())
  partyId        Int
  channel        CommChannel
  prevPreference PreferenceLevel?
  newPreference  PreferenceLevel?
  prevCompliance ComplianceStatus?
  newCompliance  ComplianceStatus?
  actorPartyId   Int?
  reason         String?
  source         String?
  createdAt      DateTime          @default(now())
  party          Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([partyId, createdAt])
  @@index([channel, createdAt])
}

model Contact {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  tenant         Tenant        @relation(fields: [tenantId], references: [id])

  partyId Int?   @unique
  party   Party? @relation(name: "ContactParty", fields: [partyId], references: [id], onDelete: Restrict)

  // Names
  display_name String
  first_name   String?
  last_name    String?
  nickname     String?

  // Contact info
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Address
  street  String?
  street2 String?
  city    String?
  state   String?
  zip     String?
  country String? @db.Char(2)

  // Relations

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  externalProvider String?
  externalId       String?

  @@unique([tenantId, email])
  @@index([organizationId])
  @@index([tenantId])
  @@index([display_name])
  @@index([archived])
  @@index([last_name])
  @@index([first_name])
  @@index([nickname])
  @@index([tenantId, partyId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Animals & Ownership
 * ────────────────────────────────────────────────────────────────────────────
 */

model Animal {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organizationId Int?
  organization   Organization? @relation("OrgAnimals", fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  name           String
  species        Species
  sex            Sex
  status         AnimalStatus  @default(ACTIVE)

  // Horse asset metadata (nullable for non-horse species)
  intendedUse           HorseIntendedUse?
  declaredValueCents    Int?
  declaredValueCurrency String?               @db.VarChar(3)
  valuationDate         DateTime?
  valuationSource       HorseValuationSource?
  forSale               Boolean               @default(false)
  inSyndication         Boolean               @default(false)
  isLeased              Boolean               @default(false)

  ownershipChanges AnimalOwnershipChange[]
  birthDate        DateTime?
  microchip        String?
  notes            String?
  breed            String?

  photoUrl String? @db.Text

  canonicalBreedId Int?
  canonicalBreed   Breed? @relation(fields: [canonicalBreedId], references: [id], onDelete: SetNull)

  customBreedId Int?
  customBreed   CustomBreed? @relation(fields: [customBreedId, tenantId], references: [id, tenantId], onDelete: Restrict)

  breeds AnimalBreed[]

  reproductiveCycles  ReproductiveCycle[]
  breedingPlansAsDam  BreedingPlan[]      @relation("PlanDam")
  breedingPlansAsSire BreedingPlan[]      @relation("PlanSire")

  // legacy links
  litterId         Int?
  litter           Litter?         @relation(fields: [litterId], references: [id], onDelete: SetNull)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation("OffspringGroupPuppiesLegacy", fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // parent backrefs to groups
  offspringGroupsAsDam  OffspringGroup[] @relation("OffspringDam")
  offspringGroupsAsSire OffspringGroup[] @relation("OffspringSire")

  // parent backrefs to individual offspring
  offspringAsDam  Offspring[] @relation("OffspringIndividualDam")
  offspringAsSire Offspring[] @relation("OffspringIndividualSire")

  waitlistAllocations WaitlistEntry[] @relation("WaitlistAllocation")
  waitlistSirePrefs   WaitlistEntry[] @relation("WaitlistSirePref")
  waitlistDamPrefs    WaitlistEntry[] @relation("WaitlistDamPref")

  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  // Party migration step 6G: unified party reference for animal buyer (party-only)
  buyerPartyId       Int?
  buyerParty         Party?    @relation("AnimalBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)
  priceCents         Int?
  depositCents       Int?
  saleInvoiceId      String?
  contractId         String?
  contractSignedAt   DateTime?
  paidInFullAt       DateTime?
  healthCertAt       DateTime?
  microchipAppliedAt DateTime?
  pickupAt           DateTime?
  placedAt           DateTime?

  tagAssignments   TagAssignment[]
  owners           AnimalOwner[]
  registryIds      AnimalRegistryIdentifier[]
  shares           AnimalShare[]              @relation("ShareAnimal")
  publicListing    AnimalPublicListing?
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  archived         Boolean                    @default(false)
  TestResult       TestResult[]
  Attachment       Attachment[]
  Offspring        Offspring[]                @relation("PromotedAnimal")
  PaymentIntent    PaymentIntent[]
  AnimalTraitValue AnimalTraitValue[]
  Document         Document[]
  Invoice          Invoice[]
  Expense          Expense[]

  @@unique([tenantId, microchip])
  @@index([organizationId])
  @@index([tenantId])
  @@index([species])
  @@index([status])
  @@index([archived])
  @@index([canonicalBreedId])
  @@index([tenantId, customBreedId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([tenantId, placedAt])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
}

model AnimalOwner {
  id        Int     @id @default(autoincrement())
  animalId  Int
  percent   Int
  isPrimary Boolean @default(false)
  animal    Animal  @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // Party migration step 6H: unified party reference for co-owner (party-only)
  partyId Int
  party   Party @relation("AnimalOwnerParty", fields: [partyId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([animalId, partyId])
  @@index([animalId])
  @@index([partyId])
}

model Registry {
  id                Int                        @id @default(autoincrement())
  name              String
  code              String?                    @unique
  url               String?
  country           String?
  species           Species?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  identifiers       AnimalRegistryIdentifier[]
  BreedRegistryLink BreedRegistryLink[]
}

model AnimalRegistryIdentifier {
  id                Int       @id @default(autoincrement())
  animalId          Int
  animal            Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  registryId        Int
  registry          Registry  @relation(fields: [registryId], references: [id], onDelete: Cascade)
  identifier        String
  registrarOfRecord String?
  issuedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([registryId, identifier])
  @@index([animalId])
  @@index([registryId])
}

model AnimalShare {
  id           Int         @id @default(autoincrement())
  animalId     Int
  animal       Animal      @relation("ShareAnimal", fields: [animalId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant      @relation("ShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant      @relation("ShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope  @default(VIEW)
  status       ShareStatus @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([animalId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

model AnimalPublicListing {
  id          Int      @id @default(autoincrement())
  animalId    Int      @unique
  animal      Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenantId    Int
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title       String?
  description String?
  isListed    Boolean  @default(false)
  visibility  String?
  urlSlug     String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Trait System Models
 * ────────────────────────────────────────────────────────────────────────────
 */

model TraitDefinition {
  id                        Int                @id @default(autoincrement())
  tenantId                  Int?
  species                   Species
  key                       String
  displayName               String
  category                  String
  valueType                 TraitValueType
  enumValues                Json?
  requiresDocument          Boolean            @default(false)
  marketplaceVisibleDefault Boolean            @default(false)
  sortOrder                 Int?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  animalTraitValues         AnimalTraitValue[]

  @@unique([species, key, tenantId])
  @@index([species])
  @@index([tenantId, species])
}

model AnimalTraitValue {
  id                 Int                        @id @default(autoincrement())
  tenantId           Int
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId           Int
  traitDefinitionId  Int
  valueBoolean       Boolean?
  valueNumber        Float?
  valueText          String?
  valueDate          DateTime?
  valueJson          Json?
  status             TraitStatus?
  performedAt        DateTime?
  source             TraitSource?
  verified           Boolean                    @default(false)
  verifiedAt         DateTime?
  marketplaceVisible Boolean?
  notes              String?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  traitDefinition    TraitDefinition            @relation(fields: [traitDefinitionId], references: [id])
  animal             Animal                     @relation(fields: [animalId], references: [id], onDelete: Cascade)
  documents          AnimalTraitValueDocument[]

  @@unique([tenantId, animalId, traitDefinitionId])
  @@index([tenantId, animalId])
  @@index([tenantId, traitDefinitionId])
}

model AnimalTraitValueDocument {
  id                 Int              @id @default(autoincrement())
  tenantId           Int
  animalId           Int
  animalTraitValueId Int
  documentId         Int
  createdAt          DateTime         @default(now())
  animalTraitValue   AnimalTraitValue @relation(fields: [animalTraitValueId], references: [id], onDelete: Cascade)
  document           Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([tenantId, animalTraitValueId, documentId])
  @@index([tenantId, animalId])
  @@index([tenantId, animalTraitValueId])
  @@index([tenantId, documentId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Tags
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tag {
  id          Int             @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  module      TagModule
  color       String?
  assignments TagAssignment[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([tenantId, module, name])
  @@index([tenantId, module])
}

model TagAssignment {
  id    Int @id @default(autoincrement())
  tagId Int
  tag   Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  // Step 6B: Party-only storage for Contact/Organization tags
  taggedPartyId Int?
  taggedParty   Party? @relation("TagAssignmentTaggedParty", fields: [taggedPartyId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: Cascade)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([tagId, taggedPartyId])
  @@unique([tagId, animalId])
  @@unique([tagId, waitlistEntryId])
  @@unique([tagId, offspringGroupId])
  @@unique([tagId, offspringId])
  @@index([taggedPartyId])
  @@index([animalId])
  @@index([waitlistEntryId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([tagId, taggedPartyId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeds
 * ────────────────────────────────────────────────────────────────────────────
 */

model Breed {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  species   Species
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  registries   BreedRegistryLink[]
  Animal       Animal[]
  AnimalBreeds AnimalBreed[]

  @@index([species])
}

model AnimalBreed {
  id         Int      @id @default(autoincrement())
  animalId   Int
  animal     Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  breedId    Int
  breed      Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  percentage Float    @default(100)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([animalId, breedId])
  @@index([animalId])
  @@index([breedId])
}

model BreedRegistryLink {
  breedId    Int
  registryId Int

  statusText  String?
  registryRef String?
  url         String?
  primary     Boolean?
  since       Int?
  notes       String?
  proofUrl    String?

  breed    Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  registry Registry @relation(fields: [registryId], references: [id], onDelete: Cascade)

  @@id([breedId, registryId])
  @@index([registryId])
}

model CustomBreed {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdByOrganizationId Int?
  createdByOrganization   Organization? @relation("CreatedByOrganization", fields: [createdByOrganizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  species     Species
  name        String
  composition Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Animal    Animal[]

  @@unique([id, tenantId])
  @@unique([tenantId, species, name])
  @@index([tenantId, species])
  @@index([tenantId, createdByOrganizationId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding core
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlan {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  code      String?
  name      String
  nickname  String?
  species   Species
  breedText String?

  damId  Int
  dam    Animal  @relation("PlanDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId Int?
  sire   Animal? @relation("PlanSire", fields: [sireId], references: [id], onDelete: SetNull)

  lockedCycleKey           String?
  lockedCycleStart         DateTime?
  lockedOvulationDate      DateTime?
  lockedDueDate            DateTime?
  lockedPlacementStartDate DateTime?

  expectedCycleStart          DateTime?
  expectedHormoneTestingStart DateTime?
  expectedBreedDate           DateTime?
  expectedBirthDate           DateTime?
  expectedWeaned              DateTime?
  expectedPlacementStart      DateTime?
  expectedPlacementCompleted  DateTime?

  cycleStartDateActual          DateTime?
  hormoneTestingStartDateActual DateTime?
  breedDateActual               DateTime?
  birthDateActual               DateTime?
  weanedDateActual              DateTime?
  placementStartDateActual      DateTime?
  placementCompletedDateActual  DateTime?
  completedDateActual           DateTime?

  status BreedingPlanStatus @default(PLANNING)
  notes  String?

  committedAt       DateTime?
  committedByUserId String?
  committedByUser   User?     @relation("CommittedByUser", fields: [committedByUserId], references: [id], onDelete: SetNull)

  depositsCommittedCents Int?
  depositsPaidCents      Int?
  depositRiskScore       Int?

  Litter           Litter?
  offspringGroup   OffspringGroup?
  Events           BreedingPlanEvent[]
  Waitlist         WaitlistEntry[]
  Shares           BreedingPlanShare[]
  TestResults      TestResult[]
  BreedingAttempts BreedingAttempt[]
  PregnancyChecks  PregnancyCheck[]
  Attachments      Attachment[]
  Parties          PlanParty[]
  Invoice          Invoice[]
  Expense          Expense[]

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([organizationId])
  @@index([damId])
  @@index([sireId])
  @@index([status])
  @@index([committedAt])
  @@index([expectedWeaned])
  @@index([expectedPlacementCompleted])
  @@index([expectedPlacementStart])
  @@index([placementStartDateActual])
  @@index([placementCompletedDateActual])
  @@index([expectedBirthDate])
  @@index([expectedCycleStart])
  @@index([expectedHormoneTestingStart])
  @@index([expectedBreedDate])
  @@index([cycleStartDateActual])
}

model ReproductiveCycle {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  femaleId Int
  female   Animal @relation(fields: [femaleId], references: [id], onDelete: Cascade)

  cycleStart         DateTime
  ovulation          DateTime?
  dueDate            DateTime?
  placementStartDate DateTime?

  status String?
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([femaleId])
  @@index([cycleStart])
}

model BreedingPlanShare {
  id           Int          @id @default(autoincrement())
  planId       Int
  plan         BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant       @relation("PlanShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant       @relation("PlanShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope   @default(BREED_PLAN)
  status       ShareStatus  @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([planId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding plug-ins
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlanEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  type String

  occurredAt DateTime
  label      String?
  notes      String?
  data       Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, type, occurredAt])
}

model TestResult {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  kind    String
  method  String?
  labName String?

  valueNumber    Float?
  valueText      String?
  units          String?
  referenceRange String?

  collectedAt DateTime
  resultAt    DateTime?
  notes       String?
  data        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([animalId])
  @@index([planId])
  @@index([kind, collectedAt])
}

model BreedingAttempt {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method      BreedingMethod
  attemptAt   DateTime?
  windowStart DateTime?
  windowEnd   DateTime?

  // Party migration step 5: unified party reference for stud owner
  studOwnerPartyId Int?
  studOwnerParty   Party? @relation("BreedingAttemptStudOwner", fields: [studOwnerPartyId], references: [id], onDelete: SetNull)

  semenBatchId Int?

  success Boolean?
  notes   String?
  data    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId])
  @@index([studOwnerPartyId])
}

model PregnancyCheck {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method    PregnancyCheckMethod
  result    Boolean
  checkedAt DateTime
  notes     String?
  data      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, checkedAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group, Offspring, legacy Litter, Waitlist
 * ────────────────────────────────────────────────────────────────────────────
 */

model OffspringGroup {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  linkState  OffspringLinkState   @default(linked)
  linkReason OffspringLinkReason?

  species Species
  damId   Int
  dam     Animal  @relation("OffspringDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId  Int?
  sire    Animal? @relation("OffspringSire", fields: [sireId], references: [id], onDelete: SetNull)
  name    String?

  expectedBirthOn DateTime?
  actualBirthOn   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  published     Boolean @default(false)
  coverImageUrl String?
  themeName     String?

  // Marketplace MVP: public listing fields
  listingSlug        String?
  listingTitle       String?
  listingDescription String? @db.Text

  notes String?
  data  Json?

  // children as Offspring, not Animals
  Offspring Offspring[] @relation("GroupOffspring")

  // legacy Animal linkage retained for compatibility
  AnimalsLegacy Animal[] @relation("OffspringGroupPuppiesLegacy")

  Waitlist        WaitlistEntry[]
  Tags            TagAssignment[]
  Events          OffspringGroupEvent[]
  Attachment      Attachment[]
  groupBuyerLinks OffspringGroupBuyer[] @relation("GroupBuyerGroup")

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  Invoice   Invoice[]
  Campaign  Campaign[]
  Task      Task[]
  Document  Document[]
  Contract  Contract[]
  Expense   Expense[]

  @@unique([planId])
  @@unique([tenantId, listingSlug])
  @@index([tenantId])
  @@index([tenantId, species, expectedBirthOn])
  @@index([tenantId, damId, actualBirthOn])
  @@index([sireId])
  @@index([linkState])
  @@index([placementStartAt])
  @@index([placementCompletedAt])
  @@index([published])
}

model OffspringGroupBuyer {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  groupId Int
  group   OffspringGroup @relation("GroupBuyerGroup", fields: [groupId], references: [id], onDelete: Cascade)

  // Step 6C: Party-only storage for buyer identity
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringGroupBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation("GroupBuyerWaitlistEntry", fields: [waitlistEntryId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, buyerPartyId])
  @@unique([groupId, waitlistEntryId])
  @@index([tenantId])
  @@index([groupId])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([waitlistEntryId])
}

model Offspring {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  groupId Int
  group   OffspringGroup @relation("GroupOffspring", fields: [groupId], references: [id], onDelete: Cascade)

  // identity
  name    String?
  species Species
  breed   String?
  sex     Sex?
  bornAt  DateTime?
  diedAt  DateTime?
  status  OffspringStatus @default(NEWBORN)

  // orthogonal lifecycle dimensions (production canonical state)
  lifeState      OffspringLifeState      @default(ALIVE)
  placementState OffspringPlacementState @default(UNASSIGNED)
  keeperIntent   OffspringKeeperIntent   @default(AVAILABLE)
  financialState OffspringFinancialState @default(NONE)
  paperworkState OffspringPaperworkState @default(NONE)

  // parents as of creation time
  damId  Int?
  dam    Animal? @relation("OffspringIndividualDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   Animal? @relation("OffspringIndividualSire", fields: [sireId], references: [id], onDelete: SetNull)

  // collar
  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  // Step 6D: Party-only storage for buyer identity
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  // finance and placement
  priceCents       Int?
  depositCents     Int?
  contractId       String?
  contractSignedAt DateTime?
  paidInFullAt     DateTime?
  pickupAt         DateTime?
  placedAt         DateTime?

  // promotion link
  promotedAnimalId Int?
  promotedAnimal   Animal? @relation("PromotedAnimal", fields: [promotedAnimalId], references: [id], onDelete: SetNull)

  notes String?
  data  Json?

  Tags                TagAssignment[]
  Attachments         Attachment[]
  Events              OffspringEvent[]
  WaitlistAllocations WaitlistEntry[]  @relation("WaitlistAllocationOffspring")

  // finance, tasks, health, documents, contracts
  Invoices   Invoice[]
  Tasks      Task[]
  HealthLogs HealthEvent[]
  Documents  Document[]
  Contracts  Contract[]

  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  InvoiceLinks        OffspringInvoiceLink[]
  CampaignAttribution CampaignAttribution[]
  OffspringDocument   OffspringDocument[]
  OffspringContract   OffspringContract[]

  @@index([tenantId])
  @@index([groupId])
  @@index([tenantId, status])
  @@index([tenantId, lifeState])
  @@index([tenantId, placementState])
  @@index([tenantId, keeperIntent])
  @@index([tenantId, financialState])
  @@index([tenantId, paperworkState])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([placedAt])
  @@index([tenantId, damId])
  @@index([tenantId, sireId])
}

model OffspringEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  // NOTE, CHANGE, HEALTH, PROMOTION
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId, type, occurredAt])
}

/**
 * Legacy Litter retained
 */
model Litter {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int          @unique
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  identifier     String?
  birthedStartAt DateTime?
  birthedEndAt   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  statusOverride       String?
  statusOverrideReason String?

  published     Boolean @default(false)
  coverImageUrl String?
  themeName     String?

  notes String?
  data  Json?

  Animals    Animal[]
  Waitlist   WaitlistEntry[]
  Attachment Attachment[]
  Events     LitterEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, weanedAt])
  @@index([tenantId, placementStartAt])
  @@index([tenantId, placementCompletedAt])
}

model WaitlistEntry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // Step 6E: Party-only storage for client identity
  clientPartyId Int?
  clientParty   Party? @relation("WaitlistParty", fields: [clientPartyId], references: [id], onDelete: SetNull)

  speciesPref Species?
  breedPrefs  Json?
  sirePrefId  Int?
  sirePref    Animal?  @relation("WaitlistSirePref", fields: [sirePrefId], references: [id], onDelete: SetNull)
  damPrefId   Int?
  damPref     Animal?  @relation("WaitlistDamPref", fields: [damPrefId], references: [id], onDelete: SetNull)

  status               WaitlistStatus @default(INQUIRY)
  priority             Int?
  depositInvoiceId     String?
  balanceInvoiceId     String?
  depositPaidAt        DateTime?
  depositRequiredCents Int?
  depositPaidCents     Int?
  balanceDueCents      Int?

  // legacy allocation to Animal
  animalId Int?
  animal   Animal? @relation("WaitlistAllocation", fields: [animalId], references: [id], onDelete: SetNull)

  // canonical allocation to Offspring
  offspringId Int?
  offspring   Offspring? @relation("WaitlistAllocationOffspring", fields: [offspringId], references: [id], onDelete: SetNull)

  groupBuyerLinks OffspringGroupBuyer[] @relation("GroupBuyerWaitlistEntry")

  skipCount  Int?
  lastSkipAt DateTime?

  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  TagAssignment TagAssignment[]

  @@index([tenantId])
  @@index([planId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([clientPartyId])
  @@index([tenantId, clientPartyId])
  @@index([tenantId, speciesPref])
  @@index([sirePrefId])
  @@index([damPrefId])
  @@index([animalId])
  @@index([tenantId, depositPaidAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model OffspringGroupEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringGroupId Int
  offspringGroup   OffspringGroup @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)

  // CHANGE, NOTE, STATUS_OVERRIDE, BUYER_MOVE, LINK, UNLINK
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringGroupId, type, occurredAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Litter audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model LitterEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  litterId Int
  litter   Litter @relation(fields: [litterId], references: [id], onDelete: Cascade)

  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([litterId, type, occurredAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Attachments, Parties, Counters
 * ────────────────────────────────────────────────────────────────────────────
 */

model Attachment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // Step 6A: Party-only attachment ownership. Legacy contactId removed, use attachmentParty instead.
  attachmentPartyId Int?
  attachmentParty   Party? @relation("AttachmentParty", fields: [attachmentPartyId], references: [id], onDelete: SetNull)

  // Finance MVP: receipts and documents for invoices, payments, expenses
  invoiceId Int?
  invoice   Invoice? @relation("AttachmentInvoice", fields: [invoiceId], references: [id], onDelete: SetNull)
  paymentId Int?
  payment   Payment? @relation("AttachmentPayment", fields: [paymentId], references: [id], onDelete: SetNull)
  expenseId Int?
  expense   Expense? @relation("AttachmentExpense", fields: [expenseId], references: [id], onDelete: SetNull)

  kind            String
  storageProvider String
  storageKey      String
  filename        String
  mime            String
  bytes           Int

  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt         DateTime            @default(now())
  OffspringDocument OffspringDocument[]
  OffspringContract OffspringContract[]

  @@index([tenantId])
  @@index([planId])
  @@index([animalId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([attachmentPartyId])
  @@index([invoiceId])
  @@index([paymentId])
  @@index([expenseId])
}

model PlanParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  role String

  // Step 6F: Party-only storage for role-based parties
  partyId Int?
  party   Party? @relation("PlanPartyRole", fields: [partyId], references: [id], onDelete: SetNull)

  notes String?

  @@index([tenantId])
  @@index([planId])
  @@index([partyId])
  @@index([tenantId, partyId, role])
}

model PlanCodeCounter {
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  year Int
  seq  Int @default(0)

  @@id([tenantId, year])
  @@index([tenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Generic, namespaced tenant settings
 * ────────────────────────────────────────────────────────────────────────────
 */

model TenantSetting {
  tenantId  Int
  namespace String
  version   Int     @default(1)
  data      Json
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, namespace])
  @@index([tenantId])
  @@index([namespace])
}

/**
 * Additive models: finance, marketing, tasks, health, documents, contracts
 */

enum FinanceScope {
  group
  offspring
  contact
  organization
  general
}

enum InvoiceStatus {
  draft
  issued
  partially_paid
  paid
  void
  uncollectible
  refunded
  cancelled
}

enum InvoiceCategory {
  DEPOSIT
  SERVICE
  GOODS
  MIXED
  OTHER
}

enum LineItemKind {
  DEPOSIT
  SERVICE_FEE
  GOODS
  DISCOUNT
  TAX
  OTHER
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
  disputed
  cancelled
}

enum ExpenseCategory {
  VETERINARY
  FEED
  SUPPLIES
  BREEDING_FEE
  BOARDING
  TRAINING
  TRANSPORT
  MARKETING
  ADMINISTRATIVE
  FACILITIES
  INSURANCE
  OTHER
}

enum CampaignChannel {
  email
  social
  ads
  marketplace
  website
  other
}

enum TaskScope {
  group
  offspring
}

enum TaskStatus {
  open
  in_progress
  done
  cancelled
}

enum HealthType {
  weight
  vaccine
  deworm
  vet_visit
  treatment
  other
}

enum DocumentScope {
  group
  offspring
  invoice
  contract
  animal
}

enum DocumentKind {
  generic
  health_certificate
  registration
  contract_pdf
  invoice_pdf
  photo
  other
  bill_of_sale
  syndication_agreement
  lease_agreement
  insurance_policy
  vet_certificate
}

enum SignatureProvider {
  internal
  docusign
  hellosign
  adobe
  other
}

enum ContractStatus {
  draft
  sent
  viewed
  signed
  declined
  voided
  expired
}

enum SignatureStatus {
  pending
  viewed
  signed
  declined
  voided
  expired
}

// ---------- Finance ----------

/**
 * Sequence counter for server-side numbering (invoice numbers, etc.)
 * Tenant-scoped, per-year counter for generating unique sequential numbers
 */
model Sequence {
  id         Int      @id @default(autoincrement())
  tenantId   Int
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key        String // e.g., "invoice"
  year       Int
  nextNumber Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([tenantId, key, year])
  @@index([tenantId, key, year])
}

/**
 * IdempotencyKey for preventing duplicate operations
 * Stores request hash and response for exact-match replay
 */
model IdempotencyKey {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key          String // Client-provided idempotency key
  requestHash  String // Hash of request body
  responseBody String? // Stored response payload
  createdAt    DateTime @default(now())

  @@unique([tenantId, key])
  @@index([tenantId, createdAt])
}

model Invoice {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope   FinanceScope
  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // Party migration step 6J: unified party reference for invoice client/buyer
  clientPartyId Int?
  clientParty   Party? @relation("InvoiceParty", fields: [clientPartyId], references: [id], onDelete: SetNull)

  // Finance MVP anchor fields
  animalId       Int?
  animal         Animal?       @relation(fields: [animalId], references: [id], onDelete: SetNull)
  breedingPlanId Int?
  breedingPlan   BreedingPlan? @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)

  invoiceNumber String // Server-generated, format: INV-YYYY-NNNN
  number        String? // Legacy field, keep for compatibility
  currency      String          @default("USD")
  amountCents   Int
  balanceCents  Int
  depositCents  Int?
  status        InvoiceStatus   @default(draft)
  category      InvoiceCategory @default(OTHER)
  dueAt         DateTime?
  issuedAt      DateTime?
  paidAt        DateTime?
  voidedAt      DateTime?
  paymentTerms  String?

  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?

  notes String?
  data  Json?

  LineItems     InvoiceLineItem[]
  Payments      Payment[]
  Documents     Document[]
  Contract      Contract?
  Attachments   Attachment[]      @relation("AttachmentInvoice")
  EmailSendLogs EmailSendLog[]

  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  OffspringInvoiceLink OffspringInvoiceLink[]
  PaymentIntent        PaymentIntent[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([tenantId, clientPartyId, status])
  @@index([tenantId, offspringId])
  @@index([tenantId, groupId])
  @@index([tenantId, animalId])
  @@index([tenantId, breedingPlanId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status])
  @@index([clientPartyId])
}

model InvoiceLineItem {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  kind          LineItemKind @default(OTHER)
  description   String
  qty           Int          @default(1)
  unitCents     Int
  discountCents Int?
  taxRate       Float?
  category      String?
  itemCode      String?
  totalCents    Int

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([invoiceId])
}

model Payment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  status       PaymentStatus @default(pending)
  amountCents  Int
  receivedAt   DateTime // When payment was received
  methodType   String? // e.g., "card", "bank_transfer", "cash", "check"
  processor    String? // e.g., "stripe", "square", "manual"
  processorRef String? // Reference from payment processor
  method       String? // Legacy field
  reference    String? // Legacy field
  paidAt       DateTime? // Legacy field

  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?

  notes String?
  data  Json?

  Attachments Attachment[] @relation("AttachmentPayment")

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, invoiceId])
  @@index([tenantId, receivedAt])
  @@index([invoiceId])
  @@index([status])
}

/**
 * Expense tracking for business operations
 * Can be anchored to breeding plans, offspring groups, animals, or general operations
 */
model Expense {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  amountCents Int
  currency    String          @default("USD")
  incurredAt  DateTime
  category    ExpenseCategory
  description String?

  // Optional vendor/supplier
  vendorPartyId Int?
  vendorParty   Party? @relation("ExpenseVendor", fields: [vendorPartyId], references: [id], onDelete: SetNull)

  // Anchor fields - expense can be linked to one of these
  breedingPlanId   Int?
  breedingPlan     BreedingPlan?   @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)
  animalId         Int?
  animal           Animal?         @relation(fields: [animalId], references: [id], onDelete: SetNull)

  notes String?
  data  Json?

  Attachments Attachment[] @relation("AttachmentExpense")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, incurredAt])
  @@index([tenantId, breedingPlanId])
  @@index([tenantId, offspringGroupId])
  @@index([tenantId, animalId])
  @@index([tenantId, vendorPartyId])
  @@index([tenantId, category])
}

model AnimalOwnershipChange {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  kind          OwnershipChangeKind
  effectiveDate DateTime?
  occurredAt    DateTime            @default(now())

  valueCents Int?
  currency   String? @db.VarChar(3)

  // Immutable snapshots of ownership at time of change
  fromOwners Json
  toOwners   Json

  // Party migration step 5: party-based ownership snapshots
  fromOwnerParties Json?
  toOwnerParties   Json?

  notes     String?
  documents Document[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  PaymentIntent PaymentIntent[]

  @@index([tenantId])
  @@index([animalId])
  @@index([kind])
  @@index([occurredAt])
}

model PaymentIntent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional links depending on what the payment represents
  invoiceId         Int?
  invoice           Invoice?               @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  animalId          Int?
  animal            Animal?                @relation(fields: [animalId], references: [id], onDelete: SetNull)
  ownershipChangeId Int?
  ownershipChange   AnimalOwnershipChange? @relation(fields: [ownershipChangeId], references: [id], onDelete: SetNull)

  purpose PaymentIntentPurpose
  status  PaymentIntentStatus  @default(PLANNED)

  amountCents Int
  currency    String @db.VarChar(3)

  externalProvider String?
  externalId       String?
  reference        String?

  data Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([invoiceId])
  @@index([animalId])
  @@index([ownershipChangeId])
  @@index([status])
  @@index([purpose])
}

// ---------- Marketing ----------
model Campaign {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringGroupId Int?
  group            OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  name      String
  channel   CampaignChannel
  startedAt DateTime?
  endedAt   DateTime?

  budgetCents Int?
  spendCents  Int?

  impressions  Int?
  clicks       Int?
  inquiries    Int?
  reservations Int?
  conversions  Int?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  notes String?
  data  Json?

  Attributions CampaignAttribution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringGroupId])
  @@index([channel])
}

model CampaignAttribution {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  campaignId Int
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  weight Float?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([campaignId])
  @@index([offspringId])
}

enum EmailSendStatus {
  queued
  sent
  failed
}

enum TemplateChannel {
  email
  dm
  social
}

enum TemplateStatus {
  draft
  active
  archived
}

enum TemplateCategory {
  auto_reply
  invoice_message
  birth_announcement
  waitlist_update
  general_follow_up
  custom
}

enum EmailSendCategory {
  transactional
  marketing
}

enum AutoReplyTriggerType {
  dm_first_message_from_party
  dm_after_hours
}

enum AutoReplyStatus {
  sent
  skipped
  failed
}

model Template {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  key         String? // stable identifier for system templates
  channel     TemplateChannel
  category    TemplateCategory
  status      TemplateStatus   @default(draft)
  description String?          @db.Text

  createdByPartyId Int?
  createdByParty   Party? @relation("TemplateCreatedBy", fields: [createdByPartyId], references: [id], onDelete: SetNull)

  content        TemplateContent[]
  autoReplyRules AutoReplyRule[]

  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([tenantId, key])
  @@index([tenantId, channel])
  @@index([tenantId, status])
  @@index([tenantId, category])
}

model TemplateContent {
  id         Int      @id @default(autoincrement())
  templateId Int
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  subject      String? // email only
  bodyText     String  @db.Text
  bodyHtml     String? @db.Text // email only
  metadataJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
}

model AutoReplyRule {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  channel TemplateChannel
  enabled Boolean         @default(true)

  templateId Int
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  triggerType       AutoReplyTriggerType
  cooldownMinutes   Int                  @default(60)
  businessHoursJson Json?

  logs AutoReplyLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, channel, enabled])
  @@index([templateId])
}

model AutoReplyLog {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  channel TemplateChannel
  partyId Int
  party   Party           @relation("AutoReplyLogParty", fields: [partyId], references: [id], onDelete: Cascade)

  threadId Int?
  thread   MessageThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)

  ruleId Int?
  rule   AutoReplyRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  templateId Int?

  status AutoReplyStatus
  reason String?         @db.Text

  createdAt DateTime @default(now())

  @@index([tenantId, partyId])
  @@index([tenantId, channel, createdAt])
  @@index([threadId])
  @@index([ruleId])
}

model EmailSendLog {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  to      String
  from    String
  subject String

  templateKey       String?
  templateId        Int?
  category          EmailSendCategory?
  provider          String             @default("resend")
  providerMessageId String?

  relatedInvoiceId Int?
  invoice          Invoice? @relation(fields: [relatedInvoiceId], references: [id], onDelete: SetNull)

  status   EmailSendStatus @default(queued)
  error    Json?
  metadata Json?

  createdAt DateTime @default(now())

  @@unique([tenantId, templateKey, relatedInvoiceId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([providerMessageId])
  @@index([createdAt])
  @@index([relatedInvoiceId])
  @@index([templateId])
  @@index([tenantId, category])
}

model MessageThread {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  subject  String?
  archived Boolean @default(false)

  // Marketplace MVP: inquiry context fields
  inquiryType       String? // "MARKETPLACE" | "WAITLIST" | "GENERAL" | null
  sourceListingSlug String?
  guestEmail        String?
  guestName         String?

  participants  MessageParticipant[]
  messages      Message[]
  autoReplyLogs AutoReplyLog[]

  lastMessageAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, updatedAt])
  @@index([inquiryType])
}

model MessageParticipant {
  id       Int           @id @default(autoincrement())
  threadId Int
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  partyId Int
  party   Party @relation("MessageParticipantParty", fields: [partyId], references: [id], onDelete: Cascade)

  lastReadAt DateTime?

  createdAt DateTime @default(now())

  @@unique([threadId, partyId])
  @@index([threadId])
  @@index([partyId])
}

model Message {
  id       Int           @id @default(autoincrement())
  threadId Int
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  senderPartyId Int
  senderParty   Party @relation("MessageSenderParty", fields: [senderPartyId], references: [id], onDelete: Cascade)

  body String @db.Text

  isAutomated      Boolean @default(false)
  automationRuleId Int?

  createdAt DateTime @default(now())

  @@index([threadId, createdAt])
  @@index([senderPartyId])
}

// ---------- Tasks ----------
model Task {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope TaskScope

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  title  String
  notes  String?
  dueAt  DateTime?
  status TaskStatus @default(open)

  assignedToUserId String?
  assignedToUser   User?   @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status, dueAt])
}

// ---------- Health ----------
model HealthEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  kind       HealthType
  occurredAt DateTime

  weightGrams Int?
  vaccineCode String?
  dose        String?
  vetClinic   String?
  result      String?
  notes       String?
  data        Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId, occurredAt])
  @@index([kind])
}

// ---------- Documents & Contracts ----------
model Document {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope DocumentScope
  kind  DocumentKind  @default(generic)

  // Optional links for Animal and ownership transactions (horses)
  animalId          Int?
  animal            Animal?                @relation(fields: [animalId], references: [id], onDelete: SetNull)
  ownershipChangeId Int?
  ownershipChange   AnimalOwnershipChange? @relation(fields: [ownershipChangeId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  invoiceId Int?     @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  contractId Int?
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  title       String
  storageKey  String?
  externalUrl String?
  mimeType    String?
  bytes       Int?
  sha256      String?

  data             Json?
  // Prototype fields for trait document linking
  visibility       DocVisibility? @default(PRIVATE)
  status           DocStatus?     @default(PLACEHOLDER)
  sizeBytes        Int?
  originalFileName String?
  storageProvider  String?
  bucket           String?
  objectKey        String?
  url              String?

  // Relation to trait values
  traitValueLinks AnimalTraitValueDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope, offspringId])
  @@index([scope, groupId])
  @@index([scope, invoiceId])
  @@index([scope, contractId])
  @@index([kind])
}

model ContractTemplate {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  body        String?
  storageKey  String?
  description String?

  isActive Boolean @default(true)
  data     Json?

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  Contract  Contract[]

  @@index([tenantId])
  @@index([isActive])
}

model Contract {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  templateId Int?
  template   ContractTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  invoiceId Int?     @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  title  String
  status ContractStatus @default(draft)

  provider           SignatureProvider @default(internal)
  providerEnvelopeId String?
  providerDocId      String?

  issuedAt  DateTime?
  signedAt  DateTime?
  voidedAt  DateTime?
  expiresAt DateTime?

  documents Document[]
  parties   ContractParty[]
  events    SignatureEvent[]

  data Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([groupId])
  @@index([invoiceId])
  @@index([status])
  @@index([provider, providerEnvelopeId])
}

model ContractParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contractId Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  partyId Int?
  party   Party? @relation("ContractPartyRole", fields: [partyId], references: [id], onDelete: SetNull)

  role   String?
  email  String?
  name   String?
  signer Boolean @default(true)
  order  Int?

  status   SignatureStatus @default(pending)
  signedAt DateTime?

  providerRecipientId String?

  data Json?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  SignatureEvent SignatureEvent[]

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([tenantId, partyId])
  @@index([status])
}

model SignatureEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contractId Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  partyId Int?
  party   ContractParty? @relation(fields: [partyId], references: [id], onDelete: SetNull)

  status    SignatureStatus
  at        DateTime        @default(now())
  ipAddress String?
  userAgent String?
  message   String?
  data      Json?

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([status, at])
}

enum InvoiceRole {
  RESERVATION
  DEPOSIT
  FINAL
  MISC
}

enum EsignProvider {
  DOCUSIGN
  HELLOSIGN
  ADOBE
  OTHER
}

enum EsignStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  DECLINED
  EXPIRED
  VOIDED
}

model OffspringDocument {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  name       String
  templateId String?
  provider   EsignProvider?
  status     EsignStatus    @default(DRAFT)

  sentAt      DateTime?
  viewedAt    DateTime?
  completedAt DateTime?

  fileId Int?
  file   Attachment? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  metaJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([status])
}

model OffspringContract {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  title    String
  version  String?
  provider EsignProvider?
  status   EsignStatus    @default(DRAFT)

  sentAt   DateTime?
  viewedAt DateTime?
  signedAt DateTime?

  fileId Int?
  file   Attachment? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  // Party migration step 6L: unified party reference for contract buyer (legacy columns removed)
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringContractBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  metaJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([status])
}

model OffspringInvoiceLink {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  invoiceId Int?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  role        InvoiceRole @default(MISC)
  amountCents Int?
  currency    String?

  externalProvider String?
  externalId       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([offspringId, invoiceId, role])
  @@index([tenantId])
  @@index([offspringId])
  @@index([invoiceId])
}

model AccountingIntegration {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider String // for example "quickbooks_online"
  realmId  String // external account or company id

  accessToken          String
  refreshToken         String
  accessTokenExpiresAt DateTime

  isActive       Boolean   @default(true)
  syncDirection  String    @default("outbound") // outbound, inbound, bidirectional
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastSyncError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, provider])
}

/**
 * Portal Access Management
 * Controls client portal access per Party (Contact or Organization)
 */

model PortalAccess {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation("PortalAccessTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int    @unique
  party    Party  @relation("PortalAccessParty", fields: [partyId], references: [id], onDelete: Cascade)

  // UX state only - NOT used for authorization
  status PortalAccessStatus @default(NO_ACCESS)

  // Linked user (set when invite is accepted)
  userId String?
  user   User?   @relation("PortalAccessUser", fields: [userId], references: [id], onDelete: SetNull)

  // Denormalized pointer to TenantMembership (informational only, set after acceptance)
  // Note: Cannot add FK to composite PK, so this is just userId reference for traceability
  membershipUserId String?

  // Timestamps
  invitedAt   DateTime?
  activatedAt DateTime?
  suspendedAt DateTime?
  lastLoginAt DateTime?

  // Audit
  createdByUserId String?
  updatedByUserId String?
  createdBy       User?   @relation("PortalAccessCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedBy       User?   @relation("PortalAccessUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, partyId])
  @@index([tenantId])
  @@index([partyId])
  @@index([userId])
  @@index([status])
}

model PortalInvite {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation("PortalInviteTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int
  party    Party  @relation("PortalInviteParty", fields: [partyId], references: [id], onDelete: Cascade)

  // Normalized email for lookup (lowercase, trimmed)
  emailNorm String @db.Citext

  // User reference (set if user exists at invite time, or after acceptance)
  userId String?
  user   User?   @relation("PortalInviteUser", fields: [userId], references: [id], onDelete: SetNull)

  // Role and status to grant upon acceptance (defaults to CLIENT/ACTIVE)
  roleToGrant   TenantMembershipRole   @default(CLIENT)
  statusToGrant TenantMembershipStatus @default(ACTIVE)

  // Token for activation link
  tokenHash String    @unique
  expiresAt DateTime
  sentAt    DateTime  @default(now())
  usedAt    DateTime?

  // Backfilled after acceptance for traceability
  membershipUserId String?

  // Audit
  sentByUserId String?
  sentBy       User?   @relation("PortalInviteSentBy", fields: [sentByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, partyId])
  @@index([tenantId, emailNorm])
  @@index([expiresAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Audit Event Log
 * Immutable security event log for auth, access control, and abuse monitoring
 * ────────────────────────────────────────────────────────────────────────────
 */

enum AuditOutcome {
  SUCCESS
  FAILURE
}

enum AuditSurface {
  PLATFORM
  PORTAL
  MARKETPLACE
}

enum AuditActorContext {
  STAFF
  CLIENT
  PUBLIC
}

model AuditEvent {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // Request context
  requestId String? @db.VarChar(64)
  ip        String? @db.VarChar(45) // IPv4 or IPv6
  userAgent String? @db.Text

  // Actor context
  userId       String?            @db.VarChar(64)
  surface      AuditSurface
  actorContext AuditActorContext?
  tenantId     Int?

  // Event data
  action     String       @db.VarChar(64)
  outcome    AuditOutcome
  detailJson Json?

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([tenantId, createdAt])
  @@index([action, createdAt])
}
