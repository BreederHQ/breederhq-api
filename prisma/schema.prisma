generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Core enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum PartyType {
  CONTACT
  ORGANIZATION
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum AnimalStatus {
  ACTIVE
  BREEDING
  UNAVAILABLE
  RETIRED
  DECEASED
  PROSPECT
}

enum Species {
  DOG
  CAT
  HORSE
  GOAT
  RABBIT
  SHEEP
}

enum TenantOperationType {
  HOBBY
  COMMERCIAL
  PERFORMANCE
}

enum HorseIntendedUse {
  BREEDING
  SHOW
  RACING
}

enum HorseValuationSource {
  PRIVATE_SALE
  AUCTION
  APPRAISAL
  INSURANCE
  OTHER
}

enum OwnershipChangeKind {
  SALE
  SYNDICATION
  TRANSFER
  LEASE
  DEATH
  OTHER
}

enum PaymentIntentStatus {
  PLANNED
  EXTERNAL
  COMPLETED
  CANCELED
}

enum PaymentIntentPurpose {
  DEPOSIT
  PURCHASE
  STUD_FEE
  BOARDING
  TRAINING
  OTHER
}

enum Sex {
  FEMALE
  MALE
}

enum TagModule {
  CONTACT
  ORGANIZATION
  ANIMAL
  WAITLIST_ENTRY
  OFFSPRING_GROUP
  OFFSPRING
}

enum OwnerPartyType {
  Organization
  Contact
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
  VIEWER
}

// New enums for unified tenant membership model (STAFF vs CLIENT)
enum TenantMembershipRole {
  STAFF // Staff member (maps from OWNER/ADMIN/MEMBER/BILLING/VIEWER)
  CLIENT // Portal client (created via invite acceptance)
}

enum TenantMembershipStatus {
  INVITED // Invite sent, not yet accepted
  ACTIVE // Full access
  SUSPENDED // Access revoked
}

enum ShareScope {
  VIEW
  BREED_PLAN
}

enum ShareStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum VerificationPurpose {
  VERIFY_EMAIL
  RESET_PASSWORD
  INVITE
  OTHER
}

enum PortalAccessStatus {
  NO_ACCESS
  INVITED
  ACTIVE
  SUSPENDED
}

// User entitlement enums for marketplace and other feature access
enum EntitlementKey {
  // Surface access
  MARKETPLACE_ACCESS // Access to marketplace surface
  PLATFORM_ACCESS // Access to platform
  PORTAL_ACCESS // Access to portal

  // Feature access
  BREEDING_PLANS
  FINANCIAL_SUITE
  DOCUMENT_MANAGEMENT
  HEALTH_RECORDS
  WAITLIST_MANAGEMENT
  ADVANCED_REPORTING
  API_ACCESS
  MULTI_LOCATION
  E_SIGNATURES
  DATA_EXPORT // Blocked during free trial to prevent data cleaning abuse

  // Quotas (use ProductEntitlement.limitValue for the actual number)
  ANIMAL_QUOTA
  CONTACT_QUOTA
  PORTAL_USER_QUOTA
  BREEDING_PLAN_QUOTA
  MARKETPLACE_LISTING_QUOTA
  STORAGE_QUOTA_GB
  SMS_QUOTA
}

enum EntitlementStatus {
  ACTIVE // Entitlement granted and active
  REVOKED // Entitlement revoked
}

// Subscription & Billing enums
enum ProductType {
  SUBSCRIPTION // Recurring subscription plan
  ADD_ON // Add-on to subscription
  ONE_TIME // One-time purchase
}

enum BillingInterval {
  MONTHLY
  YEARLY
  QUARTERLY
}

enum SubscriptionStatus {
  TRIAL // In trial period
  ACTIVE // Paid and active
  PAST_DUE // Payment failed, in grace period
  CANCELED // Canceled by user
  EXPIRED // Trial or subscription expired
  INCOMPLETE // Stripe payment pending
  PAUSED // Paused (future feature)
}

enum UsageMetricKey {
  ANIMAL_COUNT
  CONTACT_COUNT
  PORTAL_USER_COUNT
  BREEDING_PLAN_COUNT
  MARKETPLACE_LISTING_COUNT
  STORAGE_BYTES
  SMS_SENT
  API_CALLS
}

enum AnimalCategory {
  RABBIT
  SMALL_RODENT // Hamster, guinea pig, etc.
  BIRD
  CAT
  SMALL_DOG // Under 25 lbs
  LARGE_DOG // Over 25 lbs
  HORSE
  LIVESTOCK // Cattle, sheep, goats
  EXOTIC // Reptiles, etc.
  OTHER
}

enum ListingType {
  BREEDING_PROGRAM // Breeder's main program profile
  STUD_SERVICE // Stud/breeding services
  TRAINING // Training services
  VETERINARY // Vet services
  PHOTOGRAPHY // Photo/video services
  GROOMING // Grooming services
  TRANSPORT // Transport/shipping
  BOARDING // Boarding/kennel
  PRODUCT // Equipment, supplies
  OTHER_SERVICE
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  EXPIRED
  REMOVED
}

enum ListingTier {
  FREE // Basic listing
  PREMIUM // Featured, more photos
  BUSINESS // Top placement, analytics
}

enum CommChannel {
  EMAIL
  SMS
  PHONE
  MAIL
  WHATSAPP
}

enum PreferenceLevel {
  ALLOW
  NOT_PREFERRED
  NEVER
}

enum ComplianceStatus {
  SUBSCRIBED
  UNSUBSCRIBED
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Trait system enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum TraitValueType {
  BOOLEAN
  ENUM
  NUMBER
  DATE
  TEXT
  JSON
}

enum TraitSource {
  SELF_REPORTED
  VET
  LAB
  REGISTRY
}

enum TraitStatus {
  NOT_PROVIDED
  PROVIDED
  PENDING
  PASS
  FAIL
}

enum DocVisibility {
  PRIVATE
  BUYERS
  PUBLIC
}

enum DocStatus {
  PLACEHOLDER
  UPLOADING
  READY
  FAILED
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding additions: enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum BreedingPlanStatus {
  PLANNING
  COMMITTED
  CYCLE_EXPECTED
  HORMONE_TESTING
  BRED
  PREGNANT
  BIRTHED
  WEANED
  PLACEMENT
  COMPLETE
  CANCELED
}

enum BreedingMethod {
  NATURAL
  AI_TCI
  AI_SI
  AI_FROZEN
}

enum PregnancyCheckMethod {
  PALPATION
  ULTRASOUND
  RELAXIN_TEST
  XRAY
  OTHER
}

enum WaitlistStatus {
  INQUIRY
  APPROVED
  DEPOSIT_DUE
  DEPOSIT_PAID
  READY
  ALLOCATED
  COMPLETED
  CANCELED
  REJECTED
}

/**
 * Offspring Group linking state
 */
enum OffspringLinkState {
  linked
  orphan
  pending
}

enum OffspringLinkReason {
  legacy_import
  rescue
  accidental
  third_party
  cobreeder
  placeholder
  historical
  other
}

/**
 * Offspring lifecycle
 */
enum OffspringStatus {
  NEWBORN
  ALIVE
  WEANED
  PLACED
  DECEASED
}

enum OffspringLifeState {
  ALIVE
  DECEASED
}

enum OffspringPlacementState {
  UNASSIGNED
  OPTION_HOLD
  RESERVED
  PLACED
  RETURNED
  TRANSFERRED
}

enum OffspringKeeperIntent {
  AVAILABLE
  UNDER_EVALUATION
  WITHHELD
  KEEP
}

enum OffspringFinancialState {
  NONE
  DEPOSIT_PENDING
  DEPOSIT_PAID
  PAID_IN_FULL
  REFUNDED
  CHARGEBACK
}

enum OffspringPaperworkState {
  NONE
  SENT
  SIGNED
  COMPLETE
}

/**
 * Animal marketplace listing enums
 */
enum AnimalListingIntent {
  STUD
  BROOD_PLACEMENT
  REHOME
  SHOWCASE
}

enum AnimalListingStatus {
  DRAFT
  LIVE
  PAUSED
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Users & Auth
 * ────────────────────────────────────────────────────────────────────────────
 */

model User {
  id        String  @id @default(cuid())
  email     String  @unique @db.Citext
  name      String?
  firstName String
  lastName  String
  nickname  String?
  image     String?

  // auth
  passwordHash         String?
  passwordUpdatedAt    DateTime?
  mustChangePassword   Boolean   @default(false)
  passwordSetAt        DateTime?
  lastPasswordChangeAt DateTime?
  isSuperAdmin         Boolean   @default(false)
  emailVerifiedAt      DateTime?

  // profile / contact fields (user-scoped)
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)
  street       String?
  street2      String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @db.Char(2)

  // Party migration step 5: unified party reference for user profile
  partyId Int?
  party   Party? @relation("UserParty", fields: [partyId], references: [id], onDelete: SetNull)

  // org/tenant membership
  memberships       Membership[]
  tenantMemberships TenantMembership[]
  defaultTenantId   Int?
  defaultTenant     Tenant?            @relation(fields: [defaultTenantId], references: [id], onDelete: SetNull)

  // auth ancillaries
  Passkey           Passkey[]
  RecoveryCode      RecoveryCode[]
  Session           Session[]
  VerificationToken VerificationToken[]

  // auth/activity timestamps
  lastLoginAt DateTime?

  // breeding events authored
  BreedingPlanEvent BreedingPlanEvent[]

  // committed plans (optional backref)
  committedPlans BreedingPlan[] @relation("CommittedByUser")

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  Attachment          Attachment[]
  LitterEvent         LitterEvent[]
  OffspringGroupEvent OffspringGroupEvent[]
  OffspringEvent      OffspringEvent[]
  Task                Task[]
  HealthEvent         HealthEvent[]
  ContractParty       ContractParty[]

  // Portal access management
  portalAccesses          PortalAccess[] @relation("PortalAccessUser")
  portalAccessesCreatedBy PortalAccess[] @relation("PortalAccessCreatedBy")
  portalAccessesUpdatedBy PortalAccess[] @relation("PortalAccessUpdatedBy")
  portalInvites           PortalInvite[] @relation("PortalInviteUser")
  portalInvitesSentBy     PortalInvite[] @relation("PortalInviteSentBy")

  // User entitlements (marketplace access, etc.)
  entitlements UserEntitlement[]

  // Legal - Terms of Service acceptances
  tosAcceptances TosAcceptance[]

  // Legal - Genetics Lab disclaimer acceptances
  geneticsDisclaimerAcceptances GeneticsDisclaimerAcceptance[]

  // Marketplace blocklist
  marketplaceBlocks MarketplaceUserBlock[] @relation("BlockedMarketplaceUser")
  marketplaceFlag   MarketplaceUserFlag?   @relation("MarketplaceUserFlagUser")

  // Breeder reports (user as reporter or reviewer)
  breederReportsSubmitted BreederReport[] @relation("BreederReportReporter")
  breederReportsReviewed  BreederReport[] @relation("BreederReportReviewedBy")

  // Service provider profile (for non-breeders listing services)
  serviceProviderProfile ServiceProviderProfile?

  // Cross-tenant lineage
  lineageRequestsSent LineageInfoRequest[] @relation("LineageRequestFromUser")

  @@index([partyId])
  @@index([defaultTenantId])
  @@index([phoneE164])
  @@index([whatsappE164])
  @@index([country])
}

/**
 * TosAcceptance - Terms of Service acceptance records
 * Stores a history of ToS acceptances for audit/compliance.
 */
model TosAcceptance {
  id         Int      @id @default(autoincrement())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  version    String   @db.VarChar(16)
  acceptedAt DateTime @default(now())
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.Text
  surface    String?  @db.VarChar(32) // marketplace, platform, portal
  flow       String?  @db.VarChar(32) // register, invite_signup, portal_activate

  @@index([userId])
  @@index([version])
}

/**
 * UserEntitlement - Per-user feature access grants
 * Used for marketplace access and other user-level permissions.
 */
model UserEntitlement {
  id              Int               @id @default(autoincrement())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  key             EntitlementKey
  status          EntitlementStatus @default(ACTIVE)
  grantedAt       DateTime          @default(now())
  revokedAt       DateTime?
  grantedByUserId String?

  @@unique([userId, key])
  @@index([userId])
  @@index([key, status])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String? @unique
  tokenHash  String  @unique

  purpose VerificationPurpose @default(VERIFY_EMAIL)
  expires DateTime
  userId  String?
  User    User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@id([identifier, tokenHash])
  @@index([identifier, purpose])
}

model Passkey {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId String   @unique
  publicKey    String
  counter      Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model RecoveryCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String   @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Invitation {
  id             String         @id @default(cuid())
  email          String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  token          String         @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime       @default(now())
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organizationId])
}

model Invite {
  id             Int       @id @default(autoincrement())
  email          String
  organizationId Int?
  role           String    @default("STAFF")
  token          String    @unique
  expiresAt      DateTime
  consumedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([email])
  @@index([token])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Multi-tenancy & Orgs
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tenant {
  id           Int     @id @default(autoincrement())
  name         String
  slug         String? @unique
  primaryEmail String?

  operationType TenantOperationType @default(HOBBY)

  memberships    TenantMembership[]
  organizations  Organization[]
  contacts       Contact[]
  parties        Party[]
  animals        Animal[]
  billing        BillingAccount?
  sharesSent     AnimalShare[]         @relation("ShareFromTenant")
  sharesReceived AnimalShare[]         @relation("ShareToTenant")
  publicListings AnimalPublicListing[]
  User           User[]
  tags           Tag[]
  CustomBreed    CustomBreed[]

  // breeding additions
  breedingPlans      BreedingPlan[]
  reproductiveCycles ReproductiveCycle[]
  planSharesSent     BreedingPlanShare[] @relation("PlanShareFromTenant")
  planSharesReceived BreedingPlanShare[] @relation("PlanShareToTenant")
  planEvents         BreedingPlanEvent[]
  testResults        TestResult[]
  breedingAttempts   BreedingAttempt[]
  pregnancyChecks    PregnancyCheck[]
  litters            Litter[]
  offspringGroups    OffspringGroup[]
  offspring          Offspring[]
  waitlist           WaitlistEntry[]
  attachments        Attachment[]
  planParties        PlanParty[]
  planCodeCounters   PlanCodeCounter[]

  availabilityPrefs Json?

  settings TenantSetting[]

  programBreeds TenantProgramBreed[]

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  LitterEvent            LitterEvent[]
  OffspringGroupEvent    OffspringGroupEvent[]
  OffspringEvent         OffspringEvent[]
  OffspringGroupBuyer    OffspringGroupBuyer[]
  Invoice                Invoice[]
  InvoiceLineItem        InvoiceLineItem[]
  Payment                Payment[]
  Expense                Expense[]
  Sequence               Sequence[]
  IdempotencyKey         IdempotencyKey[]
  Campaign               Campaign[]
  CampaignAttribution    CampaignAttribution[]
  EmailSendLog           EmailSendLog[]
  MessageThread          MessageThread[]
  Task                   Task[]
  HealthEvent            HealthEvent[]
  Document               Document[]
  ContractTemplate       ContractTemplate[]
  Contract               Contract[]
  ContractParty          ContractParty[]
  SignatureEvent         SignatureEvent[]
  OffspringDocument      OffspringDocument[]
  OffspringContract      OffspringContract[]
  OffspringInvoiceLink   OffspringInvoiceLink[]
  accountingIntegrations AccountingIntegration[]
  AnimalOwnershipChange  AnimalOwnershipChange[]
  PaymentIntent          PaymentIntent[]
  AnimalTraitValue       AnimalTraitValue[]
  Template               Template[]
  AutoReplyRule          AutoReplyRule[]
  AutoReplyLog           AutoReplyLog[]
  portalAccesses         PortalAccess[]          @relation("PortalAccessTenant")
  portalInvites          PortalInvite[]          @relation("PortalInviteTenant")

  // Scheduling
  schedulingEventTemplates     SchedulingEventTemplate[]
  schedulingAvailabilityBlocks SchedulingAvailabilityBlock[]
  schedulingSlots              SchedulingSlot[]
  schedulingBookings           SchedulingBooking[]

  // Business hours for messaging availability
  // JSON structure: { monday: { open: "09:00", close: "17:00", enabled: true }, ... }
  // If null, system defaults apply (Mon-Fri 9am-5pm)
  businessHours Json?
  timeZone      String? // IANA timezone e.g. "America/New_York"

  // Quick Responder badge tracking
  // Badge is earned when avgBusinessHoursResponseTime <= 4 hours (14400 seconds)
  // Badge is lost when it exceeds that threshold
  quickResponderBadge          Boolean   @default(false)
  avgBusinessHoursResponseTime Int? // Average response time in seconds (business hours only)
  totalResponseCount           Int       @default(0) // Number of responses used in average
  lastBadgeEvaluatedAt         DateTime?

  // Marketplace blocklist
  marketplaceUserBlocks MarketplaceUserBlock[]

  // Breeder report system (marketplace users reporting this breeder)
  breederReports    BreederReport[]    @relation("BreederReports")
  breederReportFlag BreederReportFlag? @relation("BreederReportFlag")

  // Subscription & Billing
  subscriptions       Subscription[]
  usageRecords        UsageRecord[]
  usageSnapshots      UsageSnapshot[]
  paymentMethods      PaymentMethod[]
  referralCodesOwned  ReferralCode[]       @relation("ReferralCodeOwner")
  referralsMade       Referral[]           @relation("ReferralsMade")
  referralsReceived   Referral[]           @relation("ReferralsReceived")
  marketplaceListings MarketplaceListing[]

  // Cross-tenant lineage
  contributedIdentifiers  GlobalAnimalIdentifier[]
  lineageRequestsSent     LineageInfoRequest[]     @relation("LineageRequestFrom")
  lineageRequestsReceived LineageInfoRequest[]     @relation("LineageRequestTo")

  // Title & Competition tracking
  titleDefinitions   TitleDefinition[]
  animalTitles       AnimalTitle[]
  competitionEntries CompetitionEntry[]

  @@index([name])
  @@index([quickResponderBadge])
}

model TenantMembership {
  userId   String
  tenantId Int
  role     TenantRole @default(MEMBER)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // New fields for unified membership model
  membershipRole   TenantMembershipRole   @default(STAFF)
  membershipStatus TenantMembershipStatus @default(ACTIVE)
  partyId          Int? // Links CLIENT memberships to their Party record

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, tenantId])
  @@index([tenantId])
  @@index([partyId])
  @@index([membershipRole, membershipStatus])
}

model BillingAccount {
  id       Int    @id @default(autoincrement())
  tenantId Int    @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Stripe customer
  stripeCustomerId String? @unique

  // Billing contact
  billingEmail String?
  companyName  String?
  taxId        String? // VAT/EIN

  // Billing address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @db.VarChar(2)

  // Legacy fields (deprecated, keep for backward compatibility)
  provider         String?
  subscriptionId   String?
  plan             String?
  status           String?
  currentPeriodEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stripeCustomerId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Subscription & Billing System
 * ────────────────────────────────────────────────────────────────────────────
 */

model Product {
  id Int @id @default(autoincrement())

  // Product details
  name            String
  description     String?          @db.Text
  type            ProductType
  billingInterval BillingInterval?

  // Stripe integration
  stripeProductId String? @unique
  stripePriceId   String?

  // Status
  active Boolean @default(true)

  // Pricing
  priceUSD Int // Price in cents
  currency String @default("USD") @db.VarChar(3)

  // Display
  sortOrder Int   @default(0)
  features  Json? // Feature bullets for display

  // Relations
  entitlements  ProductEntitlement[]
  subscriptions Subscription[]
  addOns        SubscriptionAddOn[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, active])
  @@index([active, sortOrder])
}

model ProductEntitlement {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  entitlementKey EntitlementKey
  limitValue     Int? // Quota limit (null = unlimited)
  metadata       Json?

  createdAt DateTime @default(now())

  @@unique([productId, entitlementKey])
  @@index([productId])
  @@index([entitlementKey])
}

model Subscription {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  status SubscriptionStatus @default(TRIAL)

  // Stripe references
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?

  // Billing cycle
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Trial tracking
  trialStart DateTime?
  trialEnd   DateTime?

  // Pricing snapshot
  amountCents     Int
  currency        String          @default("USD") @db.VarChar(3)
  billingInterval BillingInterval

  // Metadata
  metadata Json?

  // Relations
  addOns SubscriptionAddOn[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([currentPeriodEnd])
}

model SubscriptionAddOn {
  id             Int          @id @default(autoincrement())
  subscriptionId Int
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity    Int @default(1)
  amountCents Int

  // Stripe reference
  stripeItemId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([productId])
}

model UsageRecord {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  metricKey  UsageMetricKey
  value      Int
  recordedAt DateTime       @default(now())

  // Optional context
  userId     String?
  resourceId Int?
  metadata   Json?

  @@index([tenantId, metricKey, recordedAt])
  @@index([recordedAt])
}

model UsageSnapshot {
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  metricKey    UsageMetricKey
  currentValue Int
  limit        Int? // null = unlimited

  lastUpdatedAt DateTime @default(now())

  @@id([tenantId, metricKey])
  @@index([tenantId])
}

model PaymentMethod {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  stripePaymentMethodId String @unique
  type                  String // "card", "us_bank_account"

  // Card details
  cardBrand    String?
  cardLast4    String?
  cardExpMonth Int?
  cardExpYear  Int?

  // Bank details
  bankName  String?
  bankLast4 String?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, isDefault])
}

model ReferralCode {
  id Int @id @default(autoincrement())

  code String @unique

  referrerTenantId Int
  referrer         Tenant @relation("ReferralCodeOwner", fields: [referrerTenantId], references: [id], onDelete: Cascade)

  // Reward structure
  refereeDiscountStripeCouponId String?
  referrerCreditCents           Int?

  // Tracking
  usedCount Int       @default(0)
  maxUses   Int?
  expiresAt DateTime?
  active    Boolean   @default(true)

  // Relations
  referrals Referral[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referrerTenantId])
  @@index([code])
  @@index([active, expiresAt])
}

model Referral {
  id Int @id @default(autoincrement())

  codeId Int
  code   ReferralCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  referrerTenantId Int
  referrer         Tenant @relation("ReferralsMade", fields: [referrerTenantId], references: [id], onDelete: Cascade)

  refereeTenantId Int
  referee         Tenant @relation("ReferralsReceived", fields: [refereeTenantId], references: [id], onDelete: Cascade)

  // Reward tracking
  refereeDiscountApplied Boolean @default(false)
  refereeStripeCouponId  String?

  referrerCreditApplied Boolean   @default(false)
  referrerCreditCents   Int?
  referrerCreditedAt    DateTime?

  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([codeId, refereeTenantId])
  @@index([referrerTenantId])
  @@index([refereeTenantId])
  @@index([codeId])
}

model MarketplaceListing {
  id Int @id @default(autoincrement())

  // Owner
  tenantId Int?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  serviceProviderId Int?
  serviceProvider   ServiceProviderProfile? @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)

  // Listing details
  listingType ListingType
  category    AnimalCategory?
  title       String
  description String?         @db.Text

  // Contact
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Location
  city    String?
  state   String?
  country String  @default("US") @db.VarChar(2)

  // Media
  images   Json?
  videoUrl String?

  // Pricing
  priceCents Int?
  priceType  String? // "fixed", "starting_at", "contact"

  // Monetization
  tier            ListingTier @default(FREE)
  monthlyFeeCents Int?
  commissionRate  Float?

  // Status
  status      ListingStatus @default(DRAFT)
  publishedAt DateTime?
  expiresAt   DateTime?

  // SEO
  slug String? @unique

  // Analytics
  viewCount    Int @default(0)
  inquiryCount Int @default(0)

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([serviceProviderId])
  @@index([status, publishedAt])
  @@index([listingType, category])
  @@index([tier])
}

model ServiceProviderProfile {
  id Int @id @default(autoincrement())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business details
  businessName String
  email        String
  phone        String?
  website      String?

  // Location
  city    String?
  state   String?
  country String  @default("US") @db.VarChar(2)

  // Subscription
  plan ListingTier @default(FREE)

  // Stripe references
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique

  // Relations
  listings MarketplaceListing[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([plan])
}

model SystemConfig {
  key         String   @id
  value       String
  type        String // "number", "boolean", "string", "json"
  description String?  @db.Text
  updatedBy   String?
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model Organization {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  partyId Int   @unique
  party   Party @relation("OrganizationParty", fields: [partyId], references: [id], onDelete: Cascade)

  name     String
  email    String?
  phone    String?
  website  String?
  street   String?
  street2  String?
  city     String?
  state    String?
  zip      String?
  country  String?
  archived Boolean @default(false)

  // Marketplace MVP: public program profile fields
  programSlug        String?
  isPublicProgram    Boolean @default(false)
  programBio         String? @db.Text
  publicContactEmail String?

  contacts            Contact[]
  animals             Animal[]       @relation("OrgAnimals")
  memberships         Membership[]
  createdCustomBreeds CustomBreed[]  @relation("CreatedByOrganization")
  breedingPlans       BreedingPlan[]
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  Invitation          Invitation[]
  externalProvider    String?
  externalId          String?

  @@unique([id, tenantId])
  @@unique([tenantId, name])
  @@unique([tenantId, programSlug])
  @@index([archived])
  @@index([name])
  @@index([tenantId])
  @@index([isPublicProgram])
}

model Membership {
  userId         String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([organizationId])
}

model Party {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  type PartyType

  // Unified list label
  name String

  // Shared comms
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Shared address
  street     String?
  street2    String?
  city       String?
  state      String?
  postalCode String?
  country    String? @db.Char(2)

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization         Organization?              @relation("OrganizationParty")
  contact              Contact?                   @relation("ContactParty")
  users                User[]                     @relation("UserParty")
  attachments          Attachment[]               @relation("AttachmentParty")
  tagAssignments       TagAssignment[]            @relation("TagAssignmentTaggedParty")
  breedingAttempts     BreedingAttempt[]          @relation("BreedingAttemptStudOwner")
  planParties          PlanParty[]                @relation("PlanPartyRole")
  waitlistEntries      WaitlistEntry[]            @relation("WaitlistParty")
  offspringGroupBuyers OffspringGroupBuyer[]      @relation("OffspringGroupBuyerParty")
  offspringBuyers      Offspring[]                @relation("OffspringBuyerParty")
  invoiceParties       Invoice[]                  @relation("InvoiceParty")
  contractParties      ContractParty[]            @relation("ContractPartyRole")
  offspringContracts   OffspringContract[]        @relation("OffspringContractBuyerParty")
  animalBuyers         Animal[]                   @relation("AnimalBuyerParty")
  animalOwnerships     AnimalOwner[]              @relation("AnimalOwnerParty")
  expenseVendors       Expense[]                  @relation("ExpenseVendor")
  commPreferences      PartyCommPreference[]
  commPreferenceEvents PartyCommPreferenceEvent[]
  messageParticipants  MessageParticipant[]       @relation("MessageParticipantParty")
  sentMessages         Message[]                  @relation("MessageSenderParty")
  createdTemplates     Template[]                 @relation("TemplateCreatedBy")
  autoReplyLogs        AutoReplyLog[]             @relation("AutoReplyLogParty")
  portalAccess         PortalAccess?              @relation("PortalAccessParty")
  portalInvites        PortalInvite[]             @relation("PortalInviteParty")
  schedulingBookings   SchedulingBooking[]        @relation("SchedulingBookingParty")

  // Marketplace blocklist (who blocked, who lifted)
  marketplaceBlocksCreated MarketplaceUserBlock[] @relation("MarketplaceBlockCreator")
  marketplaceBlocksLifted  MarketplaceUserBlock[] @relation("MarketplaceBlockLifter")

  @@index([tenantId, type])
  @@index([tenantId, name])
  @@index([tenantId, email])
}

model PartyCommPreference {
  id               Int               @id @default(autoincrement())
  partyId          Int
  channel          CommChannel
  preference       PreferenceLevel   @default(ALLOW)
  compliance       ComplianceStatus?
  complianceSetAt  DateTime?
  complianceSource String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  party            Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, channel])
  @@index([partyId])
  @@index([channel, compliance])
}

model PartyCommPreferenceEvent {
  id             Int               @id @default(autoincrement())
  partyId        Int
  channel        CommChannel
  prevPreference PreferenceLevel?
  newPreference  PreferenceLevel?
  prevCompliance ComplianceStatus?
  newCompliance  ComplianceStatus?
  actorPartyId   Int?
  reason         String?
  source         String?
  createdAt      DateTime          @default(now())
  party          Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([partyId, createdAt])
  @@index([channel, createdAt])
}

model Contact {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  tenant         Tenant        @relation(fields: [tenantId], references: [id])

  partyId Int?   @unique
  party   Party? @relation(name: "ContactParty", fields: [partyId], references: [id], onDelete: Restrict)

  // Names
  display_name String
  first_name   String?
  last_name    String?
  nickname     String?

  // Contact info
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Address
  street  String?
  street2 String?
  city    String?
  state   String?
  zip     String?
  country String? @db.Char(2)

  // Relations

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  externalProvider String?
  externalId       String?

  @@unique([tenantId, email])
  @@index([organizationId])
  @@index([tenantId])
  @@index([display_name])
  @@index([archived])
  @@index([last_name])
  @@index([first_name])
  @@index([nickname])
  @@index([tenantId, partyId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Animals & Ownership
 * ────────────────────────────────────────────────────────────────────────────
 */

model Animal {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organizationId Int?
  organization   Organization? @relation("OrgAnimals", fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  name           String
  species        Species
  sex            Sex
  status         AnimalStatus  @default(ACTIVE)

  // Horse asset metadata (nullable for non-horse species)
  intendedUse           HorseIntendedUse?
  declaredValueCents    Int?
  declaredValueCurrency String?               @db.VarChar(3)
  valuationDate         DateTime?
  valuationSource       HorseValuationSource?
  forSale               Boolean               @default(false)
  inSyndication         Boolean               @default(false)
  isLeased              Boolean               @default(false)

  ownershipChanges AnimalOwnershipChange[]
  birthDate        DateTime?
  microchip        String?
  notes            String?
  breed            String?

  photoUrl String? @db.Text

  canonicalBreedId Int?
  canonicalBreed   Breed? @relation(fields: [canonicalBreedId], references: [id], onDelete: SetNull)

  customBreedId Int?
  customBreed   CustomBreed? @relation(fields: [customBreedId, tenantId], references: [id, tenantId], onDelete: Restrict)

  breeds AnimalBreed[]

  reproductiveCycles  ReproductiveCycle[]
  breedingPlansAsDam  BreedingPlan[]      @relation("PlanDam")
  breedingPlansAsSire BreedingPlan[]      @relation("PlanSire")

  // Cycle Length Override v1: Animal-level override for female cycle length calculation
  // Valid range: 30-730 days. NULL means use automatic calculation from history/biology.
  femaleCycleLenOverrideDays Int?

  // legacy links
  litterId         Int?
  litter           Litter?         @relation(fields: [litterId], references: [id], onDelete: SetNull)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation("OffspringGroupPuppiesLegacy", fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // parent backrefs to groups
  offspringGroupsAsDam  OffspringGroup[] @relation("OffspringDam")
  offspringGroupsAsSire OffspringGroup[] @relation("OffspringSire")

  // parent backrefs to individual offspring
  offspringAsDam  Offspring[] @relation("OffspringIndividualDam")
  offspringAsSire Offspring[] @relation("OffspringIndividualSire")

  // ─────────────────────────────────────────────────────────────────────────────
  // Lineage: Direct parent references for pedigree tracking
  // These allow setting parents for animals not born in-system (imports, purchases)
  // ─────────────────────────────────────────────────────────────────────────────
  damId  Int?
  dam    Animal? @relation("AnimalDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   Animal? @relation("AnimalSire", fields: [sireId], references: [id], onDelete: SetNull)

  // Reverse relations: offspring where this animal is a parent
  childrenAsDam  Animal[] @relation("AnimalDam")
  childrenAsSire Animal[] @relation("AnimalSire")

  // Cached COI (coefficient of inbreeding) - recalculated when pedigree changes
  coiPercent      Float? // 0.0 to 1.0 (display as percentage)
  coiGenerations  Int? // number of generations used in calculation
  coiCalculatedAt DateTime? // when COI was last computed

  // Cross-tenant lineage identity link
  identityLink    AnimalIdentityLink?
  privacySettings AnimalPrivacySettings?

  waitlistAllocations WaitlistEntry[] @relation("WaitlistAllocation")
  waitlistSirePrefs   WaitlistEntry[] @relation("WaitlistSirePref")
  waitlistDamPrefs    WaitlistEntry[] @relation("WaitlistDamPref")

  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  // Party migration step 6G: unified party reference for animal buyer (party-only)
  buyerPartyId       Int?
  buyerParty         Party?    @relation("AnimalBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)
  priceCents         Int?
  depositCents       Int?
  saleInvoiceId      String?
  contractId         String?
  contractSignedAt   DateTime?
  paidInFullAt       DateTime?
  healthCertAt       DateTime?
  microchipAppliedAt DateTime?
  pickupAt           DateTime?
  placedAt           DateTime?

  tagAssignments   TagAssignment[]
  owners           AnimalOwner[]
  registryIds      AnimalRegistryIdentifier[]
  shares           AnimalShare[]              @relation("ShareAnimal")
  publicListing    AnimalPublicListing?
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  archived         Boolean                    @default(false)
  TestResult       TestResult[]
  Attachment       Attachment[]
  Offspring        Offspring[]                @relation("PromotedAnimal")
  PaymentIntent    PaymentIntent[]
  AnimalTraitValue AnimalTraitValue[]
  Document         Document[]
  Invoice          Invoice[]
  Expense          Expense[]
  genetics         AnimalGenetics?

  // Title & Competition tracking
  titles             AnimalTitle[]
  competitionEntries CompetitionEntry[]

  // Cached title strings for display (computed and stored on title changes)
  titlePrefix String? // "GCH CH" - prefix titles in display order
  titleSuffix String? // "CD CGC" - suffix titles in display order

  @@unique([tenantId, microchip])
  @@index([organizationId])
  @@index([tenantId])
  @@index([species])
  @@index([status])
  @@index([archived])
  @@index([canonicalBreedId])
  @@index([tenantId, customBreedId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([tenantId, placedAt])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([damId])
  @@index([sireId])
}

model AnimalGenetics {
  id                 Int       @id @default(autoincrement())
  animalId           Int       @unique
  animal             Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  testProvider       String?   @db.VarChar(255)
  testDate           DateTime? @db.Date
  testId             String?   @db.VarChar(255)
  coatColorData      Json?     @db.JsonB
  healthGeneticsData Json?     @db.JsonB
  coatTypeData       Json?     @db.JsonB // Furnishings, Curly, Long Hair, Shedding
  physicalTraitsData Json?     @db.JsonB // Size (IGF1), Bobtail, Dewclaws, etc.
  eyeColorData       Json?     @db.JsonB // Eye color genetics
  otherTraitsData    Json?     @db.JsonB // Breed-specific traits
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt

  @@index([animalId])
}

model AnimalOwner {
  id        Int     @id @default(autoincrement())
  animalId  Int
  percent   Int
  isPrimary Boolean @default(false)
  animal    Animal  @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // Party migration step 6H: unified party reference for co-owner (party-only)
  partyId Int
  party   Party @relation("AnimalOwnerParty", fields: [partyId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([animalId, partyId])
  @@index([animalId])
  @@index([partyId])
}

model Registry {
  id                Int                        @id @default(autoincrement())
  name              String
  code              String?                    @unique
  url               String?
  country           String?
  species           Species?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  identifiers       AnimalRegistryIdentifier[]
  BreedRegistryLink BreedRegistryLink[]
}

model AnimalRegistryIdentifier {
  id                Int       @id @default(autoincrement())
  animalId          Int
  animal            Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  registryId        Int
  registry          Registry  @relation(fields: [registryId], references: [id], onDelete: Cascade)
  identifier        String
  registrarOfRecord String?
  issuedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([registryId, identifier])
  @@index([animalId])
  @@index([registryId])
}

model AnimalShare {
  id           Int         @id @default(autoincrement())
  animalId     Int
  animal       Animal      @relation("ShareAnimal", fields: [animalId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant      @relation("ShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant      @relation("ShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope  @default(VIEW)
  status       ShareStatus @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([animalId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

model AnimalPublicListing {
  id       Int    @id @default(autoincrement())
  animalId Int    @unique
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Core listing fields
  urlSlug String?              @unique
  intent  AnimalListingIntent?
  status  AnimalListingStatus  @default(DRAFT)

  // Display fields
  headline    String? @db.VarChar(120)
  title       String?
  summary     String? @db.Text
  description String? @db.Text

  // Legacy visibility control (retained for compatibility)
  isListed   Boolean @default(false)
  visibility String?

  // Publishing timestamps
  publishedAt DateTime?
  pausedAt    DateTime?

  // Location override (optional, defaults to org location if null)
  locationCity    String? @db.VarChar(100)
  locationRegion  String? @db.VarChar(100)
  locationCountry String? @db.VarChar(2)

  // Pricing fields for marketplace cards
  priceModel    String? @db.VarChar(32) // "fixed" | "range" | "negotiable" | "inquire"
  priceCents    Int?
  priceMinCents Int?
  priceMaxCents Int?
  priceText     String? @db.VarChar(100)

  // Intent-specific details (JSON for flexibility)
  detailsJson Json? @db.JsonB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, intent])
  @@index([status, intent])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Trait System Models
 * ────────────────────────────────────────────────────────────────────────────
 */

model TraitDefinition {
  id                        Int                @id @default(autoincrement())
  tenantId                  Int?
  species                   Species
  key                       String
  displayName               String
  category                  String
  valueType                 TraitValueType
  enumValues                Json?
  requiresDocument          Boolean            @default(false)
  marketplaceVisibleDefault Boolean            @default(false)
  sortOrder                 Int?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  animalTraitValues         AnimalTraitValue[]

  @@unique([species, key, tenantId])
  @@index([species])
  @@index([tenantId, species])
}

model AnimalTraitValue {
  id                 Int                        @id @default(autoincrement())
  tenantId           Int
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId           Int
  traitDefinitionId  Int
  valueBoolean       Boolean?
  valueNumber        Float?
  valueText          String?
  valueDate          DateTime?
  valueJson          Json?
  status             TraitStatus?
  performedAt        DateTime?
  source             TraitSource?
  verified           Boolean                    @default(false)
  verifiedAt         DateTime?
  marketplaceVisible Boolean?
  notes              String?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  traitDefinition    TraitDefinition            @relation(fields: [traitDefinitionId], references: [id])
  animal             Animal                     @relation(fields: [animalId], references: [id], onDelete: Cascade)
  documents          AnimalTraitValueDocument[]

  @@unique([tenantId, animalId, traitDefinitionId])
  @@index([tenantId, animalId])
  @@index([tenantId, traitDefinitionId])
}

model AnimalTraitValueDocument {
  id                 Int              @id @default(autoincrement())
  tenantId           Int
  animalId           Int
  animalTraitValueId Int
  documentId         Int
  createdAt          DateTime         @default(now())
  animalTraitValue   AnimalTraitValue @relation(fields: [animalTraitValueId], references: [id], onDelete: Cascade)
  document           Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([tenantId, animalTraitValueId, documentId])
  @@index([tenantId, animalId])
  @@index([tenantId, animalTraitValueId])
  @@index([tenantId, documentId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Tags
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tag {
  id          Int             @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  module      TagModule
  color       String?
  isArchived  Boolean         @default(false)
  archivedAt  DateTime?
  assignments TagAssignment[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([tenantId, module, name])
  @@index([tenantId, module])
  @@index([tenantId, isArchived, module])
}

model TagAssignment {
  id    Int @id @default(autoincrement())
  tagId Int
  tag   Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  // Step 6B: Party-only storage for Contact/Organization tags
  taggedPartyId Int?
  taggedParty   Party? @relation("TagAssignmentTaggedParty", fields: [taggedPartyId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: Cascade)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([tagId, taggedPartyId])
  @@unique([tagId, animalId])
  @@unique([tagId, waitlistEntryId])
  @@unique([tagId, offspringGroupId])
  @@unique([tagId, offspringId])
  @@index([taggedPartyId])
  @@index([animalId])
  @@index([waitlistEntryId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([tagId, taggedPartyId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeds
 * ────────────────────────────────────────────────────────────────────────────
 */

model Breed {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  species   Species
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  registries         BreedRegistryLink[]
  Animal             Animal[]
  AnimalBreeds       AnimalBreed[]
  TenantProgramBreed TenantProgramBreed[]

  @@index([species])
}

model AnimalBreed {
  id         Int      @id @default(autoincrement())
  animalId   Int
  animal     Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  breedId    Int
  breed      Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  percentage Float    @default(100)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([animalId, breedId])
  @@index([animalId])
  @@index([breedId])
}

model BreedRegistryLink {
  breedId    Int
  registryId Int

  statusText  String?
  registryRef String?
  url         String?
  primary     Boolean?
  since       Int?
  notes       String?
  proofUrl    String?

  breed    Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  registry Registry @relation(fields: [registryId], references: [id], onDelete: Cascade)

  @@id([breedId, registryId])
  @@index([registryId])
}

model CustomBreed {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdByOrganizationId Int?
  createdByOrganization   Organization? @relation("CreatedByOrganization", fields: [createdByOrganizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  species     Species
  name        String
  composition Json?

  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  Animal             Animal[]
  TenantProgramBreed TenantProgramBreed[]

  @@unique([id, tenantId])
  @@unique([tenantId, species, name])
  @@index([tenantId, species])
  @@index([tenantId, createdByOrganizationId])
}

/// Breeds selected for a tenant's breeding program (displayed on marketplace listings)
model TenantProgramBreed {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  species Species

  /// Reference to canonical breed (mutually exclusive with customBreedId)
  breedId Int?
  breed   Breed? @relation(fields: [breedId], references: [id], onDelete: Cascade)

  /// Reference to custom breed (mutually exclusive with breedId)
  customBreedId Int?
  customBreed   CustomBreed? @relation(fields: [customBreedId, tenantId], references: [id, tenantId], onDelete: Cascade)

  /// Whether this is the primary breed for the species
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, breedId])
  @@unique([tenantId, customBreedId])
  @@index([tenantId, species])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding core
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlan {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  code      String?
  name      String
  nickname  String?
  species   Species
  breedText String?

  damId  Int?
  dam    Animal? @relation("PlanDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId Int?
  sire   Animal? @relation("PlanSire", fields: [sireId], references: [id], onDelete: SetNull)

  lockedCycleKey           String?
  lockedCycleStart         DateTime?
  lockedOvulationDate      DateTime?
  lockedDueDate            DateTime?
  lockedPlacementStartDate DateTime?

  expectedCycleStart          DateTime?
  expectedHormoneTestingStart DateTime?
  expectedBreedDate           DateTime?
  expectedBirthDate           DateTime?
  expectedWeaned              DateTime?
  expectedPlacementStart      DateTime?
  expectedPlacementCompleted  DateTime?

  cycleStartDateActual          DateTime?
  hormoneTestingStartDateActual DateTime?
  breedDateActual               DateTime?
  birthDateActual               DateTime?
  weanedDateActual              DateTime?
  placementStartDateActual      DateTime?
  placementCompletedDateActual  DateTime?
  completedDateActual           DateTime?

  status BreedingPlanStatus @default(PLANNING)
  notes  String?

  committedAt       DateTime?
  committedByUserId String?
  committedByUser   User?     @relation("CommittedByUser", fields: [committedByUserId], references: [id], onDelete: SetNull)

  depositsCommittedCents Int?
  depositsPaidCents      Int?
  depositRiskScore       Int?

  Litter           Litter?
  offspringGroup   OffspringGroup?
  Events           BreedingPlanEvent[]
  Waitlist         WaitlistEntry[]
  Shares           BreedingPlanShare[]
  TestResults      TestResult[]
  BreedingAttempts BreedingAttempt[]
  PregnancyChecks  PregnancyCheck[]
  Attachments      Attachment[]
  Parties          PlanParty[]
  Invoice          Invoice[]
  Expense          Expense[]

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([organizationId])
  @@index([damId])
  @@index([sireId])
  @@index([status])
  @@index([committedAt])
  @@index([expectedWeaned])
  @@index([expectedPlacementCompleted])
  @@index([expectedPlacementStart])
  @@index([placementStartDateActual])
  @@index([placementCompletedDateActual])
  @@index([expectedBirthDate])
  @@index([expectedCycleStart])
  @@index([expectedHormoneTestingStart])
  @@index([expectedBreedDate])
  @@index([cycleStartDateActual])
}

model ReproductiveCycle {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  femaleId Int
  female   Animal @relation(fields: [femaleId], references: [id], onDelete: Cascade)

  cycleStart         DateTime
  ovulation          DateTime?
  dueDate            DateTime?
  placementStartDate DateTime?

  status String?
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([femaleId])
  @@index([cycleStart])
}

model BreedingPlanShare {
  id           Int          @id @default(autoincrement())
  planId       Int
  plan         BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant       @relation("PlanShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant       @relation("PlanShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope   @default(BREED_PLAN)
  status       ShareStatus  @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([planId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding plug-ins
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlanEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  type String

  occurredAt DateTime
  label      String?
  notes      String?
  data       Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, type, occurredAt])
}

model TestResult {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  kind    String
  method  String?
  labName String?

  valueNumber    Float?
  valueText      String?
  units          String?
  referenceRange String?

  collectedAt DateTime
  resultAt    DateTime?
  notes       String?
  data        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([animalId])
  @@index([planId])
  @@index([kind, collectedAt])
}

model BreedingAttempt {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method      BreedingMethod
  attemptAt   DateTime?
  windowStart DateTime?
  windowEnd   DateTime?

  // Party migration step 5: unified party reference for stud owner
  studOwnerPartyId Int?
  studOwnerParty   Party? @relation("BreedingAttemptStudOwner", fields: [studOwnerPartyId], references: [id], onDelete: SetNull)

  semenBatchId Int?

  success Boolean?
  notes   String?
  data    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId])
  @@index([studOwnerPartyId])
}

model PregnancyCheck {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method    PregnancyCheckMethod
  result    Boolean
  checkedAt DateTime
  notes     String?
  data      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, checkedAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group, Offspring, legacy Litter, Waitlist
 * ────────────────────────────────────────────────────────────────────────────
 */

model OffspringGroup {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  linkState  OffspringLinkState   @default(linked)
  linkReason OffspringLinkReason?

  species Species
  damId   Int?
  dam     Animal? @relation("OffspringDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId  Int?
  sire    Animal? @relation("OffspringSire", fields: [sireId], references: [id], onDelete: SetNull)
  name    String?

  expectedBirthOn DateTime?
  actualBirthOn   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  published     Boolean @default(false)
  coverImageUrl String?
  themeName     String?

  // Marketplace MVP: public listing fields
  listingSlug                  String?
  listingTitle                 String?
  listingDescription           String? @db.Text
  marketplaceDefaultPriceCents Int?

  notes String?
  data  Json?

  // Phase 6: Placement scheduling policy for scheduling fairness
  placementSchedulingPolicy Json?

  // children as Offspring, not Animals
  Offspring Offspring[] @relation("GroupOffspring")

  // legacy Animal linkage retained for compatibility
  AnimalsLegacy Animal[] @relation("OffspringGroupPuppiesLegacy")

  Waitlist         WaitlistEntry[]
  Tags             TagAssignment[]
  Events           OffspringGroupEvent[]
  Attachment       Attachment[]
  groupBuyerLinks  OffspringGroupBuyer[]         @relation("GroupBuyerGroup")
  schedulingBlocks SchedulingAvailabilityBlock[] @relation("GroupSchedulingBlocks")

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  archivedAt DateTime?
  Invoice    Invoice[]
  Campaign   Campaign[]
  Task       Task[]
  Document   Document[]
  Contract   Contract[]
  Expense    Expense[]

  @@unique([planId])
  @@unique([tenantId, listingSlug])
  @@index([tenantId])
  @@index([tenantId, species, expectedBirthOn])
  @@index([tenantId, damId, actualBirthOn])
  @@index([sireId])
  @@index([linkState])
  @@index([placementStartAt])
  @@index([placementCompletedAt])
  @@index([published])
}

model OffspringGroupBuyer {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  groupId Int
  group   OffspringGroup @relation("GroupBuyerGroup", fields: [groupId], references: [id], onDelete: Cascade)

  // Step 6C: Party-only storage for buyer identity
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringGroupBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation("GroupBuyerWaitlistEntry", fields: [waitlistEntryId], references: [id], onDelete: SetNull)

  // Phase 6: Placement rank for scheduling fairness (lower rank = earlier pick)
  placementRank Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, buyerPartyId])
  @@unique([groupId, waitlistEntryId])
  @@index([tenantId])
  @@index([groupId])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([waitlistEntryId])
}

model Offspring {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  groupId Int
  group   OffspringGroup @relation("GroupOffspring", fields: [groupId], references: [id], onDelete: Cascade)

  // identity
  name    String?
  species Species
  breed   String?
  sex     Sex?
  bornAt  DateTime?
  diedAt  DateTime?
  status  OffspringStatus @default(NEWBORN)

  // orthogonal lifecycle dimensions (production canonical state)
  lifeState      OffspringLifeState      @default(ALIVE)
  placementState OffspringPlacementState @default(UNASSIGNED)
  keeperIntent   OffspringKeeperIntent   @default(AVAILABLE)
  financialState OffspringFinancialState @default(NONE)
  paperworkState OffspringPaperworkState @default(NONE)

  // parents as of creation time
  damId  Int?
  dam    Animal? @relation("OffspringIndividualDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   Animal? @relation("OffspringIndividualSire", fields: [sireId], references: [id], onDelete: SetNull)

  // collar
  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  // Step 6D: Party-only storage for buyer identity
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  // finance and placement
  priceCents       Int?
  depositCents     Int?
  contractId       String?
  contractSignedAt DateTime?
  paidInFullAt     DateTime?
  pickupAt         DateTime?
  placedAt         DateTime?

  // marketplace listing control
  marketplaceListed     Boolean @default(false)
  marketplacePriceCents Int?

  // promotion link
  promotedAnimalId Int?
  promotedAnimal   Animal? @relation("PromotedAnimal", fields: [promotedAnimalId], references: [id], onDelete: SetNull)

  notes String?
  data  Json?

  Tags                TagAssignment[]
  Attachments         Attachment[]
  Events              OffspringEvent[]
  WaitlistAllocations WaitlistEntry[]  @relation("WaitlistAllocationOffspring")

  // finance, tasks, health, documents, contracts
  Invoices   Invoice[]
  Tasks      Task[]
  HealthLogs HealthEvent[]
  Documents  Document[]
  Contracts  Contract[]

  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  InvoiceLinks             OffspringInvoiceLink[]
  CampaignAttribution      CampaignAttribution[]
  OffspringDocument        OffspringDocument[]
  OffspringContract        OffspringContract[]
  schedulingEventTemplates SchedulingEventTemplate[]

  @@index([tenantId])
  @@index([groupId])
  @@index([tenantId, status])
  @@index([tenantId, lifeState])
  @@index([tenantId, placementState])
  @@index([tenantId, keeperIntent])
  @@index([tenantId, financialState])
  @@index([tenantId, paperworkState])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([placedAt])
  @@index([tenantId, damId])
  @@index([tenantId, sireId])
}

model OffspringEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  // NOTE, CHANGE, HEALTH, PROMOTION
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId, type, occurredAt])
}

/**
 * Legacy Litter retained
 */
model Litter {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int          @unique
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  identifier     String?
  birthedStartAt DateTime?
  birthedEndAt   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  statusOverride       String?
  statusOverrideReason String?

  published     Boolean @default(false)
  coverImageUrl String?
  themeName     String?

  notes String?
  data  Json?

  Animals    Animal[]
  Waitlist   WaitlistEntry[]
  Attachment Attachment[]
  Events     LitterEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, weanedAt])
  @@index([tenantId, placementStartAt])
  @@index([tenantId, placementCompletedAt])
}

model WaitlistEntry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // Step 6E: Party-only storage for client identity
  clientPartyId Int?
  clientParty   Party? @relation("WaitlistParty", fields: [clientPartyId], references: [id], onDelete: SetNull)

  speciesPref Species?
  breedPrefs  Json?
  sirePrefId  Int?
  sirePref    Animal?  @relation("WaitlistSirePref", fields: [sirePrefId], references: [id], onDelete: SetNull)
  damPrefId   Int?
  damPref     Animal?  @relation("WaitlistDamPref", fields: [damPrefId], references: [id], onDelete: SetNull)

  status               WaitlistStatus @default(INQUIRY)
  priority             Int?
  depositInvoiceId     String?
  balanceInvoiceId     String?
  depositPaidAt        DateTime?
  depositRequiredCents Int?
  depositPaidCents     Int?
  balanceDueCents      Int?

  // legacy allocation to Animal
  animalId Int?
  animal   Animal? @relation("WaitlistAllocation", fields: [animalId], references: [id], onDelete: SetNull)

  // canonical allocation to Offspring
  offspringId Int?
  offspring   Offspring? @relation("WaitlistAllocationOffspring", fields: [offspringId], references: [id], onDelete: SetNull)

  groupBuyerLinks OffspringGroupBuyer[] @relation("GroupBuyerWaitlistEntry")

  skipCount  Int?
  lastSkipAt DateTime?

  // Approval/rejection tracking
  approvedAt     DateTime?
  rejectedAt     DateTime?
  rejectedReason String?

  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  TagAssignment TagAssignment[]

  @@index([tenantId])
  @@index([planId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([clientPartyId])
  @@index([tenantId, clientPartyId])
  @@index([tenantId, speciesPref])
  @@index([sirePrefId])
  @@index([damPrefId])
  @@index([animalId])
  @@index([tenantId, depositPaidAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model OffspringGroupEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringGroupId Int
  offspringGroup   OffspringGroup @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)

  // CHANGE, NOTE, STATUS_OVERRIDE, BUYER_MOVE, LINK, UNLINK
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringGroupId, type, occurredAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Litter audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model LitterEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  litterId Int
  litter   Litter @relation(fields: [litterId], references: [id], onDelete: Cascade)

  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([litterId, type, occurredAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Attachments, Parties, Counters
 * ────────────────────────────────────────────────────────────────────────────
 */

model Attachment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // Step 6A: Party-only attachment ownership. Legacy contactId removed, use attachmentParty instead.
  attachmentPartyId Int?
  attachmentParty   Party? @relation("AttachmentParty", fields: [attachmentPartyId], references: [id], onDelete: SetNull)

  // Finance MVP: receipts and documents for invoices, payments, expenses
  invoiceId Int?
  invoice   Invoice? @relation("AttachmentInvoice", fields: [invoiceId], references: [id], onDelete: SetNull)
  paymentId Int?
  payment   Payment? @relation("AttachmentPayment", fields: [paymentId], references: [id], onDelete: SetNull)
  expenseId Int?
  expense   Expense? @relation("AttachmentExpense", fields: [expenseId], references: [id], onDelete: SetNull)

  kind            String
  storageProvider String
  storageKey      String
  filename        String
  mime            String
  bytes           Int

  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt         DateTime            @default(now())
  OffspringDocument OffspringDocument[]
  OffspringContract OffspringContract[]

  @@index([tenantId])
  @@index([planId])
  @@index([animalId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([attachmentPartyId])
  @@index([invoiceId])
  @@index([paymentId])
  @@index([expenseId])
}

model PlanParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  role String

  // Step 6F: Party-only storage for role-based parties
  partyId Int?
  party   Party? @relation("PlanPartyRole", fields: [partyId], references: [id], onDelete: SetNull)

  notes String?

  @@index([tenantId])
  @@index([planId])
  @@index([partyId])
  @@index([tenantId, partyId, role])
}

model PlanCodeCounter {
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  year Int
  seq  Int @default(0)

  @@id([tenantId, year])
  @@index([tenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Generic, namespaced tenant settings
 * ────────────────────────────────────────────────────────────────────────────
 */

model TenantSetting {
  tenantId  Int
  namespace String
  version   Int     @default(1)
  data      Json
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, namespace])
  @@index([tenantId])
  @@index([namespace])
}

/**
 * Additive models: finance, marketing, tasks, health, documents, contracts
 */

enum FinanceScope {
  group
  offspring
  contact
  organization
  general
}

enum InvoiceStatus {
  draft
  issued
  partially_paid
  paid
  void
  uncollectible
  refunded
  cancelled
}

enum InvoiceCategory {
  DEPOSIT
  SERVICE
  GOODS
  MIXED
  OTHER
}

enum LineItemKind {
  DEPOSIT
  SERVICE_FEE
  GOODS
  DISCOUNT
  TAX
  OTHER
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
  disputed
  cancelled
}

enum ExpenseCategory {
  VETERINARY
  FEED
  SUPPLIES
  BREEDING_FEE
  BOARDING
  TRAINING
  TRANSPORT
  MARKETING
  ADMINISTRATIVE
  FACILITIES
  INSURANCE
  OTHER
}

enum CampaignChannel {
  email
  social
  ads
  marketplace
  website
  other
}

enum TaskScope {
  group
  offspring
}

enum TaskStatus {
  open
  in_progress
  done
  cancelled
}

enum HealthType {
  weight
  vaccine
  deworm
  vet_visit
  treatment
  other
}

enum DocumentScope {
  group
  offspring
  invoice
  contract
  animal
}

enum DocumentKind {
  generic
  health_certificate
  registration
  contract_pdf
  invoice_pdf
  photo
  other
  bill_of_sale
  syndication_agreement
  lease_agreement
  insurance_policy
  vet_certificate
}

enum SignatureProvider {
  internal
  docusign
  hellosign
  adobe
  other
}

enum ContractStatus {
  draft
  sent
  viewed
  signed
  declined
  voided
  expired
}

enum SignatureStatus {
  pending
  viewed
  signed
  declined
  voided
  expired
}

// ---------- Finance ----------

/**
 * Sequence counter for server-side numbering (invoice numbers, etc.)
 * Tenant-scoped, per-year counter for generating unique sequential numbers
 */
model Sequence {
  id         Int      @id @default(autoincrement())
  tenantId   Int
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key        String // e.g., "invoice"
  year       Int
  nextNumber Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([tenantId, key, year])
  @@index([tenantId, key, year])
}

/**
 * IdempotencyKey for preventing duplicate operations
 * Stores request hash and response for exact-match replay
 */
model IdempotencyKey {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key          String // Client-provided idempotency key
  requestHash  String // Hash of request body
  responseBody String? // Stored response payload
  createdAt    DateTime @default(now())

  @@unique([tenantId, key])
  @@index([tenantId, createdAt])
}

model Invoice {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope   FinanceScope
  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // Party migration step 6J: unified party reference for invoice client/buyer
  clientPartyId Int?
  clientParty   Party? @relation("InvoiceParty", fields: [clientPartyId], references: [id], onDelete: SetNull)

  // Finance MVP anchor fields
  animalId       Int?
  animal         Animal?       @relation(fields: [animalId], references: [id], onDelete: SetNull)
  breedingPlanId Int?
  breedingPlan   BreedingPlan? @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)

  invoiceNumber String // Server-generated, format: INV-YYYY-NNNN
  number        String? // Legacy field, keep for compatibility
  currency      String          @default("USD")
  amountCents   Int
  balanceCents  Int
  depositCents  Int?
  status        InvoiceStatus   @default(draft)
  category      InvoiceCategory @default(OTHER)
  dueAt         DateTime?
  issuedAt      DateTime?
  paidAt        DateTime?
  voidedAt      DateTime?
  paymentTerms  String?

  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?

  notes String?
  data  Json?

  LineItems     InvoiceLineItem[]
  Payments      Payment[]
  Documents     Document[]
  Contract      Contract?
  Attachments   Attachment[]      @relation("AttachmentInvoice")
  EmailSendLogs EmailSendLog[]

  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  OffspringInvoiceLink OffspringInvoiceLink[]
  PaymentIntent        PaymentIntent[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([tenantId, clientPartyId, status])
  @@index([tenantId, offspringId])
  @@index([tenantId, groupId])
  @@index([tenantId, animalId])
  @@index([tenantId, breedingPlanId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status])
  @@index([clientPartyId])
}

model InvoiceLineItem {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  kind          LineItemKind @default(OTHER)
  description   String
  qty           Int          @default(1)
  unitCents     Int
  discountCents Int?
  taxRate       Float?
  category      String?
  itemCode      String?
  totalCents    Int

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([invoiceId])
}

model Payment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  status       PaymentStatus @default(pending)
  amountCents  Int
  receivedAt   DateTime // When payment was received
  methodType   String? // e.g., "card", "bank_transfer", "cash", "check"
  processor    String? // e.g., "stripe", "square", "manual"
  processorRef String? // Reference from payment processor
  method       String? // Legacy field
  reference    String? // Legacy field
  paidAt       DateTime? // Legacy field

  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?

  notes String?
  data  Json?

  Attachments Attachment[] @relation("AttachmentPayment")

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, invoiceId])
  @@index([tenantId, receivedAt])
  @@index([invoiceId])
  @@index([status])
}

/**
 * Expense tracking for business operations
 * Can be anchored to breeding plans, offspring groups, animals, or general operations
 */
model Expense {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  amountCents Int
  currency    String          @default("USD")
  incurredAt  DateTime
  category    ExpenseCategory
  description String?

  // Optional vendor/supplier
  vendorPartyId Int?
  vendorParty   Party? @relation("ExpenseVendor", fields: [vendorPartyId], references: [id], onDelete: SetNull)

  // Anchor fields - expense can be linked to one of these
  breedingPlanId   Int?
  breedingPlan     BreedingPlan?   @relation(fields: [breedingPlanId], references: [id], onDelete: SetNull)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)
  animalId         Int?
  animal           Animal?         @relation(fields: [animalId], references: [id], onDelete: SetNull)

  notes String?
  data  Json?

  Attachments Attachment[] @relation("AttachmentExpense")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, incurredAt])
  @@index([tenantId, breedingPlanId])
  @@index([tenantId, offspringGroupId])
  @@index([tenantId, animalId])
  @@index([tenantId, vendorPartyId])
  @@index([tenantId, category])
}

model AnimalOwnershipChange {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  kind          OwnershipChangeKind
  effectiveDate DateTime?
  occurredAt    DateTime            @default(now())

  valueCents Int?
  currency   String? @db.VarChar(3)

  // Immutable snapshots of ownership at time of change
  fromOwners Json
  toOwners   Json

  // Party migration step 5: party-based ownership snapshots
  fromOwnerParties Json?
  toOwnerParties   Json?

  notes     String?
  documents Document[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  PaymentIntent PaymentIntent[]

  @@index([tenantId])
  @@index([animalId])
  @@index([kind])
  @@index([occurredAt])
}

model PaymentIntent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional links depending on what the payment represents
  invoiceId         Int?
  invoice           Invoice?               @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  animalId          Int?
  animal            Animal?                @relation(fields: [animalId], references: [id], onDelete: SetNull)
  ownershipChangeId Int?
  ownershipChange   AnimalOwnershipChange? @relation(fields: [ownershipChangeId], references: [id], onDelete: SetNull)

  purpose PaymentIntentPurpose
  status  PaymentIntentStatus  @default(PLANNED)

  amountCents Int
  currency    String @db.VarChar(3)

  externalProvider String?
  externalId       String?
  reference        String?

  data Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([invoiceId])
  @@index([animalId])
  @@index([ownershipChangeId])
  @@index([status])
  @@index([purpose])
}

// ---------- Marketing ----------
model Campaign {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringGroupId Int?
  group            OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  name      String
  channel   CampaignChannel
  startedAt DateTime?
  endedAt   DateTime?

  budgetCents Int?
  spendCents  Int?

  impressions  Int?
  clicks       Int?
  inquiries    Int?
  reservations Int?
  conversions  Int?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  notes String?
  data  Json?

  Attributions CampaignAttribution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringGroupId])
  @@index([channel])
}

model CampaignAttribution {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  campaignId Int
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  weight Float?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([campaignId])
  @@index([offspringId])
}

enum EmailSendStatus {
  queued
  sent
  failed
}

enum TemplateChannel {
  email
  dm
  social
}

enum TemplateStatus {
  draft
  active
  archived
}

enum TemplateCategory {
  auto_reply
  invoice_message
  birth_announcement
  waitlist_update
  general_follow_up
  custom
}

enum EmailSendCategory {
  transactional
  marketing
}

enum AutoReplyTriggerType {
  dm_first_message_from_party
  dm_after_hours
}

enum AutoReplyStatus {
  sent
  skipped
  failed
}

model Template {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  key         String? // stable identifier for system templates
  channel     TemplateChannel
  category    TemplateCategory
  status      TemplateStatus   @default(draft)
  description String?          @db.Text

  createdByPartyId Int?
  createdByParty   Party? @relation("TemplateCreatedBy", fields: [createdByPartyId], references: [id], onDelete: SetNull)

  content        TemplateContent[]
  autoReplyRules AutoReplyRule[]

  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([tenantId, key])
  @@index([tenantId, channel])
  @@index([tenantId, status])
  @@index([tenantId, category])
}

model TemplateContent {
  id         Int      @id @default(autoincrement())
  templateId Int
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  subject      String? // email only
  bodyText     String  @db.Text
  bodyHtml     String? @db.Text // email only
  metadataJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
}

model AutoReplyRule {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  channel TemplateChannel
  enabled Boolean         @default(true)

  templateId Int
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  triggerType       AutoReplyTriggerType
  cooldownMinutes   Int                  @default(60)
  businessHoursJson Json?

  logs AutoReplyLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, channel, enabled])
  @@index([templateId])
}

model AutoReplyLog {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  channel TemplateChannel
  partyId Int
  party   Party           @relation("AutoReplyLogParty", fields: [partyId], references: [id], onDelete: Cascade)

  threadId Int?
  thread   MessageThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)

  ruleId Int?
  rule   AutoReplyRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  templateId Int?

  status AutoReplyStatus
  reason String?         @db.Text

  createdAt DateTime @default(now())

  @@index([tenantId, partyId])
  @@index([tenantId, channel, createdAt])
  @@index([threadId])
  @@index([ruleId])
}

model EmailSendLog {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  to      String
  from    String
  subject String

  templateKey       String?
  templateId        Int?
  category          EmailSendCategory?
  provider          String             @default("resend")
  providerMessageId String?

  relatedInvoiceId Int?
  invoice          Invoice? @relation(fields: [relatedInvoiceId], references: [id], onDelete: SetNull)

  status   EmailSendStatus @default(queued)
  error    Json?
  metadata Json?

  createdAt DateTime @default(now())

  @@unique([tenantId, templateKey, relatedInvoiceId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([providerMessageId])
  @@index([createdAt])
  @@index([relatedInvoiceId])
  @@index([templateId])
  @@index([tenantId, category])
}

model MessageThread {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  subject  String?
  archived Boolean @default(false)

  // Marketplace MVP: inquiry context fields
  inquiryType       String? // "MARKETPLACE" | "WAITLIST" | "GENERAL" | null
  sourceListingSlug String?
  guestEmail        String?
  guestName         String?

  participants  MessageParticipant[]
  messages      Message[]
  autoReplyLogs AutoReplyLog[]

  lastMessageAt DateTime?

  // Response time tracking for "Quick Responder" badge
  // Time when first inbound message was received (from non-org party)
  firstInboundAt            DateTime?
  // Time when org/breeder first replied to inbound message
  firstOrgReplyAt           DateTime?
  // Calculated response time in seconds (null until org replies) - raw wall-clock time
  responseTimeSeconds       Int?
  // Calculated response time in seconds counting only business hours
  // This is the value used for Quick Responder badge calculation
  businessHoursResponseTime Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, updatedAt])
  @@index([inquiryType])
  @@index([tenantId, responseTimeSeconds])
  @@index([tenantId, businessHoursResponseTime])
}

model MessageParticipant {
  id       Int           @id @default(autoincrement())
  threadId Int
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  partyId Int
  party   Party @relation("MessageParticipantParty", fields: [partyId], references: [id], onDelete: Cascade)

  lastReadAt DateTime?

  createdAt DateTime @default(now())

  @@unique([threadId, partyId])
  @@index([threadId])
  @@index([partyId])
}

model Message {
  id       Int           @id @default(autoincrement())
  threadId Int
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  senderPartyId Int
  senderParty   Party @relation("MessageSenderParty", fields: [senderPartyId], references: [id], onDelete: Cascade)

  body String @db.Text

  isAutomated      Boolean @default(false)
  automationRuleId Int?

  createdAt DateTime @default(now())

  @@index([threadId, createdAt])
  @@index([senderPartyId])
}

// ---------- Tasks ----------
model Task {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope TaskScope

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  title  String
  notes  String?
  dueAt  DateTime?
  status TaskStatus @default(open)

  assignedToUserId String?
  assignedToUser   User?   @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status, dueAt])
}

// ---------- Health ----------
model HealthEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  kind       HealthType
  occurredAt DateTime

  weightGrams Int?
  vaccineCode String?
  dose        String?
  vetClinic   String?
  result      String?
  notes       String?
  data        Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId, occurredAt])
  @@index([kind])
}

// ---------- Documents & Contracts ----------
model Document {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope DocumentScope
  kind  DocumentKind  @default(generic)

  // Optional links for Animal and ownership transactions (horses)
  animalId          Int?
  animal            Animal?                @relation(fields: [animalId], references: [id], onDelete: SetNull)
  ownershipChangeId Int?
  ownershipChange   AnimalOwnershipChange? @relation(fields: [ownershipChangeId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  invoiceId Int?     @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  contractId Int?
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  title       String
  storageKey  String?
  externalUrl String?
  mimeType    String?
  bytes       Int?
  sha256      String?

  data             Json?
  // Prototype fields for trait document linking
  visibility       DocVisibility? @default(PRIVATE)
  status           DocStatus?     @default(PLACEHOLDER)
  sizeBytes        Int?
  originalFileName String?
  storageProvider  String?
  bucket           String?
  objectKey        String?
  url              String?

  // Relation to trait values
  traitValueLinks AnimalTraitValueDocument[]

  // Title & Competition document links
  titleLinks       AnimalTitleDocument[]
  competitionLinks CompetitionEntryDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope, offspringId])
  @@index([scope, groupId])
  @@index([scope, invoiceId])
  @@index([scope, contractId])
  @@index([kind])
}

model ContractTemplate {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  body        String?
  storageKey  String?
  description String?

  isActive Boolean @default(true)
  data     Json?

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  Contract  Contract[]

  @@index([tenantId])
  @@index([isActive])
}

model Contract {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  templateId Int?
  template   ContractTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  invoiceId Int?     @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  title  String
  status ContractStatus @default(draft)

  provider           SignatureProvider @default(internal)
  providerEnvelopeId String?
  providerDocId      String?

  issuedAt  DateTime?
  signedAt  DateTime?
  voidedAt  DateTime?
  expiresAt DateTime?

  documents Document[]
  parties   ContractParty[]
  events    SignatureEvent[]

  data Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([groupId])
  @@index([invoiceId])
  @@index([status])
  @@index([provider, providerEnvelopeId])
}

model ContractParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contractId Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  partyId Int?
  party   Party? @relation("ContractPartyRole", fields: [partyId], references: [id], onDelete: SetNull)

  role   String?
  email  String?
  name   String?
  signer Boolean @default(true)
  order  Int?

  status   SignatureStatus @default(pending)
  signedAt DateTime?

  providerRecipientId String?

  data Json?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  SignatureEvent SignatureEvent[]

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([tenantId, partyId])
  @@index([status])
}

model SignatureEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contractId Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  partyId Int?
  party   ContractParty? @relation(fields: [partyId], references: [id], onDelete: SetNull)

  status    SignatureStatus
  at        DateTime        @default(now())
  ipAddress String?
  userAgent String?
  message   String?
  data      Json?

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([status, at])
}

enum InvoiceRole {
  RESERVATION
  DEPOSIT
  FINAL
  MISC
}

enum EsignProvider {
  DOCUSIGN
  HELLOSIGN
  ADOBE
  OTHER
}

enum EsignStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  DECLINED
  EXPIRED
  VOIDED
}

model OffspringDocument {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  name       String
  templateId String?
  provider   EsignProvider?
  status     EsignStatus    @default(DRAFT)

  sentAt      DateTime?
  viewedAt    DateTime?
  completedAt DateTime?

  fileId Int?
  file   Attachment? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  metaJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([status])
}

model OffspringContract {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  title    String
  version  String?
  provider EsignProvider?
  status   EsignStatus    @default(DRAFT)

  sentAt   DateTime?
  viewedAt DateTime?
  signedAt DateTime?

  fileId Int?
  file   Attachment? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  // Party migration step 6L: unified party reference for contract buyer (legacy columns removed)
  buyerPartyId Int?
  buyerParty   Party? @relation("OffspringContractBuyerParty", fields: [buyerPartyId], references: [id], onDelete: SetNull)

  metaJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([status])
}

model OffspringInvoiceLink {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  invoiceId Int?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  role        InvoiceRole @default(MISC)
  amountCents Int?
  currency    String?

  externalProvider String?
  externalId       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([offspringId, invoiceId, role])
  @@index([tenantId])
  @@index([offspringId])
  @@index([invoiceId])
}

model AccountingIntegration {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider String // for example "quickbooks_online"
  realmId  String // external account or company id

  accessToken          String
  refreshToken         String
  accessTokenExpiresAt DateTime

  isActive       Boolean   @default(true)
  syncDirection  String    @default("outbound") // outbound, inbound, bidirectional
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastSyncError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, provider])
}

/**
 * Portal Access Management
 * Controls client portal access per Party (Contact or Organization)
 */

model PortalAccess {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation("PortalAccessTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int    @unique
  party    Party  @relation("PortalAccessParty", fields: [partyId], references: [id], onDelete: Cascade)

  // UX state only - NOT used for authorization
  status PortalAccessStatus @default(NO_ACCESS)

  // Linked user (set when invite is accepted)
  userId String?
  user   User?   @relation("PortalAccessUser", fields: [userId], references: [id], onDelete: SetNull)

  // Denormalized pointer to TenantMembership (informational only, set after acceptance)
  // Note: Cannot add FK to composite PK, so this is just userId reference for traceability
  membershipUserId String?

  // Timestamps
  invitedAt   DateTime?
  activatedAt DateTime?
  suspendedAt DateTime?
  lastLoginAt DateTime?

  // Audit
  createdByUserId String?
  updatedByUserId String?
  createdBy       User?   @relation("PortalAccessCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedBy       User?   @relation("PortalAccessUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, partyId])
  @@index([tenantId])
  @@index([partyId])
  @@index([userId])
  @@index([status])
}

model PortalInvite {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation("PortalInviteTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  partyId  Int
  party    Party  @relation("PortalInviteParty", fields: [partyId], references: [id], onDelete: Cascade)

  // Normalized email for lookup (lowercase, trimmed)
  emailNorm String @db.Citext

  // User reference (set if user exists at invite time, or after acceptance)
  userId String?
  user   User?   @relation("PortalInviteUser", fields: [userId], references: [id], onDelete: SetNull)

  // Role and status to grant upon acceptance (defaults to CLIENT/ACTIVE)
  roleToGrant   TenantMembershipRole   @default(CLIENT)
  statusToGrant TenantMembershipStatus @default(ACTIVE)

  // Token for activation link
  tokenHash String    @unique
  expiresAt DateTime
  sentAt    DateTime  @default(now())
  usedAt    DateTime?

  // Backfilled after acceptance for traceability
  membershipUserId String?

  // Audit
  sentByUserId String?
  sentBy       User?   @relation("PortalInviteSentBy", fields: [sentByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, partyId])
  @@index([tenantId, emailNorm])
  @@index([expiresAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Audit Event Log
 * Immutable security event log for auth, access control, and abuse monitoring
 * ────────────────────────────────────────────────────────────────────────────
 */

enum AuditOutcome {
  SUCCESS
  FAILURE
}

enum AuditSurface {
  PLATFORM
  PORTAL
  MARKETPLACE
}

enum AuditActorContext {
  STAFF
  CLIENT
  PUBLIC
}

model AuditEvent {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // Request context
  requestId String? @db.VarChar(64)
  ip        String? @db.VarChar(45) // IPv4 or IPv6
  userAgent String? @db.Text

  // Actor context
  userId       String?            @db.VarChar(64)
  surface      AuditSurface
  actorContext AuditActorContext?
  tenantId     Int?

  // Event data
  action     String       @db.VarChar(64)
  outcome    AuditOutcome
  detailJson Json?

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([tenantId, createdAt])
  @@index([action, createdAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Scheduling System
 * Client-facing appointment booking (e.g., pickup, meet & greet, vet visits)
 * ────────────────────────────────────────────────────────────────────────────
 */

enum SchedulingEventStatus {
  DRAFT // Not yet published
  OPEN // Accepting bookings
  CLOSED // No longer accepting bookings
  CANCELLED // Event cancelled
}

enum SchedulingSlotStatus {
  AVAILABLE // Open for booking
  FULL // Capacity reached
  CANCELLED // Slot cancelled
}

enum SchedulingSlotMode {
  IN_PERSON
  VIRTUAL
}

enum SchedulingBookingStatus {
  CONFIRMED
  CANCELLED
  RESCHEDULED
  NO_SHOW
}

enum MarketplaceBlockLevel {
  LIGHT // Block waitlist requests only
  MEDIUM // Block waitlist + messages
  HEAVY // Block waitlist + messages + profile view
}

/**
 * SchedulingEventTemplate - Reusable event configuration
 * Optional for MVP but provides future flexibility for recurring events
 */
model SchedulingEventTemplate {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String // e.g., "Pickup Appointment", "Meet and Greet"
  eventType   String // e.g., "pickup", "meet_greet", "vet_visit"
  description String?               @db.Text
  status      SchedulingEventStatus @default(DRAFT)

  // Booking rules (can be overridden per slot block)
  defaultDurationMinutes    Int     @default(60)
  defaultCapacity           Int     @default(1)
  canCancel                 Boolean @default(true)
  canReschedule             Boolean @default(true)
  cancellationDeadlineHours Int?
  rescheduleDeadlineHours   Int?

  // Optional next steps text shown after booking
  nextStepsText String? @db.Text

  // Subject context (what this event is about)
  // Links to offspring, placement, agreement, or transaction
  subjectType String? // "offspring" | "placement" | "agreement" | "transaction"
  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // Audit
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  availabilityBlocks SchedulingAvailabilityBlock[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, eventType])
  @@index([offspringId])
}

/**
 * SchedulingAvailabilityBlock - A time block containing multiple slots
 * Represents a period during which the breeder is available for appointments
 */
model SchedulingAvailabilityBlock {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional template reference (can create ad-hoc blocks without template)
  templateId Int?
  template   SchedulingEventTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Optional offspring group link for buyer-specific scheduling
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation("GroupSchedulingBlocks", fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // Time range
  startAt  DateTime
  endAt    DateTime
  timezone String   @default("America/New_York") @db.VarChar(64)

  // Status
  status SchedulingEventStatus @default(OPEN)

  // Override rules from template
  canCancel                 Boolean?
  canReschedule             Boolean?
  cancellationDeadlineHours Int?
  rescheduleDeadlineHours   Int?
  nextStepsText             String?  @db.Text

  // Location for in-person slots in this block
  location String? @db.Text

  // Audit
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  slots SchedulingSlot[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startAt])
  @@index([templateId])
  @@index([offspringGroupId])
}

/**
 * SchedulingSlot - Individual bookable time slot
 */
model SchedulingSlot {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Parent block
  blockId Int
  block   SchedulingAvailabilityBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  // Time range (UTC)
  startsAt DateTime
  endsAt   DateTime

  // Capacity
  capacity    Int @default(1)
  bookedCount Int @default(0)

  // Status (computed from bookedCount vs capacity)
  status SchedulingSlotStatus @default(AVAILABLE)

  // Mode and location
  mode     SchedulingSlotMode?
  location String?             @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings SchedulingBooking[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startsAt])
  @@index([blockId])
  @@index([blockId, startsAt])
}

/**
 * SchedulingBooking - A confirmed booking for a slot
 * Links a party (client) to a slot
 */
model SchedulingBooking {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Slot reference
  slotId Int
  slot   SchedulingSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  // Party (the client making the booking)
  partyId Int
  party   Party @relation("SchedulingBookingParty", fields: [partyId], references: [id], onDelete: Cascade)

  // Event context (denormalized for query convenience)
  // eventId is the templateId or blockId (or synthetic ID for ad-hoc)
  eventId String @db.VarChar(64)

  // Status
  status SchedulingBookingStatus @default(CONFIRMED)

  // Timestamps
  bookedAt      DateTime  @default(now())
  cancelledAt   DateTime?
  rescheduledAt DateTime?

  // Notes from client or breeder
  clientNotes  String? @db.Text
  breederNotes String? @db.Text

  // Next steps text (copied from template/block at booking time)
  nextSteps String? @db.Text

  // Rescheduling linkage
  rescheduledFromId Int?
  rescheduledFrom   SchedulingBooking?  @relation("RescheduledBooking", fields: [rescheduledFromId], references: [id], onDelete: SetNull)
  rescheduledTo     SchedulingBooking[] @relation("RescheduledBooking")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Unique constraint: one active booking per event per party
  // (enforced in application layer - can't have @@unique with status filter)

  // Unique constraint: one booking per slot per party
  @@unique([slotId, partyId])
  @@index([tenantId])
  @@index([tenantId, partyId])
  @@index([tenantId, eventId])
  @@index([slotId])
  @@index([partyId])
  @@index([eventId, partyId])
  @@index([status])
}

// ============================================================================
// Marketplace Blocklist System
// ============================================================================

/**
 * MarketplaceUserBlock - Per-tenant block records (breeder → marketplace user)
 * Allows breeders to block marketplace users at different levels
 */
model MarketplaceUserBlock {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // The blocked user (by their User ID from marketplace auth)
  blockedUserId String @db.VarChar(36)
  blockedUser   User   @relation("BlockedMarketplaceUser", fields: [blockedUserId], references: [id], onDelete: Cascade)

  level  MarketplaceBlockLevel
  reason String?               @db.Text // Optional reason for breeder's reference

  // Who blocked them (optional - for audit)
  blockedByPartyId Int?
  blockedByParty   Party? @relation("MarketplaceBlockCreator", fields: [blockedByPartyId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  // Block can be lifted (soft delete pattern)
  liftedAt        DateTime?
  liftedByPartyId Int?
  liftedByParty   Party?    @relation("MarketplaceBlockLifter", fields: [liftedByPartyId], references: [id], onDelete: SetNull)

  @@unique([tenantId, blockedUserId])
  @@index([blockedUserId])
  @@index([tenantId])
  @@index([tenantId, liftedAt]) // For finding active blocks
}

/**
 * MarketplaceUserFlag - Platform-level aggregation for admin visibility
 * Tracks how many times a marketplace user has been blocked across all breeders
 */
model MarketplaceUserFlag {
  id     Int    @id @default(autoincrement())
  userId String @unique @db.VarChar(36)
  user   User   @relation("MarketplaceUserFlagUser", fields: [userId], references: [id], onDelete: Cascade)

  // Aggregated stats
  totalBlocks  Int @default(0) // Number of times blocked (any level, all-time)
  activeBlocks Int @default(0) // Current non-lifted blocks
  lightBlocks  Int @default(0)
  mediumBlocks Int @default(0)
  heavyBlocks  Int @default(0)

  // Waitlist history (platform-wide)
  totalApprovals  Int @default(0)
  totalRejections Int @default(0)

  // Admin action flags
  flaggedAt       DateTime? // When auto-flagged for review
  flagReason      String?   @db.Text
  suspendedAt     DateTime? // If account disabled by admin
  suspendedReason String?   @db.Text

  updatedAt DateTime @updatedAt

  @@index([flaggedAt])
  @@index([suspendedAt])
  @@index([activeBlocks])
}

/**
 * PlatformSetting - Configurable platform-wide settings
 * Used for admin-configurable thresholds like blocklist thresholds
 */
model PlatformSetting {
  id        Int      @id @default(autoincrement())
  namespace String   @unique @db.VarChar(64) // e.g., "marketplace-abuse"
  data      Json
  updatedAt DateTime @updatedAt
}

// ============================================================================
// Breeder Report System (Marketplace users → Breeders)
// ============================================================================

enum BreederReportReason {
  SPAM
  FRAUD
  HARASSMENT
  MISREPRESENTATION
  OTHER
}

enum BreederReportSeverity {
  LIGHT
  MEDIUM
  HEAVY
}

enum BreederReportStatus {
  PENDING
  REVIEWED
  DISMISSED
  ACTIONED
}

/**
 * BreederReport - Individual reports from marketplace users against breeders
 * Reports require admin review before any action is taken
 */
model BreederReport {
  id Int @id @default(autoincrement())

  // The breeder being reported (by tenant)
  breederTenantId Int
  breederTenant   Tenant @relation("BreederReports", fields: [breederTenantId], references: [id], onDelete: Cascade)

  // Reporter info (masked for privacy in admin view)
  reporterUserId String @db.VarChar(36)
  reporterUser   User   @relation("BreederReportReporter", fields: [reporterUserId], references: [id], onDelete: Cascade)

  // Report details
  reason      BreederReportReason
  severity    BreederReportSeverity
  description String?               @db.Text

  // Status tracking
  status     BreederReportStatus @default(PENDING)
  adminNotes String?             @db.Text

  // Review tracking
  reviewedByUserId String?
  reviewedBy       User?     @relation("BreederReportReviewedBy", fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  reviewedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([breederTenantId])
  @@index([reporterUserId])
  @@index([status])
  @@index([createdAt])
}

/**
 * BreederReportFlag - Platform-level aggregation for admin visibility
 * Tracks report counts per breeder for flagging and admin review
 */
model BreederReportFlag {
  id Int @id @default(autoincrement())

  breederTenantId Int    @unique
  breederTenant   Tenant @relation("BreederReportFlag", fields: [breederTenantId], references: [id], onDelete: Cascade)

  // Aggregated stats
  totalReports   Int @default(0)
  pendingReports Int @default(0)
  lightReports   Int @default(0)
  mediumReports  Int @default(0)
  heavyReports   Int @default(0)

  // Admin flags
  flaggedAt  DateTime?
  flagReason String?   @db.Text

  // Warning tracking
  warningIssuedAt DateTime?
  warningNote     String?   @db.Text

  // Marketplace suspension (soft - hides listing, not account ban)
  marketplaceSuspendedAt DateTime?
  suspendedReason        String?   @db.Text

  updatedAt DateTime @updatedAt

  @@index([flaggedAt])
  @@index([marketplaceSuspendedAt])
  @@index([pendingReports])
}

/**
 * GeneticsDisclaimerAcceptance - Genetics Lab disclaimer acceptance records
 * Stores acceptance of genetics calculator disclaimers for legal protection.
 */
model GeneticsDisclaimerAcceptance {
  id         Int      @id @default(autoincrement())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  acceptedAt DateTime @default(now())
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.Text

  @@index([userId])
}

// ═══════════════════════════════════════════════════════════════════════════════
// CROSS-TENANT LINEAGE TRACKING
// Global animal identity matching and pedigree sharing across tenants
// ═══════════════════════════════════════════════════════════════════════════════

/**
 * IdentifierType - Types of unique identifiers that can be used to match animals
 */
enum IdentifierType {
  MICROCHIP // ISO 15-digit microchip number
  AKC // American Kennel Club registration
  UKC // United Kennel Club registration
  CKC // Canadian Kennel Club registration
  KC // The Kennel Club (UK)
  FCI // Fédération Cynologique Internationale
  AQHA // American Quarter Horse Association
  JOCKEY_CLUB // The Jockey Club (thoroughbreds)
  USEF // US Equestrian Federation
  ADGA // American Dairy Goat Association
  AGS // American Goat Society
  ARBA // American Rabbit Breeders Association
  TICA // The International Cat Association
  CFA // Cat Fanciers Association
  EMBARK // Embark DNA test ID
  WISDOM_PANEL // Wisdom Panel DNA test ID
  DNA_PROFILE // Generic DNA profile identifier
  TATTOO // Tattoo ID (common in livestock/horses)
  EAR_TAG // Ear tag number (livestock)
  USDA_SCRAPIE // USDA Scrapie ID (sheep/goats)
  OTHER // Other registry or identifier
}

/**
 * GlobalAnimalIdentity - A canonical identity cluster for an animal across all tenants
 * When we're confident animals across tenants are the same individual, they share one of these.
 */
model GlobalAnimalIdentity {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Denormalized core identity (from highest-confidence source)
  species   Species
  sex       Sex?
  birthDate DateTime?
  name      String? // "Call name" - most commonly used name

  // All identifiers associated with this identity
  identifiers GlobalAnimalIdentifier[]

  // All tenant-local animals linked to this identity
  linkedAnimals AnimalIdentityLink[]

  // Cross-tenant parent relationships (the global pedigree)
  damId  Int?
  dam    GlobalAnimalIdentity? @relation("GlobalDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   GlobalAnimalIdentity? @relation("GlobalSire", fields: [sireId], references: [id], onDelete: SetNull)

  // Reverse: offspring in the global graph
  childrenAsDam  GlobalAnimalIdentity[] @relation("GlobalDam")
  childrenAsSire GlobalAnimalIdentity[] @relation("GlobalSire")

  // Lineage info requests targeting this identity
  infoRequests LineageInfoRequest[]

  @@index([species])
  @@index([damId])
  @@index([sireId])
}

/**
 * GlobalAnimalIdentifier - A unique identifier attached to a global identity
 * Multiple identifiers can point to the same GlobalAnimalIdentity
 */
model GlobalAnimalIdentifier {
  id         Int                  @id @default(autoincrement())
  identityId Int
  identity   GlobalAnimalIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  type     IdentifierType
  value    String // The actual identifier value (normalized/uppercased)
  rawValue String? // Original value as entered (for display)

  // Confidence and provenance
  confidence Float     @default(1.0) // 0.0-1.0, how confident we are this is correct
  verifiedAt DateTime? // If manually verified
  verifiedBy String? // User ID who verified

  // Which tenant contributed this identifier
  sourceTenantId Int?
  sourceTenant   Tenant? @relation(fields: [sourceTenantId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@unique([type, value]) // Each identifier value is globally unique per type
  @@index([identityId])
  @@index([type, value])
}

/**
 * AnimalIdentityLink - Links a tenant's local Animal record to a GlobalAnimalIdentity
 * This is how we know "Animal #123 in Tenant A" is the same as "Animal #456 in Tenant B"
 */
model AnimalIdentityLink {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // The tenant-local animal
  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // The global identity
  identityId Int
  identity   GlobalAnimalIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  // How confident are we in this link?
  confidence      Float     @default(1.0) // 0.0-1.0
  matchedOn       String[] // Which identifiers matched: ["MICROCHIP", "AKC", "NAME_DOB"]
  autoMatched     Boolean   @default(false) // Was this auto-matched or manually confirmed?
  confirmedAt     DateTime?
  confirmedByUser String? // User ID who confirmed

  @@unique([animalId]) // Each local animal links to at most one global identity
  @@index([identityId])
}

/**
 * AnimalPrivacySettings - Per-animal controls over what's shared cross-tenant
 * Owner of the animal (tenant) controls visibility of their animal's data
 */
model AnimalPrivacySettings {
  id        Int      @id @default(autoincrement())
  animalId  Int      @unique
  animal    Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  updatedAt DateTime @updatedAt

  // Opt-in to cross-tenant matching at all
  allowCrossTenantMatching Boolean @default(true)

  // Field-level visibility controls
  showName          Boolean @default(true)
  showPhoto         Boolean @default(true)
  showFullDob       Boolean @default(true) // false = year only
  showRegistryFull  Boolean @default(false) // false = last 4 digits only
  showHealthResults Boolean @default(false) // false = summary only (clear/carrier/affected)
  showGeneticData   Boolean @default(false)
  showBreeder       Boolean @default(true) // Show tenant/breeder name

  // Contact preferences
  allowInfoRequests  Boolean @default(true) // Can others request more info?
  allowDirectContact Boolean @default(false) // Show contact info directly?
}

/**
 * LineageInfoRequest - Request from one breeder to another for animal information
 * When you see a silhouette in your pedigree, you can request details from the owner
 */
model LineageInfoRequest {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Who is requesting
  requestingTenantId Int
  requestingTenant   Tenant @relation("LineageRequestFrom", fields: [requestingTenantId], references: [id], onDelete: Cascade)
  requestingUserId   String
  requestingUser     User   @relation("LineageRequestFromUser", fields: [requestingUserId], references: [id], onDelete: Cascade)

  // What animal they want info about
  targetIdentityId Int
  targetIdentity   GlobalAnimalIdentity @relation(fields: [targetIdentityId], references: [id], onDelete: Cascade)

  // Who owns that animal (resolved at request time)
  targetTenantId Int
  targetTenant   Tenant @relation("LineageRequestTo", fields: [targetTenantId], references: [id], onDelete: Cascade)

  // Request details
  message String? @db.Text // Optional message from requester
  purpose String? // "pedigree_research", "coi_calculation", "breeding_decision", etc.

  // Response
  status          LineageRequestStatus @default(PENDING)
  respondedAt     DateTime?
  responseMessage String?              @db.Text
  grantedAccess   LineageAccessLevel? // What level of access was granted

  // If granted, when does access expire?
  accessExpiresAt DateTime?

  @@index([requestingTenantId])
  @@index([targetTenantId])
  @@index([targetIdentityId])
  @@index([status])
}

enum LineageRequestStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
}

enum LineageAccessLevel {
  LINEAGE_ONLY // Just position in pedigree, no details
  BASIC // Name, breed, DOB year
  STANDARD // Name, breed, full DOB, registry (partial)
  FULL // Everything the owner has made shareable
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Title & Competition Tracking
 * For show/performance breeders to track achievements and competition records
 * ────────────────────────────────────────────────────────────────────────────
 */

enum TitleCategory {
  CONFORMATION // CH, GCH, GCHB, etc.
  OBEDIENCE // CD, CDX, UD, OTCH
  AGILITY // MACH, PACH, etc.
  FIELD // FC, AFC, MH, etc.
  HERDING // HT, PT, HC, etc.
  TRACKING // TD, TDX, VST
  RALLY // RN, RA, RE, etc.
  PRODUCING // ROM, ROMX (breed club)
  BREED_SPECIFIC // Breed club awards
  PERFORMANCE // Racing, working, etc.
  OTHER
}

enum TitleStatus {
  IN_PROGRESS // Working toward (optional tracking)
  EARNED // Title completed
  VERIFIED // Confirmed by registry/org
}

enum CompetitionType {
  CONFORMATION_SHOW
  OBEDIENCE_TRIAL
  AGILITY_TRIAL
  FIELD_TRIAL
  HERDING_TRIAL
  TRACKING_TEST
  RALLY_TRIAL
  RACE
  PERFORMANCE_TEST
  BREED_SPECIALTY
  OTHER
}

/**
 * TitleDefinition - Defines available titles (global or tenant-specific)
 * Global titles (tenantId=null) are seeded for common registries (AKC, UKC, etc.)
 * Tenants can create custom titles for breed clubs or internal awards
 */
model TitleDefinition {
  id       Int     @id @default(autoincrement())
  tenantId Int? // null = global, set = tenant-specific custom title
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  species  Species

  abbreviation String // "CH", "GCH", "MACH"
  fullName     String // "Champion", "Grand Champion"
  category     TitleCategory
  organization String? // "AKC", "UKC", "AQHA", breed club name

  // Title hierarchy (e.g., CH required before GCH)
  parentTitleId Int?
  parentTitle   TitleDefinition?  @relation("TitleHierarchy", fields: [parentTitleId], references: [id], onDelete: SetNull)
  childTitles   TitleDefinition[] @relation("TitleHierarchy")

  // Requirements (informational display)
  pointsRequired Int?
  description    String? @db.Text // "15 points + 2 majors under different judges"

  // Producing title flag (ROM, ROMX - based on offspring achievements)
  isProducingTitle Boolean @default(false)

  // Display position in title string
  prefixTitle  Boolean @default(true) // CH goes before name
  suffixTitle  Boolean @default(false) // CGC goes after name
  displayOrder Int     @default(0) // Sort order within prefix/suffix group

  createdAt DateTime @default(now())

  // Relation to earned titles
  animalTitles AnimalTitle[]

  @@unique([species, abbreviation, organization, tenantId])
  @@index([species])
  @@index([category])
  @@index([tenantId])
}

/**
 * AnimalTitle - A title earned by a specific animal
 */
model AnimalTitle {
  id                Int             @id @default(autoincrement())
  tenantId          Int
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId          Int
  animal            Animal          @relation(fields: [animalId], references: [id], onDelete: Cascade)
  titleDefinitionId Int
  titleDefinition   TitleDefinition @relation(fields: [titleDefinitionId], references: [id], onDelete: Restrict)

  // When earned
  dateEarned DateTime?
  status     TitleStatus @default(EARNED)

  // Points/progress tracking
  pointsEarned Float? // Total points at time of earning
  majorWins    Int? // For conformation titles

  // Where the title was earned (event info)
  eventName    String? // "Westminster Kennel Club 2024"
  eventLocation String? // "New York, NY"
  handlerName  String? // Person who handled/showed the animal

  // Verification
  verified    Boolean   @default(false)
  verifiedAt  DateTime?
  verifiedBy  String? // User ID or "AKC Registry"
  registryRef String? // External reference number

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Supporting documents
  documents AnimalTitleDocument[]

  @@unique([animalId, titleDefinitionId])
  @@index([tenantId])
  @@index([animalId])
  @@index([status])
}

/**
 * AnimalTitleDocument - Links documents to animal titles
 */
model AnimalTitleDocument {
  id            Int         @id @default(autoincrement())
  animalTitleId Int
  animalTitle   AnimalTitle @relation(fields: [animalTitleId], references: [id], onDelete: Cascade)
  documentId    Int
  document      Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([animalTitleId, documentId])
}

/**
 * CompetitionEntry - Individual competition/show entries
 * Tracks placements, points, and results for performance analysis
 */
model CompetitionEntry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalId Int
  animal   Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // Event info
  eventName       String // "Westminster Kennel Club", "Kentucky Derby"
  eventDate       DateTime
  location        String? // "New York, NY", "Churchill Downs"
  organization    String? // "AKC", "Jockey Club"
  competitionType CompetitionType

  // Class/division
  className String? // "Open Dogs", "Excellent B Standard", "G1 Stakes"

  // Results
  placement       Int? // 1, 2, 3, 4 or null if no placement
  placementLabel  String? // "Best of Breed", "Winners Dog", "High in Trial"
  pointsEarned    Float?
  isMajorWin      Boolean @default(false)
  qualifyingScore Boolean @default(false) // Q for agility, pass for tracking

  // Scores (for performance events)
  score    Float? // Agility time, obedience score, race time
  scoreMax Float? // Max possible score

  // Racing-specific fields
  prizeMoneyCents  Int?     // Prize/purse won in cents (e.g., 100000 = $1,000.00)
  trackName        String?  // "Churchill Downs", "Santa Anita", "Shelbourne Park"
  trackSurface     String?  // "dirt", "turf", "synthetic", "sand"
  distanceFurlongs Float?   // Race distance in furlongs (1 furlong = 1/8 mile)
  distanceMeters   Int?     // Race distance in meters (for greyhounds/international)
  raceGrade        String?  // "G1", "G2", "G3", "Listed", "A", "B", "Open"
  finishTime       String?  // "1:59.40" or "29.45" - stored as string for display
  speedFigure      Int?     // Beyer speed figure, Timeform, etc.

  // Handler/rider info
  handlerName String? // Jockey, driver, handler (person who competed with animal)
  trainerName String? // Trainer at time of event (if different from current)

  // Judge
  judgeName String?

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Supporting documents (ribbons, photos, scoresheets)
  documents CompetitionEntryDocument[]

  @@index([tenantId])
  @@index([animalId])
  @@index([eventDate])
  @@index([competitionType])
}

/**
 * CompetitionEntryDocument - Links documents to competition entries
 */
model CompetitionEntryDocument {
  id                 Int              @id @default(autoincrement())
  competitionEntryId Int
  competitionEntry   CompetitionEntry @relation(fields: [competitionEntryId], references: [id], onDelete: Cascade)
  documentId         Int
  document           Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([competitionEntryId, documentId])
}
