generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["marketplace", "public"]
}

model User {
  id                             String                          @id @default(cuid())
  email                          String                          @unique @db.Citext
  name                           String?
  firstName                      String
  lastName                       String
  nickname                       String?
  image                          String?
  passwordHash                   String?
  passwordUpdatedAt              DateTime?
  mustChangePassword             Boolean                         @default(false)
  passwordSetAt                  DateTime?
  lastPasswordChangeAt           DateTime?
  isSuperAdmin                   Boolean                         @default(false)
  emailVerifiedAt                DateTime?
  phoneE164                      String?                         @db.VarChar(32)
  whatsappE164                   String?                         @db.VarChar(32)
  street                         String?
  street2                        String?
  city                           String?
  state                          String?
  postalCode                     String?
  country                        String?                         @db.Char(2)
  partyId                        Int?
  defaultTenantId                Int?
  lastLoginAt                    DateTime?
  createdAt                      DateTime                        @default(now())
  updatedAt                      DateTime                        @updatedAt
  role                           String                          @default("user")
  twoFactorEnabled               Boolean                         @default(false)
  providerReportsSubmitted       MarketplaceProviderReport[]     @relation("UserProviderReports")
  savedListings                  MarketplaceSavedListing[]       @relation("UserSavedListings")
  animalLinkRequestsSent         AnimalLinkRequest[]             @relation("LinkRequestFromUser")
  Attachment                     Attachment[]
  breederReportsSubmitted        BreederReport[]                 @relation("BreederReportReporter")
  breederReportsReviewed         BreederReport[]                 @relation("BreederReportReviewedBy")
  committedPlans                 BreedingPlan[]                  @relation("CommittedByUser")
  BreedingPlanEvent              BreedingPlanEvent[]
  assignedInquiries              BreedingProgramInquiry[]
  buyerTasksAssigned             BuyerTask[]                     @relation("BuyerTaskAssignee")
  buyerTasksCompleted            BuyerTask[]                     @relation("BuyerTaskCompleter")
  ContractParty                  ContractParty[]
  contractTemplatesCreated       ContractTemplate[]              @relation("ContractTemplateCreatedBy")
  dealActivities                 DealActivity[]
  drafts                         Draft[]                         @relation("DraftCreatedBy")
  geneticNotificationPreferences GeneticNotificationPreference[]
  geneticNotificationSnoozes     GeneticNotificationSnooze[]
  geneticsDisclaimerAcceptances  GeneticsDisclaimerAcceptance[]
  HealthEvent                    HealthEvent[]
  LitterEvent                    LitterEvent[]
  marketplaceBlocks              MarketplaceUserBlock[]          @relation("BlockedMarketplaceUser")
  marketplaceFlag                MarketplaceUserFlag?            @relation("MarketplaceUserFlagUser")
  memberships                    Membership[]
  neonatalCareEntries            NeonatalCareEntry[]
  neonatalInterventions          NeonatalIntervention[]
  notifications                  Notification[]
  OffspringEvent                 OffspringEvent[]
  OffspringGroupEvent            OffspringGroupEvent[]
  portalAccessesCreatedBy        PortalAccess[]                  @relation("PortalAccessCreatedBy")
  portalAccessesUpdatedBy        PortalAccess[]                  @relation("PortalAccessUpdatedBy")
  portalAccesses                 PortalAccess[]                  @relation("PortalAccessUser")
  portalInvitesSentBy            PortalInvite[]                  @relation("PortalInviteSentBy")
  portalInvites                  PortalInvite[]                  @relation("PortalInviteUser")
  protocolHandoffsInitiated      RearingProtocolAssignment[]     @relation("ProtocolHandoffInitiator")
  protocolHandoffsReceived       RearingProtocolAssignment[]     @relation("ProtocolHandoffRecipient")
  registrySyncLogs               RegistrySyncLog[]               @relation("RegistrySyncLogInitiator")
  registryVerifications          RegistryVerification[]          @relation("RegistryVerificationVerifier")
  Session                        Session[]
  Task                           Task[]
  tenantMemberships              TenantMembership[]
  tosAcceptances                 TosAcceptance[]
  defaultTenant                  Tenant?                         @relation(fields: [defaultTenantId], references: [id])
  party                          Party?                          @relation("UserParty", fields: [partyId], references: [id])
  entitlements                   UserEntitlement[]
  notificationPreferences        UserNotificationPreferences?
  VerificationToken              VerificationToken[]
  devices                        Device[]
  refreshTokens                  RefreshToken[]

  @@index([partyId])
  @@index([defaultTenantId])
  @@index([phoneE164])
  @@index([whatsappE164])
  @@index([country])
  @@schema("public")
}

/// *
/// * TosAcceptance - Terms of Service acceptance records
/// * Stores a history of ToS acceptances for audit/compliance.
model TosAcceptance {
  id         Int      @id @default(autoincrement())
  userId     String
  version    String   @db.VarChar(16)
  acceptedAt DateTime @default(now())
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?
  surface    String?  @db.VarChar(32)
  flow       String?  @db.VarChar(32)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([version])
  @@schema("public")
}

/// *
/// * UserEntitlement - Per-user feature access grants
/// * Used for marketplace access and other user-level permissions.
model UserEntitlement {
  id              Int               @id @default(autoincrement())
  userId          String
  key             EntitlementKey
  status          EntitlementStatus @default(ACTIVE)
  grantedAt       DateTime          @default(now())
  revokedAt       DateTime?
  grantedByUserId String?
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([userId])
  @@index([key, status])
  @@schema("public")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
}

model VerificationToken {
  identifier String
  token      String?             @unique
  tokenHash  String              @unique
  purpose    VerificationPurpose @default(VERIFY_EMAIL)
  expires    DateTime
  userId     String?
  createdAt  DateTime            @default(now())
  User       User?               @relation(fields: [userId], references: [id])

  @@id([identifier, tokenHash])
  @@index([identifier, purpose])
  @@schema("public")
}

model Invite {
  id             Int       @id @default(autoincrement())
  email          String
  organizationId Int?
  role           String    @default("STAFF")
  token          String    @unique
  expiresAt      DateTime
  consumedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([email])
  @@index([token])
  @@schema("public")
}

model Tenant {
  id                              Int                             @id @default(autoincrement())
  name                            String
  slug                            String?                         @unique
  primaryEmail                    String?
  operationType                   TenantOperationType             @default(HOBBY)
  availabilityPrefs               Json?
  createdAt                       DateTime                        @default(now())
  updatedAt                       DateTime                        @updatedAt
  avgBusinessHoursResponseTime    Int?
  businessHours                   Json?
  lastBadgeEvaluatedAt            DateTime?
  quickResponderBadge             Boolean                         @default(false)
  timeZone                        String?
  totalResponseCount              Int                             @default(0)
  inboundEmailSlug                String?                         @unique
  marketplacePaymentMode          String                          @default("manual")
  stripeConnectAccountId          String?                         @unique
  stripeConnectOnboardingComplete Boolean                         @default(false)
  stripeConnectPayoutsEnabled     Boolean                         @default(false)
  demoResetType                   String?
  isDemoTenant                    Boolean                         @default(false)
  city                            String?
  country                         String?                         @db.Char(2)
  region                          String?
  watermarkSettings               Json?
  inquiryPermission               InquiryPermission               @default(ANYONE)
  networkVisibility               NetworkVisibility               @default(VISIBLE)
  invoicingMode                   String                          @default("manual")
  paymentInstructions             String?
  unifiedListings                 MktListingBreederService[]
  activityCompletions             ActivityCompletion[]
  animals                         Animal[]
  animalAccessesAsAccessor        AnimalAccess[]                  @relation("AnimalAccessAccessor")
  animalAccessesAsOwner           AnimalAccess[]                  @relation("AnimalAccessOwner")
  animalBreedingProfiles          AnimalBreedingProfile[]
  animalIncompatibilities         AnimalIncompatibility[]
  linkRequestsFrom                AnimalLinkRequest[]             @relation("LinkRequestFrom")
  linkRequestsTo                  AnimalLinkRequest[]             @relation("LinkRequestTo")
  microchipRegistrations          AnimalMicrochipRegistration[]
  AnimalOwnershipChange           AnimalOwnershipChange[]
  animalTitles                    AnimalTitle[]
  AnimalTraitEntry                AnimalTraitEntry[]
  AnimalTraitValue                AnimalTraitValue[]
  assessmentResults               AssessmentResult[]
  attachments                     Attachment[]
  AutoReplyLog                    AutoReplyLog[]
  AutoReplyRule                   AutoReplyRule[]
  billing                         BillingAccount?
  blockedEmails                   BlockedEmail[]
  breederProfile                  BreederProfile?
  breederReports                  BreederReport[]                 @relation("BreederReports")
  breederReportFlag               BreederReportFlag?              @relation("BreederReportFlag")
  breedingAttempts                BreedingAttempt[]
  breedingBookingsOffering        BreedingBooking[]               @relation("OfferingBookings")
  breedingBookingsSeeking         BreedingBooking[]               @relation("SeekingBookings")
  breedingAgreementsApproving     BreedingDataAgreement[]         @relation("BreedingAgreementApprover")
  breedingAgreementsRequested     BreedingDataAgreement[]         @relation("BreedingAgreementRequester")
  breedingDiscoveryPrograms       BreedingDiscoveryProgram[]
  breedingEventsLog               BreedingEvent[]
  breedingGroups                  BreedingGroup[]
  breedingGroupMembers            BreedingGroupMember[]
  breedingInquiries               BreedingInquiry[]
  breedingListings                BreedingListing[]
  breedingMilestones              BreedingMilestone[]
  breedingPlans                   BreedingPlan[]
  BreedingPlanBuyer               BreedingPlanBuyer[]
  planEvents                      BreedingPlanEvent[]
  BreedingPlanTempLog             BreedingPlanTempLog[]
  breedingProgramInquiries        BreedingProgramInquiry[]
  breedingProgramMedia            BreedingProgramMedia[]
  breedingProgramRules            BreedingProgramRule[]
  buyers                          Buyer[]
  buyerEmailTemplates             BuyerEmailTemplate[]
  buyerTasks                      BuyerTask[]
  Campaign                        Campaign[]
  CampaignAttribution             CampaignAttribution[]
  competitionEntries              CompetitionEntry[]
  contacts                        Contact[]
  contactChangeRequests           ContactChangeRequest[]
  Contract                        Contract[]
  ContractParty                   ContractParty[]
  ContractTemplate                ContractTemplate[]
  crossTenantLinksAsChild         CrossTenantAnimalLink[]         @relation("LinkChildTenant")
  crossTenantLinksAsParent        CrossTenantAnimalLink[]         @relation("LinkParentTenant")
  CustomBreed                     CustomBreed[]
  dhiaTestRecords                 DHIATestRecord[]
  dairyProductionHistory          DairyProductionHistory[]
  deals                           Deal[]
  dealActivities                  DealActivity[]
  Document                        Document[]
  documentBundles                 DocumentBundle[]
  drafts                          Draft[]
  emailChangeRequests             EmailChangeRequest[]
  emailFilters                    EmailFilter[]
  EmailSendLog                    EmailSendLog[]
  Expense                         Expense[]
  featureChecks                   FeatureCheck[]
  feedingPlans                    FeedingPlan[]
  feedingRecords                  FeedingRecord[]
  fiberLabTests                   FiberLabTest[]
  fiberProductionHistory          FiberProductionHistory[]
  foalingOutcomes                 FoalingOutcome[]
  foodChanges                     FoodChange[]
  foodProducts                    FoodProduct[]
  geneticNotificationPreferences  GeneticNotificationPreference[]
  geneticNotificationSnoozes      GeneticNotificationSnooze[]
  contributedIdentifiers          GlobalAnimalIdentifier[]
  HealthEvent                     HealthEvent[]
  IdempotencyKey                  IdempotencyKey[]
  Invoice                         Invoice[]
  InvoiceLineItem                 InvoiceLineItem[]
  lactationCycles                 LactationCycle[]
  linearAppraisals                LinearAppraisal[]
  litters                         Litter[]
  LitterEvent                     LitterEvent[]
  mareReproductiveHistories       MareReproductiveHistory[]
  marketplaceUserBlocks           MarketplaceUserBlock[]
  mediaAccessEvents               MediaAccessEvent[]
  MessageThread                   MessageThread[]
  milkingRecords                  MilkingRecord[]
  neonatalCareEntries             NeonatalCareEntry[]
  neonatalInterventions           NeonatalIntervention[]
  networkInquiriesReceived        NetworkBreedingInquiry[]        @relation("NetworkBreedingInquiryRecipient")
  networkInquiriesSent            NetworkBreedingInquiry[]        @relation("NetworkBreedingInquirySender")
  networkSearchIndexes            NetworkSearchIndex[]
  notifications                   Notification[]
  offspring                       Offspring[]
  OffspringContract               OffspringContract[]
  OffspringDocument               OffspringDocument[]
  OffspringEvent                  OffspringEvent[]
  offspringGroups                 OffspringGroup[]
  OffspringGroupBuyer             OffspringGroupBuyer[]
  OffspringGroupEvent             OffspringGroupEvent[]
  OffspringInvoiceLink            OffspringInvoiceLink[]
  protocolExceptions              OffspringProtocolException[]
  organizations                   Organization[]
  parties                         Party[]
  partyActivity                   PartyActivity[]
  partyEmails                     PartyEmail[]
  partyEvents                     PartyEvent[]
  partyMilestones                 PartyMilestone[]
  partyNotes                      PartyNote[]
  Payment                         Payment[]
  PaymentIntent                   PaymentIntent[]
  paymentMethods                  PaymentMethod[]
  planCodeCounters                PlanCodeCounter[]
  planParties                     PlanParty[]
  portalAccesses                  PortalAccess[]                  @relation("PortalAccessTenant")
  portalInvites                   PortalInvite[]                  @relation("PortalInviteTenant")
  pregnancyChecks                 PregnancyCheck[]
  protocolComments                ProtocolComment[]
  protocolCopyRecords             ProtocolCopyRecord[]
  protocolRatings                 ProtocolRating[]
  rearingCertificates             RearingCertificate[]
  rearingProtocols                RearingProtocol[]
  rearingAssignments              RearingProtocolAssignment[]
  registryConnections             RegistryConnection[]
  registrySyncLogs                RegistrySyncLog[]
  reproductiveCycles              ReproductiveCycle[]
  schedulingAvailabilityBlocks    SchedulingAvailabilityBlock[]
  schedulingBookings              SchedulingBooking[]
  schedulingEventTemplates        SchedulingEventTemplate[]
  schedulingSlots                 SchedulingSlot[]
  semenInventory                  SemenInventory[]
  semenUsage                      SemenUsage[]
  Sequence                        Sequence[]
  shareCodes                      ShareCode[]
  shearingRecords                 ShearingRecord[]
  SignatureEvent                  SignatureEvent[]
  studVisibilityRules             StudVisibilityRule[]
  subscriptions                   Subscription[]
  supplementAdministrations       SupplementAdministration[]
  supplementProtocols             SupplementProtocol[]
  supplementSchedules             SupplementSchedule[]
  tags                            Tag[]
  Task                            Task[]
  Template                        Template[]
  memberships                     TenantMembership[]
  programBreeds                   TenantProgramBreed[]
  settings                        TenantSetting[]
  testResults                     TestResult[]
  titleDefinitions                TitleDefinition[]
  unlinkedEmails                  UnlinkedEmail[]
  usageRecords                    UsageRecord[]
  usageSnapshots                  UsageSnapshot[]
  User                            User[]
  notificationPreferences         UserNotificationPreferences[]
  VaccinationRecord               VaccinationRecord[]
  waitlist                        WaitlistEntry[]
  watermarkedAssets               WatermarkedAsset[]
  animalPrograms                  MktListingAnimalProgram[]       @relation("TenantAnimalPrograms")
  breedingBookings                MktListingBreedingBooking[]
  breedingPrograms                MktListingBreedingProgram[]
  individualAnimalListings        MktListingIndividualAnimal[]    @relation("TenantIndividualAnimalListings")

  @@index([name])
  @@index([quickResponderBadge])
  @@schema("public")
}

model TenantMembership {
  userId           String
  tenantId         Int
  role             TenantRole             @default(MEMBER)
  createdAt        DateTime               @default(now())
  membershipRole   TenantMembershipRole   @default(STAFF)
  membershipStatus TenantMembershipStatus @default(ACTIVE)
  partyId          Int?
  updatedAt        DateTime               @updatedAt
  tenant           Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user             User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, tenantId])
  @@index([tenantId])
  @@index([partyId])
  @@index([membershipRole, membershipStatus])
  @@schema("public")
}

/// *
/// * Notification - Stores all user notifications (in-app, email, SMS)
/// * MVP: Focus on vaccination and breeding timeline alerts
model Notification {
  id             Int                  @id @default(autoincrement())
  tenantId       Int
  userId         String?
  type           NotificationType
  title          String
  message        String
  linkUrl        String?
  priority       NotificationPriority @default(MEDIUM)
  status         NotificationStatus   @default(UNREAD)
  readAt         DateTime?
  dismissedAt    DateTime?
  idempotencyKey String?              @unique
  metadata       Json?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  tenant         Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user           User?                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, status])
  @@index([tenantId, status, createdAt])
  @@index([type])
  @@index([createdAt])
  @@schema("public")
}

/// *
/// * UserNotificationPreferences - User settings for notification delivery
/// * MVP: Focus on toggles for alert types (email channel for Phase 2)
model UserNotificationPreferences {
  id                    Int       @id @default(autoincrement())
  tenantId              Int
  userId                String    @unique
  vaccinationExpiring   Boolean   @default(true)
  vaccinationOverdue    Boolean   @default(true)
  breedingTimeline      Boolean   @default(true)
  pregnancyCheck        Boolean   @default(true)
  foalingApproaching    Boolean   @default(true)
  heatCycleExpected     Boolean   @default(true)
  marketplaceInquiry    Boolean   @default(true)
  waitlistSignup        Boolean   @default(true)
  emailEnabled          Boolean   @default(true)
  smsEnabled            Boolean   @default(false)
  pushEnabled           Boolean   @default(true)
  phoneNumber           String?
  phoneVerified         Boolean   @default(false)
  phoneVerifiedAt       DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  microchipRenewal      Boolean   @default(true)
  geneticCarrierWarning Boolean   @default(true)
  geneticIncomplete     Boolean   @default(false)
  geneticMissing        Boolean   @default(false)
  geneticPrebreeding    Boolean   @default(true)
  geneticRecommended    Boolean   @default(false)
  geneticRegistration   Boolean   @default(true)
  tenant                Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@schema("public")
}

/// *
/// * GeneticNotificationPreference - Granular user preferences for genetic test notifications
/// * Provides separate in-app and email toggles for each notification type.
/// * IMPORTANT: Carrier warnings (inAppCarrier) cannot be disabled for lethal genes.
model GeneticNotificationPreference {
  id               Int      @id @default(autoincrement())
  userId           String
  tenantId         Int
  inAppMissing     Boolean  @default(true)
  inAppIncomplete  Boolean  @default(true)
  inAppCarrier     Boolean  @default(true)
  inAppPrebreeding Boolean  @default(true)
  inAppRegistry    Boolean  @default(true)
  inAppRecommended Boolean  @default(false)
  emailMissing     Boolean  @default(false)
  emailIncomplete  Boolean  @default(false)
  emailCarrier     Boolean  @default(true)
  emailPrebreeding Boolean  @default(true)
  emailRegistry    Boolean  @default(true)
  emailRecommended Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@schema("public")
}

/// *
/// * GeneticNotificationSnooze - "Don't remind me" functionality for genetic notifications
/// * Users can snooze notifications for specific animals, tests, or animal+test combinations.
model GeneticNotificationSnooze {
  id           Int               @id @default(autoincrement())
  userId       String
  tenantId     Int
  snoozeType   GeneticSnoozeType
  animalId     Int?
  testCode     String?
  snoozedUntil DateTime?
  createdAt    DateTime          @default(now())
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId, snoozeType, animalId, testCode])
  @@index([tenantId, userId])
  @@index([animalId])
  @@schema("public")
}

model BillingAccount {
  id               Int       @id @default(autoincrement())
  tenantId         Int       @unique
  provider         String?
  subscriptionId   String?
  plan             String?
  status           String?
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  addressLine1     String?
  addressLine2     String?
  billingEmail     String?
  city             String?
  companyName      String?
  country          String?   @db.VarChar(2)
  postalCode       String?
  state            String?
  stripeCustomerId String?   @unique
  taxId            String?
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@schema("public")
}

model Product {
  id              Int                  @id @default(autoincrement())
  name            String
  description     String?
  type            ProductType
  billingInterval BillingInterval?
  stripeProductId String?              @unique
  stripePriceId   String?
  active          Boolean              @default(true)
  priceUSD        Int
  currency        String               @default("USD") @db.VarChar(3)
  sortOrder       Int                  @default(0)
  features        Json?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  entitlements    ProductEntitlement[]
  subscriptions   Subscription[]
  addOns          SubscriptionAddOn[]

  @@index([type, active])
  @@index([active, sortOrder])
  @@schema("public")
}

model ProductEntitlement {
  id             Int            @id @default(autoincrement())
  productId      Int
  entitlementKey EntitlementKey
  limitValue     Int?
  metadata       Json?
  createdAt      DateTime       @default(now())
  product        Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, entitlementKey])
  @@index([productId])
  @@index([entitlementKey])
  @@schema("public")
}

model Subscription {
  id                   Int                 @id @default(autoincrement())
  tenantId             Int
  productId            Int
  status               SubscriptionStatus  @default(TRIAL)
  stripeSubscriptionId String?             @unique
  stripeCustomerId     String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean             @default(false)
  canceledAt           DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  amountCents          Int
  currency             String              @default("USD") @db.VarChar(3)
  billingInterval      BillingInterval
  metadata             Json?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  product              Product             @relation(fields: [productId], references: [id])
  tenant               Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  addOns               SubscriptionAddOn[]

  @@index([tenantId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([currentPeriodEnd])
  @@schema("public")
}

model SubscriptionAddOn {
  id             Int          @id @default(autoincrement())
  subscriptionId Int
  productId      Int
  quantity       Int          @default(1)
  amountCents    Int
  stripeItemId   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  product        Product      @relation(fields: [productId], references: [id])
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([productId])
  @@schema("public")
}

model UsageRecord {
  id         Int            @id @default(autoincrement())
  tenantId   Int
  metricKey  UsageMetricKey
  value      Int
  recordedAt DateTime       @default(now())
  userId     String?
  resourceId Int?
  metadata   Json?
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, metricKey, recordedAt])
  @@index([recordedAt])
  @@schema("public")
}

model UsageSnapshot {
  tenantId      Int
  metricKey     UsageMetricKey
  currentValue  Int
  limit         Int?
  lastUpdatedAt DateTime       @default(now())
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, metricKey])
  @@index([tenantId])
  @@schema("public")
}

model Feature {
  id             Int            @id @default(autoincrement())
  key            String         @unique @db.VarChar(100)
  name           String         @db.VarChar(100)
  description    String?
  module         FeatureModule
  entitlementKey EntitlementKey
  uiHint         String?        @db.VarChar(200)
  isActive       Boolean        @default(true)
  archivedAt     DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([module])
  @@index([entitlementKey])
  @@index([isActive])
  @@schema("public")
}

/// *
/// * Feature check telemetry - logs when features are checked in the UI.
/// * Used for analytics: which features are used, denied access attempts, etc.
/// * Raw events - aggregated daily into FeatureCheckDaily for long-term storage.
model FeatureCheck {
  id         BigInt   @id @default(autoincrement())
  featureKey String   @db.VarChar(100)
  tenantId   Int
  userId     String?
  granted    Boolean
  context    String?  @db.VarChar(100)
  timestamp  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([featureKey, timestamp])
  @@index([tenantId, timestamp])
  @@index([timestamp])
  @@index([granted, timestamp])
  @@schema("public")
}

/// *
/// * Aggregated daily feature check statistics.
/// * Raw FeatureCheck events older than 30 days should be aggregated here then deleted.
model FeatureCheckDaily {
  id         Int      @id @default(autoincrement())
  date       DateTime @db.Date
  featureKey String   @db.VarChar(100)
  tenantId   Int
  checkCount Int      @default(0)
  grantCount Int      @default(0)
  denyCount  Int      @default(0)

  @@unique([date, featureKey, tenantId])
  @@index([date])
  @@index([featureKey])
  @@index([tenantId])
  @@schema("public")
}

model PaymentMethod {
  id                    Int      @id @default(autoincrement())
  tenantId              Int
  stripePaymentMethodId String   @unique
  type                  String
  cardBrand             String?
  cardLast4             String?
  cardExpMonth          Int?
  cardExpYear           Int?
  bankName              String?
  bankLast4             String?
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, isDefault])
  @@schema("public")
}

model Organization {
  id                  Int             @id @default(autoincrement())
  tenantId            Int
  partyId             Int             @unique
  name                String
  email               String?
  phone               String?
  website             String?
  street              String?
  street2             String?
  city                String?
  state               String?
  zip                 String?
  country             String?
  archived            Boolean         @default(false)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  externalProvider    String?
  externalId          String?
  programSlug         String?
  isPublicProgram     Boolean         @default(false)
  programBio          String?
  publicContactEmail  String?
  animals             Animal[]        @relation("OrgAnimals")
  breedingGroups      BreedingGroup[]
  breedingPlans       BreedingPlan[]
  contacts            Contact[]
  createdCustomBreeds CustomBreed[]   @relation("CreatedByOrganization")
  memberships         Membership[]
  party               Party           @relation("OrganizationParty", fields: [partyId], references: [id], onDelete: Cascade)
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([id, tenantId])
  @@unique([tenantId, name])
  @@unique([tenantId, programSlug])
  @@index([archived])
  @@index([name])
  @@index([tenantId])
  @@index([isPublicProgram])
  @@schema("public")
}

model Membership {
  userId         String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([organizationId])
  @@schema("public")
}

model Party {
  id                       Int                        @id @default(autoincrement())
  tenantId                 Int
  type                     PartyType
  name                     String
  email                    String?                    @db.Citext
  phoneE164                String?                    @db.VarChar(32)
  whatsappE164             String?                    @db.VarChar(32)
  street                   String?
  street2                  String?
  city                     String?
  state                    String?
  postalCode               String?
  country                  String?                    @db.Char(2)
  archived                 Boolean                    @default(false)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  animalBuyers             Animal[]                   @relation("AnimalBuyerParty")
  animalOwnerships         AnimalOwner[]              @relation("AnimalOwnerParty")
  attachments              Attachment[]               @relation("AttachmentParty")
  autoReplyLogs            AutoReplyLog[]             @relation("AutoReplyLogParty")
  autoReplyRulesCreated    AutoReplyRule[]            @relation("AutoReplyRuleCreatedBy")
  breedingAttempts         BreedingAttempt[]          @relation("BreedingAttemptStudOwner")
  breedingBookings         BreedingBooking[]
  breedingPlanBuyers       BreedingPlanBuyer[]        @relation("BreedingPlanBuyerParty")
  buyer                    Buyer?                     @relation("BuyerParty")
  contact                  Contact?                   @relation("ContactParty")
  contractParties          ContractParty[]            @relation("ContractPartyRole")
  Document                 Document[]
  drafts                   Draft[]                    @relation("DraftParty")
  emailSendLogs            EmailSendLog[]             @relation("EmailSendLogParty")
  expenseVendors           Expense[]                  @relation("ExpenseVendor")
  invoiceParties           Invoice[]                  @relation("InvoiceParty")
  marketplaceBlocksCreated MarketplaceUserBlock[]     @relation("MarketplaceBlockCreator")
  marketplaceBlocksLifted  MarketplaceUserBlock[]     @relation("MarketplaceBlockLifter")
  sentMessages             Message[]                  @relation("MessageSenderParty")
  messageParticipants      MessageParticipant[]       @relation("MessageParticipantParty")
  offspringBuyers          Offspring[]                @relation("OffspringBuyerParty")
  offspringContracts       OffspringContract[]        @relation("OffspringContractBuyerParty")
  offspringGroupBuyers     OffspringGroupBuyer[]      @relation("OffspringGroupBuyerParty")
  organization             Organization?              @relation("OrganizationParty")
  tenant                   Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  activity                 PartyActivity[]            @relation("PartyActivity")
  commPreferences          PartyCommPreference[]
  commPreferenceEvents     PartyCommPreferenceEvent[]
  emails                   PartyEmail[]               @relation("PartyEmails")
  events                   PartyEvent[]               @relation("PartyEvents")
  milestones               PartyMilestone[]           @relation("PartyMilestones")
  notes                    PartyNote[]                @relation("PartyNotes")
  planParties              PlanParty[]                @relation("PlanPartyRole")
  portalAccess             PortalAccess?              @relation("PortalAccessParty")
  portalInvites            PortalInvite[]             @relation("PortalInviteParty")
  schedulingBookings       SchedulingBooking[]        @relation("SchedulingBookingParty")
  tagAssignments           TagAssignment[]            @relation("TagAssignmentTaggedParty")
  createdTemplates         Template[]                 @relation("TemplateCreatedBy")
  unlinkedEmailsLinked     UnlinkedEmail[]            @relation("UnlinkedEmailsLinked")
  users                    User[]                     @relation("UserParty")
  waitlistEntries          WaitlistEntry[]            @relation("WaitlistParty")

  @@index([tenantId, type])
  @@index([tenantId, name])
  @@index([tenantId, email])
  @@schema("public")
}

model PartyCommPreference {
  id               Int               @id @default(autoincrement())
  partyId          Int
  channel          CommChannel
  preference       PreferenceLevel   @default(ALLOW)
  compliance       ComplianceStatus?
  complianceSetAt  DateTime?
  complianceSource String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  party            Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, channel])
  @@index([partyId])
  @@index([channel, compliance])
  @@schema("public")
}

model PartyCommPreferenceEvent {
  id             Int               @id @default(autoincrement())
  partyId        Int
  channel        CommChannel
  prevPreference PreferenceLevel?
  newPreference  PreferenceLevel?
  prevCompliance ComplianceStatus?
  newCompliance  ComplianceStatus?
  actorPartyId   Int?
  reason         String?
  source         String?
  createdAt      DateTime          @default(now())
  party          Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([partyId, createdAt])
  @@index([channel, createdAt])
  @@schema("public")
}

model Contact {
  id                           Int                           @id @default(autoincrement())
  tenantId                     Int
  organizationId               Int?
  partyId                      Int?                          @unique
  display_name                 String
  first_name                   String?
  last_name                    String?
  nickname                     String?
  email                        String?                       @db.Citext
  phoneE164                    String?                       @db.VarChar(32)
  whatsappE164                 String?                       @db.VarChar(32)
  street                       String?
  street2                      String?
  city                         String?
  state                        String?
  zip                          String?
  country                      String?                       @db.Char(2)
  archived                     Boolean                       @default(false)
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt
  externalProvider             String?
  externalId                   String?
  deletedAt                    DateTime?
  marketplaceFirstContactedAt  DateTime?
  marketplaceTotalSpentCents   BigInt                        @default(0)
  marketplaceTotalTransactions Int                           @default(0)
  marketplaceUserId            Int?
  microchipRegistrations       AnimalMicrochipRegistration[] @relation("MicrochipRegisteredTo")
  organization                 Organization?                 @relation(fields: [organizationId, tenantId], references: [id, tenantId])
  party                        Party?                        @relation("ContactParty", fields: [partyId], references: [id], onDelete: Restrict)
  tenant                       Tenant                        @relation(fields: [tenantId], references: [id])
  changeRequests               ContactChangeRequest[]
  emailChangeRequests          EmailChangeRequest[]

  @@unique([tenantId, email])
  @@unique([marketplaceUserId, tenantId])
  @@index([organizationId])
  @@index([tenantId])
  @@index([display_name])
  @@index([archived])
  @@index([last_name])
  @@index([first_name])
  @@index([nickname])
  @@index([tenantId, partyId])
  @@index([deletedAt])
  @@index([tenantId, deletedAt])
  @@schema("public")
}

model PartyNote {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  partyId   Int
  content   String
  pinned    Boolean  @default(false)
  createdBy Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  party     Party    @relation("PartyNotes", fields: [partyId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, partyId])
  @@index([partyId, pinned])
  @@schema("public")
}

model PartyEvent {
  id          Int              @id @default(autoincrement())
  tenantId    Int
  partyId     Int
  kind        PartyEventKind   @default(FOLLOW_UP)
  title       String
  notes       String?
  scheduledAt DateTime
  status      PartyEventStatus @default(SCHEDULED)
  completedAt DateTime?
  createdBy   Int?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  party       Party            @relation("PartyEvents", fields: [partyId], references: [id], onDelete: Cascade)
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, partyId])
  @@index([partyId, scheduledAt])
  @@index([tenantId, status, scheduledAt])
  @@schema("public")
}

model PartyMilestone {
  id        Int                @id @default(autoincrement())
  tenantId  Int
  partyId   Int
  kind      PartyMilestoneKind @default(CUSTOM)
  label     String
  date      DateTime           @db.Date
  annual    Boolean            @default(true)
  notes     String?
  createdBy Int?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  party     Party              @relation("PartyMilestones", fields: [partyId], references: [id], onDelete: Cascade)
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, partyId])
  @@index([partyId, date])
  @@index([tenantId, annual])
  @@schema("public")
}

model PartyEmail {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  partyId   Int
  subject   String
  body      String
  toEmail   String
  sentAt    DateTime @default(now())
  status    String   @default("sent")
  messageId String?
  createdBy Int?
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false)
  party     Party    @relation("PartyEmails", fields: [partyId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, partyId])
  @@index([partyId, sentAt])
  @@schema("public")
}

/// UnlinkedEmail - Emails sent to addresses not associated with a contact/org
/// Used by MessagingHub to store emails that can later be linked when contacts are created
model UnlinkedEmail {
  id            Int       @id @default(autoincrement())
  tenantId      Int
  toAddresses   String[]
  fromAddress   String
  subject       String
  bodyText      String?
  bodyHtml      String?
  bodyPreview   String?
  status        String    @default("sent")
  direction     String    @default("outbound")
  sentAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  linkedPartyId Int?
  linkedAt      DateTime?
  messageId     String?
  templateKey   String?
  category      String    @default("transactional")
  metadata      Json?
  createdBy     Int?
  isRead        Boolean   @default(false)
  linkedParty   Party?    @relation("UnlinkedEmailsLinked", fields: [linkedPartyId], references: [id])
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, linkedPartyId])
  @@index([tenantId, createdAt])
  @@index([toAddresses])
  @@schema("public")
}

model PartyActivity {
  id        Int               @id @default(autoincrement())
  tenantId  Int
  partyId   Int
  kind      PartyActivityKind
  title     String
  detail    String?
  metadata  Json?
  actorId   Int?
  createdAt DateTime          @default(now())
  party     Party             @relation("PartyActivity", fields: [partyId], references: [id], onDelete: Cascade)
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, partyId])
  @@index([partyId, createdAt])
  @@index([tenantId, kind])
  @@schema("public")
}

model Animal {
  id                         Int                           @id @default(autoincrement())
  tenantId                   Int
  organizationId             Int?
  name                       String
  species                    Species
  sex                        Sex
  status                     AnimalStatus                  @default(ACTIVE)
  intendedUse                HorseIntendedUse?
  declaredValueCents         Int?
  declaredValueCurrency      String?                       @db.VarChar(3)
  valuationDate              DateTime?
  valuationSource            HorseValuationSource?
  forSale                    Boolean                       @default(false)
  inSyndication              Boolean                       @default(false)
  isLeased                   Boolean                       @default(false)
  birthDate                  DateTime?
  microchip                  String?
  notes                      String?
  breed                      String?
  photoUrl                   String?
  canonicalBreedId           Int?
  customBreedId              Int?
  litterId                   Int?
  offspringGroupId           Int?
  collarColorId              String?
  collarColorName            String?
  collarColorHex             String?
  collarAssignedAt           DateTime?
  collarLocked               Boolean                       @default(false)
  buyerPartyId               Int?
  priceCents                 Int?
  depositCents               Int?
  saleInvoiceId              String?
  contractId                 String?
  contractSignedAt           DateTime?
  paidInFullAt               DateTime?
  healthCertAt               DateTime?
  microchipAppliedAt         DateTime?
  pickupAt                   DateTime?
  placedAt                   DateTime?
  createdAt                  DateTime                      @default(now())
  updatedAt                  DateTime                      @updatedAt
  archived                   Boolean                       @default(false)
  femaleCycleLenOverrideDays Int?
  damId                      Int?
  sireId                     Int?
  coiPercent                 Float?
  coiGenerations             Int?
  coiCalculatedAt            DateTime?
  titlePrefix                String?
  titleSuffix                String?
  exchangeCode               String?                       @unique
  exchangeCodeExpiresAt      DateTime?
  deletedAt                  DateTime?
  breedingAvailability       String?
  lineDescription            String?
  lineTypes                  String[]
  primaryLineType            String?
  brandMark                  String?
  earTagNumber               String?
  earTagRfidNumber           String?
  scrapieTagNumber           String?
  tattooNumber               String?
  networkSearchVisible       Boolean                       @default(true)
  coverImageUrl              String?
  nickname                   String?
  buyerParty                 Party?                        @relation("AnimalBuyerParty", fields: [buyerPartyId], references: [id])
  canonicalBreed             Breed?                        @relation(fields: [canonicalBreedId], references: [id])
  customBreed                CustomBreed?                  @relation(fields: [customBreedId, tenantId], references: [id, tenantId])
  dam                        Animal?                       @relation("AnimalDam", fields: [damId], references: [id])
  childrenAsDam              Animal[]                      @relation("AnimalDam")
  litter                     Litter?                       @relation(fields: [litterId], references: [id])
  offspringGroup             OffspringGroup?               @relation("OffspringGroupPuppiesLegacy", fields: [offspringGroupId], references: [id])
  organization               Organization?                 @relation("OrgAnimals", fields: [organizationId, tenantId], references: [id, tenantId])
  sire                       Animal?                       @relation("AnimalSire", fields: [sireId], references: [id])
  childrenAsSire             Animal[]                      @relation("AnimalSire")
  tenant                     Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  animalAccesses             AnimalAccess[]                @relation("AnimalAccessAnimal")
  breeds                     AnimalBreed[]
  breedingProfile            AnimalBreedingProfile?
  genetics                   AnimalGenetics?
  identityLink               AnimalIdentityLink?
  incompatibleWithProfiles   AnimalIncompatibility[]       @relation("IncompatibleWith")
  linkRequestsAsSource       AnimalLinkRequest[]           @relation("LinkSource")
  linkRequestsAsTarget       AnimalLinkRequest[]           @relation("LinkTarget")
  microchipRegistrations     AnimalMicrochipRegistration[] @relation("AnimalMicrochipRegistrations")
  owners                     AnimalOwner[]
  ownershipChanges           AnimalOwnershipChange[]
  privacySettings            AnimalPrivacySettings?
  programParticipants        AnimalProgramParticipant[]    @relation("AnimalProgramParticipants")
  registryIds                AnimalRegistryIdentifier[]
  titles                     AnimalTitle[]
  AnimalTraitEntry           AnimalTraitEntry[]
  AnimalTraitValue           AnimalTraitValue[]
  Attachment                 Attachment[]
  breedingAttemptsAsDam      BreedingAttempt[]             @relation("BreedingAttemptDam")
  breedingAttemptsAsSire     BreedingAttempt[]             @relation("BreedingAttemptSire")
  breedingBookingsOffering   BreedingBooking[]             @relation("OfferingAnimal")
  breedingBookingsSeeking    BreedingBooking[]             @relation("SeekingAnimal")
  breedingEvents             BreedingEvent[]               @relation("BreedingEvents")
  partnerBreedingEvents      BreedingEvent[]               @relation("PartnerBreedingEvents")
  breedingGroupsAsSire       BreedingGroup[]               @relation("BreedingGroupSire")
  breedingGroupMembersAsDam  BreedingGroupMember[]         @relation("BreedingGroupDam")
  breedingListings           BreedingListing[]
  breedingPlansAsDam         BreedingPlan[]                @relation("PlanDam")
  breedingPlansAsSire        BreedingPlan[]                @relation("PlanSire")
  buyerInterests             BuyerInterest[]               @relation("BuyerInterestAnimal")
  buyerTasks                 BuyerTask[]                   @relation("BuyerTaskAnimal")
  competitionEntries         CompetitionEntry[]
  contracts                  Contract[]                    @relation("ContractAnimal")
  crossTenantLinksAsChild    CrossTenantAnimalLink[]       @relation("LinkedChild")
  crossTenantLinksAsParent   CrossTenantAnimalLink[]       @relation("LinkedParent")
  dhiaTestRecords            DHIATestRecord[]
  dairyProductionHistory     DairyProductionHistory?
  deals                      Deal[]                        @relation("DealAnimal")
  Document                   Document[]
  Expense                    Expense[]
  feedingPlans               FeedingPlan[]
  feedingRecords             FeedingRecord[]
  fiberLabTests              FiberLabTest[]
  fiberProductionHistory     FiberProductionHistory?
  foodChanges                FoodChange[]
  Invoice                    Invoice[]
  lactationCycles            LactationCycle[]
  linearAppraisals           LinearAppraisal[]
  mareReproductiveHistory    MareReproductiveHistory?
  milkingRecords             MilkingRecord[]
  offspringAsDam             Offspring[]                   @relation("OffspringIndividualDam")
  Offspring                  Offspring[]                   @relation("PromotedAnimal")
  offspringAsSire            Offspring[]                   @relation("OffspringIndividualSire")
  offspringGroupsAsDam       OffspringGroup[]              @relation("OffspringDam")
  offspringGroupsAsSire      OffspringGroup[]              @relation("OffspringSire")
  PaymentIntent              PaymentIntent[]
  rearingAssignments         RearingProtocolAssignment[]   @relation("AnimalProtocolAssignment")
  registryPedigrees          RegistryPedigree[]            @relation("RegistryPedigreeLinkedAnimal")
  reproductiveCycles         ReproductiveCycle[]
  semenInventory             SemenInventory[]              @relation("StallionSemenInventory")
  shearingRecords            ShearingRecord[]
  supplementAdministrations  SupplementAdministration[]
  supplementSchedules        SupplementSchedule[]
  tagAssignments             TagAssignment[]
  TestResult                 TestResult[]
  VaccinationRecord          VaccinationRecord[]
  waitlistAllocations        WaitlistEntry[]               @relation("WaitlistAllocation")
  waitlistDamPrefs           WaitlistEntry[]               @relation("WaitlistDamPref")
  waitlistSirePrefs          WaitlistEntry[]               @relation("WaitlistSirePref")
  loci                       AnimalLoci[]                  @relation("AnimalLoci")
  breedingBookingAnimals     MktBreedingBookingAnimal[]
  individualAnimalListings   MktListingIndividualAnimal[]  @relation("AnimalIndividualAnimalListings")

  @@unique([tenantId, microchip])
  @@index([organizationId])
  @@index([tenantId])
  @@index([species])
  @@index([status])
  @@index([archived])
  @@index([canonicalBreedId])
  @@index([tenantId, customBreedId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([tenantId, placedAt])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([damId])
  @@index([sireId])
  @@index([tenantId, species, primaryLineType])
  @@index([tenantId, species, sex, networkSearchVisible])
  @@schema("public")
}

model AnimalGenetics {
  id                   Int       @id @default(autoincrement())
  animalId             Int       @unique
  testProvider         String?   @db.VarChar(255)
  testDate             DateTime? @db.Date
  testId               String?   @db.VarChar(255)
  coatColorData        Json?
  healthGeneticsData   Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @default(now()) @updatedAt
  coatTypeData         Json?
  eyeColorData         Json?
  otherTraitsData      Json?
  physicalTraitsData   Json?
  breedComposition     Json?
  coi                  Json?
  lifeStage            String?   @db.VarChar(100)
  lineage              Json?
  mhcDiversity         Json?
  predictedAdultWeight Json?
  performanceData      Json?
  temperamentData      Json?
  animal               Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@index([animalId])
  @@schema("public")
}

/// Normalized genetics table for high-performance searching
/// One row per locus per animal - enables fast queries for carriers, compatibility, etc.
model AnimalLoci {
  id             Int      @id @default(autoincrement())
  animalId       Int      @map("animal_id")
  category       String
  locus          String
  locusName      String   @map("locus_name")
  allele1        String?
  allele2        String?
  genotype       String?
  networkVisible Boolean  @default(false) @map("network_visible")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")
  animal         Animal   @relation("AnimalLoci", fields: [animalId], references: [id], onDelete: Cascade)

  @@unique([animalId, category, locus], name: "animal_loci_animal_id_category_locus_key")
  @@index([animalId])
  @@index([locus])
  @@index([category])
  @@index([genotype])
  @@index([allele1])
  @@index([allele2])
  @@index([locus, genotype])
  @@index([locus, allele1])
  @@index([locus, allele2])
  @@index([category, locus])
  @@map("animal_loci")
  @@schema("public")
}

model AnimalOwner {
  id                   Int       @id @default(autoincrement())
  animalId             Int
  percent              Int
  isPrimary            Boolean   @default(false)
  partyId              Int
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  effectiveDate        DateTime  @default(now())
  endDate              DateTime?
  isPrimaryContact     Boolean   @default(false)
  notes                String?
  receiveNotifications Boolean   @default(true)
  role                 OwnerRole @default(CO_OWNER)
  animal               Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  party                Party     @relation("AnimalOwnerParty", fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([animalId, partyId])
  @@index([animalId])
  @@index([partyId])
  @@schema("public")
}

model Registry {
  id                Int                        @id @default(autoincrement())
  name              String
  code              String?                    @unique
  url               String?
  country           String?
  species           Species?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  identifiers       AnimalRegistryIdentifier[]
  BreedRegistryLink BreedRegistryLink[]
  connections       RegistryConnection[]

  @@schema("public")
}

model AnimalRegistryIdentifier {
  id                Int                   @id @default(autoincrement())
  animalId          Int
  registryId        Int
  identifier        String
  registrarOfRecord String?
  issuedAt          DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  animal            Animal                @relation(fields: [animalId], references: [id], onDelete: Cascade)
  registry          Registry              @relation(fields: [registryId], references: [id], onDelete: Cascade)
  pedigrees         RegistryPedigree[]
  verification      RegistryVerification?

  @@unique([registryId, identifier])
  @@index([animalId])
  @@index([registryId])
  @@schema("public")
}

model MktListingIndividualAnimal {
  id                   Int                      @id @default(autoincrement())
  tenantId             Int
  animalId             Int
  templateType         String                   @db.VarChar(32)
  slug                 String                   @unique
  headline             String?                  @db.VarChar(120)
  title                String?                  @db.VarChar(100)
  summary              String?
  description          String?
  dataDrawerConfig     Json
  listingContent       Json?
  priceModel           String                   @db.VarChar(32)
  priceCents           Int?
  priceMinCents        Int?
  priceMaxCents        Int?
  locationCity         String?                  @db.VarChar(100)
  locationRegion       String?                  @db.VarChar(100)
  locationCountry      String?                  @db.VarChar(2)
  status               MarketplaceListingStatus @default(DRAFT)
  listed               Boolean                  @default(true)
  publishedAt          DateTime?
  pausedAt             DateTime?
  viewCount            Int                      @default(0)
  inquiryCount         Int                      @default(0)
  lastViewedAt         DateTime?
  lastInquiryAt        DateTime?
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  bookingFeeCents      Int?
  bookingsClosed       Boolean                  @default(false)
  bookingsReceived     Int                      @default(0)
  breedingMethods      String[]                 @default([])
  defaultGuaranteeType BreedingGuaranteeType?
  healthCertRequired   Boolean                  @default(false)
  maxBookings          Int?
  requiredTests        String[]                 @default([])
  seasonEnd            DateTime?
  seasonName           String?                  @db.VarChar(100)
  seasonStart          DateTime?
  locationZip          String?                  @db.VarChar(20)
  coverImageUrl        String?                  @db.VarChar(500)
  animal               Animal                   @relation("AnimalIndividualAnimalListings", fields: [animalId], references: [id], onDelete: Cascade)
  tenant               Tenant                   @relation("TenantIndividualAnimalListings", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, templateType])
  @@index([animalId])
  @@index([status])
  @@index([slug])
  @@map("mkt_listing_individual_animal")
  @@schema("public")
}

model MktListingAnimalProgram {
  id                          Int                        @id @default(autoincrement())
  tenantId                    Int
  name                        String                     @db.VarChar(100)
  slug                        String                     @unique
  templateType                String                     @db.VarChar(32)
  headline                    String?                    @db.VarChar(120)
  description                 String?
  coverImageUrl               String?                    @db.VarChar(500)
  dataDrawerConfig            Json
  programContent              Json?
  defaultPriceModel           String                     @default("inquire") @db.VarChar(32)
  defaultPriceCents           Int?
  defaultPriceMinCents        Int?
  defaultPriceMaxCents        Int?
  listed                      Boolean                    @default(true)
  publishedAt                 DateTime?
  acceptInquiries             Boolean                    @default(true)
  openWaitlist                Boolean                    @default(false)
  viewCount                   Int                        @default(0)
  inquiryCount                Int                        @default(0)
  lastViewedAt                DateTime?
  lastInquiryAt               DateTime?
  createdAt                   DateTime                   @default(now())
  updatedAt                   DateTime                   @updatedAt
  status                      MarketplaceListingStatus   @default(DRAFT)
  breedingMethods             String[]                   @default([])
  defaultBookingFeeCents      Int?
  defaultGuaranteeType        BreedingGuaranteeType?
  defaultMaxBookingsPerAnimal Int?
  healthCertRequired          Boolean                    @default(false)
  requiredTests               String[]                   @default([])
  seasonEnd                   DateTime?
  seasonName                  String?                    @db.VarChar(100)
  seasonStart                 DateTime?
  locationCity                String?                    @db.VarChar(100)
  locationCountry             String?                    @db.VarChar(2)
  locationRegion              String?                    @db.VarChar(100)
  locationZip                 String?                    @db.VarChar(20)
  media                       AnimalProgramMedia[]
  participants                AnimalProgramParticipant[]
  tenant                      Tenant                     @relation("TenantAnimalPrograms", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, templateType])
  @@index([slug])
  @@map("mkt_listing_animal_program")
  @@schema("public")
}

model AnimalProgramParticipant {
  id                  Int                     @id @default(autoincrement())
  programId           Int
  animalId            Int
  status              String                  @default("ACTIVE")
  listed              Boolean                 @default(true)
  featured            Boolean                 @default(false)
  headlineOverride    String?                 @db.VarChar(120)
  descriptionOverride String?
  dataDrawerOverride  Json?
  contentOverride     Json?
  priceModel          String?                 @db.VarChar(32)
  priceCents          Int?
  priceMinCents       Int?
  priceMaxCents       Int?
  sortOrder           Int                     @default(0)
  viewCount           Int                     @default(0)
  inquiryCount        Int                     @default(0)
  lastViewedAt        DateTime?
  lastInquiryAt       DateTime?
  addedAt             DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  bookingFeeOverride  Int?
  bookingsClosed      Boolean                 @default(false)
  bookingsReceived    Int                     @default(0)
  maxBookingsOverride Int?
  animal              Animal                  @relation("AnimalProgramParticipants", fields: [animalId], references: [id], onDelete: Cascade)
  program             MktListingAnimalProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, animalId])
  @@index([programId, status])
  @@index([animalId])
  @@schema("public")
}

model AnimalProgramMedia {
  id        Int                     @id @default(autoincrement())
  programId Int
  type      String                  @db.VarChar(32)
  url       String                  @db.VarChar(500)
  caption   String?
  sortOrder Int                     @default(0)
  isPrimary Boolean                 @default(false)
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  program   MktListingAnimalProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId, sortOrder])
  @@schema("public")
}

model TraitDefinition {
  id                        Int                @id @default(autoincrement())
  tenantId                  Int?
  species                   Species
  key                       String
  displayName               String
  category                  String
  valueType                 TraitValueType
  enumValues                Json?
  requiresDocument          Boolean            @default(false)
  marketplaceVisibleDefault Boolean            @default(false)
  sortOrder                 Int?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  supportsHistory           Boolean            @default(false)
  animalTraitEntries        AnimalTraitEntry[]
  animalTraitValues         AnimalTraitValue[]

  @@unique([species, key, tenantId])
  @@index([species])
  @@index([tenantId, species])
  @@schema("public")
}

model AnimalTraitValue {
  id                 Int                        @id @default(autoincrement())
  tenantId           Int
  animalId           Int
  traitDefinitionId  Int
  valueBoolean       Boolean?
  valueNumber        Float?
  valueText          String?
  valueDate          DateTime?
  valueJson          Json?
  status             TraitStatus?
  performedAt        DateTime?
  source             TraitSource?
  verified           Boolean                    @default(false)
  verifiedAt         DateTime?
  marketplaceVisible Boolean?
  notes              String?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  networkVisible     Boolean?
  animal             Animal                     @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  traitDefinition    TraitDefinition            @relation(fields: [traitDefinitionId], references: [id])
  documents          AnimalTraitValueDocument[]

  @@unique([tenantId, animalId, traitDefinitionId])
  @@index([tenantId, animalId])
  @@index([tenantId, traitDefinitionId])
  @@schema("public")
}

model AnimalTraitValueDocument {
  id                 Int              @id @default(autoincrement())
  tenantId           Int
  animalId           Int
  animalTraitValueId Int
  documentId         Int
  createdAt          DateTime         @default(now())
  animalTraitValue   AnimalTraitValue @relation(fields: [animalTraitValueId], references: [id], onDelete: Cascade)
  document           Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([tenantId, animalTraitValueId, documentId])
  @@index([tenantId, animalId])
  @@index([tenantId, animalTraitValueId])
  @@index([tenantId, documentId])
  @@schema("public")
}

model AnimalTraitEntry {
  id                Int             @id @default(autoincrement())
  tenantId          Int
  animalId          Int
  traitDefinitionId Int
  recordedAt        DateTime
  data              Json
  performedBy       String?         @db.VarChar(255)
  location          String?         @db.VarChar(255)
  notes             String?
  documentId        Int?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  animal            Animal          @relation(fields: [animalId], references: [id], onDelete: Cascade)
  document          Document?       @relation(fields: [documentId], references: [id])
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  traitDefinition   TraitDefinition @relation(fields: [traitDefinitionId], references: [id])

  @@index([tenantId, animalId])
  @@index([tenantId, animalId, traitDefinitionId])
  @@index([tenantId, animalId, recordedAt])
  @@schema("public")
}

model VaccinationRecord {
  id             Int       @id @default(autoincrement())
  tenantId       Int
  animalId       Int
  protocolKey    String    @db.VarChar(100)
  administeredAt DateTime
  expiresAt      DateTime?
  veterinarian   String?   @db.VarChar(255)
  clinic         String?   @db.VarChar(255)
  batchLotNumber String?   @db.VarChar(100)
  notes          String?
  documentId     Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  animal         Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  document       Document? @relation(fields: [documentId], references: [id])
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, animalId])
  @@index([tenantId, protocolKey])
  @@index([animalId, protocolKey])
  @@index([administeredAt])
  @@schema("public")
}

model Tag {
  id          Int             @id @default(autoincrement())
  tenantId    Int
  name        String
  module      TagModule
  color       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  isArchived  Boolean         @default(false)
  archivedAt  DateTime?
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignments TagAssignment[]

  @@unique([tenantId, module, name])
  @@index([tenantId, module])
  @@index([tenantId, isArchived, module])
  @@schema("public")
}

model TagAssignment {
  id               Int             @id @default(autoincrement())
  tagId            Int
  taggedPartyId    Int?
  animalId         Int?
  waitlistEntryId  Int?
  offspringGroupId Int?
  offspringId      Int?
  createdAt        DateTime        @default(now())
  draftId          Int?
  messageThreadId  Int?
  breedingPlanId   Int?
  buyerId          Int?
  dealId           Int?
  documentId       Int?
  animal           Animal?         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  breedingPlan     BreedingPlan?   @relation(fields: [breedingPlanId], references: [id], onDelete: Cascade)
  buyer            Buyer?          @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  deal             Deal?           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  Document         Document?       @relation(fields: [documentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  draft            Draft?          @relation(fields: [draftId], references: [id], onDelete: Cascade)
  messageThread    MessageThread?  @relation(fields: [messageThreadId], references: [id], onDelete: Cascade)
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  offspring        Offspring?      @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  tag              Tag             @relation(fields: [tagId], references: [id], onDelete: Cascade)
  taggedParty      Party?          @relation("TagAssignmentTaggedParty", fields: [taggedPartyId], references: [id])
  waitlistEntry    WaitlistEntry?  @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  @@unique([tagId, taggedPartyId])
  @@unique([tagId, animalId])
  @@unique([tagId, waitlistEntryId])
  @@unique([tagId, offspringGroupId])
  @@unique([tagId, offspringId])
  @@unique([tagId, messageThreadId])
  @@unique([tagId, draftId])
  @@unique([tagId, breedingPlanId])
  @@unique([tagId, buyerId])
  @@unique([tagId, dealId])
  @@index([taggedPartyId])
  @@index([animalId])
  @@index([waitlistEntryId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([messageThreadId])
  @@index([draftId])
  @@index([breedingPlanId])
  @@index([buyerId])
  @@index([dealId])
  @@index([tagId, taggedPartyId])
  @@index([documentId], map: "idx_TagAssignment_documentId")
  @@schema("public")
}

model Breed {
  id                 Int                  @id @default(autoincrement())
  name               String               @unique
  slug               String               @unique
  species            Species
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  Animal             Animal[]
  AnimalBreeds       AnimalBreed[]
  registries         BreedRegistryLink[]
  TenantProgramBreed TenantProgramBreed[]

  @@index([species])
  @@schema("public")
}

model AnimalBreed {
  id         Int      @id @default(autoincrement())
  animalId   Int
  breedId    Int
  percentage Float    @default(100)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  animal     Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  breed      Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)

  @@unique([animalId, breedId])
  @@index([animalId])
  @@index([breedId])
  @@schema("public")
}

model BreedRegistryLink {
  breedId     Int
  registryId  Int
  statusText  String?
  registryRef String?
  url         String?
  primary     Boolean?
  since       Int?
  notes       String?
  proofUrl    String?
  breed       Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  registry    Registry @relation(fields: [registryId], references: [id], onDelete: Cascade)

  @@id([breedId, registryId])
  @@index([registryId])
  @@schema("public")
}

model CustomBreed {
  id                      Int                 @id @default(autoincrement())
  tenantId                Int
  createdByOrganizationId Int?
  species                 Species
  name                    String
  composition             Json?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  Animal                  Animal[]
  createdByOrganization   Organization?       @relation("CreatedByOrganization", fields: [createdByOrganizationId, tenantId], references: [id, tenantId])
  tenant                  Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  TenantProgramBreed      TenantProgramBreed?

  @@unique([id, tenantId])
  @@unique([tenantId, species, name])
  @@index([tenantId, species])
  @@index([tenantId, createdByOrganizationId])
  @@schema("public")
}

/// Breeds selected for a tenant's breeding program (displayed on marketplace listings)
model TenantProgramBreed {
  id            Int          @id @default(autoincrement())
  tenantId      Int
  species       Species
  /// Reference to canonical breed (mutually exclusive with customBreedId)
  breedId       Int?
  /// Reference to custom breed (mutually exclusive with breedId)
  customBreedId Int?
  /// Whether this is the primary breed for the species
  isPrimary     Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  breed         Breed?       @relation(fields: [breedId], references: [id], onDelete: Cascade)
  customBreed   CustomBreed? @relation(fields: [customBreedId, tenantId], references: [id, tenantId], onDelete: Cascade)
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, breedId])
  @@unique([customBreedId, tenantId])
  @@index([tenantId, species])
  @@schema("public")
}

model MktListingBreedingProgram {
  id                       Int                      @id @default(autoincrement())
  tenantId                 Int
  slug                     String
  name                     String
  description              String?
  species                  Species
  breedText                String?
  acceptInquiries          Boolean                  @default(true)
  openWaitlist             Boolean                  @default(false)
  acceptReservations       Boolean                  @default(false)
  pricingTiers             Json?
  whatsIncluded            String?
  typicalWaitTime          String?
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  publishedAt              DateTime?
  breedId                  Int?
  comingSoon               Boolean                  @default(false)
  coverImageUrl            String?
  programStory             String?
  showCoverImage           Boolean                  @default(true)
  showWaitTime             Boolean                  @default(true)
  showWhatsIncluded        Boolean                  @default(true)
  status                   MarketplaceListingStatus @default(DRAFT)
  comingSoonWeeksThreshold Int                      @default(8)
  offspringDisplayMode     String                   @default("curated")
  showOffspringPhotos      Boolean                  @default(true)
  showParentPhotos         Boolean                  @default(true)
  showPricing              Boolean                  @default(true)
  breedingGroups           BreedingGroup[]
  breedingPlans            BreedingPlan[]
  inquiries                BreedingProgramInquiry[]
  media                    BreedingProgramMedia[]
  waitlistEntries          WaitlistEntry[]
  tenant                   Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([status])
  @@index([species])
  @@map("mkt_listing_breeding_program")
  @@schema("public")
}

model BreedingProgramMedia {
  id        Int                       @id @default(autoincrement())
  programId Int
  tenantId  Int
  assetUrl  String
  caption   String?
  sortOrder Int                       @default(0)
  isPublic  Boolean                   @default(true)
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt
  program   MktListingBreedingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  tenant    Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@index([tenantId])
  @@schema("public")
}

model BreedingProgramInquiry {
  id               Int                       @id @default(autoincrement())
  programId        Int
  tenantId         Int
  buyerName        String
  buyerEmail       String
  buyerPhone       String?
  subject          String
  message          String
  interestedIn     String?
  priceRange       String?
  timeline         String?
  status           InquiryStatus             @default(NEW)
  assignedToUserId String?
  responded        Boolean                   @default(false)
  respondedAt      DateTime?
  notes            String?
  source           String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  assignedToUser   User?                     @relation(fields: [assignedToUserId], references: [id])
  program          MktListingBreedingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  tenant           Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([programId, status])
  @@index([tenantId, status])
  @@index([buyerEmail])
  @@index([createdAt])
  @@schema("public")
}

model MktListingBreedingBooking {
  id                   Int                        @id @default(autoincrement())
  tenantId             Int
  slug                 String                     @unique
  headline             String?                    @db.VarChar(120)
  description          String?
  intent               String                     @db.VarChar(32)
  feeCents             Int?
  feeDirection         String?                    @db.VarChar(32)
  breedingMethods      String[]                   @default([])
  guaranteeType        String?                    @db.VarChar(32)
  guaranteeTerms       String?
  healthCertRequired   Boolean                    @default(false)
  cogginsCurrent       Boolean                    @default(false)
  cultureRequired      Boolean                    @default(false)
  contractRequired     Boolean                    @default(false)
  customRequirements   String[]                   @default([])
  availableFrom        DateTime?
  availableTo          DateTime?
  blackoutDates        String[]                   @default([])
  maxBookingsPerPeriod Int?
  acceptingInquiries   Boolean                    @default(true)
  status               MarketplaceListingStatus   @default(DRAFT)
  publishedAt          DateTime?
  pausedAt             DateTime?
  viewCount            Int                        @default(0)
  inquiryCount         Int                        @default(0)
  lastViewedAt         DateTime?
  lastInquiryAt        DateTime?
  notes                String?
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  coverImageUrl        String?                    @db.VarChar(500)
  dataDrawerConfig     Json?
  animals              MktBreedingBookingAnimal[]
  tenant               Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([intent])
  @@map("mkt_listing_breeding_booking")
  @@schema("public")
}

/// *
/// * Animal assignments for breeding booking listings
model MktBreedingBookingAnimal {
  id             Int                       @id @default(autoincrement())
  bookingId      Int
  animalId       Int
  featured       Boolean                   @default(false)
  feeOverride    Int?
  maxBookings    Int?
  bookingsClosed Boolean                   @default(false)
  addedAt        DateTime                  @default(now())
  animal         Animal                    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  booking        MktListingBreedingBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@unique([bookingId, animalId])
  @@index([bookingId])
  @@index([animalId])
  @@map("mkt_breeding_booking_animal")
  @@schema("public")
}

model BreedingPlan {
  id                            Int                        @id @default(autoincrement())
  tenantId                      Int
  organizationId                Int?
  code                          String?
  name                          String
  nickname                      String?
  species                       Species
  breedText                     String?
  damId                         Int?
  sireId                        Int?
  lockedCycleKey                String?
  lockedCycleStart              DateTime?
  lockedOvulationDate           DateTime?
  lockedDueDate                 DateTime?
  lockedPlacementStartDate      DateTime?
  expectedCycleStart            DateTime?
  expectedHormoneTestingStart   DateTime?
  expectedBreedDate             DateTime?
  expectedBirthDate             DateTime?
  expectedWeaned                DateTime?
  expectedPlacementStart        DateTime?
  expectedPlacementCompleted    DateTime?
  cycleStartDateActual          DateTime?
  hormoneTestingStartDateActual DateTime?
  breedDateActual               DateTime?
  birthDateActual               DateTime?
  weanedDateActual              DateTime?
  placementStartDateActual      DateTime?
  placementCompletedDateActual  DateTime?
  completedDateActual           DateTime?
  status                        BreedingPlanStatus         @default(PLANNING)
  notes                         String?
  committedAt                   DateTime?
  committedByUserId             String?
  depositsCommittedCents        Int?
  depositsPaidCents             Int?
  depositRiskScore              Int?
  archived                      Boolean                    @default(false)
  createdAt                     DateTime                   @default(now())
  updatedAt                     DateTime                   @updatedAt
  programId                     Int?
  deletedAt                     DateTime?
  actualOvulationOffset         Int?
  cycleStartConfidence          ConfidenceLevel?
  /// Cycle start tracking (observed or derived from ovulation)
  cycleStartObserved            DateTime?
  cycleStartSource              DataSource?
  /// General date confidence metadata
  dateConfidenceLevel           ConfidenceLevel?           @default(MEDIUM)
  dateSourceNotes               String?
  /// Variance tracking for machine learning and validation
  expectedOvulationOffset       Int?
  ovulationConfidence           ConfidenceLevel?
  /// Ovulation tracking (confirmed via hormone test or calculated)
  ovulationConfirmed            DateTime?
  ovulationConfirmedMethod      OvulationMethod?
  ovulationTestResultId         Int?
  /// System-determined primary anchor based on data quality
  primaryAnchor                 AnchorType                 @default(CYCLE_START)
  /// User-selected primary anchor mode for this plan
  reproAnchorMode               ReproAnchorMode            @default(CYCLE_START)
  varianceFromExpected          Int?
  breedDateUnknown              Boolean                    @default(false)
  /// Unknown date flags - for surprise pregnancies where breeder doesn't know exact dates
  /// When true, the corresponding date is unknown and phase can progress without it
  cycleStartDateUnknown         Boolean                    @default(false)
  /// User intent flag: breeder has mentally committed to this plan (set during PLANNING phase)
  /// This is separate from the CYCLE phase - indicates serious intent without locking cycle dates
  isCommittedIntent             Boolean                    @default(false)
  ovulationDateUnknown          Boolean                    @default(false)
  /// For ON_HOLD status: stores the previous status so plan can resume
  statusBeforeHold              BreedingPlanStatus?
  /// Optional reason for terminal status (CANCELED, UNSUCCESSFUL, ON_HOLD)
  statusReason                  String?
  depositOverrideAmountCents    Int?
  depositOverrideRequired       Boolean?
  expectedLitterSize            Int?
  /// Optional reason/note provided when archiving the plan
  archiveReason                 String?
  animalAccesses                AnimalAccess[]             @relation("AnimalAccessBreedingPlan")
  Attachments                   Attachment[]
  BreedingAttempts              BreedingAttempt[]
  breedingBooking               BreedingBooking?
  breedingAgreements            BreedingDataAgreement[]    @relation("BreedingAgreementPlan")
  breedingEventsLog             BreedingEvent[]
  groupMember                   BreedingGroupMember?       @relation("GroupMemberPlan")
  breedingMilestones            BreedingMilestone[]
  committedByUser               User?                      @relation("CommittedByUser", fields: [committedByUserId], references: [id])
  dam                           Animal?                    @relation("PlanDam", fields: [damId], references: [id], onDelete: Restrict)
  organization                  Organization?              @relation(fields: [organizationId, tenantId], references: [id, tenantId])
  ovulationTestResult           TestResult?                @relation("OvulationAnchor", fields: [ovulationTestResultId], references: [id])
  program                       MktListingBreedingProgram? @relation(fields: [programId], references: [id])
  sire                          Animal?                    @relation("PlanSire", fields: [sireId], references: [id])
  tenant                        Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  buyers                        BreedingPlanBuyer[]
  Events                        BreedingPlanEvent[]
  BreedingPlanTempLog           BreedingPlanTempLog[]
  Expense                       Expense[]
  foalingOutcome                FoalingOutcome?
  Invoice                       Invoice[]
  Litter                        Litter?
  offspringGroup                OffspringGroup?
  Parties                       PlanParty[]
  PregnancyChecks               PregnancyCheck[]
  supplementSchedules           SupplementSchedule[]
  TagAssignments                TagAssignment[]
  TestResults                   TestResult[]
  Waitlist                      WaitlistEntry[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([organizationId])
  @@index([programId])
  @@index([damId])
  @@index([sireId])
  @@index([status])
  @@index([deletedAt])
  @@index([committedAt])
  @@index([expectedWeaned])
  @@index([expectedPlacementCompleted])
  @@index([expectedPlacementStart])
  @@index([placementStartDateActual])
  @@index([placementCompletedDateActual])
  @@index([expectedBirthDate])
  @@index([expectedCycleStart])
  @@index([expectedHormoneTestingStart])
  @@index([expectedBreedDate])
  @@index([cycleStartDateActual])
  @@index([reproAnchorMode])
  @@index([ovulationConfirmed])
  @@index([cycleStartObserved])
  @@index([primaryAnchor])
  @@index([ovulationTestResultId])
  @@schema("public")
}

model BreedingPlanBuyer {
  id                    Int                    @id @default(autoincrement())
  tenantId              Int
  planId                Int
  waitlistEntryId       Int?
  partyId               Int?
  stage                 BreedingPlanBuyerStage @default(POSSIBLE_MATCH)
  matchScore            Int?
  matchReasons          Json?
  assignedAt            DateTime?
  assignedByPartyId     Int?
  priority              Int?
  offspringGroupBuyerId Int?
  offspringId           Int?
  notes                 String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  buyerId               Int?
  buyer                 Buyer?                 @relation("BreedingPlanBuyerCRM", fields: [buyerId], references: [id])
  party                 Party?                 @relation("BreedingPlanBuyerParty", fields: [partyId], references: [id])
  plan                  BreedingPlan           @relation(fields: [planId], references: [id], onDelete: Cascade)
  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  waitlistEntry         WaitlistEntry?         @relation(fields: [waitlistEntryId], references: [id])
  Invoice               Invoice?

  @@index([tenantId])
  @@index([planId])
  @@index([planId, stage])
  @@index([waitlistEntryId])
  @@index([partyId])
  @@index([buyerId])
  @@schema("public")
}

model ReproductiveCycle {
  id                 Int       @id @default(autoincrement())
  tenantId           Int
  femaleId           Int
  cycleStart         DateTime
  ovulation          DateTime?
  dueDate            DateTime?
  placementStartDate DateTime?
  status             String?
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  female             Animal    @relation(fields: [femaleId], references: [id], onDelete: Cascade)
  tenant             Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([femaleId])
  @@index([cycleStart])
  @@schema("public")
}

model BreedingPlanEvent {
  id               Int          @id @default(autoincrement())
  tenantId         Int
  planId           Int
  type             String
  occurredAt       DateTime
  label            String?
  notes            String?
  data             Json?
  recordedByUserId String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  plan             BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  recordedByUser   User?        @relation(fields: [recordedByUserId], references: [id])
  tenant           Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([planId, type, occurredAt])
  @@schema("public")
}

model TestResult {
  id                     Int            @id @default(autoincrement())
  tenantId               Int
  planId                 Int?
  animalId               Int?
  kind                   String
  method                 String?
  labName                String?
  valueNumber            Float?
  valueText              String?
  units                  String?
  referenceRange         String?
  collectedAt            DateTime
  resultAt               DateTime?
  notes                  String?
  data                   Json?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  indicatesOvulationDate DateTime?
  anchoredPlans          BreedingPlan[] @relation("OvulationAnchor")
  animal                 Animal?        @relation(fields: [animalId], references: [id])
  plan                   BreedingPlan?  @relation(fields: [planId], references: [id])
  tenant                 Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([animalId])
  @@index([planId])
  @@index([kind, collectedAt])
  @@schema("public")
}

model BreedingAttempt {
  id                      Int                    @id @default(autoincrement())
  tenantId                Int
  planId                  Int?
  method                  BreedingMethod
  attemptAt               DateTime?
  windowStart             DateTime?
  windowEnd               DateTime?
  studOwnerPartyId        Int?
  semenBatchId            Int?
  success                 Boolean?
  notes                   String?
  data                    Json?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  damId                   Int?
  sireId                  Int?
  agreedFeeCents          Int?
  feePaidCents            Int?                   @default(0)
  guaranteeExpiresAt      DateTime?
  guaranteeReason         String?
  guaranteeResolution     GuaranteeResolution?
  guaranteeTriggered      Boolean                @default(false)
  guaranteeTriggeredAt    DateTime?
  guaranteeType           BreedingGuaranteeType?
  returnBreedingExpiresAt DateTime?
  returnBreedingGranted   Boolean                @default(false)
  returnBreedingUsedAt    DateTime?
  location                String?                @db.VarChar(255)
  dam                     Animal?                @relation("BreedingAttemptDam", fields: [damId], references: [id])
  plan                    BreedingPlan?          @relation(fields: [planId], references: [id])
  sire                    Animal?                @relation("BreedingAttemptSire", fields: [sireId], references: [id])
  studOwnerParty          Party?                 @relation("BreedingAttemptStudOwner", fields: [studOwnerPartyId], references: [id])
  tenant                  Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  semenUsage              SemenUsage?

  @@index([tenantId])
  @@index([planId])
  @@index([damId])
  @@index([sireId])
  @@index([studOwnerPartyId])
  @@schema("public")
}

model SemenInventory {
  id               Int                   @id @default(autoincrement())
  tenantId         Int
  stallionId       Int
  batchNumber      String
  collectionDate   DateTime
  collectionMethod SemenCollectionMethod @default(AV)
  storageType      SemenStorageType
  storageLocation  String?
  storageFacility  String?
  initialDoses     Int
  availableDoses   Int
  doseVolumeMl     Decimal?              @db.Decimal(5, 2)
  concentration    Int?
  motility         Int?
  morphology       Int?
  qualityGrade     SemenQualityGrade?
  expiresAt        DateTime?
  isExpired        Boolean               @default(false)
  status           SemenInventoryStatus  @default(AVAILABLE)
  notes            String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  createdBy        Int?
  archivedAt       DateTime?
  stallion         Animal                @relation("StallionSemenInventory", fields: [stallionId], references: [id])
  tenant           Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  usages           SemenUsage[]

  @@unique([tenantId, batchNumber])
  @@index([tenantId, stallionId])
  @@index([tenantId, status])
  @@schema("public")
}

model SemenUsage {
  id                    Int              @id @default(autoincrement())
  tenantId              Int
  inventoryId           Int
  usageType             SemenUsageType
  usageDate             DateTime         @default(now())
  dosesUsed             Int              @default(1)
  breedingAttemptId     Int?             @unique
  shippedToName         String?
  shippedToAddress      String?
  shippingCarrier       String?
  trackingNumber        String?
  transferredToFacility String?
  notes                 String?
  recordedBy            Int?
  createdAt             DateTime         @default(now())
  breedingBooking       BreedingBooking?
  breedingAttempt       BreedingAttempt? @relation(fields: [breedingAttemptId], references: [id])
  inventory             SemenInventory   @relation(fields: [inventoryId], references: [id])
  tenant                Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, inventoryId])
  @@index([tenantId, usageDate])
  @@schema("public")
}

model PregnancyCheck {
  id        Int                  @id @default(autoincrement())
  tenantId  Int
  planId    Int
  method    PregnancyCheckMethod
  result    Boolean
  checkedAt DateTime
  notes     String?
  data      Json?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  plan      BreedingPlan         @relation(fields: [planId], references: [id], onDelete: Cascade)
  tenant    Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([planId, checkedAt])
  @@schema("public")
}

model FoalingOutcome {
  id                    Int                       @id @default(autoincrement())
  tenantId              Int
  breedingPlanId        Int                       @unique
  hadComplications      Boolean                   @default(false)
  complicationDetails   String?
  veterinarianCalled    Boolean                   @default(false)
  veterinarianName      String?
  veterinarianNotes     String?
  placentaPassed        Boolean?
  placentaPassedMinutes Int?
  mareCondition         MarePostFoalingCondition?
  postFoalingHeatDate   DateTime?
  postFoalingHeatNotes  String?
  readyForRebreeding    Boolean                   @default(false)
  rebredDate            DateTime?
  foalPhotoUrls         Json?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  wasCSection           Boolean                   @default(false)
  cSectionReason        String?
  placentaCount         Int?
  damRecoveryNotes      String?
  totalBorn             Int?
  bornAlive             Int?
  stillborn             Int?
  breedingPlan          BreedingPlan              @relation(fields: [breedingPlanId], references: [id], onDelete: Cascade)
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([breedingPlanId])
  @@schema("public")
}

model MareReproductiveHistory {
  id                           Int       @id @default(autoincrement())
  tenantId                     Int
  mareId                       Int       @unique
  totalFoalings                Int       @default(0)
  totalLiveFoals               Int       @default(0)
  totalComplicatedFoalings     Int       @default(0)
  totalVeterinaryInterventions Int       @default(0)
  totalRetainedPlacentas       Int       @default(0)
  lastFoalingDate              DateTime?
  lastFoalingComplications     Boolean?
  lastMareCondition            String?
  lastPlacentaPassed           Boolean?
  lastPlacentaMinutes          Int?
  avgPostFoalingHeatDays       Float?
  minPostFoalingHeatDays       Int?
  maxPostFoalingHeatDays       Int?
  lastPostFoalingHeatDate      DateTime?
  lastReadyForRebreeding       Boolean?
  lastRebredDate               DateTime?
  riskScore                    Int       @default(0)
  riskFactors                  String[]
  notes                        String?
  lastUpdatedFromPlanId        Int?
  lastUpdatedFromBreedYear     Int?
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt
  isBarren                     Boolean   @default(false)
  mare                         Animal    @relation(fields: [mareId], references: [id], onDelete: Cascade)
  tenant                       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([mareId])
  @@index([riskScore])
  @@schema("public")
}

model BreedingMilestone {
  id                 Int             @id @default(autoincrement())
  tenantId           Int
  breedingPlanId     Int
  milestoneType      MilestoneType
  scheduledDate      DateTime
  completedDate      DateTime?
  isCompleted        Boolean         @default(false)
  notificationSent   Boolean         @default(false)
  notificationSentAt DateTime?
  notes              String?
  vetAppointmentId   Int?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  offspringGroupId   Int?
  breedingPlan       BreedingPlan    @relation(fields: [breedingPlanId], references: [id], onDelete: Cascade)
  OffspringGroup     OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant             Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([breedingPlanId, scheduledDate])
  @@index([scheduledDate, isCompleted])
  @@schema("public")
}

model OffspringGroup {
  id                           Int                           @id @default(autoincrement())
  tenantId                     Int
  planId                       Int?                          @unique
  linkState                    OffspringLinkState            @default(linked)
  linkReason                   OffspringLinkReason?
  species                      Species
  damId                        Int?
  sireId                       Int?
  name                         String?
  expectedBirthOn              DateTime?
  actualBirthOn                DateTime?
  countBorn                    Int?
  countLive                    Int?
  countStillborn               Int?
  countMale                    Int?
  countFemale                  Int?
  countWeaned                  Int?
  countPlaced                  Int?
  weanedAt                     DateTime?
  placementStartAt             DateTime?
  placementCompletedAt         DateTime?
  coverImageUrl                String?
  themeName                    String?
  notes                        String?
  data                         Json?
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt
  listingSlug                  String?
  listingTitle                 String?
  listingDescription           String?
  marketplaceDefaultPriceCents Int?
  placementSchedulingPolicy    Json?
  archivedAt                   DateTime?
  deletedAt                    DateTime?
  status                       MarketplaceListingStatus      @default(DRAFT)
  depositRequired              Boolean                       @default(false)
  depositAmountCents           Int?
  lifecycleStatus              String                        @default("PENDING") @db.VarChar(30)
  expectedWeanedAt             DateTime?                     @db.Timestamptz(6)
  expectedPlacementStartAt     DateTime?                     @db.Timestamptz(6)
  expectedPlacementCompletedAt DateTime?                     @db.Timestamptz(6)
  completedAt                  DateTime?                     @db.Timestamptz(6)
  lockedPlacementStartDate     DateTime?                     @db.Timestamptz(6)
  AnimalsLegacy                Animal[]                      @relation("OffspringGroupPuppiesLegacy")
  Attachment                   Attachment[]
  BreedingMilestone            BreedingMilestone[]
  Campaign                     Campaign[]
  Contract                     Contract[]
  Document                     Document[]
  Expense                      Expense[]
  FeedingPlan                  FeedingPlan[]
  FeedingRecord                FeedingRecord[]
  FoodChange                   FoodChange[]
  Invoice                      Invoice[]
  Offspring                    Offspring[]                   @relation("GroupOffspring")
  dam                          Animal?                       @relation("OffspringDam", fields: [damId], references: [id], onDelete: Restrict)
  plan                         BreedingPlan?                 @relation(fields: [planId], references: [id])
  sire                         Animal?                       @relation("OffspringSire", fields: [sireId], references: [id])
  tenant                       Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  groupBuyerLinks              OffspringGroupBuyer[]         @relation("GroupBuyerGroup")
  Events                       OffspringGroupEvent[]
  rearingAssignments           RearingProtocolAssignment[]
  schedulingBlocks             SchedulingAvailabilityBlock[] @relation("GroupSchedulingBlocks")
  SupplementSchedule           SupplementSchedule[]
  Tags                         TagAssignment[]
  Task                         Task[]
  Waitlist                     WaitlistEntry[]

  @@unique([tenantId, listingSlug])
  @@index([tenantId])
  @@index([tenantId, species, expectedBirthOn])
  @@index([tenantId, damId, actualBirthOn])
  @@index([sireId])
  @@index([linkState])
  @@index([placementStartAt])
  @@index([placementCompletedAt])
  @@index([status])
  @@index([deletedAt])
  @@index([lifecycleStatus])
  @@schema("public")
}

model OffspringGroupBuyer {
  id                 Int            @id @default(autoincrement())
  tenantId           Int
  groupId            Int
  buyerPartyId       Int?
  waitlistEntryId    Int?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  placementRank      Int?
  buyerId            Int?
  stage              String         @default("PENDING") @db.VarChar(50)
  optedOutAt         DateTime?      @db.Timestamptz(6)
  optedOutReason     String?
  optedOutBy         String?        @db.VarChar(20)
  depositDisposition String?        @db.VarChar(30)
  notes              String?
  Invoice            Invoice?
  buyer              Buyer?         @relation("OffspringGroupBuyerCRM", fields: [buyerId], references: [id])
  buyerParty         Party?         @relation("OffspringGroupBuyerParty", fields: [buyerPartyId], references: [id])
  group              OffspringGroup @relation("GroupBuyerGroup", fields: [groupId], references: [id], onDelete: Cascade)
  tenant             Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  waitlistEntry      WaitlistEntry? @relation("GroupBuyerWaitlistEntry", fields: [waitlistEntryId], references: [id])

  @@unique([groupId, waitlistEntryId])
  @@index([tenantId])
  @@index([groupId])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([waitlistEntryId])
  @@index([buyerId])
  @@index([stage])
  @@schema("public")
}

model Offspring {
  id                       Int                           @id @default(autoincrement())
  tenantId                 Int
  groupId                  Int
  name                     String?
  species                  Species
  breed                    String?
  sex                      Sex?
  bornAt                   DateTime?
  diedAt                   DateTime?
  status                   OffspringStatus               @default(NEWBORN)
  lifeState                OffspringLifeState            @default(ALIVE)
  placementState           OffspringPlacementState       @default(UNASSIGNED)
  keeperIntent             OffspringKeeperIntent         @default(AVAILABLE)
  financialState           OffspringFinancialState       @default(NONE)
  paperworkState           OffspringPaperworkState       @default(NONE)
  damId                    Int?
  sireId                   Int?
  collarColorId            String?
  collarColorName          String?
  collarColorHex           String?
  collarAssignedAt         DateTime?
  collarLocked             Boolean                       @default(false)
  buyerPartyId             Int?
  priceCents               Int?
  depositCents             Int?
  contractId               String?
  contractSignedAt         DateTime?
  paidInFullAt             DateTime?
  pickupAt                 DateTime?
  placedAt                 DateTime?
  promotedAnimalId         Int?
  notes                    String?
  data                     Json?
  createdAt                DateTime                      @default(now())
  updatedAt                DateTime                      @updatedAt
  marketplaceListed        Boolean                       @default(false)
  marketplacePriceCents    Int?
  birthWeight              Float?
  color                    String?
  healthNotes              String?
  healthStatus             FoalHealthStatus              @default(HEALTHY)
  nursingMinutes           Int?
  nursingStatus            FoalNursingStatus             @default(UNKNOWN)
  requiredVetCare          Boolean                       @default(false)
  standingMinutes          Int?
  vetCareDetails           String?
  archiveReason            String?
  archivedAt               DateTime?
  birthWeightOz            Float?
  isExtraNeeds             Boolean                       @default(false)
  neonatalFeedingMethod    NeonatalFeedingMethod?
  neonatalHealthStatus     NeonatalHealthStatus?
  rearingCompletions       ActivityCompletion[]
  microchipRegistrations   AnimalMicrochipRegistration[] @relation("OffspringMicrochipRegistrations")
  rearingAssessments       AssessmentResult[]
  rearingOverrides         AssignmentOffspringOverride[]
  Attachments              Attachment[]
  CampaignAttribution      CampaignAttribution[]
  Contracts                Contract[]
  Documents                Document[]
  HealthLogs               HealthEvent[]
  Invoices                 Invoice[]
  NeonatalCareEntries      NeonatalCareEntry[]
  NeonatalInterventions    NeonatalIntervention[]
  buyerParty               Party?                        @relation("OffspringBuyerParty", fields: [buyerPartyId], references: [id])
  dam                      Animal?                       @relation("OffspringIndividualDam", fields: [damId], references: [id])
  group                    OffspringGroup                @relation("GroupOffspring", fields: [groupId], references: [id], onDelete: Cascade)
  promotedAnimal           Animal?                       @relation("PromotedAnimal", fields: [promotedAnimalId], references: [id])
  sire                     Animal?                       @relation("OffspringIndividualSire", fields: [sireId], references: [id])
  tenant                   Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  OffspringContract        OffspringContract[]
  OffspringDocument        OffspringDocument[]
  Events                   OffspringEvent[]
  InvoiceLinks             OffspringInvoiceLink[]
  rearingExceptions        OffspringProtocolException[]
  rearingCertificates      RearingCertificate[]
  rearingAssignments       RearingProtocolAssignment[]   @relation("OffspringProtocolAssignment")
  schedulingEventTemplates SchedulingEventTemplate[]
  Tags                     TagAssignment[]
  Tasks                    Task[]
  WaitlistAllocations      WaitlistEntry[]               @relation("WaitlistAllocationOffspring")

  @@index([tenantId])
  @@index([groupId])
  @@index([tenantId, status])
  @@index([tenantId, lifeState])
  @@index([tenantId, placementState])
  @@index([tenantId, keeperIntent])
  @@index([tenantId, financialState])
  @@index([tenantId, paperworkState])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([placedAt])
  @@index([tenantId, damId])
  @@index([tenantId, sireId])
  @@schema("public")
}

model OffspringEvent {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  offspringId      Int
  type             String
  occurredAt       DateTime
  field            String?
  before           Json?
  after            Json?
  notes            String?
  recordedByUserId String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  offspring        Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  recordedByUser   User?     @relation(fields: [recordedByUserId], references: [id])
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([offspringId, type, occurredAt])
  @@schema("public")
}

model NeonatalCareEntry {
  id                  Int                    @id @default(autoincrement())
  tenantId            Int
  offspringId         Int
  recordedAt          DateTime
  recordedBy          String?
  recordedById        String?
  weightOz            Decimal?               @db.Decimal(6, 2)
  weightChangePercent Decimal?               @db.Decimal(5, 2)
  temperatureF        Decimal?               @db.Decimal(4, 1)
  feedingMethod       NeonatalFeedingMethod?
  feedingVolumeMl     Decimal?               @db.Decimal(5, 1)
  feedingNotes        String?
  urinated            Boolean?
  stoolQuality        StoolQuality?
  activityLevel       ActivityLevel?
  notes               String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  offspring           Offspring              @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  recordedUser        User?                  @relation(fields: [recordedById], references: [id])
  tenant              Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, offspringId, recordedAt])
  @@index([offspringId, recordedAt])
  @@schema("public")
}

model NeonatalIntervention {
  id             Int                      @id @default(autoincrement())
  tenantId       Int
  offspringId    Int
  occurredAt     DateTime
  type           NeonatalInterventionType
  route          InterventionRoute?
  dose           String?
  administeredBy AdministeredBy?
  vetClinic      String?
  reason         String?
  response       InterventionResponse?
  followUpNeeded Boolean                  @default(false)
  followUpDate   DateTime?
  cost           Decimal?                 @db.Decimal(10, 2)
  notes          String?
  recordedById   String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  offspring      Offspring                @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  recordedUser   User?                    @relation(fields: [recordedById], references: [id])
  tenant         Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, offspringId, occurredAt])
  @@index([offspringId, type])
  @@schema("public")
}

/// *
/// * Legacy Litter retained
model Litter {
  id                   Int                      @id @default(autoincrement())
  tenantId             Int
  planId               Int                      @unique
  identifier           String?
  birthedStartAt       DateTime?
  birthedEndAt         DateTime?
  countBorn            Int?
  countLive            Int?
  countStillborn       Int?
  countMale            Int?
  countFemale          Int?
  countWeaned          Int?
  countPlaced          Int?
  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?
  statusOverride       String?
  statusOverrideReason String?
  coverImageUrl        String?
  themeName            String?
  notes                String?
  data                 Json?
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  marketplaceStatus    MarketplaceListingStatus @default(DRAFT)
  Animals              Animal[]
  Attachment           Attachment[]
  plan                 BreedingPlan             @relation(fields: [planId], references: [id], onDelete: Cascade)
  tenant               Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  Events               LitterEvent[]
  Waitlist             WaitlistEntry[]

  @@index([tenantId])
  @@index([tenantId, weanedAt])
  @@index([tenantId, placementStartAt])
  @@index([tenantId, placementCompletedAt])
  @@schema("public")
}

model WaitlistEntry {
  id                   Int                        @id @default(autoincrement())
  tenantId             Int
  planId               Int?
  litterId             Int?
  offspringGroupId     Int?
  clientPartyId        Int?
  speciesPref          Species?
  breedPrefs           Json?
  sirePrefId           Int?
  damPrefId            Int?
  status               WaitlistStatus             @default(INQUIRY)
  priority             Int?
  balanceInvoiceId     String?
  depositPaidAt        DateTime?
  depositRequiredCents Int?
  depositPaidCents     Int?
  balanceDueCents      Int?
  animalId             Int?
  offspringId          Int?
  skipCount            Int?
  lastSkipAt           DateTime?
  notes                String?
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  approvedAt           DateTime?
  rejectedAt           DateTime?
  rejectedReason       String?
  depositInvoiceId     Int?
  originPagePath       String?
  originProgramSlug    String?
  originReferrer       String?
  originSource         String?
  originUtmCampaign    String?
  originUtmMedium      String?
  originUtmSource      String?
  programId            Int?
  buyerId              Int?
  buyerPreferences     Json?                      @default("{}")
  planBuyerLinks       BreedingPlanBuyer[]
  contracts            Contract[]
  depositInvoice       Invoice?                   @relation("WaitlistDepositInvoice")
  groupBuyerLinks      OffspringGroupBuyer[]      @relation("GroupBuyerWaitlistEntry")
  TagAssignment        TagAssignment[]
  animal               Animal?                    @relation("WaitlistAllocation", fields: [animalId], references: [id])
  buyer                Buyer?                     @relation("WaitlistEntryCRM", fields: [buyerId], references: [id])
  clientParty          Party?                     @relation("WaitlistParty", fields: [clientPartyId], references: [id])
  damPref              Animal?                    @relation("WaitlistDamPref", fields: [damPrefId], references: [id])
  litter               Litter?                    @relation(fields: [litterId], references: [id])
  offspringGroup       OffspringGroup?            @relation(fields: [offspringGroupId], references: [id])
  offspring            Offspring?                 @relation("WaitlistAllocationOffspring", fields: [offspringId], references: [id])
  plan                 BreedingPlan?              @relation(fields: [planId], references: [id])
  program              MktListingBreedingProgram? @relation(fields: [programId], references: [id])
  sirePref             Animal?                    @relation("WaitlistSirePref", fields: [sirePrefId], references: [id])
  tenant               Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([planId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([programId])
  @@index([clientPartyId])
  @@index([tenantId, clientPartyId])
  @@index([tenantId, speciesPref])
  @@index([sirePrefId])
  @@index([damPrefId])
  @@index([animalId])
  @@index([tenantId, depositPaidAt])
  @@index([buyerId])
  @@schema("public")
}

model OffspringGroupEvent {
  id               Int            @id @default(autoincrement())
  tenantId         Int
  offspringGroupId Int
  type             String
  occurredAt       DateTime
  field            String?
  before           Json?
  after            Json?
  notes            String?
  recordedByUserId String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  offspringGroup   OffspringGroup @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  recordedByUser   User?          @relation(fields: [recordedByUserId], references: [id])
  tenant           Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([offspringGroupId, type, occurredAt])
  @@schema("public")
}

model LitterEvent {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  litterId         Int
  type             String
  occurredAt       DateTime
  field            String?
  before           Json?
  after            Json?
  notes            String?
  recordedByUserId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  litter           Litter   @relation(fields: [litterId], references: [id], onDelete: Cascade)
  recordedByUser   User?    @relation(fields: [recordedByUserId], references: [id])
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([litterId, type, occurredAt])
  @@schema("public")
}

model Attachment {
  id                Int                 @id @default(autoincrement())
  tenantId          Int
  planId            Int?
  animalId          Int?
  litterId          Int?
  offspringGroupId  Int?
  offspringId       Int?
  attachmentPartyId Int?
  invoiceId         Int?
  paymentId         Int?
  expenseId         Int?
  kind              String
  storageProvider   String
  storageKey        String
  filename          String
  mime              String
  bytes             Int
  createdByUserId   String?
  createdAt         DateTime            @default(now())
  animal            Animal?             @relation(fields: [animalId], references: [id])
  attachmentParty   Party?              @relation("AttachmentParty", fields: [attachmentPartyId], references: [id])
  createdByUser     User?               @relation(fields: [createdByUserId], references: [id])
  expense           Expense?            @relation("AttachmentExpense", fields: [expenseId], references: [id])
  invoice           Invoice?            @relation("AttachmentInvoice", fields: [invoiceId], references: [id])
  litter            Litter?             @relation(fields: [litterId], references: [id])
  offspringGroup    OffspringGroup?     @relation(fields: [offspringGroupId], references: [id])
  offspring         Offspring?          @relation(fields: [offspringId], references: [id])
  payment           Payment?            @relation("AttachmentPayment", fields: [paymentId], references: [id])
  plan              BreedingPlan?       @relation(fields: [planId], references: [id])
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  OffspringContract OffspringContract[]
  OffspringDocument OffspringDocument[]

  @@index([tenantId])
  @@index([planId])
  @@index([animalId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([attachmentPartyId])
  @@index([invoiceId])
  @@index([paymentId])
  @@index([expenseId])
  @@schema("public")
}

model PlanParty {
  id       Int          @id @default(autoincrement())
  tenantId Int
  planId   Int
  role     String
  partyId  Int?
  notes    String?
  party    Party?       @relation("PlanPartyRole", fields: [partyId], references: [id])
  plan     BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([planId])
  @@index([partyId])
  @@index([tenantId, partyId, role])
  @@schema("public")
}

model PlanCodeCounter {
  tenantId Int
  year     Int
  seq      Int    @default(0)
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, year])
  @@index([tenantId])
  @@schema("public")
}

model TenantSetting {
  tenantId  Int
  namespace String
  version   Int      @default(1)
  data      Json
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, namespace])
  @@index([tenantId])
  @@index([namespace])
  @@schema("public")
}

/// *
/// * Sequence counter for server-side numbering (invoice numbers, etc.)
/// * Tenant-scoped, per-year counter for generating unique sequential numbers
model Sequence {
  id         Int      @id @default(autoincrement())
  tenantId   Int
  key        String
  year       Int
  nextNumber Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key, year])
  @@index([tenantId, key, year])
  @@schema("public")
}

/// *
/// * IdempotencyKey for preventing duplicate operations
/// * Stores request hash and response for exact-match replay
model IdempotencyKey {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  key          String
  requestHash  String
  responseBody String?
  createdAt    DateTime @default(now())
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId, createdAt])
  @@schema("public")
}

model Invoice {
  id                       Int                    @id @default(autoincrement())
  tenantId                 Int
  scope                    FinanceScope
  groupId                  Int?
  offspringId              Int?
  clientPartyId            Int?
  animalId                 Int?
  breedingPlanId           Int?
  invoiceNumber            String
  number                   String?
  currency                 String                 @default("USD")
  amountCents              BigInt
  balanceCents             BigInt
  depositCents             BigInt?
  status                   InvoiceStatus          @default(draft)
  category                 InvoiceCategory        @default(OTHER)
  dueAt                    DateTime?
  issuedAt                 DateTime?
  paidAt                   DateTime?
  voidedAt                 DateTime?
  paymentTerms             String?
  externalProvider         String?
  externalId               String?
  syncedAt                 DateTime?
  lastSyncStatus           String?
  lastSyncError            String?
  notes                    String?
  data                     Json?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  waitlistEntryId          Int?                   @unique
  buyerMarkedPaidAt        DateTime?
  buyerPaymentMethod       String?
  buyerPaymentReference    String?
  deletedAt                DateTime?
  isMarketplaceInvoice     Boolean                @default(false)
  marketplaceTransactionId Int?
  paymentModeSnapshot      String?
  providerConfirmedAt      DateTime?
  providerConfirmedBy      Int?
  refundedCents            BigInt                 @default(0)
  stripeInvoiceId          String?
  stripePaymentIntentId    String?
  breedingPlanBuyerId      Int?                   @unique
  offspringGroupBuyerId    Int?                   @unique
  Attachments              Attachment[]           @relation("AttachmentInvoice")
  Contract                 Contract?
  Documents                Document?
  EmailSendLogs            EmailSendLog[]
  animal                   Animal?                @relation(fields: [animalId], references: [id])
  BreedingPlanBuyer        BreedingPlanBuyer?     @relation(fields: [breedingPlanBuyerId], references: [id])
  breedingPlan             BreedingPlan?          @relation(fields: [breedingPlanId], references: [id])
  clientParty              Party?                 @relation("InvoiceParty", fields: [clientPartyId], references: [id])
  group                    OffspringGroup?        @relation(fields: [groupId], references: [id])
  OffspringGroupBuyer      OffspringGroupBuyer?   @relation(fields: [offspringGroupBuyerId], references: [id])
  offspring                Offspring?             @relation(fields: [offspringId], references: [id])
  tenant                   Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  waitlistEntry            WaitlistEntry?         @relation("WaitlistDepositInvoice", fields: [waitlistEntryId], references: [id])
  LineItems                InvoiceLineItem[]
  OffspringInvoiceLink     OffspringInvoiceLink[]
  Payments                 Payment[]
  PaymentIntent            PaymentIntent[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([tenantId, clientPartyId, status])
  @@index([tenantId, offspringId])
  @@index([tenantId, groupId])
  @@index([tenantId, animalId])
  @@index([tenantId, breedingPlanId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status])
  @@index([clientPartyId])
  @@index([tenantId, status, createdAt(sort: Desc)])
  @@index([clientPartyId, status])
  @@index([deletedAt])
  @@index([tenantId, isMarketplaceInvoice, status])
  @@index([stripeInvoiceId])
  @@index([breedingPlanBuyerId])
  @@schema("public")
}

model InvoiceLineItem {
  id            Int          @id @default(autoincrement())
  tenantId      Int
  invoiceId     Int
  kind          LineItemKind @default(OTHER)
  description   String
  qty           Int          @default(1)
  unitCents     Int
  discountCents Int?
  taxRate       Float?
  category      String?
  itemCode      String?
  totalCents    Int
  createdAt     DateTime     @default(now())
  invoice       Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@schema("public")
}

model Payment {
  id               Int           @id @default(autoincrement())
  tenantId         Int
  invoiceId        Int
  status           PaymentStatus @default(pending)
  amountCents      BigInt
  receivedAt       DateTime
  methodType       String?
  processor        String?
  processorRef     String?
  method           String?
  reference        String?
  paidAt           DateTime?
  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?
  notes            String?
  data             Json?
  createdAt        DateTime      @default(now())
  Attachments      Attachment[]  @relation("AttachmentPayment")
  invoice          Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, invoiceId])
  @@index([tenantId, receivedAt])
  @@index([invoiceId])
  @@index([status])
  @@index([invoiceId, status])
  @@schema("public")
}

/// *
/// * Expense tracking for business operations
/// * Can be anchored to breeding plans, offspring groups, animals, or general operations
model Expense {
  id               Int             @id @default(autoincrement())
  tenantId         Int
  amountCents      Int
  currency         String          @default("USD")
  incurredAt       DateTime
  category         ExpenseCategory
  description      String?
  vendorPartyId    Int?
  breedingPlanId   Int?
  offspringGroupId Int?
  animalId         Int?
  notes            String?
  data             Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  foodProductId    Int?
  quantityUnit     String?
  quantityValue    Float?
  Attachments      Attachment[]    @relation("AttachmentExpense")
  animal           Animal?         @relation(fields: [animalId], references: [id])
  breedingPlan     BreedingPlan?   @relation(fields: [breedingPlanId], references: [id])
  foodProduct      FoodProduct?    @relation(fields: [foodProductId], references: [id])
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id])
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vendorParty      Party?          @relation("ExpenseVendor", fields: [vendorPartyId], references: [id])

  @@index([tenantId])
  @@index([tenantId, incurredAt])
  @@index([tenantId, breedingPlanId])
  @@index([tenantId, offspringGroupId])
  @@index([tenantId, animalId])
  @@index([tenantId, vendorPartyId])
  @@index([tenantId, category])
  @@index([tenantId, foodProductId])
  @@schema("public")
}

model AnimalOwnershipChange {
  id               Int                 @id @default(autoincrement())
  tenantId         Int
  animalId         Int
  kind             OwnershipChangeKind
  effectiveDate    DateTime?
  occurredAt       DateTime            @default(now())
  valueCents       Int?
  currency         String?             @db.VarChar(3)
  fromOwners       Json
  toOwners         Json
  fromOwnerParties Json?
  toOwnerParties   Json?
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  animal           Animal              @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant           Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents        Document[]
  PaymentIntent    PaymentIntent[]

  @@index([tenantId])
  @@index([animalId])
  @@index([kind])
  @@index([occurredAt])
  @@schema("public")
}

model PaymentIntent {
  id                Int                    @id @default(autoincrement())
  tenantId          Int
  invoiceId         Int?
  animalId          Int?
  ownershipChangeId Int?
  purpose           PaymentIntentPurpose
  status            PaymentIntentStatus    @default(PLANNED)
  amountCents       Int
  currency          String                 @db.VarChar(3)
  externalProvider  String?
  externalId        String?
  reference         String?
  data              Json?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  animal            Animal?                @relation(fields: [animalId], references: [id])
  invoice           Invoice?               @relation(fields: [invoiceId], references: [id])
  ownershipChange   AnimalOwnershipChange? @relation(fields: [ownershipChangeId], references: [id])
  tenant            Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@index([animalId])
  @@index([ownershipChangeId])
  @@index([status])
  @@index([purpose])
  @@schema("public")
}

model Campaign {
  id               Int                   @id @default(autoincrement())
  tenantId         Int
  offspringGroupId Int?
  name             String
  channel          CampaignChannel
  startedAt        DateTime?
  endedAt          DateTime?
  budgetCents      Int?
  spendCents       Int?
  impressions      Int?
  clicks           Int?
  inquiries        Int?
  reservations     Int?
  conversions      Int?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  notes            String?
  data             Json?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  group            OffspringGroup?       @relation(fields: [offspringGroupId], references: [id])
  tenant           Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  Attributions     CampaignAttribution[]

  @@index([tenantId])
  @@index([offspringGroupId])
  @@index([channel])
  @@schema("public")
}

model CampaignAttribution {
  id          Int        @id @default(autoincrement())
  tenantId    Int
  campaignId  Int
  offspringId Int?
  weight      Float?
  createdAt   DateTime   @default(now())
  campaign    Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  offspring   Offspring? @relation(fields: [offspringId], references: [id])
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([campaignId])
  @@index([offspringId])
  @@schema("public")
}

model Template {
  id               Int               @id @default(autoincrement())
  tenantId         Int
  name             String
  key              String?
  channel          TemplateChannel
  category         TemplateCategory
  status           TemplateStatus    @default(draft)
  description      String?
  createdByPartyId Int?
  lastUsedAt       DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  autoReplyRules   AutoReplyRule[]
  drafts           Draft[]           @relation("DraftTemplate")
  createdByParty   Party?            @relation("TemplateCreatedBy", fields: [createdByPartyId], references: [id])
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  content          TemplateContent[]

  @@unique([tenantId, key])
  @@index([tenantId, channel])
  @@index([tenantId, status])
  @@index([tenantId, category])
  @@schema("public")
}

model TemplateContent {
  id           Int      @id @default(autoincrement())
  templateId   Int
  subject      String?
  bodyText     String
  bodyHtml     String?
  metadataJson Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  template     Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@schema("public")
}

model AutoReplyRule {
  id                  Int                  @id @default(autoincrement())
  tenantId            Int
  channel             TemplateChannel
  enabled             Boolean              @default(true)
  templateId          Int
  triggerType         AutoReplyTriggerType
  cooldownMinutes     Int                  @default(60)
  businessHoursJson   Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  createdByPartyId    Int?
  description         String?
  executionCount      Int                  @default(0)
  keywordConfigJson   Json?
  lastExecutedAt      DateTime?
  name                String
  status              AutoReplyRuleStatus  @default(active)
  timeBasedConfigJson Json?
  logs                AutoReplyLog[]
  createdByParty      Party?               @relation("AutoReplyRuleCreatedBy", fields: [createdByPartyId], references: [id])
  template            Template             @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, channel, status])
  @@index([tenantId, triggerType])
  @@index([templateId])
  @@schema("public")
}

model AutoReplyLog {
  id         Int                @id @default(autoincrement())
  tenantId   Int
  channel    TemplateChannel
  partyId    Int
  threadId   Int?
  ruleId     Int?
  templateId Int?
  reason     String?
  createdAt  DateTime           @default(now())
  status     AutoReplyLogStatus
  party      Party              @relation("AutoReplyLogParty", fields: [partyId], references: [id], onDelete: Cascade)
  rule       AutoReplyRule?     @relation(fields: [ruleId], references: [id])
  tenant     Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  thread     MessageThread?     @relation(fields: [threadId], references: [id])

  @@index([tenantId, partyId])
  @@index([tenantId, channel, createdAt])
  @@index([threadId])
  @@index([ruleId])
  @@schema("public")
}

model EmailSendLog {
  id                Int                @id @default(autoincrement())
  tenantId          Int?
  to                String
  from              String
  subject           String
  templateKey       String?
  templateId        Int?
  category          EmailSendCategory?
  provider          String             @default("resend")
  providerMessageId String?
  relatedInvoiceId  Int?
  status            EmailSendStatus    @default(queued)
  error             Json?
  metadata          Json?
  createdAt         DateTime           @default(now())
  archived          Boolean            @default(false)
  archivedAt        DateTime?
  flagged           Boolean            @default(false)
  flaggedAt         DateTime?
  partyId           Int?
  retryCount        Int                @default(0)
  nextRetryAt       DateTime?          @db.Timestamptz(6)
  lastEventAt       DateTime?          @db.Timestamptz(6)
  deliveryEvents    Json?
  party             Party?             @relation("EmailSendLogParty", fields: [partyId], references: [id])
  invoice           Invoice?           @relation(fields: [relatedInvoiceId], references: [id])
  tenant            Tenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, templateKey, relatedInvoiceId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([providerMessageId])
  @@index([createdAt])
  @@index([relatedInvoiceId])
  @@index([templateId])
  @@index([tenantId, category])
  @@index([tenantId, archived])
  @@index([tenantId, flagged])
  @@index([tenantId, partyId])
  @@schema("public")
}

model MessageThread {
  id                        Int                       @id @default(autoincrement())
  tenantId                  Int
  subject                   String?
  archived                  Boolean                   @default(false)
  lastMessageAt             DateTime?
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime                  @updatedAt
  inquiryType               String?
  sourceListingSlug         String?
  guestEmail                String?
  guestName                 String?
  businessHoursResponseTime Int?
  firstInboundAt            DateTime?
  firstOrgReplyAt           DateTime?
  responseTimeSeconds       Int?
  flagged                   Boolean                   @default(false)
  flaggedAt                 DateTime?
  originPagePath            String?
  originReferrer            String?
  originSource              String?
  originUtmCampaign         String?
  originUtmMedium           String?
  originUtmSource           String?
  authenticationPass        Boolean?
  isQuarantined             Boolean                   @default(false)
  spamFlags                 String[]                  @default([])
  spamScore                 Int?                      @default(0)
  contextType               String?
  animalAccessConversation  AnimalAccessConversation? @relation("AnimalAccessConversationThread")
  autoReplyLogs             AutoReplyLog[]
  messages                  Message[]
  participants              MessageParticipant[]
  tenant                    Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  networkBreedingInquiry    NetworkBreedingInquiry?   @relation("NetworkBreedingInquiryThread")
  tagAssignments            TagAssignment[]

  @@index([tenantId])
  @@index([tenantId, updatedAt])
  @@index([inquiryType])
  @@index([tenantId, responseTimeSeconds])
  @@index([tenantId, businessHoursResponseTime])
  @@index([tenantId, flagged])
  @@index([tenantId, archived])
  @@schema("public")
}

model MessageParticipant {
  id         Int           @id @default(autoincrement())
  threadId   Int
  partyId    Int
  lastReadAt DateTime?
  createdAt  DateTime      @default(now())
  party      Party         @relation("MessageParticipantParty", fields: [partyId], references: [id], onDelete: Cascade)
  thread     MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, partyId])
  @@index([threadId])
  @@index([partyId])
  @@schema("public")
}

model Message {
  id                 Int           @id @default(autoincrement())
  threadId           Int
  senderPartyId      Int?
  body               String
  isAutomated        Boolean       @default(false)
  automationRuleId   Int?
  createdAt          DateTime      @default(now())
  attachmentBytes    Int?
  attachmentFilename String?
  attachmentKey      String?
  attachmentMime     String?
  senderParty        Party?        @relation("MessageSenderParty", fields: [senderPartyId], references: [id])
  thread             MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([senderPartyId])
  @@schema("public")
}

model Draft {
  id              Int             @id @default(autoincrement())
  tenantId        Int
  partyId         Int?
  channel         DraftChannel
  subject         String?
  toAddresses     String[]
  bodyText        String
  bodyHtml        String?
  templateId      Int?
  metadata        Json?
  createdByUserId String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdByUser   User?           @relation("DraftCreatedBy", fields: [createdByUserId], references: [id])
  party           Party?          @relation("DraftParty", fields: [partyId], references: [id])
  template        Template?       @relation("DraftTemplate", fields: [templateId], references: [id])
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tagAssignments  TagAssignment[]

  @@index([tenantId])
  @@index([tenantId, partyId])
  @@index([tenantId, channel])
  @@index([tenantId, updatedAt])
  @@schema("public")
}

model Task {
  id               Int             @id @default(autoincrement())
  tenantId         Int
  scope            TaskScope
  groupId          Int?
  offspringId      Int?
  title            String
  notes            String?
  dueAt            DateTime?
  status           TaskStatus      @default(open)
  assignedToUserId String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  assignedToUser   User?           @relation(fields: [assignedToUserId], references: [id])
  group            OffspringGroup? @relation(fields: [groupId], references: [id])
  offspring        Offspring?      @relation(fields: [offspringId], references: [id])
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status, dueAt])
  @@schema("public")
}

model HealthEvent {
  id               Int        @id @default(autoincrement())
  tenantId         Int
  offspringId      Int
  kind             HealthType
  occurredAt       DateTime
  weightGrams      Int?
  vaccineCode      String?
  dose             String?
  vetClinic        String?
  result           String?
  notes            String?
  data             Json?
  recordedByUserId String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  offspring        Offspring  @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  recordedByUser   User?      @relation(fields: [recordedByUserId], references: [id])
  tenant           Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([offspringId, occurredAt])
  @@index([kind])
  @@schema("public")
}

model Document {
  id                 Int                        @id @default(autoincrement())
  tenantId           Int
  scope              DocumentScope
  kind               DocumentKind               @default(generic)
  animalId           Int?
  ownershipChangeId  Int?
  offspringId        Int?
  groupId            Int?
  invoiceId          Int?                       @unique
  contractId         Int?
  title              String
  storageKey         String?
  externalUrl        String?
  mimeType           String?
  bytes              Int?
  sha256             String?
  data               Json?
  visibility         DocVisibility?             @default(PRIVATE)
  status             DocStatus?                 @default(PLACEHOLDER)
  sizeBytes          Int?
  originalFileName   String?
  storageProvider    String?
  bucket             String?
  objectKey          String?
  url                String?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  watermarkEnabled   Boolean                    @default(false)
  partyId            Int?
  titleLinks         AnimalTitleDocument[]
  traitEntries       AnimalTraitEntry[]
  traitValueLinks    AnimalTraitValueDocument[]
  competitionLinks   CompetitionEntryDocument[]
  animal             Animal?                    @relation(fields: [animalId], references: [id])
  contract           Contract?                  @relation(fields: [contractId], references: [id])
  group              OffspringGroup?            @relation(fields: [groupId], references: [id])
  invoice            Invoice?                   @relation(fields: [invoiceId], references: [id])
  offspring          Offspring?                 @relation(fields: [offspringId], references: [id])
  ownershipChange    AnimalOwnershipChange?     @relation(fields: [ownershipChangeId], references: [id])
  Party              Party?                     @relation(fields: [partyId], references: [id], onUpdate: NoAction)
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bundleItems        DocumentBundleItem[]
  TagAssignment      TagAssignment[]
  vaccinationRecords VaccinationRecord[]

  @@index([tenantId])
  @@index([scope, offspringId])
  @@index([scope, groupId])
  @@index([scope, invoiceId])
  @@index([scope, contractId])
  @@index([kind])
  @@index([partyId], map: "idx_Document_partyId")
  @@schema("public")
}

model DocumentBundle {
  id          Int                  @id @default(autoincrement())
  tenantId    Int
  name        String
  description String?
  status      BundleStatus         @default(active)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items       DocumentBundleItem[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@schema("public")
}

model DocumentBundleItem {
  id         Int            @id @default(autoincrement())
  bundleId   Int
  documentId Int
  sortOrder  Int            @default(0)
  addedAt    DateTime       @default(now())
  bundle     DocumentBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  document   Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([bundleId, documentId])
  @@index([bundleId])
  @@index([documentId])
  @@schema("public")
}

/// Track all document/media access events for audit trail
model MediaAccessEvent {
  id                Int              @id @default(autoincrement())
  createdAt         DateTime         @default(now())
  tenantId          Int
  documentId        Int?
  storageKey        String
  actorType         MediaAccessActor
  userId            String?          @db.VarChar(36)
  marketplaceUserId Int?
  partyId           Int?
  accessType        MediaAccessType
  ip                String?          @db.VarChar(45)
  userAgent         String?
  watermarked       Boolean          @default(false)
  watermarkHash     String?          @db.VarChar(32)
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([documentId])
  @@index([storageKey])
  @@schema("public")
}

/// Cache watermarked asset references to avoid re-processing
model WatermarkedAsset {
  id             Int      @id @default(autoincrement())
  tenantId       Int
  originalKey    String
  watermarkedKey String
  settingsHash   String   @db.VarChar(32)
  mimeType       String
  sizeBytes      Int
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, originalKey, settingsHash])
  @@index([expiresAt])
  @@schema("public")
}

model ContractTemplate {
  id                  Int                      @id @default(autoincrement())
  tenantId            Int?
  name                String
  body                String?
  storageKey          String?
  description         String?
  isActive            Boolean                  @default(true)
  data                Json?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  bodyHtml            String?
  bodyJson            Json?
  category            ContractTemplateCategory @default(CUSTOM)
  conditionalSections Json?
  createdByUserId     String?
  mergeFields         Json?
  slug                String?                  @unique
  type                ContractTemplateType     @default(CUSTOM)
  version             Int                      @default(1)
  Contract            Contract[]
  createdBy           User?                    @relation("ContractTemplateCreatedBy", fields: [createdByUserId], references: [id])
  tenant              Tenant?                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([category])
  @@index([isActive])
  @@schema("public")
}

model Contract {
  id                 Int               @id @default(autoincrement())
  tenantId           Int
  templateId         Int?
  offspringId        Int?
  groupId            Int?
  invoiceId          Int?              @unique
  title              String
  status             ContractStatus    @default(draft)
  provider           SignatureProvider @default(internal)
  providerEnvelopeId String?
  providerDocId      String?
  issuedAt           DateTime?
  signedAt           DateTime?
  voidedAt           DateTime?
  expiresAt          DateTime?
  data               Json?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  animalId           Int?
  waitlistEntryId    Int?
  animal             Animal?           @relation("ContractAnimal", fields: [animalId], references: [id])
  group              OffspringGroup?   @relation(fields: [groupId], references: [id])
  invoice            Invoice?          @relation(fields: [invoiceId], references: [id])
  offspring          Offspring?        @relation(fields: [offspringId], references: [id])
  template           ContractTemplate? @relation(fields: [templateId], references: [id])
  tenant             Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  waitlistEntry      WaitlistEntry?    @relation(fields: [waitlistEntryId], references: [id])
  content            ContractContent?
  parties            ContractParty[]
  documents          Document[]
  events             SignatureEvent[]

  @@index([tenantId])
  @@index([offspringId])
  @@index([groupId])
  @@index([animalId])
  @@index([waitlistEntryId])
  @@index([invoiceId])
  @@index([status])
  @@index([expiresAt])
  @@index([provider, providerEnvelopeId])
  @@schema("public")
}

model ContractParty {
  id                  Int              @id @default(autoincrement())
  tenantId            Int
  contractId          Int
  userId              String?
  partyId             Int?
  role                String?
  email               String?
  name                String?
  signer              Boolean          @default(true)
  order               Int?
  status              SignatureStatus  @default(pending)
  signedAt            DateTime?
  providerRecipientId String?
  data                Json?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  signatureData       Json?
  contract            Contract         @relation(fields: [contractId], references: [id], onDelete: Cascade)
  party               Party?           @relation("ContractPartyRole", fields: [partyId], references: [id])
  tenant              Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                User?            @relation(fields: [userId], references: [id])
  SignatureEvent      SignatureEvent[]

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([tenantId, partyId])
  @@index([status])
  @@schema("public")
}

model SignatureEvent {
  id         Int             @id @default(autoincrement())
  tenantId   Int
  contractId Int
  partyId    Int?
  status     SignatureStatus
  at         DateTime        @default(now())
  ipAddress  String?
  userAgent  String?
  message    String?
  data       Json?
  contract   Contract        @relation(fields: [contractId], references: [id], onDelete: Cascade)
  party      ContractParty?  @relation(fields: [partyId], references: [id])
  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([status, at])
  @@schema("public")
}

/// Immutable snapshot of rendered contract content at time of creation/sending
/// Ensures contract terms are preserved even if template changes later
model ContractContent {
  id              Int      @id @default(autoincrement())
  contractId      Int      @unique
  renderedHtml    String
  renderedPdfKey  String?
  mergeData       Json
  templateVersion Int
  createdAt       DateTime @default(now())
  contract        Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model OffspringDocument {
  id          Int            @id @default(autoincrement())
  tenantId    Int
  offspringId Int
  name        String
  templateId  String?
  provider    EsignProvider?
  status      EsignStatus    @default(DRAFT)
  sentAt      DateTime?
  viewedAt    DateTime?
  completedAt DateTime?
  fileId      Int?
  metaJson    Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  file        Attachment?    @relation(fields: [fileId], references: [id])
  offspring   Offspring      @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([offspringId])
  @@index([status])
  @@schema("public")
}

model OffspringContract {
  id           Int            @id @default(autoincrement())
  tenantId     Int
  offspringId  Int
  title        String
  version      String?
  provider     EsignProvider?
  status       EsignStatus    @default(DRAFT)
  sentAt       DateTime?
  viewedAt     DateTime?
  signedAt     DateTime?
  fileId       Int?
  buyerPartyId Int?
  metaJson     Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  buyerParty   Party?         @relation("OffspringContractBuyerParty", fields: [buyerPartyId], references: [id])
  file         Attachment?    @relation(fields: [fileId], references: [id])
  offspring    Offspring      @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([offspringId])
  @@index([buyerPartyId])
  @@index([tenantId, buyerPartyId])
  @@index([status])
  @@schema("public")
}

model OffspringInvoiceLink {
  id               Int         @id @default(autoincrement())
  tenantId         Int
  offspringId      Int
  invoiceId        Int?
  role             InvoiceRole @default(MISC)
  amountCents      Int?
  currency         String?
  externalProvider String?
  externalId       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  invoice          Invoice?    @relation(fields: [invoiceId], references: [id])
  offspring        Offspring   @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  tenant           Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([offspringId, invoiceId, role])
  @@index([tenantId])
  @@index([offspringId])
  @@index([invoiceId])
  @@schema("public")
}

model PortalAccess {
  id               Int                @id @default(autoincrement())
  partyId          Int                @unique
  status           PortalAccessStatus @default(NO_ACCESS)
  userId           String?
  invitedAt        DateTime?
  activatedAt      DateTime?
  suspendedAt      DateTime?
  lastLoginAt      DateTime?
  createdByUserId  String?
  updatedByUserId  String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  tenantId         Int
  membershipUserId String?
  createdBy        User?              @relation("PortalAccessCreatedBy", fields: [createdByUserId], references: [id])
  party            Party              @relation("PortalAccessParty", fields: [partyId], references: [id], onDelete: Cascade)
  tenant           Tenant             @relation("PortalAccessTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy        User?              @relation("PortalAccessUpdatedBy", fields: [updatedByUserId], references: [id])
  user             User?              @relation("PortalAccessUser", fields: [userId], references: [id])

  @@unique([tenantId, partyId])
  @@index([tenantId])
  @@index([partyId])
  @@index([userId])
  @@index([status])
  @@schema("public")
}

model PortalInvite {
  id               Int                    @id @default(autoincrement())
  tokenHash        String                 @unique
  expiresAt        DateTime
  sentAt           DateTime               @default(now())
  usedAt           DateTime?
  sentByUserId     String?
  createdAt        DateTime               @default(now())
  tenantId         Int
  partyId          Int
  emailNorm        String                 @db.Citext
  userId           String?
  roleToGrant      TenantMembershipRole   @default(CLIENT)
  statusToGrant    TenantMembershipStatus @default(ACTIVE)
  membershipUserId String?
  updatedAt        DateTime               @updatedAt
  party            Party                  @relation("PortalInviteParty", fields: [partyId], references: [id], onDelete: Cascade)
  sentBy           User?                  @relation("PortalInviteSentBy", fields: [sentByUserId], references: [id])
  tenant           Tenant                 @relation("PortalInviteTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  user             User?                  @relation("PortalInviteUser", fields: [userId], references: [id])

  @@index([tenantId, partyId])
  @@index([tenantId, emailNorm])
  @@index([expiresAt])
  @@schema("public")
}

model AuditEvent {
  id           Int                @id @default(autoincrement())
  createdAt    DateTime           @default(now())
  requestId    String?            @db.VarChar(64)
  ip           String?            @db.VarChar(45)
  userAgent    String?
  userId       String?            @db.VarChar(64)
  surface      AuditSurface
  actorContext AuditActorContext?
  tenantId     Int?
  action       String             @db.VarChar(64)
  outcome      AuditOutcome
  detailJson   Json?

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([tenantId, createdAt])
  @@index([action, createdAt])
  @@schema("public")
}

/// *
/// * SchedulingEventTemplate - Reusable event configuration
/// * Optional for MVP but provides future flexibility for recurring events
model SchedulingEventTemplate {
  id                        Int                           @id @default(autoincrement())
  tenantId                  Int
  name                      String
  eventType                 String
  description               String?
  status                    SchedulingEventStatus         @default(DRAFT)
  defaultDurationMinutes    Int                           @default(60)
  defaultCapacity           Int                           @default(1)
  canCancel                 Boolean                       @default(true)
  canReschedule             Boolean                       @default(true)
  cancellationDeadlineHours Int?
  rescheduleDeadlineHours   Int?
  nextStepsText             String?
  subjectType               String?
  offspringId               Int?
  createdByUserId           String?
  createdAt                 DateTime                      @default(now())
  updatedAt                 DateTime                      @updatedAt
  availabilityBlocks        SchedulingAvailabilityBlock[]
  offspring                 Offspring?                    @relation(fields: [offspringId], references: [id])
  tenant                    Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, eventType])
  @@index([offspringId])
  @@schema("public")
}

/// *
/// * SchedulingAvailabilityBlock - A time block containing multiple slots
/// * Represents a period during which the breeder is available for appointments
model SchedulingAvailabilityBlock {
  id                        Int                      @id @default(autoincrement())
  tenantId                  Int
  templateId                Int?
  startAt                   DateTime
  endAt                     DateTime
  timezone                  String                   @default("America/New_York") @db.VarChar(64)
  status                    SchedulingEventStatus    @default(OPEN)
  canCancel                 Boolean?
  canReschedule             Boolean?
  cancellationDeadlineHours Int?
  rescheduleDeadlineHours   Int?
  nextStepsText             String?
  location                  String?
  createdByUserId           String?
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
  offspringGroupId          Int?
  offspringGroup            OffspringGroup?          @relation("GroupSchedulingBlocks", fields: [offspringGroupId], references: [id])
  template                  SchedulingEventTemplate? @relation(fields: [templateId], references: [id])
  tenant                    Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slots                     SchedulingSlot[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startAt])
  @@index([templateId])
  @@index([offspringGroupId])
  @@schema("public")
}

/// *
/// * SchedulingSlot - Individual bookable time slot
model SchedulingSlot {
  id          Int                         @id @default(autoincrement())
  tenantId    Int
  blockId     Int
  startsAt    DateTime
  endsAt      DateTime
  capacity    Int                         @default(1)
  bookedCount Int                         @default(0)
  status      SchedulingSlotStatus        @default(AVAILABLE)
  mode        SchedulingSlotMode?
  location    String?
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  bookings    SchedulingBooking[]
  block       SchedulingAvailabilityBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)
  tenant      Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startsAt])
  @@index([blockId])
  @@index([blockId, startsAt])
  @@schema("public")
}

/// *
/// * SchedulingBooking - A confirmed booking for a slot
/// * Links a party (client) to a slot
model SchedulingBooking {
  id                Int                     @id @default(autoincrement())
  tenantId          Int
  slotId            Int
  partyId           Int
  eventId           String                  @db.VarChar(64)
  status            SchedulingBookingStatus @default(CONFIRMED)
  bookedAt          DateTime                @default(now())
  cancelledAt       DateTime?
  rescheduledAt     DateTime?
  clientNotes       String?
  breederNotes      String?
  nextSteps         String?
  rescheduledFromId Int?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  party             Party                   @relation("SchedulingBookingParty", fields: [partyId], references: [id], onDelete: Cascade)
  rescheduledFrom   SchedulingBooking?      @relation("RescheduledBooking", fields: [rescheduledFromId], references: [id])
  rescheduledTo     SchedulingBooking[]     @relation("RescheduledBooking")
  slot              SchedulingSlot          @relation(fields: [slotId], references: [id], onDelete: Cascade)
  tenant            Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([slotId, partyId])
  @@index([tenantId])
  @@index([tenantId, partyId])
  @@index([tenantId, eventId])
  @@index([slotId])
  @@index([partyId])
  @@index([eventId, partyId])
  @@index([status])
  @@schema("public")
}

/// *
/// * MarketplaceUserBlock - Per-tenant block records (breeder  marketplace user)
/// * Allows breeders to block marketplace users at different levels
model MarketplaceUserBlock {
  id               Int                   @id @default(autoincrement())
  tenantId         Int
  blockedUserId    String                @db.VarChar(36)
  level            MarketplaceBlockLevel
  reason           String?
  blockedByPartyId Int?
  createdAt        DateTime              @default(now())
  liftedAt         DateTime?
  liftedByPartyId  Int?
  blockedByParty   Party?                @relation("MarketplaceBlockCreator", fields: [blockedByPartyId], references: [id])
  blockedUser      User                  @relation("BlockedMarketplaceUser", fields: [blockedUserId], references: [id], onDelete: Cascade)
  liftedByParty    Party?                @relation("MarketplaceBlockLifter", fields: [liftedByPartyId], references: [id])
  tenant           Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, blockedUserId])
  @@index([blockedUserId])
  @@index([tenantId])
  @@index([tenantId, liftedAt])
  @@schema("public")
}

/// *
/// * MarketplaceUserFlag - Platform-level aggregation for admin visibility
/// * Tracks how many times a marketplace user has been blocked across all breeders
model MarketplaceUserFlag {
  id              Int       @id @default(autoincrement())
  userId          String    @unique @db.VarChar(36)
  totalBlocks     Int       @default(0)
  activeBlocks    Int       @default(0)
  lightBlocks     Int       @default(0)
  mediumBlocks    Int       @default(0)
  heavyBlocks     Int       @default(0)
  totalApprovals  Int       @default(0)
  totalRejections Int       @default(0)
  flaggedAt       DateTime?
  flagReason      String?
  suspendedAt     DateTime?
  suspendedReason String?
  updatedAt       DateTime  @updatedAt
  user            User      @relation("MarketplaceUserFlagUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([flaggedAt])
  @@index([suspendedAt])
  @@index([activeBlocks])
  @@schema("public")
}

/// *
/// * PlatformSetting - Configurable platform-wide settings
/// * Used for admin-configurable thresholds like blocklist thresholds
model PlatformSetting {
  id        Int      @id @default(autoincrement())
  namespace String   @unique @db.VarChar(64)
  data      Json
  updatedAt DateTime @updatedAt

  @@schema("public")
}

/// *
/// * BreederReport - Individual reports from marketplace users against breeders
/// * Reports require admin review before any action is taken
model BreederReport {
  id               Int                   @id @default(autoincrement())
  breederTenantId  Int
  reporterUserId   String                @db.VarChar(36)
  reason           BreederReportReason
  severity         BreederReportSeverity
  description      String?
  status           BreederReportStatus   @default(PENDING)
  adminNotes       String?
  reviewedByUserId String?
  reviewedAt       DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  breederTenant    Tenant                @relation("BreederReports", fields: [breederTenantId], references: [id], onDelete: Cascade)
  reporterUser     User                  @relation("BreederReportReporter", fields: [reporterUserId], references: [id], onDelete: Cascade)
  reviewedBy       User?                 @relation("BreederReportReviewedBy", fields: [reviewedByUserId], references: [id])

  @@index([breederTenantId])
  @@index([reporterUserId])
  @@index([status])
  @@index([createdAt])
  @@schema("public")
}

/// *
/// * BreederReportFlag - Platform-level aggregation for admin visibility
/// * Tracks report counts per breeder for flagging and admin review
model BreederReportFlag {
  id                     Int       @id @default(autoincrement())
  breederTenantId        Int       @unique
  totalReports           Int       @default(0)
  pendingReports         Int       @default(0)
  lightReports           Int       @default(0)
  mediumReports          Int       @default(0)
  heavyReports           Int       @default(0)
  flaggedAt              DateTime?
  flagReason             String?
  warningIssuedAt        DateTime?
  warningNote            String?
  marketplaceSuspendedAt DateTime?
  suspendedReason        String?
  updatedAt              DateTime  @updatedAt
  breederTenant          Tenant    @relation("BreederReportFlag", fields: [breederTenantId], references: [id], onDelete: Cascade)

  @@index([flaggedAt])
  @@index([marketplaceSuspendedAt])
  @@index([pendingReports])
  @@schema("public")
}

/// *
/// * GeneticsDisclaimerAcceptance - Genetics Lab disclaimer acceptance records
/// * Stores acceptance of genetics calculator disclaimers for legal protection.
model GeneticsDisclaimerAcceptance {
  id         Int      @id @default(autoincrement())
  userId     String
  acceptedAt DateTime @default(now())
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
}

/// *
/// * GlobalAnimalIdentity - A canonical identity cluster for an animal across all tenants
/// * When we're confident animals across tenants are the same individual, they share one of these.
model GlobalAnimalIdentity {
  id             Int                      @id @default(autoincrement())
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  species        Species
  sex            Sex?
  birthDate      DateTime?
  name           String?
  damId          Int?
  sireId         Int?
  gaid           String?                  @unique
  linkedAnimals  AnimalIdentityLink[]
  identifiers    GlobalAnimalIdentifier[]
  dam            GlobalAnimalIdentity?    @relation("GlobalDam", fields: [damId], references: [id])
  childrenAsDam  GlobalAnimalIdentity[]   @relation("GlobalDam")
  sire           GlobalAnimalIdentity?    @relation("GlobalSire", fields: [sireId], references: [id])
  childrenAsSire GlobalAnimalIdentity[]   @relation("GlobalSire")

  @@index([species])
  @@index([damId])
  @@index([sireId])
  @@schema("public")
}

/// *
/// * GlobalAnimalIdentifier - A unique identifier attached to a global identity
/// * Multiple identifiers can point to the same GlobalAnimalIdentity
model GlobalAnimalIdentifier {
  id             Int                  @id @default(autoincrement())
  identityId     Int
  type           IdentifierType
  value          String
  rawValue       String?
  confidence     Float                @default(1.0)
  verifiedAt     DateTime?
  verifiedBy     String?
  sourceTenantId Int?
  createdAt      DateTime             @default(now())
  identity       GlobalAnimalIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)
  sourceTenant   Tenant?              @relation(fields: [sourceTenantId], references: [id])

  @@unique([type, value])
  @@index([identityId])
  @@index([type, value])
  @@schema("public")
}

/// *
/// * AnimalIdentityLink - Links a tenant's local Animal record to a GlobalAnimalIdentity
/// * This is how we know "Animal #123 in Tenant A" is the same as "Animal #456 in Tenant B"
model AnimalIdentityLink {
  id              Int                  @id @default(autoincrement())
  createdAt       DateTime             @default(now())
  animalId        Int                  @unique
  identityId      Int
  confidence      Float                @default(1.0)
  matchedOn       String[]
  autoMatched     Boolean              @default(false)
  confirmedAt     DateTime?
  confirmedByUser String?
  animal          Animal               @relation(fields: [animalId], references: [id], onDelete: Cascade)
  identity        GlobalAnimalIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@index([identityId])
  @@schema("public")
}

/// *
/// * AnimalPrivacySettings - Per-animal controls over what's shared cross-tenant
/// * Owner of the animal (tenant) controls visibility of their animal's data
model AnimalPrivacySettings {
  id                       Int      @id @default(autoincrement())
  animalId                 Int      @unique
  updatedAt                DateTime @updatedAt
  allowCrossTenantMatching Boolean  @default(true)
  showName                 Boolean  @default(true)
  showPhoto                Boolean  @default(true)
  showFullDob              Boolean  @default(true)
  showRegistryFull         Boolean  @default(false)
  showBreeder              Boolean  @default(true)
  allowInfoRequests        Boolean  @default(true)
  allowDirectContact       Boolean  @default(false)
  showCompetitionDetails   Boolean  @default(false)
  showCompetitions         Boolean  @default(false)
  showTitleDetails         Boolean  @default(false)
  showTitles               Boolean  @default(true)
  enableDocumentSharing    Boolean  @default(false)
  enableGeneticsSharing    Boolean  @default(false)
  enableHealthSharing      Boolean  @default(false)
  enableMediaSharing       Boolean  @default(false)
  showBreedingHistory      Boolean  @default(false)
  vaccinationVisibility    Json?    @default("{}")
  animal                   Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@schema("public")
}

/// *
/// * AnimalLinkRequest - Request from one breeder to link their animal's parent to another breeder's animal
/// * Workflow: Create Request  Target Breeder Approves/Denies  Active Link Created
model AnimalLinkRequest {
  id                      Int                    @id @default(autoincrement())
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  requestingTenantId      Int
  requestingUserId        String
  sourceAnimalId          Int
  relationshipType        ParentType
  targetAnimalId          Int?
  targetGaid              String?
  targetExchangeCode      String?
  targetRegistryId        Int?
  targetRegistryNum       String?
  targetTenantId          Int?
  message                 String?
  status                  LinkRequestStatus      @default(PENDING)
  respondedAt             DateTime?
  responseMessage         String?
  denialReason            String?
  confirmedTargetAnimalId Int?
  requestingTenant        Tenant                 @relation("LinkRequestFrom", fields: [requestingTenantId], references: [id], onDelete: Cascade)
  requestingUser          User                   @relation("LinkRequestFromUser", fields: [requestingUserId], references: [id], onDelete: Cascade)
  sourceAnimal            Animal                 @relation("LinkSource", fields: [sourceAnimalId], references: [id], onDelete: Cascade)
  targetAnimal            Animal?                @relation("LinkTarget", fields: [targetAnimalId], references: [id])
  targetTenant            Tenant?                @relation("LinkRequestTo", fields: [targetTenantId], references: [id])
  resultingLink           CrossTenantAnimalLink?

  @@index([requestingTenantId])
  @@index([targetTenantId])
  @@index([targetAnimalId])
  @@index([sourceAnimalId])
  @@index([status])
  @@schema("public")
}

/// *
/// * CrossTenantAnimalLink - An active link between a child animal and a parent animal across tenants
/// * Created when a link request is approved
model CrossTenantAnimalLink {
  id               Int                @id @default(autoincrement())
  createdAt        DateTime           @default(now())
  childAnimalId    Int
  childTenantId    Int
  parentAnimalId   Int
  parentTenantId   Int
  parentType       ParentType
  linkRequestId    Int?               @unique
  linkMethod       LinkMethod
  active           Boolean            @default(true)
  revokedAt        DateTime?
  revokedBy        RevokedBy?
  revocationReason String?
  childAnimal      Animal             @relation("LinkedChild", fields: [childAnimalId], references: [id], onDelete: Cascade)
  childTenant      Tenant             @relation("LinkChildTenant", fields: [childTenantId], references: [id], onDelete: Cascade)
  linkRequest      AnimalLinkRequest? @relation(fields: [linkRequestId], references: [id])
  parentAnimal     Animal             @relation("LinkedParent", fields: [parentAnimalId], references: [id], onDelete: Cascade)
  parentTenant     Tenant             @relation("LinkParentTenant", fields: [parentTenantId], references: [id], onDelete: Cascade)

  @@unique([childAnimalId, parentType])
  @@index([parentAnimalId])
  @@index([childTenantId])
  @@index([parentTenantId])
  @@index([active])
  @@schema("public")
}

/// *
/// * TitleDefinition - Defines available titles (global or tenant-specific)
/// * Global titles (tenantId=null) are seeded for common registries (AKC, UKC, etc.)
/// * Tenants can create custom titles for breed clubs or internal awards
model TitleDefinition {
  id               Int               @id @default(autoincrement())
  tenantId         Int?
  species          Species
  abbreviation     String
  fullName         String
  category         TitleCategory
  organization     String?
  parentTitleId    Int?
  pointsRequired   Int?
  description      String?
  isProducingTitle Boolean           @default(false)
  prefixTitle      Boolean           @default(true)
  suffixTitle      Boolean           @default(false)
  displayOrder     Int               @default(0)
  createdAt        DateTime          @default(now())
  animalTitles     AnimalTitle[]
  parentTitle      TitleDefinition?  @relation("TitleHierarchy", fields: [parentTitleId], references: [id])
  childTitles      TitleDefinition[] @relation("TitleHierarchy")
  tenant           Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([species, abbreviation, organization, tenantId])
  @@index([species])
  @@index([category])
  @@index([tenantId])
  @@schema("public")
}

/// *
/// * AnimalTitle - A title earned by a specific animal
model AnimalTitle {
  id                Int                   @id @default(autoincrement())
  tenantId          Int
  animalId          Int
  titleDefinitionId Int
  dateEarned        DateTime?
  status            TitleStatus           @default(EARNED)
  pointsEarned      Float?
  majorWins         Int?
  verified          Boolean               @default(false)
  verifiedAt        DateTime?
  verifiedBy        String?
  registryRef       String?
  notes             String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  eventLocation     String?
  eventName         String?
  handlerName       String?
  isPublic          Boolean               @default(false)
  animal            Animal                @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  titleDefinition   TitleDefinition       @relation(fields: [titleDefinitionId], references: [id])
  documents         AnimalTitleDocument[]

  @@unique([animalId, titleDefinitionId])
  @@index([tenantId])
  @@index([animalId])
  @@index([status])
  @@index([isPublic])
  @@schema("public")
}

/// *
/// * AnimalTitleDocument - Links documents to animal titles
model AnimalTitleDocument {
  id            Int         @id @default(autoincrement())
  animalTitleId Int
  documentId    Int
  animalTitle   AnimalTitle @relation(fields: [animalTitleId], references: [id], onDelete: Cascade)
  document      Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([animalTitleId, documentId])
  @@schema("public")
}

/// *
/// * CompetitionEntry - Individual competition/show entries
/// * Tracks placements, points, and results for performance analysis
model CompetitionEntry {
  id               Int                        @id @default(autoincrement())
  tenantId         Int
  animalId         Int
  eventName        String
  eventDate        DateTime
  location         String?
  organization     String?
  competitionType  CompetitionType
  className        String?
  placement        Int?
  placementLabel   String?
  pointsEarned     Float?
  isMajorWin       Boolean                    @default(false)
  qualifyingScore  Boolean                    @default(false)
  score            Float?
  scoreMax         Float?
  judgeName        String?
  notes            String?
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  distanceFurlongs Float?
  distanceMeters   Int?
  finishTime       String?
  handlerName      String?
  prizeMoneyCents  Int?
  raceGrade        String?
  speedFigure      Int?
  trackName        String?
  trackSurface     String?
  trainerName      String?
  isPublic         Boolean                    @default(false)
  animal           Animal                     @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant           Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents        CompetitionEntryDocument[]

  @@index([tenantId])
  @@index([animalId])
  @@index([eventDate])
  @@index([competitionType])
  @@index([isPublic])
  @@schema("public")
}

/// *
/// * CompetitionEntryDocument - Links documents to competition entries
model CompetitionEntryDocument {
  id                 Int              @id @default(autoincrement())
  competitionEntryId Int
  documentId         Int
  competitionEntry   CompetitionEntry @relation(fields: [competitionEntryId], references: [id], onDelete: Cascade)
  document           Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([competitionEntryId, documentId])
  @@schema("public")
}

/// *
/// * ContactChangeRequest - Tracks name change requests from clients
/// * (firstName, lastName, nickname require breeder approval)
model ContactChangeRequest {
  id             Int                 @id @default(autoincrement())
  tenantId       Int
  contactId      Int
  fieldName      String
  oldValue       String?
  newValue       String
  status         ChangeRequestStatus @default(PENDING)
  requestedAt    DateTime            @default(now())
  requestedBy    String?
  resolvedAt     DateTime?
  resolvedBy     String?
  resolutionNote String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  contact        Contact             @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tenant         Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([contactId])
  @@schema("public")
}

/// *
/// * EmailChangeRequest - Tracks email change requests with verification
model EmailChangeRequest {
  id                Int               @id @default(autoincrement())
  tenantId          Int
  contactId         Int
  oldEmail          String?
  newEmail          String
  verificationToken String            @unique @default(cuid())
  verifiedAt        DateTime?
  status            EmailChangeStatus @default(PENDING_VERIFICATION)
  requestedAt       DateTime          @default(now())
  expiresAt         DateTime
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  contact           Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contactId])
  @@index([verificationToken])
  @@schema("public")
}

model MarketplaceUser {
  id                              Int                                  @id @default(autoincrement())
  email                           String                               @unique
  emailVerified                   Boolean                              @default(false) @map("email_verified")
  passwordHash                    String                               @map("password_hash")
  firstName                       String?                              @map("first_name")
  lastName                        String?                              @map("last_name")
  phone                           String?
  userType                        String                               @default("buyer") @map("user_type")
  tenantId                        Int?                                 @map("tenant_id")
  tenantVerified                  Boolean                              @default(false) @map("tenant_verified")
  stripeCustomerId                String?                              @unique @map("stripe_customer_id")
  status                          String                               @default("active")
  createdAt                       DateTime                             @default(now()) @map("created_at")
  updatedAt                       DateTime                             @updatedAt @map("updated_at")
  addressLine1                    String?                              @map("address_line1")
  addressLine2                    String?                              @map("address_line2")
  city                            String?
  country                         String?                              @default("US")
  deletedAt                       DateTime?                            @map("deleted_at")
  emailVerifyExpires              DateTime?                            @map("email_verify_expires")
  emailVerifyToken                String?                              @unique @map("email_verify_token")
  lastLoginAt                     DateTime?                            @map("last_login_at")
  passwordResetExpires            DateTime?                            @map("password_reset_expires")
  passwordResetToken              String?                              @unique @map("password_reset_token")
  state                           String?
  suspendedAt                     DateTime?                            @map("suspended_at")
  suspendedReason                 String?                              @map("suspended_reason")
  zip                             String?
  acceptsPaymentsBadge            Boolean                              @default(false) @map("accepts_payments_badge")
  accreditedProviderApprovedAt    DateTime?                            @map("accredited_provider_approved_at")
  accreditedProviderApprovedBy    Int?                                 @map("accredited_provider_approved_by")
  accreditedProviderExpiresAt     DateTime?                            @map("accredited_provider_expires_at")
  accreditedProviderPurchasedAt   DateTime?                            @map("accredited_provider_purchased_at")
  establishedProviderBadge        Boolean                              @default(false) @map("established_provider_badge")
  identityVerifiedAt              DateTime?                            @map("identity_verified_at")
  passkeyCounter                  Int?                                 @map("passkey_counter")
  passkeyCreatedAt                DateTime?                            @map("passkey_created_at")
  passkeyCredentialId             String?                              @map("passkey_credential_id")
  passkeyPublicKey                Bytes?                               @map("passkey_public_key")
  quickResponderBadge             Boolean                              @default(false) @map("quick_responder_badge")
  serviceProviderTier             ServiceProviderVerificationTier?     @map("service_provider_tier")
  serviceProviderTierAchievedAt   DateTime?                            @map("service_provider_tier_achieved_at")
  smsPhoneNumber                  String?                              @map("sms_phone_number")
  smsVerificationToken            String?                              @map("sms_verification_token")
  smsVerificationTokenExpires     DateTime?                            @map("sms_verification_token_expires")
  smsVerifiedAt                   DateTime?                            @map("sms_verified_at")
  stripeIdentitySessionId         String?                              @map("stripe_identity_session_id")
  stripeIdentityStatus            String?                              @map("stripe_identity_status")
  topRatedBadge                   Boolean                              @default(false) @map("top_rated_badge")
  totpSecret                      String?                              @map("totp_secret")
  totpVerifiedAt                  DateTime?                            @map("totp_verified_at")
  trustedProviderBadge            Boolean                              @default(false) @map("trusted_provider_badge")
  twoFactorEnabled                Boolean                              @default(false) @map("two_factor_enabled")
  twoFactorEnabledAt              DateTime?                            @map("two_factor_enabled_at")
  twoFactorMethod                 TwoFactorMethod?                     @map("two_factor_method")
  verifiedProfessionalApprovedAt  DateTime?                            @map("verified_professional_approved_at")
  verifiedProfessionalApprovedBy  Int?                                 @map("verified_professional_approved_by")
  verifiedProfessionalExpiresAt   DateTime?                            @map("verified_professional_expires_at")
  verifiedProfessionalPurchasedAt DateTime?                            @map("verified_professional_purchased_at")
  passkeyChallenge                String?                              @map("passkey_challenge")
  passkeyChallengeExpires         DateTime?                            @map("passkey_challenge_expires")
  clientInvoices                  MarketplaceInvoice[]                 @relation("ClientInvoices")
  clientThreads                   MarketplaceMessageThread[]           @relation("ClientThreads")
  sentMessages                    MarketplaceMessage[]
  mobileRefreshTokens             MarketplaceMobileRefreshToken[]
  providerTermsAcceptances        MarketplaceProviderTermsAcceptance[] @relation("ProviderTermsAcceptances")
  provider                        MarketplaceProvider?
  reviews                         MarketplaceReview[]                  @relation("ReviewsByClient")
  clientTransactions              MarketplaceTransaction[]             @relation("ClientTransactions")
  verificationRequests            VerificationRequest[]                @relation("UserVerificationRequests")

  @@index([email])
  @@index([tenantId])
  @@index([stripeCustomerId])
  @@index([deletedAt])
  @@index([status])
  @@index([twoFactorEnabled])
  @@index([serviceProviderTier])
  @@map("users")
  @@schema("marketplace")
}

model MarketplaceProvider {
  id                              Int                         @id @default(autoincrement())
  userId                          Int                         @unique @map("user_id")
  providerType                    String                      @map("provider_type")
  tenantId                        Int?                        @map("tenant_id")
  businessName                    String                      @map("business_name")
  businessDescription             String?                     @map("business_description")
  city                            String?
  state                           String?
  stripeConnectAccountId          String?                     @unique @map("stripe_connect_account_id")
  stripeConnectOnboardingComplete Boolean                     @default(false) @map("stripe_connect_onboarding_complete")
  stripeConnectPayoutsEnabled     Boolean                     @default(false) @map("stripe_connect_payouts_enabled")
  paymentMode                     String                      @default("manual") @map("payment_mode")
  paymentInstructions             String?                     @map("payment_instructions")
  totalListings                   Int                         @default(0) @map("total_listings")
  totalTransactions               Int                         @default(0) @map("total_transactions")
  totalRevenueCents               BigInt                      @default(0) @map("total_revenue_cents")
  averageRating                   Decimal                     @default(0.00) @map("average_rating") @db.Decimal(3, 2)
  status                          String                      @default("pending")
  createdAt                       DateTime                    @default(now()) @map("created_at")
  updatedAt                       DateTime                    @updatedAt @map("updated_at")
  activatedAt                     DateTime?                   @map("activated_at")
  activeListings                  Int                         @default(0) @map("active_listings")
  businessHours                   Json?                       @map("business_hours")
  completedTransactions           Int                         @default(0) @map("completed_transactions")
  country                         String?                     @default("US")
  coverImageUrl                   String?                     @map("cover_image_url")
  deletedAt                       DateTime?                   @map("deleted_at")
  lifetimePayoutCents             BigInt                      @default(0) @map("lifetime_payout_cents")
  logoUrl                         String?                     @map("logo_url")
  premiumProvider                 Boolean                     @default(false) @map("premium_provider")
  publicEmail                     String?                     @map("public_email")
  publicPhone                     String?                     @map("public_phone")
  quickResponder                  Boolean                     @default(false) @map("quick_responder")
  stripeConnectDetailsSubmitted   Boolean                     @default(false) @map("stripe_connect_details_submitted")
  suspendedAt                     DateTime?                   @map("suspended_at")
  suspendedReason                 String?                     @map("suspended_reason")
  timeZone                        String?                     @default("America/New_York") @map("time_zone")
  totalReviews                    Int                         @default(0) @map("total_reviews")
  verifiedProvider                Boolean                     @default(false) @map("verified_provider")
  website                         String?
  zip                             String?
  latitude                        Decimal?                    @map("latitude") @db.Decimal(10, 8)
  longitude                       Decimal?                    @map("longitude") @db.Decimal(11, 8)
  accreditedPackageApprovedAt     DateTime?                   @map("accredited_package_approved_at")
  accreditedPackageApprovedBy     Int?                        @map("accredited_package_approved_by")
  accreditedPackageExpiresAt      DateTime?                   @map("accredited_package_expires_at")
  accreditedPackagePurchasedAt    DateTime?                   @map("accredited_package_purchased_at")
  establishedBadge                Boolean                     @default(false) @map("established_badge")
  establishedBadgeEarnedAt        DateTime?                   @map("established_badge_earned_at")
  identityVerifiedAt              DateTime?                   @map("identity_verified_at")
  phoneVerificationToken          String?                     @map("phone_verification_token")
  phoneVerificationTokenExpires   DateTime?                   @map("phone_verification_token_expires")
  phoneVerifiedAt                 DateTime?                   @map("phone_verified_at")
  stripeIdentitySessionId         String?                     @map("stripe_identity_session_id")
  stripeIdentityStatus            String?                     @map("stripe_identity_status")
  topRatedBadge                   Boolean                     @default(false) @map("top_rated_badge")
  topRatedBadgeEarnedAt           DateTime?                   @map("top_rated_badge_earned_at")
  trustedBadge                    Boolean                     @default(false) @map("trusted_badge")
  trustedBadgeEarnedAt            DateTime?                   @map("trusted_badge_earned_at")
  verificationTier                BreederVerificationTier     @default(SUBSCRIBER) @map("verification_tier")
  verificationTierAchievedAt      DateTime?                   @map("verification_tier_achieved_at")
  verifiedPackageApprovedAt       DateTime?                   @map("verified_package_approved_at")
  verifiedPackageApprovedBy       Int?                        @map("verified_package_approved_by")
  verifiedPackageExpiresAt        DateTime?                   @map("verified_package_expires_at")
  verifiedPackagePurchasedAt      DateTime?                   @map("verified_package_purchased_at")
  listingFeeExempt                Boolean                     @default(true) @map("listing_fee_exempt")
  listingFeeExemptUntil           DateTime?                   @map("listing_fee_exempt_until")
  listingTier                     String?                     @map("listing_tier")
  maxActiveListings               Int?                        @map("max_active_listings")
  flagReason                      String?                     @map("flag_reason")
  flaggedAt                       DateTime?                   @map("flagged_at")
  providerInvoices                MarketplaceInvoice[]        @relation("ProviderInvoices")
  providerThreads                 MarketplaceMessageThread[]  @relation("ProviderThreads")
  unifiedListings                 MktListingBreederService[]
  reports                         MarketplaceProviderReport[] @relation("ProviderReports")
  user                            MarketplaceUser             @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews                         MarketplaceReview[]         @relation("ReviewsForProvider")
  providerTransactions            MarketplaceTransaction[]    @relation("ProviderTransactions")
  verificationRequests            VerificationRequest[]       @relation("ProviderVerificationRequests")

  @@index([userId])
  @@index([tenantId])
  @@index([stripeConnectAccountId])
  @@index([status, activatedAt])
  @@index([city, state, status])
  @@index([deletedAt])
  @@index([verificationTier])
  @@index([flaggedAt])
  @@map("providers")
  @@schema("marketplace")
}

/// *
/// * MarketplaceProviderTermsAcceptance - Records provider service agreement acceptance
/// * for legal compliance and audit trail. Server-side timestamp ensures integrity.
/// * Follows same pattern as TosAcceptance but specific to marketplace provider terms.
model MarketplaceProviderTermsAcceptance {
  id         Int             @id @default(autoincrement())
  userId     Int             @map("user_id")
  /// Terms version accepted (e.g., "1.0", "1.1", "2.0")
  version    String          @db.VarChar(16)
  /// Server-stamped timestamp for audit integrity (B-08 compliance)
  acceptedAt DateTime        @default(now()) @map("accepted_at")
  /// IP address at time of acceptance (IPv6 compatible)
  ipAddress  String?         @map("ip_address") @db.VarChar(45)
  /// User agent string at time of acceptance
  userAgent  String?         @map("user_agent")
  user       MarketplaceUser @relation("ProviderTermsAcceptances", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, version])
  @@index([userId])
  @@index([version])
  @@index([acceptedAt])
  @@map("provider_terms_acceptance")
  @@schema("marketplace")
}

/// *
/// * MarketplaceProviderReport - User reports against service providers
/// * Allows marketplace users to report providers for fraud, harassment, spam, etc.
/// * Auto-flags providers when 3+ pending reports are received.
model MarketplaceProviderReport {
  id                   Int                 @id @default(autoincrement())
  providerId           Int                 @map("provider_id")
  reporterUserId       String              @map("reporter_user_id") @db.VarChar(36)
  reporterEmail        String?             @map("reporter_email")
  reason               String
  severity             String
  details              String?
  relatedListingIds    Int[]               @default([]) @map("related_listing_ids")
  relatedTransactionId BigInt?             @map("related_transaction_id")
  status               String              @default("pending")
  adminNotes           String?             @map("admin_notes")
  reviewedAt           DateTime?           @map("reviewed_at")
  reviewedBy           Int?                @map("reviewed_by")
  createdAt            DateTime            @default(now()) @map("created_at")
  provider             MarketplaceProvider @relation("ProviderReports", fields: [providerId], references: [id], onDelete: Cascade)
  reporter             User                @relation("UserProviderReports", fields: [reporterUserId], references: [id], onDelete: Cascade)

  @@index([providerId, status])
  @@index([reporterUserId])
  @@index([status, createdAt])
  @@map("provider_reports")
  @@schema("marketplace")
}

/// *
/// * VerificationRequest - Staff queue for processing paid verification packages
/// * Handles both Breeder and Service Provider verification requests
model VerificationRequest {
  id                Int                       @id @default(autoincrement())
  userType          String                    @map("user_type")
  providerId        Int?                      @map("provider_id")
  marketplaceUserId Int?                      @map("marketplace_user_id")
  packageType       String                    @map("package_type")
  requestedTier     String                    @map("requested_tier")
  status            VerificationRequestStatus @default(PENDING)
  submittedInfo     Json?                     @map("submitted_info")
  reviewChecklist   Json?                     @map("review_checklist")
  reviewNotes       String?                   @map("review_notes")
  reviewedAt        DateTime?                 @map("reviewed_at")
  reviewedBy        Int?                      @map("reviewed_by")
  infoRequestedAt   DateTime?                 @map("info_requested_at")
  infoRequestNote   String?                   @map("info_request_note")
  infoProvidedAt    DateTime?                 @map("info_provided_at")
  paymentIntentId   String?                   @map("payment_intent_id")
  amountPaidCents   Int?                      @map("amount_paid_cents")
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  marketplaceUser   MarketplaceUser?          @relation("UserVerificationRequests", fields: [marketplaceUserId], references: [id], onDelete: Cascade)
  provider          MarketplaceProvider?      @relation("ProviderVerificationRequests", fields: [providerId], references: [id], onDelete: Cascade)

  @@index([status, createdAt(sort: Desc)])
  @@index([userType, status])
  @@index([providerId])
  @@index([marketplaceUserId])
  @@index([reviewedBy])
  @@map("verification_requests")
  @@schema("marketplace")
}

/// *
/// * MktListingBreederService - Unified service listings table (non-breeding services)
/// * Consolidates provider and breeder service listings into single table
/// * Uses source_type discriminator to distinguish between sources
/// * NOTE: Table name remains "MktListingService" for backwards compatibility
model MktListingBreederService {
  id                       Int                               @id @default(autoincrement())
  sourceType               ServiceSourceType                 @map("source_type")
  providerId               Int?                              @map("provider_id")
  tenantId                 Int?                              @map("tenant_id")
  slug                     String                            @unique
  title                    String                            @db.VarChar(255)
  description              String?
  category                 String                            @db.VarChar(100)
  subcategory              String?                           @db.VarChar(100)
  customServiceType        String?                           @map("custom_service_type") @db.VarChar(50)
  priceCents               BigInt?                           @map("price_cents")
  priceType                String?                           @map("price_type") @db.VarChar(50)
  priceText                String?                           @map("price_text") @db.VarChar(100)
  images                   Json?
  coverImageUrl            String?                           @map("cover_image_url") @db.VarChar(500)
  city                     String?                           @db.VarChar(100)
  state                    String?                           @db.VarChar(50)
  zip                      String?                           @db.VarChar(20)
  country                  String?                           @db.VarChar(2)
  latitude                 Decimal?                          @db.Decimal(10, 8)
  longitude                Decimal?                          @db.Decimal(11, 8)
  duration                 String?                           @db.VarChar(100)
  availability             String?
  metaDescription          String?                           @map("meta_description")
  keywords                 String?
  viewCount                Int                               @default(0) @map("view_count")
  inquiryCount             Int                               @default(0) @map("inquiry_count")
  bookingCount             Int                               @default(0) @map("booking_count")
  status                   MarketplaceListingStatus          @default(DRAFT)
  publishedAt              DateTime?                         @map("published_at")
  pausedAt                 DateTime?                         @map("paused_at")
  flagged                  Boolean                           @default(false)
  flaggedAt                DateTime?                         @map("flagged_at")
  createdAt                DateTime                          @default(now()) @map("created_at")
  updatedAt                DateTime                          @updatedAt @map("updated_at")
  deletedAt                DateTime?                         @map("deleted_at")
  featuredUntil            DateTime?                         @map("featured_until")
  isFeatured               Boolean                           @default(false) @map("is_featured")
  currentPeriodEnd         DateTime?                         @map("current_period_end")
  expiresAt                DateTime?                         @map("expires_at")
  isFounding               Boolean                           @default(false) @map("is_founding")
  listingFeeCents          Int                               @default(499) @map("listing_fee_cents")
  paidAt                   DateTime?                         @map("paid_at")
  stripeSubscriptionId     String?                           @unique @map("stripe_subscription_id")
  stripeSubscriptionStatus String?                           @map("stripe_subscription_status")
  messageThreads           MarketplaceMessageThread[]
  provider                 MarketplaceProvider?              @relation(fields: [providerId], references: [id], onDelete: Cascade)
  tenant                   Tenant?                           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignments              MarketplaceServiceTagAssignment[]
  transactions             MarketplaceTransaction[]

  @@index([providerId])
  @@index([tenantId])
  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([city, state])
  @@index([sourceType])
  @@index([deletedAt])
  @@index([isFeatured, featuredUntil])
  @@index([expiresAt, status])
  @@map("mkt_listing_breeder_service")
  @@schema("marketplace")
}

model MarketplaceAbuseReport {
  id            Int       @id @default(autoincrement())
  listingId     Int       @map("listing_id")
  reason        String
  details       String?
  reporterEmail String?   @map("reporter_email")
  status        String    @default("pending")
  adminNotes    String?   @map("admin_notes")
  resolvedAt    DateTime? @map("resolved_at")
  resolvedById  Int?      @map("resolved_by_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([listingId])
  @@index([status])
  @@index([createdAt])
  @@map("abuse_reports")
  @@schema("marketplace")
}

model MarketplaceTransaction {
  id                  BigInt                     @id @default(autoincrement())
  clientId            Int                        @map("client_id")
  providerId          Int                        @map("provider_id")
  listingId           Int?                       @map("listing_id")
  serviceDescription  String                     @map("service_description")
  invoiceType         String?                    @map("invoice_type")
  tenantId            Int?                       @map("tenant_id")
  invoiceId           Int?                       @map("invoice_id")
  totalCents          BigInt                     @map("total_cents")
  platformFeeCents    BigInt                     @default(0) @map("platform_fee_cents")
  providerPayoutCents BigInt?                    @map("provider_payout_cents")
  status              String                     @default("pending")
  createdAt           DateTime                   @default(now()) @map("created_at")
  invoicedAt          DateTime?                  @map("invoiced_at")
  paidAt              DateTime?                  @map("paid_at")
  completedAt         DateTime?                  @map("completed_at")
  cancellationReason  String?                    @map("cancellation_reason")
  cancelledAt         DateTime?                  @map("cancelled_at")
  cancelledBy         String?                    @map("cancelled_by")
  refundAmountCents   BigInt                     @default(0) @map("refund_amount_cents")
  refundReason        String?                    @map("refund_reason")
  refundedAt          DateTime?                  @map("refunded_at")
  serviceNotes        String?                    @map("service_notes")
  servicePriceCents   BigInt                     @map("service_price_cents")
  startedAt           DateTime?                  @map("started_at")
  stripeFeesCents     BigInt                     @default(0) @map("stripe_fees_cents")
  taxCents            BigInt                     @default(0) @map("tax_cents")
  taxRate             Decimal?                   @map("tax_rate") @db.Decimal(5, 4)
  marketplaceInvoice  MarketplaceInvoice?
  threads             MarketplaceMessageThread[]
  review              MarketplaceReview?
  client              MarketplaceUser            @relation("ClientTransactions", fields: [clientId], references: [id])
  listing             MktListingBreederService?  @relation(fields: [listingId], references: [id])
  provider            MarketplaceProvider        @relation("ProviderTransactions", fields: [providerId], references: [id])

  @@index([clientId, status, createdAt(sort: Desc)])
  @@index([providerId, status, createdAt(sort: Desc)])
  @@index([listingId, status])
  @@index([invoiceType, tenantId, invoiceId])
  @@index([status, paidAt])
  @@map("transactions")
  @@schema("marketplace")
}

model MarketplaceInvoice {
  id                       Int                    @id @default(autoincrement())
  transactionId            BigInt                 @unique @map("transaction_id")
  providerId               Int                    @map("provider_id")
  clientId                 Int                    @map("client_id")
  invoiceNumber            String                 @unique @map("invoice_number")
  totalCents               BigInt                 @map("total_cents")
  balanceCents             BigInt                 @map("balance_cents")
  refundedCents            BigInt                 @default(0) @map("refunded_cents")
  status                   String                 @default("draft")
  paymentMode              String                 @default("stripe") @map("payment_mode")
  paymentModeLockedAt      DateTime               @default(now()) @map("payment_mode_locked_at")
  stripeInvoiceId          String?                @unique @map("stripe_invoice_id")
  stripePaymentIntentId    String?                @unique @map("stripe_payment_intent_id")
  buyerMarkedPaidAt        DateTime?              @map("buyer_marked_paid_at")
  buyerPaymentMethod       String?                @map("buyer_payment_method")
  buyerPaymentReference    String?                @map("buyer_payment_reference")
  providerConfirmedAt      DateTime?              @map("provider_confirmed_at")
  providerConfirmedById    Int?                   @map("provider_confirmed_by")
  issuedAt                 DateTime?              @map("issued_at")
  dueAt                    DateTime?              @map("due_at")
  paidAt                   DateTime?              @map("paid_at")
  createdAt                DateTime               @default(now()) @map("created_at")
  updatedAt                DateTime               @updatedAt @map("updated_at")
  internalNotes            String?                @map("internal_notes")
  manualPaymentConfirmedBy Int?                   @map("manual_payment_confirmed_by")
  manualPaymentMarkedAt    DateTime?              @map("manual_payment_marked_at")
  manualPaymentMethod      String?                @map("manual_payment_method")
  manualPaymentReference   String?                @map("manual_payment_reference")
  notes                    String?
  paidCents                BigInt                 @default(0) @map("paid_cents")
  refundedAt               DateTime?              @map("refunded_at")
  sentAt                   DateTime?              @map("sent_at")
  stripeChargeId           String?                @map("stripe_charge_id")
  subtotalCents            BigInt                 @map("subtotal_cents")
  taxCents                 BigInt                 @default(0) @map("tax_cents")
  viewedAt                 DateTime?              @map("viewed_at")
  voidedAt                 DateTime?              @map("voided_at")
  stripeInvoicePdfUrl      String?                @map("stripe_invoice_pdf_url")
  stripeInvoiceSentAt      DateTime?              @map("stripe_invoice_sent_at")
  stripeInvoiceUrl         String?                @map("stripe_invoice_url")
  client                   MarketplaceUser        @relation("ClientInvoices", fields: [clientId], references: [id])
  provider                 MarketplaceProvider    @relation("ProviderInvoices", fields: [providerId], references: [id])
  transaction              MarketplaceTransaction @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([providerId, status, createdAt(sort: Desc)])
  @@index([clientId, status, createdAt(sort: Desc)])
  @@index([stripeInvoiceId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
  @@index([status, dueAt])
  @@map("invoices")
  @@schema("marketplace")
}

model MarketplaceMessageThread {
  id                   Int                       @id @default(autoincrement())
  clientId             Int                       @map("client_id")
  providerId           Int                       @map("provider_id")
  listingId            Int?                      @map("listing_id")
  transactionId        BigInt?                   @map("transaction_id")
  subject              String?
  status               String                    @default("active")
  lastMessageAt        DateTime                  @default(now()) @map("last_message_at")
  createdAt            DateTime                  @default(now()) @map("created_at")
  archivedByProviderAt DateTime?                 @map("archived_by_provider_at")
  deletedByProviderAt  DateTime?                 @map("deleted_by_provider_at")
  firstClientMessageAt DateTime?                 @map("first_client_message_at")
  firstProviderReplyAt DateTime?                 @map("first_provider_reply_at")
  responseTimeSeconds  Int?                      @map("response_time_seconds")
  client               MarketplaceUser           @relation("ClientThreads", fields: [clientId], references: [id], onDelete: Cascade)
  listing              MktListingBreederService? @relation(fields: [listingId], references: [id])
  provider             MarketplaceProvider       @relation("ProviderThreads", fields: [providerId], references: [id], onDelete: Cascade)
  transaction          MarketplaceTransaction?   @relation(fields: [transactionId], references: [id])
  messages             MarketplaceMessage[]

  @@index([clientId, lastMessageAt(sort: Desc)])
  @@index([providerId, lastMessageAt(sort: Desc)])
  @@map("message_threads")
  @@schema("marketplace")
}

model MarketplaceMessage {
  id          BigInt                   @id @default(autoincrement())
  threadId    Int                      @map("thread_id")
  senderId    Int                      @map("sender_id")
  messageText String                   @map("message_text")
  readAt      DateTime?                @map("read_at")
  createdAt   DateTime                 @default(now()) @map("created_at")
  senderType  String                   @default("client") @map("sender_type")
  deletedAt   DateTime?                @map("deleted_at")
  sender      MarketplaceUser          @relation(fields: [senderId], references: [id], onDelete: Cascade)
  thread      MarketplaceMessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt(sort: Desc)])
  @@map("messages")
  @@schema("marketplace")
}

model MarketplaceReview {
  id               Int                    @id @default(autoincrement())
  transactionId    BigInt                 @unique @map("transaction_id")
  providerId       Int                    @map("provider_id")
  clientId         Int                    @map("client_id")
  listingId        Int?                   @map("listing_id")
  rating           Int
  title            String?
  reviewText       String?                @map("review_text")
  providerResponse String?                @map("provider_response")
  respondedAt      DateTime?              @map("responded_at")
  status           String                 @default("published")
  flaggedReason    String?                @map("flagged_reason")
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")
  client           MarketplaceUser        @relation("ReviewsByClient", fields: [clientId], references: [id])
  provider         MarketplaceProvider    @relation("ReviewsForProvider", fields: [providerId], references: [id])
  transaction      MarketplaceTransaction @relation(fields: [transactionId], references: [id])

  @@index([providerId, status, createdAt(sort: Desc)])
  @@index([clientId])
  @@index([listingId, status])
  @@index([rating, status])
  @@map("reviews")
  @@schema("marketplace")
}

model MarketplaceSavedListing {
  id          Int      @id @default(autoincrement())
  listingId   Int      @map("listing_id")
  savedAt     DateTime @default(now()) @map("saved_at")
  bhqUserId   String   @map("bhq_user_id") @db.VarChar(36)
  listingType String   @map("listing_type") @db.VarChar(20)
  bhqUser     User     @relation("UserSavedListings", fields: [bhqUserId], references: [id], onDelete: Cascade)

  @@unique([bhqUserId, listingType, listingId])
  @@index([bhqUserId, savedAt(sort: Desc)])
  @@index([listingType, listingId])
  @@map("saved_listings")
  @@schema("marketplace")
}

model MarketplaceServiceTag {
  id          Int                               @id @default(autoincrement())
  name        String                            @db.VarChar(100)
  slug        String                            @unique @db.VarChar(100)
  usageCount  Int                               @default(0) @map("usage_count")
  suggested   Boolean                           @default(false)
  createdAt   DateTime                          @default(now()) @map("created_at")
  assignments MarketplaceServiceTagAssignment[]

  @@index([suggested])
  @@index([usageCount(sort: Desc)])
  @@index([name])
  @@map("service_tags")
  @@schema("marketplace")
}

model MarketplaceServiceTagAssignment {
  listingId Int                      @map("listing_id")
  tagId     Int                      @map("tag_id")
  listing   MktListingBreederService @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tag       MarketplaceServiceTag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([listingId, tagId])
  @@index([listingId])
  @@index([tagId])
  @@map("service_tag_assignments")
  @@schema("marketplace")
}

model StripeIdentitySession {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  stripeSessionId String    @unique @map("stripe_session_id") @db.VarChar(255)
  clientSecret    String    @map("client_secret")
  status          String    @default("pending") @db.VarChar(50)
  verifiedAt      DateTime? @map("verified_at")
  stripeResponse  Json?     @map("stripe_response")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("stripe_identity_sessions")
  @@schema("marketplace")
}

model BreedingProgramRule {
  id             Int                            @id @default(autoincrement())
  tenantId       Int
  category       BreedingRuleCategory
  ruleType       String                         @db.VarChar(100)
  name           String                         @db.VarChar(255)
  description    String?
  enabled        Boolean                        @default(true)
  config         Json                           @default("{}")
  level          BreedingRuleLevel
  levelId        String                         @db.VarChar(50)
  inheritsFromId Int?
  createdAt      DateTime                       @default(now())
  updatedAt      DateTime                       @updatedAt
  inheritsFrom   BreedingProgramRule?           @relation("RuleInheritance", fields: [inheritsFromId], references: [id])
  overriddenBy   BreedingProgramRule[]          @relation("RuleInheritance")
  tenant         Tenant                         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  executions     BreedingProgramRuleExecution[]

  @@unique([tenantId, level, levelId, ruleType])
  @@index([tenantId])
  @@index([level, levelId])
  @@index([inheritsFromId])
  @@index([ruleType])
  @@index([tenantId, enabled])
  @@schema("public")
}

model BreedingProgramRuleExecution {
  id          Int                 @id @default(autoincrement())
  tenantId    Int
  ruleId      Int
  triggeredBy String              @db.VarChar(50)
  entityType  String              @db.VarChar(20)
  entityId    Int
  success     Boolean
  action      String?             @db.VarChar(100)
  changes     Json?
  error       String?
  executedAt  DateTime            @default(now())
  rule        BreedingProgramRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ruleId])
  @@index([entityType, entityId])
  @@index([executedAt])
  @@schema("public")
}

model StudVisibilityRule {
  id             Int                  @id @default(autoincrement())
  tenantId       Int
  level          StudVisibilityLevel
  levelId        String               @db.VarChar(50)
  inheritsFromId Int?
  config         Json                 @default("{}")
  enabled        Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  createdBy      Int?
  updatedBy      Int?
  inheritsFrom   StudVisibilityRule?  @relation("StudVisibilityInheritance", fields: [inheritsFromId], references: [id])
  overriddenBy   StudVisibilityRule[] @relation("StudVisibilityInheritance")
  tenant         Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, level, levelId])
  @@index([tenantId])
  @@index([level, levelId])
  @@index([inheritsFromId])
  @@schema("public")
}

/// *
/// * EmailFilter - Tenant-level allowlist/blocklist for inbound email security
/// * Allows tenants to block spam senders or ensure important contacts always get through
model EmailFilter {
  id          Int       @id @default(autoincrement())
  tenantId    Int
  pattern     String    @db.VarChar(255)
  type        String    @db.VarChar(20)
  reason      String?
  autoAdded   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  createdBy   String?
  lastMatched DateTime?
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, pattern])
  @@index([tenantId, type])
  @@schema("public")
}

/// *
/// * Blocked/rejected inbound emails - audit log for troubleshooting
/// * Tracks all emails that were blocked by security checks
model BlockedEmail {
  id            Int      @id @default(autoincrement())
  tenantId      Int
  fromEmail     String   @db.VarChar(255)
  toEmail       String   @db.VarChar(255)
  subject       String   @db.VarChar(500)
  bodySnippet   String?
  resendEmailId String?  @db.VarChar(100)
  reason        String   @db.VarChar(50)
  details       Json?
  blockedAt     DateTime @default(now())
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, blockedAt])
  @@index([fromEmail, blockedAt])
  @@index([reason, blockedAt])
  @@index([blockedAt])
  @@schema("public")
}

/// *
/// * Buyer - A prospective horse purchaser
/// * Links to Party for unified contact management (notes, events, activity all inherited)
model Buyer {
  id                   Int                   @id @default(autoincrement())
  tenantId             Int
  partyId              Int                   @unique
  status               BuyerStatus           @default(ACTIVE)
  source               String?               @db.VarChar(100)
  budget               Decimal?              @db.Decimal(12, 2)
  budgetCurrency       String                @default("USD") @db.Char(3)
  notes                String?
  preferredBreeds      String[]
  preferredUses        String[]
  preferredAgeMin      Int?
  preferredAgeMax      Int?
  preferredSex         Sex?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  archivedAt           DateTime?
  breedingPlanBuyers   BreedingPlanBuyer[]   @relation("BreedingPlanBuyerCRM")
  party                Party                 @relation("BuyerParty", fields: [partyId], references: [id])
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  interests            BuyerInterest[]
  tasks                BuyerTask[]           @relation("BuyerTasks")
  deals                Deal[]
  offspringGroupBuyers OffspringGroupBuyer[] @relation("OffspringGroupBuyerCRM")
  tagAssignments       TagAssignment[]
  waitlistEntries      WaitlistEntry[]       @relation("WaitlistEntryCRM")

  @@index([tenantId])
  @@index([partyId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, archivedAt])
  @@schema("public")
}

/// *
/// * BuyerInterest - Links buyers to specific horses they're interested in
model BuyerInterest {
  id        Int           @id @default(autoincrement())
  buyerId   Int
  animalId  Int
  level     InterestLevel @default(INTERESTED)
  notes     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  animal    Animal        @relation("BuyerInterestAnimal", fields: [animalId], references: [id], onDelete: Cascade)
  buyer     Buyer         @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@unique([buyerId, animalId])
  @@index([buyerId])
  @@index([animalId])
  @@index([level])
  @@schema("public")
}

/// *
/// * Deal - A sales opportunity in the pipeline
model Deal {
  id                Int             @id @default(autoincrement())
  tenantId          Int
  buyerId           Int
  animalId          Int?
  name              String          @db.VarChar(255)
  stage             DealStage       @default(INQUIRY)
  askingPrice       Decimal?        @db.Decimal(12, 2)
  offerPrice        Decimal?        @db.Decimal(12, 2)
  finalPrice        Decimal?        @db.Decimal(12, 2)
  currency          String          @default("USD") @db.Char(3)
  expectedCloseDate DateTime?
  closedAt          DateTime?
  outcome           DealOutcome?
  lostReason        String?         @db.VarChar(500)
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  tasks             BuyerTask[]     @relation("DealTasks")
  animal            Animal?         @relation("DealAnimal", fields: [animalId], references: [id])
  buyer             Buyer           @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  activities        DealActivity[]
  tagAssignments    TagAssignment[]

  @@index([tenantId])
  @@index([buyerId])
  @@index([animalId])
  @@index([stage])
  @@index([tenantId, stage])
  @@index([tenantId, buyerId])
  @@index([outcome])
  @@schema("public")
}

/// *
/// * DealActivity - Log of interactions on a deal
/// * Separate from PartyActivity since deals aren't parties
model DealActivity {
  id          Int              @id @default(autoincrement())
  tenantId    Int
  dealId      Int
  type        DealActivityType
  title       String           @db.VarChar(255)
  description String?
  scheduledAt DateTime?
  completedAt DateTime?
  userId      String?
  createdAt   DateTime         @default(now())
  deal        Deal             @relation(fields: [dealId], references: [id], onDelete: Cascade)
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?            @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([dealId])
  @@index([type])
  @@index([dealId, createdAt])
  @@schema("public")
}

/// *
/// * BuyerEmailTemplate - Quick-response email templates for buyer communications
/// * User-customizable templates (different from system Template model used for documents)
model BuyerEmailTemplate {
  id         Int                        @id @default(autoincrement())
  tenantId   Int
  name       String                     @db.VarChar(100)
  subject    String                     @db.VarChar(255)
  bodyHtml   String
  bodyText   String
  category   BuyerEmailTemplateCategory @default(GENERAL)
  useCount   Int                        @default(0)
  lastUsedAt DateTime?
  sortOrder  Int                        @default(0)
  isActive   Boolean                    @default(true)
  createdAt  DateTime                   @default(now())
  updatedAt  DateTime                   @updatedAt
  tenant     Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, isActive])
  @@schema("public")
}

/// *
/// * BuyerTask - Tasks related to buyer/deal management
/// * E.g., "Follow up with John Smith", "Schedule viewing for Starlight"
model BuyerTask {
  id               Int               @id @default(autoincrement())
  tenantId         Int
  title            String            @db.VarChar(255)
  description      String?
  taskType         BuyerTaskType     @default(FOLLOW_UP)
  priority         BuyerTaskPriority @default(MEDIUM)
  status           BuyerTaskStatus   @default(PENDING)
  dueAt            DateTime?
  reminderAt       DateTime?
  buyerId          Int?
  dealId           Int?
  animalId         Int?
  assignedToUserId String?
  completedAt      DateTime?
  completedById    String?
  isAutoGenerated  Boolean           @default(false)
  automationRule   String?           @db.VarChar(100)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  animal           Animal?           @relation("BuyerTaskAnimal", fields: [animalId], references: [id])
  assignedToUser   User?             @relation("BuyerTaskAssignee", fields: [assignedToUserId], references: [id])
  buyer            Buyer?            @relation("BuyerTasks", fields: [buyerId], references: [id], onDelete: Cascade)
  completedBy      User?             @relation("BuyerTaskCompleter", fields: [completedById], references: [id])
  deal             Deal?             @relation("DealTasks", fields: [dealId], references: [id], onDelete: Cascade)
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, dueAt])
  @@index([buyerId])
  @@index([dealId])
  @@index([assignedToUserId])
  @@index([tenantId, status, dueAt])
  @@schema("public")
}

model RegistryConnection {
  id             Int                      @id @default(autoincrement())
  tenantId       Int
  registryId     Int
  status         RegistryConnectionStatus @default(DISCONNECTED)
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  apiKey         String?
  apiSecret      String?
  connectedAt    DateTime?
  lastSyncAt     DateTime?
  errorMessage   String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  registry       Registry                 @relation(fields: [registryId], references: [id], onDelete: Cascade)
  tenant         Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, registryId])
  @@index([tenantId])
  @@index([registryId])
  @@schema("public")
}

model RegistryVerification {
  id                         Int                      @id @default(autoincrement())
  animalRegistryIdentifierId Int                      @unique
  verified                   Boolean                  @default(false)
  verifiedAt                 DateTime?
  method                     VerificationMethod?
  confidence                 VerificationConfidence   @default(NONE)
  registryData               Json?
  documentUrl                String?
  documentNotes              String?
  verifiedByUserId           String?
  createdAt                  DateTime                 @default(now())
  updatedAt                  DateTime                 @updatedAt
  animalRegistryIdentifier   AnimalRegistryIdentifier @relation(fields: [animalRegistryIdentifierId], references: [id], onDelete: Cascade)
  verifiedByUser             User?                    @relation("RegistryVerificationVerifier", fields: [verifiedByUserId], references: [id])

  @@index([verified])
  @@schema("public")
}

model RegistryPedigree {
  id                         Int                      @id @default(autoincrement())
  animalRegistryIdentifierId Int
  generation                 Int
  position                   String
  registrationNumber         String?
  name                       String
  color                      String?
  birthYear                  Int?
  sex                        String?
  linkedAnimalId             Int?
  rawData                    Json?
  createdAt                  DateTime                 @default(now())
  animalRegistryIdentifier   AnimalRegistryIdentifier @relation(fields: [animalRegistryIdentifierId], references: [id], onDelete: Cascade)
  linkedAnimal               Animal?                  @relation("RegistryPedigreeLinkedAnimal", fields: [linkedAnimalId], references: [id])

  @@unique([animalRegistryIdentifierId, position])
  @@index([animalRegistryIdentifierId])
  @@index([linkedAnimalId])
  @@schema("public")
}

model RegistrySyncLog {
  id                Int      @id @default(autoincrement())
  tenantId          Int
  registryId        Int
  action            String
  status            String
  animalId          Int?
  identifier        String?
  requestData       Json?
  responseData      Json?
  errorMessage      String?
  durationMs        Int?
  initiatedByUserId String?
  createdAt         DateTime @default(now())
  initiatedByUser   User?    @relation("RegistrySyncLogInitiator", fields: [initiatedByUserId], references: [id])
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, registryId])
  @@index([createdAt])
  @@index([action])
  @@schema("public")
}

model MicrochipRegistry {
  id            Int                           @id @default(autoincrement())
  name          String
  slug          String                        @unique
  website       String?
  renewalType   MicrochipRenewalType          @default(UNKNOWN)
  species       String[]
  isActive      Boolean                       @default(true)
  sortOrder     Int                           @default(0)
  createdAt     DateTime                      @default(now())
  updatedAt     DateTime                      @updatedAt
  registrations AnimalMicrochipRegistration[]

  @@index([isActive, sortOrder])
  @@schema("public")
}

model AnimalMicrochipRegistration {
  id                    Int               @id @default(autoincrement())
  tenantId              Int
  animalId              Int?
  offspringId           Int?
  microchipNumber       String
  registryId            Int
  registrationDate      DateTime?
  expirationDate        DateTime?
  accountNumber         String?
  registeredToContactId Int?
  notes                 String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  animal                Animal?           @relation("AnimalMicrochipRegistrations", fields: [animalId], references: [id], onDelete: Cascade)
  offspring             Offspring?        @relation("OffspringMicrochipRegistrations", fields: [offspringId], references: [id], onDelete: Cascade)
  registeredTo          Contact?          @relation("MicrochipRegisteredTo", fields: [registeredToContactId], references: [id])
  registry              MicrochipRegistry @relation(fields: [registryId], references: [id])
  tenant                Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, animalId, registryId], name: "unique_animal_registry")
  @@unique([tenantId, offspringId, registryId], name: "unique_offspring_registry")
  @@index([tenantId, expirationDate])
  @@index([registeredToContactId])
  @@schema("public")
}

/// *
/// * SupplementProtocol - Stores supplement protocol templates
/// * Can be system benchmark protocols (tenantId = null) or tenant custom protocols
model SupplementProtocol {
  id                  Int                       @id @default(autoincrement())
  tenantId            Int?
  name                String
  description         String?
  species             Species[]
  isBenchmark         Boolean                   @default(false)
  benchmarkSource     String?
  benchmarkNotes      String?
  dosageAmount        String?
  dosageUnit          String?
  administrationRoute String?
  triggerType         SupplementTriggerType
  anchorEvent         BreedingCycleAnchorEvent?
  offsetDays          Int?
  ageTriggerWeeks     Int?
  durationDays        Int?
  frequency           SupplementFrequency       @default(DAILY)
  reminderDaysBefore  Int[]                     @default([7, 3, 1])
  active              Boolean                   @default(true)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  tenant              Tenant?                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schedules           SupplementSchedule[]

  @@index([tenantId])
  @@index([tenantId, active])
  @@index([isBenchmark])
  @@schema("public")
}

/// *
/// * SupplementSchedule - Links a protocol to an animal, optionally tied to a breeding plan
model SupplementSchedule {
  id                       Int                        @id @default(autoincrement())
  tenantId                 Int
  protocolId               Int
  breedingPlanId           Int?
  animalId                 Int
  mode                     SupplementScheduleMode
  calculatedStartDate      DateTime
  calculatedEndDate        DateTime?
  startDateOverride        DateTime?
  nextDueDate              DateTime?
  status                   SupplementScheduleStatus   @default(NOT_STARTED)
  completedDoses           Int                        @default(0)
  totalDoses               Int?
  lastAdministeredAt       DateTime?
  disclaimerAcknowledgedAt DateTime?
  disclaimerAcknowledgedBy String?
  notes                    String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  offspringGroupId         Int?
  administrations          SupplementAdministration[]
  animal                   Animal                     @relation(fields: [animalId], references: [id], onDelete: Cascade)
  breedingPlan             BreedingPlan?              @relation(fields: [breedingPlanId], references: [id])
  OffspringGroup           OffspringGroup?            @relation(fields: [offspringGroupId], references: [id], onUpdate: NoAction)
  protocol                 SupplementProtocol         @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  tenant                   Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([breedingPlanId])
  @@index([animalId])
  @@index([status, calculatedStartDate])
  @@index([status, nextDueDate])
  @@schema("public")
}

/// *
/// * SupplementAdministration - Records individual supplement doses administered
model SupplementAdministration {
  id             Int                @id @default(autoincrement())
  tenantId       Int
  scheduleId     Int
  animalId       Int
  administeredAt DateTime
  actualDosage   String?
  givenBy        String?
  doseNumber     Int?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  animal         Animal             @relation(fields: [animalId], references: [id], onDelete: Cascade)
  schedule       SupplementSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([scheduleId])
  @@index([animalId])
  @@index([administeredAt])
  @@schema("public")
}

/// *
/// * FoodProduct - Food products available for feeding animals
/// * Stores nutritional info, cost data, and species compatibility
model FoodProduct {
  id             Int             @id @default(autoincrement())
  tenantId       Int
  name           String
  brand          String?
  sku            String?
  foodType       FoodType
  species        Species[]
  lifeStage      LifeStage?
  photoUrl       String?
  bagSizeOz      Int?
  costCents      Int?
  costPerOzCents Int?
  servingSizeOz  Float?
  proteinPct     Float?
  fatPct         Float?
  fiberPct       Float?
  caloriesPerCup Int?
  isActive       Boolean         @default(true)
  isArchived     Boolean         @default(false)
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  expenses       Expense[]
  feedingPlans   FeedingPlan[]
  feedingRecords FeedingRecord[]
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, foodType])
  @@index([tenantId, isActive])
  @@index([tenantId, species])
  @@schema("public")
}

/// *
/// * FeedingPlan - Links a food product to an animal with feeding schedule
/// * Tracks portion sizes, feeding times, and auto-expense settings
model FeedingPlan {
  id                Int             @id @default(autoincrement())
  tenantId          Int
  animalId          Int?
  foodProductId     Int
  portionOz         Float
  feedingsPerDay    Int             @default(2)
  feedingTimes      String[]
  startDate         DateTime
  endDate           DateTime?
  autoCreateExpense Boolean         @default(false)
  isActive          Boolean         @default(true)
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  offspringGroupId  Int?
  animal            Animal?         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  foodProduct       FoodProduct     @relation(fields: [foodProductId], references: [id])
  offspringGroup    OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  feedingRecords    FeedingRecord[]
  foodChangesTo     FoodChange[]    @relation("FoodChangeNewPlan")
  foodChangesFrom   FoodChange[]    @relation("FoodChangePrevPlan")

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([tenantId, animalId, isActive])
  @@index([tenantId, offspringGroupId])
  @@index([tenantId, offspringGroupId, isActive])
  @@index([animalId, startDate])
  @@index([offspringGroupId, startDate])
  @@schema("public")
}

/// *
/// * FeedingRecord - Individual feeding log entries
/// * Tracks actual feedings, skipped meals, appetite scores
model FeedingRecord {
  id               Int             @id @default(autoincrement())
  tenantId         Int
  animalId         Int?
  feedingPlanId    Int?
  foodProductId    Int?
  fedAt            DateTime
  portionOz        Float?
  costCents        Int?
  skipped          Boolean         @default(false)
  skipReason       String?
  appetiteScore    Int?
  expenseId        Int?            @unique
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  offspringGroupId Int?
  animal           Animal?         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  feedingPlan      FeedingPlan?    @relation(fields: [feedingPlanId], references: [id])
  foodProduct      FoodProduct?    @relation(fields: [foodProductId], references: [id])
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([tenantId, animalId, fedAt])
  @@index([tenantId, offspringGroupId])
  @@index([tenantId, offspringGroupId, fedAt])
  @@index([fedAt])
  @@schema("public")
}

/// *
/// * FoodChange - Records food transitions with outcomes
/// * Tracks why food changed, transition protocol, and success rating
model FoodChange {
  id               Int              @id @default(autoincrement())
  tenantId         Int
  animalId         Int?
  previousPlanId   Int?
  newPlanId        Int
  changeDate       DateTime
  changeReason     FoodChangeReason
  reasonDetails    String?
  transitionDays   Int?
  transitionNotes  String?
  reactions        String?
  digestiveNotes   String?
  overallSuccess   SuccessRating?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  offspringGroupId Int?
  animal           Animal?          @relation(fields: [animalId], references: [id], onDelete: Cascade)
  newPlan          FeedingPlan      @relation("FoodChangeNewPlan", fields: [newPlanId], references: [id], onDelete: Cascade)
  offspringGroup   OffspringGroup?  @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  previousPlan     FeedingPlan?     @relation("FoodChangePrevPlan", fields: [previousPlanId], references: [id])
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([tenantId, offspringGroupId])
  @@index([animalId, changeDate])
  @@index([offspringGroupId, changeDate])
  @@schema("public")
}

model LactationCycle {
  id                Int              @id @default(autoincrement())
  tenantId          Int
  animalId          Int
  lactationNumber   Int
  status            LactationStatus  @default(FRESH)
  freshenDate       DateTime         @db.Date
  dryOffDate        DateTime?        @db.Date
  milkingFrequency  MilkingFrequency @default(TWICE_DAILY)
  days305MilkLbs    Decimal?         @db.Decimal(10, 2)
  days305FatLbs     Decimal?         @db.Decimal(8, 3)
  days305ProteinLbs Decimal?         @db.Decimal(8, 3)
  peakMilkDate      DateTime?        @db.Date
  peakMilkLbs       Decimal?         @db.Decimal(6, 2)
  daysToReachPeak   Int?
  avgButterfatPct   Decimal?         @db.Decimal(4, 2)
  avgProteinPct     Decimal?         @db.Decimal(4, 2)
  avgSCC            Int?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  dhiaTestRecords   DHIATestRecord[]
  animal            Animal           @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  milkingRecords    MilkingRecord[]

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([animalId, status])
  @@index([animalId, freshenDate])
  @@schema("public")
}

model MilkingRecord {
  id               Int             @id @default(autoincrement())
  tenantId         Int
  animalId         Int
  lactationCycleId Int?
  milkedAt         DateTime
  sessionNumber    Int?
  daysInMilk       Int?
  milkLbs          Decimal         @db.Decimal(6, 2)
  butterfatPct     Decimal?        @db.Decimal(4, 2)
  proteinPct       Decimal?        @db.Decimal(4, 2)
  somaticCellCount Int?
  lactose          Decimal?        @db.Decimal(4, 2)
  conductivity     Decimal?        @db.Decimal(6, 2)
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  animal           Animal          @relation(fields: [animalId], references: [id], onDelete: Cascade)
  lactationCycle   LactationCycle? @relation(fields: [lactationCycleId], references: [id])
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([animalId, milkedAt])
  @@index([lactationCycleId])
  @@schema("public")
}

model DHIATestRecord {
  id               Int             @id @default(autoincrement())
  tenantId         Int
  animalId         Int
  lactationCycleId Int?
  testDate         DateTime        @db.Date
  testType         DHIATestType    @default(STANDARD)
  daysInMilk       Int?
  testDayMilkLbs   Decimal         @db.Decimal(6, 2)
  butterfatPct     Decimal?        @db.Decimal(4, 2)
  proteinPct       Decimal?        @db.Decimal(4, 2)
  lactose          Decimal?        @db.Decimal(4, 2)
  fatLbs           Decimal?        @db.Decimal(6, 3)
  proteinLbs       Decimal?        @db.Decimal(6, 3)
  somaticCellCount Int?
  milkUreaNitrogen Decimal?        @db.Decimal(5, 2)
  labName          String?
  labTestNumber    String?
  certificateUrl   String?
  documentId       Int?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  animal           Animal          @relation(fields: [animalId], references: [id], onDelete: Cascade)
  lactationCycle   LactationCycle? @relation(fields: [lactationCycleId], references: [id])
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([animalId, testDate])
  @@index([lactationCycleId])
  @@schema("public")
}

model LinearAppraisal {
  id                Int      @id @default(autoincrement())
  tenantId          Int
  animalId          Int
  appraisalDate     DateTime @db.Date
  appraiserName     String?
  appraiserId       String?
  finalScore        Int
  classification    String?
  generalAppearance Int?
  dairyCharacter    Int?
  bodyCapacity      Int?
  mammarySystem     Int?
  allScores         Json?
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  animal            Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([animalId, appraisalDate])
  @@schema("public")
}

model DairyProductionHistory {
  id                      Int       @id @default(autoincrement())
  tenantId                Int
  animalId                Int       @unique
  totalLactations         Int       @default(0)
  completedLactations     Int       @default(0)
  best305DayMilkLbs       Decimal?  @db.Decimal(10, 2)
  best305DayFatLbs        Decimal?  @db.Decimal(8, 3)
  best305DayProteinLbs    Decimal?  @db.Decimal(8, 3)
  avg305DayMilkLbs        Decimal?  @db.Decimal(10, 2)
  avgPeakMilkLbs          Decimal?  @db.Decimal(6, 2)
  avgDaysToReachPeak      Int?
  lifetimeMilkLbs         Decimal?  @db.Decimal(12, 2)
  lifetimeFatLbs          Decimal?  @db.Decimal(10, 3)
  lifetimeProteinLbs      Decimal?  @db.Decimal(10, 3)
  lifetimeAvgButterfatPct Decimal?  @db.Decimal(4, 2)
  lifetimeAvgProteinPct   Decimal?  @db.Decimal(4, 2)
  lifetimeAvgSCC          Int?
  bestAppraisalScore      Int?
  bestAppraisalDate       DateTime? @db.Date
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  animal                  Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant                  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@schema("public")
}

model ShearingRecord {
  id                    Int            @id @default(autoincrement())
  tenantId              Int
  animalId              Int
  shearingDate          DateTime       @db.Date
  shearingType          ShearingType   @default(FULL_BODY)
  daysSinceLastShearing Int?
  grossWeightLbs        Decimal        @db.Decimal(6, 2)
  cleanWeightLbs        Decimal?       @db.Decimal(6, 2)
  yieldPct              Decimal?       @db.Decimal(5, 2)
  stapleLengthIn        Decimal?       @db.Decimal(4, 2)
  grade                 FleeceGrade?
  handleQuality         String?
  crimpPerInch          Decimal?       @db.Decimal(4, 1)
  vegetableMatter       String?
  weathering            String?
  cotting               Boolean?
  tenderness            String?
  soldTo                String?
  salePriceCents        Int?
  fiberBuyer            String?
  notes                 String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  labTests              FiberLabTest[]
  animal                Animal         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant                Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([animalId, shearingDate])
  @@index([tenantId, grade])
  @@schema("public")
}

model FiberLabTest {
  id                     Int              @id @default(autoincrement())
  tenantId               Int
  animalId               Int
  shearingRecordId       Int?
  testDate               DateTime         @db.Date
  testType               FiberLabTestType @default(MICRON_ANALYSIS)
  labName                String?
  avgFiberDiameter       Decimal?         @db.Decimal(5, 2)
  standardDeviation      Decimal?         @db.Decimal(5, 2)
  coefficientOfVariation Decimal?         @db.Decimal(5, 2)
  comfortFactor          Decimal?         @db.Decimal(5, 2)
  spinningFineness       Decimal?         @db.Decimal(5, 2)
  curvature              Decimal?         @db.Decimal(6, 2)
  stapleStrengthNKtex    Decimal?         @db.Decimal(6, 2)
  positionOfBreak        String?
  cleanFleeceYieldPct    Decimal?         @db.Decimal(5, 2)
  histogramData          Json?
  certificateNumber      String?
  certificateUrl         String?
  notes                  String?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  animal                 Animal           @relation(fields: [animalId], references: [id], onDelete: Cascade)
  shearingRecord         ShearingRecord?  @relation(fields: [shearingRecordId], references: [id])
  tenant                 Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@index([animalId, testDate])
  @@index([shearingRecordId])
  @@schema("public")
}

model FiberProductionHistory {
  id                  Int          @id @default(autoincrement())
  tenantId            Int
  animalId            Int          @unique
  totalShearings      Int          @default(0)
  totalGrossWeightLbs Decimal?     @db.Decimal(10, 2)
  totalCleanWeightLbs Decimal?     @db.Decimal(10, 2)
  avgGrossWeightLbs   Decimal?     @db.Decimal(6, 2)
  avgCleanWeightLbs   Decimal?     @db.Decimal(6, 2)
  avgYieldPct         Decimal?     @db.Decimal(5, 2)
  avgStapleLengthIn   Decimal?     @db.Decimal(4, 2)
  avgMicron           Decimal?     @db.Decimal(5, 2)
  micronTrend         String?
  bestMicron          Decimal?     @db.Decimal(5, 2)
  bestFleeceWeightLbs Decimal?     @db.Decimal(6, 2)
  bestGradeAchieved   FleeceGrade?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  animal              Animal       @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant              Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, animalId])
  @@schema("public")
}

model BreederProfile {
  id                       Int      @id @default(autoincrement())
  tenantId                 Int      @unique
  registryAffiliations     String[]
  primaryRegistry          String?
  breedingLineTypes        String[]
  breedingPhilosophy       String?
  requiresHealthTesting    Boolean  @default(false)
  requiresContract         Boolean  @default(false)
  requiredTests            String[]
  excludedRegistries       String[]
  excludedLineTypes        String[]
  excludedAttributes       String[]
  exclusionNotes           String?
  showRegistryAffiliations Boolean  @default(true)
  showBreedingLineTypes    Boolean  @default(true)
  showRequirements         Boolean  @default(true)
  publicBio                String?
  websiteUrl               String?
  socialLinks              Json?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  tenant                   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model BreedingDiscoveryProgram {
  id                           Int                   @id @default(autoincrement())
  tenantId                     Int
  programNumber                String                @unique
  name                         String
  description                  String?
  species                      Species
  programType                  String
  defaultBreedingMethods       String[]
  defaultGuaranteeType         String?
  defaultGuaranteeTerms        String?
  defaultRequiresHealthTesting Boolean               @default(false)
  defaultRequiredTests         String[]
  defaultRequiresContract      Boolean               @default(false)
  publicEnabled                Boolean               @default(false)
  publicSlug                   String?               @unique
  publicEnabledAt              DateTime?
  publicHeadline               String?
  publicDescription            String?
  media                        String[]
  locationCity                 String?
  locationState                String?
  locationCountry              String?
  status                       BreedingProgramStatus @default(ACTIVE)
  createdAt                    DateTime              @default(now())
  updatedAt                    DateTime              @updatedAt
  tenant                       Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  listings                     BreedingListing[]

  @@index([tenantId, status])
  @@index([publicEnabled, status])
  @@index([publicSlug])
  @@schema("public")
}

model BreedingListing {
  id                        Int                          @id @default(autoincrement())
  tenantId                  Int
  listingNumber             String                       @unique
  animalId                  Int
  programId                 Int?
  species                   Species
  breed                     String?
  sex                       Sex
  intent                    BreedingListingIntent
  headline                  String
  description               String?
  media                     String[]
  feeCents                  Int?
  feeDirection              BreedingListingFeeDirection?
  feeNotes                  String?
  availableFrom             DateTime?
  availableTo               DateTime?
  seasonName                String?
  breedingMethods           String[]
  maxBookings               Int?
  currentBookings           Int                          @default(0)
  guaranteeType             String?
  guaranteeTerms            String?
  requiresHealthTesting     Boolean                      @default(false)
  requiredTests             String[]
  requiresContract          Boolean                      @default(false)
  additionalRequirements    String?
  status                    BreedingListingStatus        @default(DRAFT)
  publishedAt               DateTime?
  pausedAt                  DateTime?
  closedAt                  DateTime?
  closedReason              String?
  publicEnabled             Boolean                      @default(false)
  publicSlug                String?                      @unique
  publicEnabledAt           DateTime?
  publicShowPedigree        Boolean                      @default(true)
  publicPedigreeDepth       Int                          @default(2)
  publicShowTitles          Boolean                      @default(true)
  publicShowHealthTesting   Boolean                      @default(true)
  publicShowLineType        Boolean                      @default(true)
  publicShowProducingStats  Boolean                      @default(false)
  publicShowBreederName     Boolean                      @default(true)
  publicShowBreederLocation Boolean                      @default(true)
  publicShowFee             Boolean                      @default(true)
  metaTitle                 String?
  metaDescription           String?
  acceptInquiries           Boolean                      @default(true)
  inquiryEmail              String?
  inquiryPhone              String?
  inquiryInstructions       String?
  viewCount                 Int                          @default(0)
  inquiryCount              Int                          @default(0)
  bookingCount              Int                          @default(0)
  locationCity              String?
  locationState             String?
  locationCountry           String?
  locationLat               Float?
  locationLng               Float?
  createdAt                 DateTime                     @default(now())
  updatedAt                 DateTime                     @updatedAt
  createdBy                 Int?
  bookings                  BreedingBooking[]
  inquiries                 BreedingInquiry[]
  animal                    Animal                       @relation(fields: [animalId], references: [id])
  program                   BreedingDiscoveryProgram?    @relation(fields: [programId], references: [id])
  tenant                    Tenant                       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([species, breed, status])
  @@index([species, intent, status])
  @@index([publicEnabled, status])
  @@index([publicSlug])
  @@index([locationState, species])
  @@index([animalId])
  @@index([programId])
  @@schema("public")
}

model BreedingInquiry {
  id                   Int                   @id @default(autoincrement())
  tenantId             Int
  listingId            Int
  inquirerName         String
  inquirerEmail        String
  inquirerPhone        String?
  inquirerType         String
  isBreeder            Boolean               @default(false)
  message              String
  interestedInMethod   String?
  status               BreedingInquiryStatus @default(NEW)
  readAt               DateTime?
  repliedAt            DateTime?
  convertedToUserId    Int?
  convertedToBookingId Int?
  convertedAt          DateTime?
  referrerUrl          String?
  utmSource            String?
  utmMedium            String?
  utmCampaign          String?
  createdAt            DateTime              @default(now())
  listing              BreedingListing       @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([listingId])
  @@index([inquirerEmail])
  @@schema("public")
}

model BreedingBooking {
  id                  Int                         @id @default(autoincrement())
  bookingNumber       String                      @unique
  sourceListingId     Int?
  sourceInquiryId     Int?
  offeringTenantId    Int
  offeringAnimalId    Int
  seekingPartyId      Int
  seekingTenantId     Int?
  seekingAnimalId     Int?
  externalAnimalName  String?
  externalAnimalReg   String?
  externalAnimalBreed String?
  externalAnimalSex   String?
  species             Species
  bookingType         BreedingBookingType
  preferredMethod     String?
  preferredDateStart  DateTime?
  preferredDateEnd    DateTime?
  scheduledDate       DateTime?
  shippingRequired    Boolean                     @default(false)
  shippingAddress     String?
  agreedFeeCents      Int
  depositCents        Int                         @default(0)
  totalPaidCents      Int                         @default(0)
  feeDirection        BreedingListingFeeDirection
  status              BreedingBookingStatus       @default(INQUIRY)
  statusChangedAt     DateTime                    @default(now())
  requirements        Json?
  requirementsConfig  String?
  guaranteeType       String?
  breedingPlanId      Int?                        @unique
  notes               String?
  internalNotes       String?
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  cancelledAt         DateTime?
  cancellationReason  String?
  outcomeRecordedAt   DateTime?
  outcomeType         String?                     @db.VarChar(50)
  semenUsageId        Int?                        @unique
  breedingPlan        BreedingPlan?               @relation(fields: [breedingPlanId], references: [id])
  offeringAnimal      Animal                      @relation("OfferingAnimal", fields: [offeringAnimalId], references: [id])
  offeringTenant      Tenant                      @relation("OfferingBookings", fields: [offeringTenantId], references: [id])
  seekingAnimal       Animal?                     @relation("SeekingAnimal", fields: [seekingAnimalId], references: [id])
  seekingParty        Party                       @relation(fields: [seekingPartyId], references: [id])
  seekingTenant       Tenant?                     @relation("SeekingBookings", fields: [seekingTenantId], references: [id])
  semenUsage          SemenUsage?                 @relation(fields: [semenUsageId], references: [id])
  sourceListing       BreedingListing?            @relation(fields: [sourceListingId], references: [id])

  @@index([offeringTenantId, status])
  @@index([seekingTenantId, status])
  @@index([sourceListingId])
  @@index([seekingPartyId])
  @@index([offeringAnimalId])
  @@schema("public")
}

model AnimalBreedingProfile {
  id                      Int                     @id @default(autoincrement())
  tenantId                Int
  animalId                Int                     @unique
  breedingStatus          String                  @default("INTACT")
  statusNotes             String?
  statusChangedAt         DateTime?
  environmentPreference   String?                 @db.VarChar(50)
  environmentNotes        String?
  temperament             String?                 @db.VarChar(50)
  temperamentNotes        String?
  specialRequirements     String?
  generalNotes            String?
  libido                  String?                 @db.VarChar(20)
  libidoNotes             String?
  serviceType             String?                 @db.VarChar(20)
  collectionTrained       Boolean?
  collectionNotes         String?
  fertilityStatus         String?                 @db.VarChar(20)
  lastFertilityTestDate   DateTime?               @db.Date
  lastFertilityTestResult String?
  fertilityNotes          String?
  heatCycleRegularity     String?                 @db.VarChar(20)
  avgCycleLengthDays      Int?
  lastHeatDate            DateTime?               @db.Date
  heatNotes               String?
  pregnancyComplications  String?
  proneToComplications    Boolean                 @default(false)
  naturalBirthCount       Int                     @default(0)
  cSectionCount           Int                     @default(0)
  cSectionNotes           String?
  lastBirthType           String?                 @db.VarChar(20)
  lastBirthDate           DateTime?               @db.Date
  maternalRating          String?                 @db.VarChar(20)
  maternalNotes           String?
  milkProduction          String?                 @db.VarChar(20)
  mastitisHistory         Boolean                 @default(false)
  milkNotes               String?
  recoveryPattern         String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  animal                  Animal                  @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenant                  Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  incompatibilities       AnimalIncompatibility[]

  @@index([tenantId, animalId])
  @@index([tenantId, breedingStatus])
  @@schema("public")
}

model AnimalIncompatibility {
  id                   Int                   @id @default(autoincrement())
  tenantId             Int
  profileId            Int
  incompatibleAnimalId Int
  reason               String                @db.VarChar(500)
  severity             String                @default("AVOID") @db.VarChar(20)
  recordedAt           DateTime              @default(now())
  recordedBy           String?               @db.VarChar(255)
  incompatibleAnimal   Animal                @relation("IncompatibleWith", fields: [incompatibleAnimalId], references: [id], onDelete: Cascade)
  profile              AnimalBreedingProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([profileId, incompatibleAnimalId])
  @@index([tenantId])
  @@index([profileId])
  @@schema("public")
}

model BreedingEvent {
  id                 Int           @id @default(autoincrement())
  tenantId           Int
  animalId           Int
  eventType          String        @db.VarChar(50)
  occurredAt         DateTime
  outcome            String?       @db.VarChar(30)
  breedingPlanId     Int?
  partnerAnimalId    Int?
  title              String?       @db.VarChar(200)
  description        String?
  serviceType        String?       @db.VarChar(20)
  tieDurationMinutes Int?
  totalBorn          Int?
  bornAlive          Int?
  stillborn          Int?
  deliveryType       String?       @db.VarChar(20)
  testType           String?       @db.VarChar(100)
  testResult         String?
  createdAt          DateTime      @default(now())
  createdBy          String?       @db.VarChar(255)
  updatedAt          DateTime      @updatedAt
  animal             Animal        @relation("BreedingEvents", fields: [animalId], references: [id], onDelete: Cascade)
  breedingPlan       BreedingPlan? @relation(fields: [breedingPlanId], references: [id])
  partnerAnimal      Animal?       @relation("PartnerBreedingEvents", fields: [partnerAnimalId], references: [id])
  tenant             Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, animalId, occurredAt])
  @@index([tenantId, eventType])
  @@index([breedingPlanId])
  @@schema("public")
}

model RearingProtocol {
  id                    Int                         @id @default(autoincrement())
  tenantId              Int?
  name                  String
  description           String?
  species               Species
  isBenchmark           Boolean                     @default(false)
  isPublic              Boolean                     @default(false)
  isActive              Boolean                     @default(true)
  version               Int                         @default(1)
  parentProtocolId      Int?
  isArchived            Boolean                     @default(false)
  targetAgeStart        Int
  targetAgeEnd          Int
  estimatedDailyMinutes Int?
  breederName           String?
  rating                Float                       @default(0)
  ratingCount           Int                         @default(0)
  usageCount            Int                         @default(0)
  publishedAt           DateTime?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  deletedAt             DateTime?
  copiedAt              DateTime?
  originBreederName     String?
  comments              ProtocolComment[]
  copyRecords           ProtocolCopyRecord[]
  ratings               ProtocolRating[]
  parentProtocol        RearingProtocol?            @relation("ProtocolVersions", fields: [parentProtocolId], references: [id])
  childProtocols        RearingProtocol[]           @relation("ProtocolVersions")
  tenant                Tenant?                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignments           RearingProtocolAssignment[]
  stages                RearingProtocolStage[]

  @@index([tenantId])
  @@index([species, isActive])
  @@index([isPublic, species])
  @@index([isBenchmark])
  @@index([deletedAt])
  @@schema("public")
}

model RearingProtocolStage {
  id           String                    @id @default(uuid())
  protocolId   Int
  name         String
  description  String?
  ageStartDays Int
  ageEndDays   Int
  order        Int
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  activities   RearingProtocolActivity[]
  protocol     RearingProtocol           @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  @@index([protocolId, order])
  @@schema("public")
}

model RearingProtocolActivity {
  id                String               @id @default(uuid())
  stageId           String
  name              String
  description       String?
  instructions      String?
  category          ActivityCategory
  frequency         ActivityFrequency
  durationMinutes   Int?
  isRequired        Boolean              @default(true)
  requiresEquipment String[]             @default([])
  order             Int
  checklistItems    Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  stage             RearingProtocolStage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([stageId, order])
  @@schema("public")
}

model RearingProtocolAssignment {
  id                     Int                           @id @default(autoincrement())
  tenantId               Int
  offspringGroupId       Int?
  protocolId             Int
  protocolVersion        Int
  protocolSnapshot       Json?
  availableUpgrade       Int?
  startDate              DateTime
  status                 RearingAssignmentStatus       @default(ACTIVE)
  acknowledgedDisclaimer Boolean                       @default(false)
  acknowledgedAt         DateTime?
  acknowledgedBy         String?
  completedActivities    Int                           @default(0)
  totalActivities        Int                           @default(0)
  notes                  String?
  createdAt              DateTime                      @default(now())
  updatedAt              DateTime                      @updatedAt
  animalId               Int?
  handoffAt              DateTime?
  handoffByUserId        String?
  handoffFromStage       Int?
  handoffNotes           String?
  handoffSnapshot        Json?
  handoffToUserId        String?
  offspringId            Int?
  completions            ActivityCompletion[]
  assessments            AssessmentResult[]
  overrides              AssignmentOffspringOverride[]
  exceptions             OffspringProtocolException[]
  certificates           RearingCertificate[]
  animal                 Animal?                       @relation("AnimalProtocolAssignment", fields: [animalId], references: [id], onDelete: Cascade)
  handoffByUser          User?                         @relation("ProtocolHandoffInitiator", fields: [handoffByUserId], references: [id])
  handoffToUser          User?                         @relation("ProtocolHandoffRecipient", fields: [handoffToUserId], references: [id])
  offspringGroup         OffspringGroup?               @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)
  offspring              Offspring?                    @relation("OffspringProtocolAssignment", fields: [offspringId], references: [id], onDelete: Cascade)
  protocol               RearingProtocol               @relation(fields: [protocolId], references: [id])
  tenant                 Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([offspringGroupId, protocolId])
  @@unique([offspringId, protocolId])
  @@unique([animalId, protocolId])
  @@index([tenantId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([animalId])
  @@index([protocolId])
  @@index([status])
  @@index([handoffToUserId])
  @@schema("public")
}

model ActivityCompletion {
  id               Int                       @id @default(autoincrement())
  tenantId         Int
  assignmentId     Int
  activityId       String
  scope            RearingCompletionScope
  offspringId      Int?
  completedAt      DateTime                  @default(now())
  completedBy      String
  checklistItemKey String?
  notes            String?
  createdAt        DateTime                  @default(now())
  assignment       RearingProtocolAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  offspring        Offspring?                @relation(fields: [offspringId], references: [id])
  tenant           Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, activityId, offspringId, checklistItemKey])
  @@index([tenantId])
  @@index([assignmentId, activityId])
  @@index([offspringId])
  @@schema("public")
}

model OffspringProtocolException {
  id               Int                       @id @default(autoincrement())
  tenantId         Int
  assignmentId     Int
  offspringId      Int
  activityId       String
  checklistItemKey String?
  exceptionType    RearingExceptionType
  reason           String
  startDate        DateTime?
  endDate          DateTime?
  createdBy        String
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  assignment       RearingProtocolAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  offspring        Offspring                 @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  tenant           Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([assignmentId])
  @@index([offspringId])
  @@schema("public")
}

model AssignmentOffspringOverride {
  id              Int                       @id @default(autoincrement())
  assignmentId    Int
  offspringId     Int
  customStartDate DateTime?
  skipToStage     String?
  notes           String?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  assignment      RearingProtocolAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  offspring       Offspring                 @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, offspringId])
  @@schema("public")
}

model ProtocolRating {
  id         Int             @id @default(autoincrement())
  protocolId Int
  tenantId   Int
  rating     Int
  review     String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  protocol   RearingProtocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([protocolId, tenantId])
  @@index([protocolId])
  @@schema("public")
}

model ProtocolComment {
  id         Int               @id @default(autoincrement())
  protocolId Int
  tenantId   Int
  content    String
  parentId   Int?
  authorName String
  isHidden   Boolean           @default(false)
  hiddenAt   DateTime?
  hiddenBy   String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  parent     ProtocolComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    ProtocolComment[] @relation("CommentReplies")
  protocol   RearingProtocol   @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([protocolId, createdAt])
  @@index([parentId])
  @@schema("public")
}

model ProtocolCopyRecord {
  id         Int             @id @default(autoincrement())
  protocolId Int
  tenantId   Int
  copiedAt   DateTime        @default(now())
  protocol   RearingProtocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([protocolId, tenantId])
  @@index([protocolId])
  @@schema("public")
}

model AssessmentResult {
  id             Int                       @id @default(autoincrement())
  tenantId       Int
  assignmentId   Int
  offspringId    Int
  assessmentType AssessmentType
  scores         Json
  notes          String?
  assessedAt     DateTime                  @default(now())
  assessedBy     String
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  assignment     RearingProtocolAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  offspring      Offspring                 @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  tenant         Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([assignmentId])
  @@index([offspringId])
  @@schema("public")
}

model RearingCertificate {
  id              String                    @id @default(uuid())
  tenantId        Int
  assignmentId    Int
  offspringId     Int
  offspringName   String
  protocolName    String
  breederName     String
  completedAt     DateTime
  issuedAt        DateTime                  @default(now())
  isValid         Boolean                   @default(true)
  revokedAt       DateTime?
  revokedReason   String?
  buyerName       String?
  buyerUserId     String?
  certificateType RearingCertificateType    @default(FULL_PROTOCOL)
  stageCompleted  Int?
  stageData       Json?
  assignment      RearingProtocolAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  offspring       Offspring                 @relation(fields: [offspringId], references: [id], onDelete: Cascade)
  tenant          Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([assignmentId])
  @@index([offspringId])
  @@index([isValid])
  @@index([certificateType])
  @@schema("public")
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  userId    String
  tokenHash String    @unique @db.VarChar(64)
  deviceId  String?   @db.VarChar(255)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
  @@schema("public")
}

model MarketplaceMobileRefreshToken {
  id        Int             @id @default(autoincrement())
  userId    Int             @map("user_id")
  tokenHash String          @unique @map("token_hash") @db.VarChar(64)
  deviceId  String?         @map("device_id") @db.VarChar(255)
  expiresAt DateTime        @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt DateTime?       @map("revoked_at") @db.Timestamptz(6)
  user      MarketplaceUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("mobile_refresh_tokens")
  @@schema("marketplace")
}

model Device {
  id        Int      @id @default(autoincrement())
  userId    String
  fcmToken  String   @db.VarChar(255)
  platform  String   @db.VarChar(10)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fcmToken])
  @@index([userId])
  @@map("devices")
  @@schema("public")
}

/// *
/// * BreedingGroup - A group mating scenario where one male is introduced
/// * to multiple females for an exposure window.
/// * Used for livestock species: sheep (tupping), cattle (joining), goat, pig
model BreedingGroup {
  id                Int                        @id @default(autoincrement())
  tenantId          Int
  organizationId    Int?
  programId         Int?
  name              String
  species           Species
  breedText         String?
  seasonLabel       String?
  notes             String?
  sireId            Int
  exposureStartDate DateTime
  exposureEndDate   DateTime?
  status            BreedingGroupStatus        @default(ACTIVE)
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  deletedAt         DateTime?
  organization      Organization?              @relation(fields: [organizationId, tenantId], references: [id, tenantId])
  program           MktListingBreedingProgram? @relation(fields: [programId], references: [id])
  sire              Animal                     @relation("BreedingGroupSire", fields: [sireId], references: [id])
  tenant            Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members           BreedingGroupMember[]

  @@index([tenantId])
  @@index([tenantId, species])
  @@index([tenantId, status])
  @@index([organizationId])
  @@index([sireId])
  @@index([programId])
  @@index([exposureStartDate])
  @@index([deletedAt])
  @@schema("public")
}

/// *
/// * BreedingGroupMember - An individual female in a breeding group.
/// * When confirmed pregnant, a BreedingPlan is auto-created and linked.
model BreedingGroupMember {
  id                   Int                       @id @default(autoincrement())
  tenantId             Int
  groupId              Int
  damId                Int
  memberStatus         BreedingGroupMemberStatus @default(EXPOSED)
  exposedAt            DateTime?
  removedAt            DateTime?
  pregnancyConfirmedAt DateTime?
  pregnancyCheckMethod PregnancyCheckMethod?
  breedingPlanId       Int?                      @unique
  expectedBirthStart   DateTime?
  expectedBirthEnd     DateTime?
  actualBirthDate      DateTime?
  offspringCount       Int?
  notes                String?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  birthNotes           String?
  liveCount            Int?
  stillbornCount       Int?
  breedingPlan         BreedingPlan?             @relation("GroupMemberPlan", fields: [breedingPlanId], references: [id])
  dam                  Animal                    @relation("BreedingGroupDam", fields: [damId], references: [id])
  group                BreedingGroup             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tenant               Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([groupId, damId])
  @@index([tenantId])
  @@index([groupId])
  @@index([damId])
  @@index([memberStatus])
  @@index([breedingPlanId])
  @@index([expectedBirthStart])
  @@schema("public")
}

/// ShareCode - Generates shareable codes for animal access
model ShareCode {
  id                Int              @id @default(autoincrement())
  tenantId          Int
  code              String           @unique
  animalIds         Int[]
  defaultAccessTier AnimalAccessTier @default(BASIC)
  perAnimalTiers    Json?
  expiresAt         DateTime?
  maxUses           Int?
  useCount          Int              @default(0)
  status            ShareCodeStatus  @default(ACTIVE)
  revokedAt         DateTime?
  createdAt         DateTime         @default(now())
  accesses          AnimalAccess[]
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([code])
  @@index([expiresAt])
  @@schema("public")
}

/// AnimalAccess - Shadow animal relationship (cross-tenant animal sharing)
model AnimalAccess {
  id                    Int                       @id @default(autoincrement())
  ownerTenantId         Int
  accessorTenantId      Int
  animalId              Int?
  accessTier            AnimalAccessTier          @default(BASIC)
  source                AnimalAccessSource
  shareCodeId           Int?
  breedingPlanId        Int?
  status                AnimalAccessStatus        @default(ACTIVE)
  expiresAt             DateTime?
  animalNameSnapshot    String?
  animalSpeciesSnapshot Species?
  animalSexSnapshot     Sex?
  deletedAt             DateTime?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  accessorTenant        Tenant                    @relation("AnimalAccessAccessor", fields: [accessorTenantId], references: [id], onDelete: Cascade)
  animal                Animal?                   @relation("AnimalAccessAnimal", fields: [animalId], references: [id])
  breedingPlan          BreedingPlan?             @relation("AnimalAccessBreedingPlan", fields: [breedingPlanId], references: [id])
  ownerTenant           Tenant                    @relation("AnimalAccessOwner", fields: [ownerTenantId], references: [id], onDelete: Cascade)
  shareCode             ShareCode?                @relation(fields: [shareCodeId], references: [id])
  conversation          AnimalAccessConversation? @relation("AnimalAccessConversationAccess")
  breedingAgreements    BreedingDataAgreement[]   @relation("BreedingAgreementAccess")

  @@unique([animalId, accessorTenantId])
  @@index([ownerTenantId, status])
  @@index([accessorTenantId, status])
  @@index([animalId])
  @@index([shareCodeId])
  @@index([status, deletedAt])
  @@index([expiresAt])
  @@schema("public")
}

/// AnimalAccessConversation - Links an AnimalAccess record to a MessageThread
/// Created lazily when either party starts a conversation about a shared animal
model AnimalAccessConversation {
  id              Int           @id @default(autoincrement())
  animalAccessId  Int           @unique
  messageThreadId Int           @unique
  createdAt       DateTime      @default(now())
  animalAccess    AnimalAccess  @relation("AnimalAccessConversationAccess", fields: [animalAccessId], references: [id], onDelete: Cascade)
  messageThread   MessageThread @relation("AnimalAccessConversationThread", fields: [messageThreadId], references: [id], onDelete: Cascade)

  @@index([animalAccessId])
  @@index([messageThreadId])
  @@schema("public")
}

/// NetworkSearchIndex - Privacy-preserving search index (no animal identity exposed)
/// Stores aggregated traits per tenant/species/sex for network breeding discovery search
model NetworkSearchIndex {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  species          Species
  sex              Sex
  geneticTraits    Json
  physicalTraits   Json?
  healthClearances Json?
  animalCount      Int      @default(1)
  lastRebuiltAt    DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, species, sex])
  @@index([species, sex])
  @@index([tenantId])
  @@schema("public")
}

/// NetworkBreedingInquiry - Tracks breeding inquiries sent between breeders via network search
/// Distinct from BreedingInquiry (marketplace listing inquiries)
model NetworkBreedingInquiry {
  id                Int                  @id @default(autoincrement())
  senderTenantId    Int
  recipientTenantId Int
  searchCriteria    Json
  matchingAnimalIds Int[]
  matchedTraits     String[]
  message           String?
  status            NetworkInquiryStatus @default(PENDING)
  respondedAt       DateTime?
  messageThreadId   Int?                 @unique
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  messageThread     MessageThread?       @relation("NetworkBreedingInquiryThread", fields: [messageThreadId], references: [id])
  recipientTenant   Tenant               @relation("NetworkBreedingInquiryRecipient", fields: [recipientTenantId], references: [id], onDelete: Cascade)
  senderTenant      Tenant               @relation("NetworkBreedingInquirySender", fields: [senderTenantId], references: [id], onDelete: Cascade)

  @@index([senderTenantId, status])
  @@index([recipientTenantId, status])
  @@index([createdAt])
  @@schema("public")
}

/// BreedingDataAgreement - Formal breeding collaboration agreement
/// Created when a shadow animal is added to a breeding plan, requiring owner approval
model BreedingDataAgreement {
  id                 String                  @id @default(uuid())
  breedingPlanId     Int
  animalAccessId     Int
  requestingTenantId Int
  approvingTenantId  Int
  animalRole         String
  status             BreedingAgreementStatus @default(PENDING)
  requestedAt        DateTime                @default(now())
  approvedAt         DateTime?
  rejectedAt         DateTime?
  requestMessage     String?
  responseMessage    String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  animalAccess       AnimalAccess            @relation("BreedingAgreementAccess", fields: [animalAccessId], references: [id])
  approvingTenant    Tenant                  @relation("BreedingAgreementApprover", fields: [approvingTenantId], references: [id], onDelete: Cascade)
  breedingPlan       BreedingPlan            @relation("BreedingAgreementPlan", fields: [breedingPlanId], references: [id], onDelete: Cascade)
  requestingTenant   Tenant                  @relation("BreedingAgreementRequester", fields: [requestingTenantId], references: [id], onDelete: Cascade)

  @@unique([breedingPlanId, animalAccessId])
  @@index([requestingTenantId, status])
  @@index([approvingTenantId, status])
  @@index([status])
  @@schema("public")
}

/// ListingBoost - Paid promotion for marketplace listings
/// Polymorphic design: listingType + listingId reference any of the 7 listing types
model ListingBoost {
  id                Int                @id @default(autoincrement())
  tenantId          Int?
  providerId        Int?
  listingType       ListingBoostTarget
  listingId         Int
  tier              BoostTier
  weight            Float
  durationDays      Int
  status            BoostStatus        @default(PENDING)
  startsAt          DateTime?
  expiresAt         DateTime?
  autoRenew         Boolean            @default(false)
  amountCents       Int
  currency          String             @default("USD") @db.VarChar(3)
  stripeSessionId   String?
  stripePaymentId   String?
  impressions       Int                @default(0)
  clicks            Int                @default(0)
  inquiries         Int                @default(0)
  expiryNotifiedAt  DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  expiredNotifiedAt DateTime?

  @@index([tenantId])
  @@index([providerId])
  @@index([listingType, listingId])
  @@index([status, expiresAt])
  @@index([listingType, status, tier])
  @@schema("public")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_activity {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  entityType  String   @db.VarChar(50)
  entityId    Int
  kind        String   @db.VarChar(50)
  category    String   @default("system") @db.VarChar(30)
  title       String   @db.VarChar(500)
  description String?
  metadata    Json?
  actorId     String?  @db.VarChar(64)
  actorName   String?  @db.VarChar(200)
  createdAt   DateTime @default(now()) @db.Timestamp(6)

  @@index([tenantId, createdAt(sort: Desc)], map: "idx_ea_tenant_created")
  @@index([tenantId, entityType, entityId, createdAt(sort: Desc)], map: "idx_ea_tenant_entity")
  @@schema("public")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_audit_log {
  id            BigInt   @id @default(autoincrement())
  tenantId      Int
  entityType    String   @db.VarChar(50)
  entityId      Int
  action        String   @db.VarChar(20)
  fieldName     String?  @db.VarChar(100)
  oldValue      String?
  newValue      String?
  changedBy     String   @db.VarChar(64)
  changedByName String?  @db.VarChar(200)
  changeSource  String   @default("PLATFORM") @db.VarChar(30)
  ip            String?  @db.VarChar(45)
  requestId     String?  @db.VarChar(64)
  metadata      Json?
  createdAt     DateTime @default(now()) @db.Timestamp(6)

  @@index([changedBy, createdAt(sort: Desc)], map: "idx_eal_changed_by")
  @@index([tenantId, createdAt(sort: Desc)], map: "idx_eal_tenant_created")
  @@index([tenantId, entityType, entityId, createdAt(sort: Desc)], map: "idx_eal_tenant_entity")
  @@schema("public")
}

model international_waitlist {
  id           Int       @id @default(autoincrement())
  email        String    @db.VarChar(255)
  first_name   String?   @db.VarChar(100)
  last_name    String?   @db.VarChar(100)
  country      String    @db.VarChar(2)
  country_name String?   @db.VarChar(100)
  source       String    @default("registration_gate") @db.VarChar(50)
  notes        String?
  notified_at  DateTime? @db.Timestamp(6)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @default(now())

  @@unique([email, country], map: "idx_intl_waitlist_email_country")
  @@index([country], map: "idx_intl_waitlist_country")
  @@index([notified_at], map: "idx_intl_waitlist_notified_at")
  @@schema("marketplace")
}

model BreedingPlanTempLog {
  id           Int          @id @default(autoincrement())
  planId       Int
  tenantId     Int
  recordedAt   DateTime     @db.Timestamptz(3)
  temperatureF Decimal      @db.Decimal(5, 2)
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  BreedingPlan BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  Tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([tenantId])
  @@schema("public")
}
enum PartyType {
  CONTACT
  ORGANIZATION

  @@schema("public")
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER

  @@schema("public")
}

enum AnimalStatus {
  ACTIVE
  BREEDING
  UNAVAILABLE
  RETIRED
  DECEASED
  PROSPECT

  @@schema("public")
}

enum Species {
  DOG
  CAT
  HORSE
  GOAT
  RABBIT
  SHEEP
  CATTLE
  PIG
  ALPACA
  LLAMA

  @@schema("public")
}

enum TenantOperationType {
  HOBBY
  COMMERCIAL
  PERFORMANCE

  @@schema("public")
}

enum HorseIntendedUse {
  BREEDING
  SHOW
  RACING

  @@schema("public")
}

enum HorseValuationSource {
  PRIVATE_SALE
  AUCTION
  APPRAISAL
  INSURANCE
  OTHER

  @@schema("public")
}

enum OwnershipChangeKind {
  SALE
  SYNDICATION
  TRANSFER
  LEASE
  DEATH
  OTHER

  @@schema("public")
}

enum OwnerRole {
  SOLE_OWNER
  CO_OWNER
  MANAGING_PARTNER
  SILENT_PARTNER
  BREEDING_RIGHTS
  INVESTOR

  @@schema("public")
}

enum PaymentIntentStatus {
  PLANNED
  EXTERNAL
  COMPLETED
  CANCELED

  @@schema("public")
}

enum PaymentIntentPurpose {
  DEPOSIT
  PURCHASE
  STUD_FEE
  BOARDING
  TRAINING
  OTHER

  @@schema("public")
}

enum Sex {
  FEMALE
  MALE
  UNKNOWN

  @@schema("public")
}

enum TagModule {
  CONTACT
  ORGANIZATION
  ANIMAL
  WAITLIST_ENTRY
  OFFSPRING_GROUP
  OFFSPRING
  MESSAGE_THREAD
  DRAFT
  BREEDING_PLAN
  BUYER
  DEAL
  DOCUMENT
  MEDIA

  @@schema("public")
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
  VIEWER

  @@schema("public")
}

enum TenantMembershipRole {
  STAFF
  CLIENT

  @@schema("public")
}

enum TenantMembershipStatus {
  INVITED
  ACTIVE
  SUSPENDED

  @@schema("public")
}

enum VerificationPurpose {
  VERIFY_EMAIL
  RESET_PASSWORD
  INVITE
  OTHER

  @@schema("public")
}

enum PortalAccessStatus {
  NO_ACCESS
  INVITED
  ACTIVE
  SUSPENDED

  @@schema("public")
}

enum EntitlementKey {
  MARKETPLACE_ACCESS
  PLATFORM_ACCESS
  PORTAL_ACCESS
  BREEDING_PLANS
  FINANCIAL_SUITE
  DOCUMENT_MANAGEMENT
  HEALTH_RECORDS
  WAITLIST_MANAGEMENT
  ADVANCED_REPORTING
  API_ACCESS
  MULTI_LOCATION
  E_SIGNATURES
  ANIMAL_QUOTA
  CONTACT_QUOTA
  PORTAL_USER_QUOTA
  BREEDING_PLAN_QUOTA
  MARKETPLACE_LISTING_QUOTA
  STORAGE_QUOTA_GB
  SMS_QUOTA
  DATA_EXPORT
  GENETICS_STANDARD
  GENETICS_PRO

  @@schema("public")
}

enum FeatureModule {
  GENETICS
  MARKETPLACE
  FINANCIAL
  ANIMALS
  CONTACTS
  BREEDING
  DOCUMENTS
  HEALTH
  SCHEDULING
  PORTAL
  REPORTING
  SETTINGS
  DASHBOARD

  @@schema("public")
}

enum EntitlementStatus {
  ACTIVE
  REVOKED

  @@schema("public")
}

enum ProductType {
  SUBSCRIPTION
  ADD_ON
  ONE_TIME

  @@schema("public")
}

enum BillingInterval {
  MONTHLY
  YEARLY
  QUARTERLY

  @@schema("public")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
  INCOMPLETE
  PAUSED

  @@schema("public")
}

enum UsageMetricKey {
  ANIMAL_COUNT
  CONTACT_COUNT
  PORTAL_USER_COUNT
  BREEDING_PLAN_COUNT
  MARKETPLACE_LISTING_COUNT
  STORAGE_BYTES
  SMS_SENT
  API_CALLS

  @@schema("public")
}

enum ListingType {
  BREEDING_PROGRAM
  STUD_SERVICE
  TRAINING
  VETERINARY
  PHOTOGRAPHY
  GROOMING
  TRANSPORT
  BOARDING
  PRODUCT
  OTHER_SERVICE

  @@schema("public")
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  EXPIRED
  REMOVED

  @@schema("public")
}

enum ListingTier {
  FREE
  PREMIUM
  BUSINESS

  @@schema("public")
}

enum CommChannel {
  EMAIL
  SMS
  PHONE
  MAIL
  WHATSAPP

  @@schema("public")
}

enum PreferenceLevel {
  ALLOW
  NOT_PREFERRED
  NEVER

  @@schema("public")
}

enum ComplianceStatus {
  SUBSCRIBED
  UNSUBSCRIBED

  @@schema("public")
}

enum BuyerStatus {
  LEAD
  ACTIVE
  QUALIFIED
  NEGOTIATING
  PURCHASED
  INACTIVE
  ARCHIVED

  @@schema("public")
}

enum InterestLevel {
  BROWSING
  INTERESTED
  SERIOUS
  OFFERED
  DECLINED

  @@schema("public")
}

enum DealStage {
  INQUIRY
  VIEWING
  NEGOTIATION
  VET_CHECK
  CONTRACT
  CLOSED_WON
  CLOSED_LOST

  @@schema("public")
}

enum DealOutcome {
  WON
  LOST
  CANCELLED

  @@schema("public")
}

enum DealActivityType {
  CALL
  EMAIL
  MEETING
  VIEWING
  NOTE
  STATUS_CHANGE
  OFFER_MADE
  OFFER_RECEIVED
  CONTRACT_SENT
  CONTRACT_SIGNED

  @@schema("public")
}

enum BuyerEmailTemplateCategory {
  GENERAL
  INITIAL_CONTACT
  FOLLOW_UP
  VIEWING
  NEGOTIATION
  CLOSING

  @@schema("public")
}

enum BuyerTaskType {
  FOLLOW_UP
  CALL
  EMAIL
  SCHEDULE_VIEWING
  SEND_INFO
  VET_CHECK
  CONTRACT
  PAYMENT
  OTHER

  @@schema("public")
}

enum BuyerTaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT

  @@schema("public")
}

enum BuyerTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DEFERRED

  @@schema("public")
}

enum TraitValueType {
  BOOLEAN
  ENUM
  NUMBER
  DATE
  TEXT
  JSON

  @@schema("public")
}

enum TraitSource {
  SELF_REPORTED
  VET
  LAB
  REGISTRY

  @@schema("public")
}

enum TraitStatus {
  NOT_PROVIDED
  PROVIDED
  PENDING
  PASS
  FAIL

  @@schema("public")
}

enum DocVisibility {
  PRIVATE
  BUYERS
  PUBLIC

  @@schema("public")
}

enum DocStatus {
  PLACEHOLDER
  UPLOADING
  READY
  FAILED

  @@schema("public")
}

enum MediaAccessType {
  VIEW
  DOWNLOAD
  SHARE

  @@schema("public")
}

enum MediaAccessActor {
  OWNER
  BUYER
  PUBLIC
  PORTAL

  @@schema("public")
}

enum ActivityCategory {
  ENS
  ESI
  SOCIALIZATION
  HANDLING
  ENRICHMENT
  TRAINING
  HEALTH
  ASSESSMENT
  TRANSITION
  CUSTOM

  @@schema("public")
}

enum ActivityFrequency {
  ONCE
  DAILY
  TWICE_DAILY
  WEEKLY
  AS_AVAILABLE
  CHECKLIST

  @@schema("public")
}

enum RearingAssignmentStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED

  @@schema("public")
}

enum RearingExceptionType {
  SKIPPED
  DELAYED
  MODIFIED
  UNABLE_TO_COMPLETE

  @@schema("public")
}

enum RearingCompletionScope {
  LITTER
  INDIVIDUAL

  @@schema("public")
}

enum AssessmentType {
  VOLHARD_PAT
  CUSTOM

  @@schema("public")
}

enum BreedingPlanStatus {
  PLANNING
  COMMITTED
  CYCLE_EXPECTED
  HORMONE_TESTING
  BRED
  PREGNANT
  BIRTHED
  WEANED
  PLACEMENT
  COMPLETE
  CANCELED
  CYCLE
  UNSUCCESSFUL
  ON_HOLD
  PLAN_COMPLETE

  @@schema("public")
}

/// User-selected primary anchor mode for a breeding plan
enum ReproAnchorMode {
  CYCLE_START
  OVULATION
  BREEDING_DATE

  @@schema("public")
}

/// Anchor type used for timeline calculations
enum AnchorType {
  CYCLE_START
  OVULATION
  BREEDING_DATE
  BIRTH
  LOCKED_CYCLE

  @@schema("public")
}

/// How the ovulation date was determined
enum OvulationMethod {
  CALCULATED
  PROGESTERONE_TEST
  LH_TEST
  ULTRASOUND
  VAGINAL_CYTOLOGY
  PALPATION
  AT_HOME_TEST
  VETERINARY_EXAM
  BREEDING_INDUCED

  @@schema("public")
}

/// Confidence level for date accuracy
enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW

  @@schema("public")
}

/// How a date was determined (observed vs calculated)
enum DataSource {
  OBSERVED
  DERIVED
  ESTIMATED

  @@schema("public")
}

enum BreedingMethod {
  NATURAL
  AI_TCI
  AI_SI
  AI_FROZEN

  @@schema("public")
}

enum PregnancyCheckMethod {
  PALPATION
  ULTRASOUND
  RELAXIN_TEST
  XRAY
  OTHER

  @@schema("public")
}

enum BreedingGroupStatus {
  ACTIVE
  EXPOSURE_COMPLETE
  MONITORING
  LAMBING
  COMPLETE
  CANCELED

  @@schema("public")
}

enum BreedingGroupMemberStatus {
  EXPOSED
  REMOVED
  NOT_PREGNANT
  PREGNANT
  LAMBING_IMMINENT
  LAMBED
  FAILED

  @@schema("public")
}

enum BreedingGuaranteeType {
  NO_GUARANTEE
  LIVE_FOAL
  STANDS_AND_NURSES
  SIXTY_DAY_PREGNANCY
  CERTIFIED_PREGNANT

  @@schema("public")
}

enum GuaranteeResolution {
  NOT_TRIGGERED
  RETURN_BREEDING_GRANTED
  PARTIAL_REFUND
  FULL_REFUND
  WAIVED

  @@schema("public")
}

enum SemenCollectionMethod {
  AV
  EE
  MANUAL

  @@schema("public")
}

enum SemenStorageType {
  FRESH
  COOLED
  FROZEN

  @@schema("public")
}

enum SemenQualityGrade {
  EXCELLENT
  GOOD
  FAIR
  POOR

  @@schema("public")
}

enum SemenInventoryStatus {
  AVAILABLE
  RESERVED
  DEPLETED
  EXPIRED
  DISCARDED

  @@schema("public")
}

enum SemenUsageType {
  BREEDING_ON_SITE
  BREEDING_SHIPPED
  TRANSFERRED
  SAMPLE_TESTING
  DISCARDED

  @@schema("public")
}

enum GeneticSnoozeType {
  ANIMAL
  TEST
  ANIMAL_TEST

  @@schema("public")
}

enum SupplementTriggerType {
  BREEDING_CYCLE_RELATIVE
  AGE_BASED
  MANUAL

  @@schema("public")
}

enum BreedingCycleAnchorEvent {
  CYCLE_START
  BREED_DATE
  BIRTH_DATE
  WEANED_DATE

  @@schema("public")
}

enum SupplementFrequency {
  ONCE
  DAILY
  EVERY_OTHER_DAY
  EVERY_3_DAYS
  WEEKLY
  ONGOING

  @@schema("public")
}

enum SupplementScheduleMode {
  BREEDING_LINKED
  STANDALONE

  @@schema("public")
}

enum SupplementScheduleStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
  CANCELLED

  @@schema("public")
}

enum WaitlistStatus {
  INQUIRY
  DEPOSIT_DUE
  DEPOSIT_PAID
  READY
  ALLOCATED
  COMPLETED
  CANCELED
  APPROVED
  REJECTED

  @@schema("public")
}

enum BreedingPlanBuyerStage {
  POSSIBLE_MATCH
  INQUIRY
  ASSIGNED
  MATCHED_TO_OFFSPRING

  @@schema("public")
}

enum BreedingListingIntent {
  OFFERING
  SEEKING
  LEASE
  ARRANGEMENT

  @@schema("public")
}

enum BreedingListingStatus {
  DRAFT
  PUBLISHED
  PAUSED
  CLOSED

  @@schema("public")
}

enum BreedingListingFeeDirection {
  I_RECEIVE
  I_PAY
  SPLIT
  NEGOTIABLE

  @@schema("public")
}

enum BreedingInquiryStatus {
  NEW
  READ
  REPLIED
  CONVERTED
  ARCHIVED
  SPAM

  @@schema("public")
}

enum BreedingBookingStatus {
  INQUIRY
  PENDING_REQUIREMENTS
  APPROVED
  DEPOSIT_PAID
  CONFIRMED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@schema("public")
}

enum BreedingBookingType {
  STUD_SERVICE
  LEASE_BREEDING
  CO_OWN
  AI_SHIPPED
  NATURAL_COVER

  @@schema("public")
}

enum BreedingProgramStatus {
  ACTIVE
  PAUSED
  ARCHIVED

  @@schema("public")
}

enum ParentType {
  SIRE
  DAM

  @@schema("public")
}

enum LinkRequestStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
  REVOKED

  @@schema("public")
}

enum LinkMethod {
  GAID
  EXCHANGE_CODE
  REGISTRY_MATCH
  MICROCHIP_MATCH
  BREEDER_REQUEST
  OFFSPRING_DERIVED

  @@schema("public")
}

enum RevokedBy {
  CHILD_OWNER
  PARENT_OWNER
  SYSTEM

  @@schema("public")
}

/// *
/// * Offspring Group linking state
enum OffspringLinkState {
  linked
  orphan
  pending

  @@schema("public")
}

enum OffspringLinkReason {
  legacy_import
  rescue
  accidental
  third_party
  cobreeder
  placeholder
  historical
  other

  @@schema("public")
}

/// *
/// * Offspring lifecycle
enum OffspringStatus {
  NEWBORN
  ALIVE
  WEANED
  PLACED
  DECEASED

  @@schema("public")
}

enum OffspringLifeState {
  ALIVE
  DECEASED

  @@schema("public")
}

enum OffspringPlacementState {
  UNASSIGNED
  OPTION_HOLD
  RESERVED
  PLACED
  RETURNED
  TRANSFERRED

  @@schema("public")
}

enum OffspringKeeperIntent {
  AVAILABLE
  UNDER_EVALUATION
  WITHHELD
  KEEP

  @@schema("public")
}

enum OffspringFinancialState {
  NONE
  DEPOSIT_PENDING
  DEPOSIT_PAID
  PAID_IN_FULL
  REFUNDED
  CHARGEBACK

  @@schema("public")
}

enum OffspringPaperworkState {
  NONE
  SENT
  SIGNED
  COMPLETE

  @@schema("public")
}

/// *
/// * Animal marketplace listing enums
enum AnimalListingIntent {
  STUD
  BROOD_PLACEMENT
  REHOME
  GUARDIAN
  TRAINED
  WORKING
  STARTED
  CO_OWNERSHIP

  @@schema("public")
}

enum AnimalListingStatus {
  DRAFT
  LIVE
  PAUSED

  @@schema("public")
}

enum MarketplaceListingStatus {
  DRAFT
  LIVE
  PAUSED

  @@schema("public")
}

/// *
/// * 
/// * Notification System Enums
/// * 
enum NotificationType {
  vaccination_expiring_7d
  vaccination_expiring_3d
  vaccination_expiring_1d
  vaccination_overdue
  breeding_heat_cycle_expected
  breeding_hormone_testing_due
  breeding_window_approaching
  pregnancy_check_14d
  pregnancy_check_30d
  pregnancy_check_overdue
  foaling_30d
  foaling_14d
  foaling_7d
  foaling_approaching
  foaling_overdue
  marketplace_inquiry
  marketplace_waitlist_signup
  system_announcement
  foaling_270d
  foaling_300d
  foaling_320d
  foaling_330d
  contract_sent
  contract_reminder_7d
  contract_reminder_3d
  contract_reminder_1d
  contract_signed
  contract_declined
  contract_voided
  contract_expired
  guarantee_expiring_30d
  guarantee_expiring_7d
  guarantee_expired
  microchip_renewal_30d
  microchip_renewal_14d
  microchip_renewal_7d
  microchip_renewal_3d
  microchip_expired
  genetic_test_missing
  genetic_test_incomplete
  genetic_test_prebreeding
  genetic_test_carrier_warning
  genetic_test_registration
  genetic_test_recommended
  supplement_starting_7d
  supplement_starting_3d
  supplement_starting_1d
  supplement_due_today
  supplement_overdue
  supplement_schedule_complete
  network_breeding_inquiry
  network_inquiry_response
  breeding_data_agreement_request
  breeding_data_agreement_approved
  breeding_data_agreement_rejected

  @@schema("public")
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT

  @@schema("public")
}

enum NotificationStatus {
  UNREAD
  READ
  DISMISSED

  @@schema("public")
}

enum PartyEventKind {
  FOLLOW_UP
  MEETING
  CALL
  VISIT
  CUSTOM

  @@schema("public")
}

enum PartyEventStatus {
  SCHEDULED
  COMPLETED
  CANCELLED

  @@schema("public")
}

enum PartyMilestoneKind {
  BIRTHDAY
  CUSTOMER_ANNIVERSARY
  PLACEMENT_ANNIVERSARY
  CUSTOM

  @@schema("public")
}

enum PartyActivityKind {
  NOTE_ADDED
  NOTE_UPDATED
  EMAIL_SENT
  EVENT_CREATED
  EVENT_COMPLETED
  MILESTONE_OCCURRED
  STATUS_CHANGED
  TAG_ADDED
  TAG_REMOVED
  INVOICE_CREATED
  PAYMENT_RECEIVED
  MESSAGE_SENT
  MESSAGE_RECEIVED
  PROFILE_UPDATED_BY_CLIENT
  NAME_CHANGE_REQUESTED
  NAME_CHANGE_APPROVED
  NAME_CHANGE_REJECTED
  EMAIL_CHANGE_REQUESTED
  EMAIL_CHANGE_VERIFIED
  EMAIL_CHANGE_EXPIRED
  PORTAL_INVITE_AUTO_SENT
  PORTAL_ACCESS_GRANTED
  PORTAL_ACCESS_REVOKED
  NOTE_DELETED
  EVENT_UPDATED
  EVENT_DELETED
  MILESTONE_UPDATED
  MILESTONE_DELETED

  @@schema("public")
}

enum InquiryStatus {
  NEW
  CONTACTED
  QUALIFIED
  SCHEDULED_VISIT
  CONVERTED
  NOT_INTERESTED
  SPAM

  @@schema("public")
}

enum MarePostFoalingCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  VETERINARY_CARE_REQUIRED

  @@schema("public")
}

enum MilestoneType {
  VET_PREGNANCY_CHECK_15D
  VET_ULTRASOUND_45D
  VET_ULTRASOUND_90D
  BEGIN_MONITORING_300D
  PREPARE_FOALING_AREA_320D
  DAILY_CHECKS_330D
  DUE_DATE_340D
  OVERDUE_VET_CALL_350D
  UDDER_DEVELOPMENT
  UDDER_FULL
  WAX_APPEARANCE
  VULVAR_RELAXATION
  TAILHEAD_RELAXATION
  MILK_CALCIUM_TEST
  PREGNANCY_CONFIRMATION
  ULTRASOUND_HEARTBEAT
  ULTRASOUND_COUNT
  XRAY_COUNT
  BEGIN_MONITORING
  DAILY_CHECKS
  PREPARE_BIRTH_AREA
  DUE_DATE
  OVERDUE_VET_CALL
  TEMPERATURE_DROP
  NESTING_BEHAVIOR
  LOSS_OF_APPETITE
  RESTLESSNESS
  VULVAR_CHANGES
  MILK_PRESENT
  LIGAMENT_SOFTENING
  UDDER_TIGHT
  FUR_PULLING
  NEST_BUILDING

  @@schema("public")
}

enum FoalHealthStatus {
  HEALTHY
  MINOR_ISSUES
  VETERINARY_CARE
  CRITICAL
  DECEASED

  @@schema("public")
}

enum FoalNursingStatus {
  UNKNOWN
  NURSING_WELL
  ASSISTED
  BOTTLE_FED
  ORPHANED

  @@schema("public")
}

/// *
/// * Neonatal health status for intensive care tracking
enum NeonatalHealthStatus {
  THRIVING
  WATCH
  CRITICAL
  DECEASED

  @@schema("public")
}

/// *
/// * Feeding method for neonates
enum NeonatalFeedingMethod {
  NURSING
  SUPPLEMENTAL
  BOTTLE
  TUBE
  ORPHANED

  @@schema("public")
}

/// *
/// * Stool quality for neonate monitoring
enum StoolQuality {
  NORMAL
  SOFT
  DIARRHEA
  CONSTIPATED
  NONE

  @@schema("public")
}

/// *
/// * Activity level for neonate monitoring
enum ActivityLevel {
  VIGOROUS
  NORMAL
  WEAK
  LETHARGIC

  @@schema("public")
}

/// *
/// * Neonatal intervention types
enum NeonatalInterventionType {
  PLASMA_TRANSFUSION
  COLOSTRUM_SUPPLEMENT
  SERUM_IMMUNOGLOBULIN
  SUBQ_FLUIDS
  IV_FLUIDS
  DEXTROSE_GLUCOSE
  TUBE_FEEDING
  IRON_SUPPLEMENT
  CALCIUM_SUPPLEMENT
  OXYGEN_THERAPY
  DOXAPRAM
  NALOXONE
  NEBULIZER
  ANTIBIOTIC
  PROBIOTIC
  DEWORMER
  VITAMIN_K
  UMBILICAL_CARE
  EYE_CARE
  SKIN_TREATMENT
  OTHER

  @@schema("public")
}

/// *
/// * Intervention administration route
enum InterventionRoute {
  ORAL
  SUBCUTANEOUS
  INTRAVENOUS
  INTRAMUSCULAR
  TOPICAL
  INHALATION

  @@schema("public")
}

/// *
/// * Who administered the intervention
enum AdministeredBy {
  SELF
  VET
  VET_TECH

  @@schema("public")
}

/// *
/// * Response to intervention
enum InterventionResponse {
  IMPROVED
  NO_CHANGE
  WORSENED

  @@schema("public")
}

enum FinanceScope {
  group
  offspring
  contact
  organization
  general
  waitlist

  @@schema("public")
}

enum InvoiceStatus {
  draft
  issued
  partially_paid
  paid
  void
  uncollectible
  refunded
  cancelled

  @@schema("public")
}

enum InvoiceCategory {
  DEPOSIT
  SERVICE
  GOODS
  MIXED
  OTHER

  @@schema("public")
}

enum LineItemKind {
  DEPOSIT
  SERVICE_FEE
  GOODS
  DISCOUNT
  TAX
  OTHER

  @@schema("public")
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
  disputed
  cancelled

  @@schema("public")
}

enum ExpenseCategory {
  VET
  SUPPLIES
  FOOD
  GROOMING
  BREEDING
  FACILITY
  MARKETING
  LABOR
  INSURANCE
  REGISTRATION
  TRAVEL
  OTHER

  @@schema("public")
}

enum CampaignChannel {
  email
  social
  ads
  marketplace
  website
  other

  @@schema("public")
}

enum TaskScope {
  group
  offspring

  @@schema("public")
}

enum TaskStatus {
  open
  in_progress
  done
  cancelled

  @@schema("public")
}

enum HealthType {
  weight
  vaccine
  deworm
  vet_visit
  treatment
  other

  @@schema("public")
}

enum DocumentScope {
  group
  offspring
  invoice
  contract
  animal
  contact

  @@schema("public")
}

enum DocumentKind {
  generic
  health_certificate
  registration
  contract_pdf
  invoice_pdf
  photo
  other
  bill_of_sale
  syndication_agreement
  lease_agreement
  insurance_policy
  vet_certificate

  @@schema("public")
}

enum SignatureProvider {
  internal
  docusign
  hellosign
  adobe
  other

  @@schema("public")
}

enum ContractStatus {
  draft
  sent
  viewed
  signed
  declined
  voided
  expired

  @@schema("public")
}

enum SignatureStatus {
  pending
  viewed
  signed
  declined
  voided
  expired

  @@schema("public")
}

enum ContractTemplateType {
  SYSTEM
  CUSTOM

  @@schema("public")
}

enum ContractTemplateCategory {
  SALES_AGREEMENT
  DEPOSIT_AGREEMENT
  CO_OWNERSHIP
  GUARDIAN_HOME
  STUD_SERVICE
  HEALTH_GUARANTEE
  CUSTOM

  @@schema("public")
}

enum EmailSendStatus {
  queued
  sent
  failed
  delivered
  bounced
  complained
  deferred

  @@schema("public")
}

enum TemplateChannel {
  email
  dm
  social

  @@schema("public")
}

enum TemplateStatus {
  draft
  active
  archived

  @@schema("public")
}

enum TemplateCategory {
  auto_reply
  invoice_message
  birth_announcement
  waitlist_update
  general_follow_up
  custom

  @@schema("public")
}

enum EmailSendCategory {
  transactional
  marketing

  @@schema("public")
}

enum AutoReplyTriggerType {
  dm_first_message_from_party
  dm_after_hours
  email_received
  time_based
  keyword_match
  business_hours

  @@schema("public")
}

enum AutoReplyRuleStatus {
  active
  paused
  archived

  @@schema("public")
}

enum AutoReplyLogStatus {
  sent
  skipped
  failed

  @@schema("public")
}

enum DraftChannel {
  email
  dm

  @@schema("public")
}

enum BundleStatus {
  active
  archived

  @@schema("public")
}

enum InvoiceRole {
  RESERVATION
  DEPOSIT
  FINAL
  MISC

  @@schema("public")
}

enum EsignProvider {
  DOCUSIGN
  HELLOSIGN
  ADOBE
  OTHER

  @@schema("public")
}

enum EsignStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  DECLINED
  EXPIRED
  VOIDED

  @@schema("public")
}

enum AuditOutcome {
  SUCCESS
  FAILURE

  @@schema("public")
}

enum AuditSurface {
  PLATFORM
  PORTAL
  MARKETPLACE

  @@schema("public")
}

enum AuditActorContext {
  STAFF
  CLIENT
  PUBLIC

  @@schema("public")
}

enum SchedulingEventStatus {
  DRAFT
  OPEN
  CLOSED
  CANCELLED

  @@schema("public")
}

enum SchedulingSlotStatus {
  AVAILABLE
  FULL
  CANCELLED

  @@schema("public")
}

enum SchedulingSlotMode {
  IN_PERSON
  VIRTUAL

  @@schema("public")
}

enum SchedulingBookingStatus {
  CONFIRMED
  CANCELLED
  RESCHEDULED
  NO_SHOW

  @@schema("public")
}

enum MarketplaceBlockLevel {
  LIGHT
  MEDIUM
  HEAVY

  @@schema("public")
}

enum BreederReportReason {
  SPAM
  FRAUD
  HARASSMENT
  MISREPRESENTATION
  OTHER

  @@schema("public")
}

enum BreederReportSeverity {
  LIGHT
  MEDIUM
  HEAVY

  @@schema("public")
}

enum BreederReportStatus {
  PENDING
  REVIEWED
  DISMISSED
  ACTIONED

  @@schema("public")
}

/// *
/// * BreederVerificationTier - Verification levels for breeders on the marketplace
/// * Tier 0: SUBSCRIBER - Has active subscription (baseline)
/// * Tier 1: MARKETPLACE_ENABLED - Phone verified
/// * Tier 2: IDENTITY_VERIFIED - Stripe Identity verified
/// * Tier 3: VERIFIED - Paid package (BreederHQ Verified)
/// * Tier 4: ACCREDITED - Paid package (BreederHQ Accredited)
enum BreederVerificationTier {
  SUBSCRIBER
  MARKETPLACE_ENABLED
  IDENTITY_VERIFIED
  VERIFIED
  ACCREDITED

  @@schema("marketplace")
}

/// *
/// * ServiceProviderVerificationTier - Verification levels for service providers
/// * Tier 0: LISTED - Email verified + 2FA enabled
/// * Tier 1: IDENTITY_VERIFIED - Stripe Identity or Stripe Connect verified
/// * Tier 2: VERIFIED_PROFESSIONAL - Paid package (credentials verified)
/// * Tier 3: ACCREDITED_PROVIDER - Paid package (license + insurance verified)
enum ServiceProviderVerificationTier {
  LISTED
  IDENTITY_VERIFIED
  VERIFIED_PROFESSIONAL
  ACCREDITED_PROVIDER

  @@schema("marketplace")
}

/// *
/// * VerificationRequestStatus - Status of verification package requests
enum VerificationRequestStatus {
  PENDING
  IN_REVIEW
  NEEDS_INFO
  APPROVED
  DENIED

  @@schema("marketplace")
}

/// *
/// * TwoFactorMethod - Available 2FA methods for marketplace users
enum TwoFactorMethod {
  PASSKEY
  TOTP
  SMS

  @@schema("marketplace")
}

/// *
/// * ServiceSourceType - Discriminator for unified service listings
/// * PROVIDER: Service listing from marketplace provider
/// * BREEDER: Service listing from breeder/tenant
enum ServiceSourceType {
  PROVIDER
  BREEDER

  @@schema("marketplace")
}

/// *
/// * IdentifierType - Types of unique identifiers that can be used to match animals
enum IdentifierType {
  MICROCHIP
  AKC
  UKC
  CKC
  KC
  FCI
  AQHA
  JOCKEY_CLUB
  USEF
  ADGA
  AGS
  ARBA
  TICA
  CFA
  EMBARK
  WISDOM_PANEL
  DNA_PROFILE
  TATTOO
  EAR_TAG
  USDA_SCRAPIE
  OTHER

  @@schema("public")
}

enum TitleCategory {
  CONFORMATION
  OBEDIENCE
  AGILITY
  FIELD
  HERDING
  TRACKING
  RALLY
  PRODUCING
  BREED_SPECIFIC
  PERFORMANCE
  OTHER

  @@schema("public")
}

enum TitleStatus {
  IN_PROGRESS
  EARNED
  VERIFIED

  @@schema("public")
}

enum CompetitionType {
  CONFORMATION_SHOW
  OBEDIENCE_TRIAL
  AGILITY_TRIAL
  FIELD_TRIAL
  HERDING_TRIAL
  TRACKING_TEST
  RALLY_TRIAL
  RACE
  PERFORMANCE_TEST
  BREED_SPECIALTY
  OTHER

  @@schema("public")
}

enum ChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED

  @@schema("public")
}

enum EmailChangeStatus {
  PENDING_VERIFICATION
  VERIFIED
  EXPIRED
  CANCELLED

  @@schema("public")
}

enum BreedingRuleCategory {
  LISTING
  PRICING
  VISIBILITY
  BUYER_INTERACTION
  STATUS
  NOTIFICATIONS

  @@schema("public")
}

enum BreedingRuleLevel {
  PROGRAM
  PLAN
  GROUP
  OFFSPRING

  @@schema("public")
}

enum StudVisibilityLevel {
  TENANT
  PROGRAM
  PARTICIPANT

  @@schema("public")
}

enum RegistryConnectionStatus {
  DISCONNECTED
  CONNECTING
  CONNECTED
  ERROR
  TOKEN_EXPIRED

  @@schema("public")
}

enum VerificationMethod {
  API
  MANUAL
  DOCUMENT

  @@schema("public")
}

enum VerificationConfidence {
  HIGH
  MEDIUM
  LOW
  NONE

  @@schema("public")
}

enum MicrochipRenewalType {
  LIFETIME
  ANNUAL
  UNKNOWN

  @@schema("public")
}

enum FoodType {
  DRY
  WET
  RAW
  FRESH
  FREEZE_DRIED
  SUPPLEMENT
  TREAT
  OTHER

  @@schema("public")
}

enum LifeStage {
  PUPPY
  JUNIOR
  ADULT
  SENIOR
  ALL_STAGES
  BREEDING
  PERFORMANCE

  @@schema("public")
}

enum FoodChangeReason {
  LIFE_STAGE
  HEALTH_ISSUE
  VET_RECOMMENDATION
  AVAILABILITY
  COST_OPTIMIZATION
  PERFORMANCE
  PREFERENCE
  OTHER

  @@schema("public")
}

enum SuccessRating {
  EXCELLENT
  GOOD
  FAIR
  POOR

  @@schema("public")
}

enum LactationStatus {
  FRESH
  MILKING
  DRY
  PREGNANT_DRY
  TRANSITION

  @@schema("public")
}

enum MilkingFrequency {
  ONCE_DAILY
  TWICE_DAILY
  THREE_DAILY

  @@schema("public")
}

enum DHIATestType {
  STANDARD
  OWNER_SAMPLER
  HERD_TEST

  @@schema("public")
}

enum ShearingType {
  FULL_BODY
  PARTIAL
  BELLY_CRUTCH

  @@schema("public")
}

enum FleeceGrade {
  PRIME
  CHOICE
  STANDARD
  UTILITY
  REJECT

  @@schema("public")
}

enum FiberLabTestType {
  MICRON_ANALYSIS
  YIELD_TEST
  STAPLE_STRENGTH
  FULL_PROFILE

  @@schema("public")
}

enum RearingCertificateType {
  BREEDER_PHASE
  BUYER_PHASE
  FULL_PROTOCOL

  @@schema("public")
}

/// Access tier for shared animal data
enum AnimalAccessTier {
  BASIC
  GENETICS
  LINEAGE
  HEALTH
  FULL

  @@schema("public")
}

/// How the access was granted
enum AnimalAccessSource {
  INQUIRY
  QR_SCAN
  SHARE_CODE
  BREEDING_AGREEMENT

  @@schema("public")
}

/// Status of the animal access relationship
enum AnimalAccessStatus {
  ACTIVE
  EXPIRED
  REVOKED
  OWNER_DELETED

  @@schema("public")
}

/// Status of a share code
enum ShareCodeStatus {
  ACTIVE
  EXPIRED
  REVOKED
  MAX_USES_REACHED

  @@schema("public")
}

/// Status of breeding data agreement
enum BreedingAgreementStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED

  @@schema("public")
}

/// Network visibility setting for breeders
enum NetworkVisibility {
  VISIBLE
  ANONYMOUS
  HIDDEN

  @@schema("public")
}

/// Who can send breeding inquiries
enum InquiryPermission {
  ANYONE
  VERIFIED
  CONNECTIONS

  @@schema("public")
}

/// Status of a network breeding inquiry
enum NetworkInquiryStatus {
  PENDING
  RESPONDED
  DECLINED

  @@schema("public")
}

/// Target listing type for boost (polymorphic reference)
enum ListingBoostTarget {
  INDIVIDUAL_ANIMAL
  ANIMAL_PROGRAM
  BREEDING_PROGRAM
  BREEDER
  BREEDER_SERVICE
  BREEDING_LISTING
  PROVIDER_SERVICE

  @@schema("public")
}

/// Boost pricing tier
enum BoostTier {
  BOOST
  FEATURED

  @@schema("public")
}

/// Boost lifecycle status
enum BoostStatus {
  PENDING
  ACTIVE
  PAUSED
  EXPIRED
  CANCELED

  @@schema("public")
}
