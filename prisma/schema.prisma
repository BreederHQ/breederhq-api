generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Core enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum AnimalStatus {
  ACTIVE
  BREEDING
  UNAVAILABLE
  RETIRED
  DECEASED
  PROSPECT
}

enum Species {
  DOG
  CAT
  HORSE
}

enum Sex {
  FEMALE
  MALE
}

enum TagModule {
  CONTACT
  ORGANIZATION
  ANIMAL
  WAITLIST_ENTRY
}

enum OwnerPartyType {
  Organization
  Contact
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
  VIEWER
}

enum ShareScope {
  VIEW
  BREED_PLAN
}

enum ShareStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum VerificationPurpose {
  VERIFY_EMAIL
  RESET_PASSWORD
  INVITE
  OTHER
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding additions: enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum BreedingPlanStatus {
  PLANNING
  COMMITTED
  CYCLE_EXPECTED
  HORMONE_TESTING
  BRED
  PREGNANT
  BIRTHED
  WEANED
  PLACEMENT
  COMPLETE
  CANCELED
}

enum BreedingMethod {
  NATURAL
  AI_TCI
  AI_SI
  AI_FROZEN
}

enum PregnancyCheckMethod {
  PALPATION
  ULTRASOUND
  RELAXIN_TEST
  XRAY
  OTHER
}

enum WaitlistStatus {
  INQUIRY
  DEPOSIT_DUE
  DEPOSIT_PAID
  READY
  ALLOCATED
  COMPLETED
  CANCELED
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Users & Auth
 * ────────────────────────────────────────────────────────────────────────────
 */

model User {
  id        String  @id @default(cuid())
  email     String  @unique @db.Citext
  name      String?
  firstName String?
  lastName  String?
  nickname  String?
  image     String?

  // auth
  passwordHash      String?
  passwordUpdatedAt DateTime?
  isSuperAdmin      Boolean   @default(false)
  emailVerifiedAt   DateTime?

  // profile / contact fields (user-scoped)
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)
  street       String?
  street2      String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @db.Char(2)

  // optional link into a Contact row
  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // org/tenant membership
  memberships       Membership[]
  tenantMemberships TenantMembership[]
  defaultTenantId   Int?
  defaultTenant     Tenant?            @relation(fields: [defaultTenantId], references: [id], onDelete: SetNull)

  // auth ancillaries
  Passkey           Passkey[]
  RecoveryCode      RecoveryCode[]
  Session           Session[]
  VerificationToken VerificationToken[]

  // auth/activity timestamps
  lastLoginAt DateTime?

  // breeding events authored
  BreedingPlanEvent BreedingPlanEvent[]

  // committed plans (optional backref)
  committedPlans BreedingPlan[] @relation("CommittedByUser")

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  Attachment  Attachment[]
  LitterEvent LitterEvent[]

  @@index([contactId])
  @@index([defaultTenantId])
  @@index([phoneE164])
  @@index([whatsappE164])
  @@index([country])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String? @unique
  tokenHash  String  @unique

  purpose VerificationPurpose @default(VERIFY_EMAIL)
  expires DateTime
  userId  String?
  User    User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@id([identifier, tokenHash])
  @@index([identifier, purpose])
}

model Passkey {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId String   @unique
  publicKey    String
  counter      Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model RecoveryCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String   @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Invitation {
  id             String         @id @default(cuid())
  email          String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  token          String         @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime       @default(now())
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organizationId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Multi-tenancy & Orgs
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tenant {
  id           Int     @id @default(autoincrement())
  name         String
  slug         String? @unique
  primaryEmail String?

  memberships    TenantMembership[]
  organizations  Organization[]
  contacts       Contact[]
  animals        Animal[]
  billing        BillingAccount?
  sharesSent     AnimalShare[]         @relation("ShareFromTenant")
  sharesReceived AnimalShare[]         @relation("ShareToTenant")
  publicListings AnimalPublicListing[]
  User           User[]
  tags           Tag[]
  CustomBreed    CustomBreed[]

  // breeding additions
  breedingPlans      BreedingPlan[]
  reproductiveCycles ReproductiveCycle[]
  planSharesSent     BreedingPlanShare[] @relation("PlanShareFromTenant")
  planSharesReceived BreedingPlanShare[] @relation("PlanShareToTenant")
  planEvents         BreedingPlanEvent[]
  testResults        TestResult[]
  breedingAttempts   BreedingAttempt[]
  pregnancyChecks    PregnancyCheck[]
  litters            Litter[]
  waitlist           WaitlistEntry[]
  attachments        Attachment[]
  planParties        PlanParty[]
  planCodeCounters   PlanCodeCounter[]

  availabilityPrefs Json?

  // namespaced settings
  settings TenantSetting[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  LitterEvent LitterEvent[]

  @@index([name])
}

model TenantMembership {
  userId   String
  tenantId Int
  role     TenantRole @default(MEMBER)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([userId, tenantId])
  @@index([tenantId])
}

model BillingAccount {
  id               Int       @id @default(autoincrement())
  tenantId         Int       @unique
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider         String?
  customerId       String?
  subscriptionId   String?
  plan             String?
  status           String?
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Organization {
  id       Int     @id @default(autoincrement())
  tenantId Int
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name     String
  email    String?
  phone    String?
  website  String?
  street   String?
  street2  String?
  city     String?
  state    String?
  zip      String?
  country  String?
  archived Boolean @default(false)

  contacts         Contact[]
  animals          Animal[]     @relation("OrgAnimals") // ← primary org ↔ animal
  animalsPurchased Animal[]     @relation("AnimalBuyerOrganization") // ← buyer backref
  memberships      Membership[]

  // backlink for creator relation
  createdCustomBreeds CustomBreed[] @relation("CreatedByOrganization")

  // breeding additions
  breedingPlans BreedingPlan[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  AnimalOwner   AnimalOwner[]
  TagAssignment TagAssignment[]
  Invitation    Invitation[]
  PlanParty     PlanParty[]
  WaitlistEntry WaitlistEntry[]

  @@unique([id, tenantId])
  @@unique([tenantId, name])
  @@index([archived])
  @@index([name])
  @@index([tenantId])
}

model Membership {
  userId         String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([organizationId])
}

model Contact {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  tenant         Tenant        @relation(fields: [tenantId], references: [id])

  // Names
  display_name String
  first_name   String?
  last_name    String?
  nickname     String?

  // Contact info
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Address
  street  String?
  street2 String?
  city    String?
  state   String?
  zip     String?
  country String? @db.Char(2)

  // Relations
  tagAssignments   TagAssignment[]
  animalOwnerships AnimalOwner[]
  users            User[]

  // breeding additions
  breedingAttemptsAsStudOwner BreedingAttempt[] @relation("StudOwnerContact")
  waitlistEntries             WaitlistEntry[]

  // buyer backref
  animalsPurchased Animal[] @relation("AnimalBuyerContact")

  archived   Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  Attachment Attachment[]
  PlanParty  PlanParty[]

  @@unique([tenantId, email])
  @@index([organizationId])
  @@index([tenantId])
  @@index([display_name])
  @@index([archived])
  @@index([last_name])
  @@index([first_name])
  @@index([nickname])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Animals & Ownership
 * ────────────────────────────────────────────────────────────────────────────
 */

model Animal {
  id               Int           @id @default(autoincrement())
  tenantId         Int
  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organizationId   Int?
  organization     Organization? @relation("OrgAnimals", fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  name             String
  species          Species
  sex              Sex
  status           AnimalStatus  @default(ACTIVE)
  birthDate        DateTime?
  microchip        String?
  notes            String?
  breed            String?
  canonicalBreedId Int?
  canonicalBreed   Breed?        @relation(fields: [canonicalBreedId], references: [id], onDelete: SetNull)

  customBreedId Int?
  customBreed   CustomBreed? @relation(fields: [customBreedId, tenantId], references: [id, tenantId], onDelete: Restrict)

  // breeding additions
  reproductiveCycles  ReproductiveCycle[]
  breedingPlansAsDam  BreedingPlan[]      @relation("PlanDam")
  breedingPlansAsSire BreedingPlan[]      @relation("PlanSire")
  litterId            Int?
  litter              Litter?             @relation(fields: [litterId], references: [id], onDelete: SetNull)

  // Waitlist back-refs
  waitlistAllocations WaitlistEntry[] @relation("WaitlistAllocation")
  waitlistSirePrefs   WaitlistEntry[] @relation("WaitlistSirePref")
  waitlistDamPrefs    WaitlistEntry[] @relation("WaitlistDamPref")

  // Collar assignment
  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  // Placement and sale workflow
  buyerPartyType      OwnerPartyType?
  buyerContactId      Int?
  buyerContact        Contact?        @relation("AnimalBuyerContact", fields: [buyerContactId], references: [id], onDelete: SetNull)
  buyerOrganizationId Int?
  buyerOrganization   Organization?   @relation("AnimalBuyerOrganization", fields: [buyerOrganizationId], references: [id], onDelete: SetNull)
  priceCents          Int?
  depositCents        Int?
  saleInvoiceId       String?
  contractId          String?
  contractSignedAt    DateTime?
  paidInFullAt        DateTime?
  healthCertAt        DateTime?
  microchipAppliedAt  DateTime?
  pickupAt            DateTime?
  placedAt            DateTime?

  tagAssignments TagAssignment[]
  owners         AnimalOwner[]
  registryIds    AnimalRegistryIdentifier[]
  shares         AnimalShare[]              @relation("ShareAnimal")
  publicListing  AnimalPublicListing?
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  archived       Boolean                    @default(false)
  TestResult     TestResult[]
  Attachment     Attachment[]

  @@unique([tenantId, microchip])
  @@index([organizationId])
  @@index([tenantId])
  @@index([species])
  @@index([status])
  @@index([archived])
  @@index([canonicalBreedId])
  @@index([tenantId, customBreedId])
  @@index([litterId])
  @@index([tenantId, placedAt])
}

model AnimalOwner {
  id             Int            @id @default(autoincrement())
  animalId       Int
  partyType      OwnerPartyType
  organizationId Int?
  contactId      Int?
  percent        Int
  isPrimary      Boolean        @default(false)
  animal         Animal         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  contact        Contact?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([animalId, organizationId])
  @@unique([animalId, contactId])
  @@index([animalId])
  @@index([organizationId])
  @@index([contactId])
}

model Registry {
  id                Int                        @id @default(autoincrement())
  name              String
  code              String?                    @unique
  url               String?
  country           String?
  species           Species?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  identifiers       AnimalRegistryIdentifier[]
  BreedRegistryLink BreedRegistryLink[]
}

model AnimalRegistryIdentifier {
  id                Int       @id @default(autoincrement())
  animalId          Int
  animal            Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  registryId        Int
  registry          Registry  @relation(fields: [registryId], references: [id], onDelete: Cascade)
  identifier        String
  registrarOfRecord String?
  issuedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([registryId, identifier])
  @@index([animalId])
  @@index([registryId])
}

model AnimalShare {
  id           Int         @id @default(autoincrement())
  animalId     Int
  animal       Animal      @relation("ShareAnimal", fields: [animalId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant      @relation("ShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant      @relation("ShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope  @default(VIEW)
  status       ShareStatus @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([animalId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

model AnimalPublicListing {
  id          Int      @id @default(autoincrement())
  animalId    Int      @unique
  animal      Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenantId    Int
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title       String?
  description String?
  isListed    Boolean  @default(false)
  visibility  String?
  urlSlug     String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Tags
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tag {
  id          Int             @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  module      TagModule
  color       String?
  assignments TagAssignment[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([tenantId, module, name])
  @@index([tenantId, module])
}

model TagAssignment {
  id    Int @id @default(autoincrement())
  tagId Int
  tag   Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: Cascade)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([tagId, contactId])
  @@unique([tagId, organizationId])
  @@unique([tagId, animalId])
  @@unique([tagId, waitlistEntryId])
  @@index([contactId])
  @@index([organizationId])
  @@index([animalId])
  @@index([waitlistEntryId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeds
 * ────────────────────────────────────────────────────────────────────────────
 */

model Breed {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  species   Species
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  registries BreedRegistryLink[]
  Animal     Animal[]

  @@index([species])
}

model BreedRegistryLink {
  breedId    Int
  registryId Int

  statusText  String?
  registryRef String?
  url         String?
  primary     Boolean?
  since       Int?
  notes       String?
  proofUrl    String?

  // relations
  breed    Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  registry Registry @relation(fields: [registryId], references: [id], onDelete: Cascade)

  @@id([breedId, registryId])
  @@index([registryId])
}

model CustomBreed {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdByOrganizationId Int?
  createdByOrganization   Organization? @relation("CreatedByOrganization", fields: [createdByOrganizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  species     Species
  name        String
  composition Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Animal    Animal[]

  @@unique([id, tenantId])
  @@unique([tenantId, species, name])
  @@index([tenantId, species])
  @@index([tenantId, createdByOrganizationId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding core
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlan {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  // identity
  code      String? // unique per tenant; assigned on commit
  name      String
  nickname  String?
  species   Species
  breedText String?

  // parents
  damId  Int
  dam    Animal  @relation("PlanDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId Int?
  sire   Animal? @relation("PlanSire", fields: [sireId], references: [id], onDelete: SetNull)

  // locked cycle snapshot for UI
  lockedCycleKey           String?
  lockedCycleStart         DateTime?
  lockedOvulationDate      DateTime?
  lockedDueDate            DateTime?
  lockedPlacementStartDate DateTime?

  // ===== Expected dates (new + normalized) =====
  expectedCycleStart          DateTime?
  expectedHormoneTestingStart DateTime?
  expectedBreedDate           DateTime?
  expectedBirthDate           DateTime?
  expectedWeaned              DateTime?
  expectedPlacementStart      DateTime?
  expectedPlacementCompleted  DateTime?

  // ===== Actual dates (complete set) =====
  cycleStartDateActual          DateTime?
  hormoneTestingStartDateActual DateTime?
  breedDateActual               DateTime?
  birthDateActual               DateTime?
  weanedDateActual              DateTime?
  placementStartDateActual      DateTime?
  placementCompletedDateActual  DateTime?
  completedDateActual           DateTime?

  // status and notes
  status BreedingPlanStatus @default(PLANNING)
  notes  String?

  // commitment
  committedAt       DateTime?
  committedByUserId String?
  committedByUser   User?     @relation("CommittedByUser", fields: [committedByUserId], references: [id], onDelete: SetNull)

  // finance rollups for UI
  depositsCommittedCents Int?
  depositsPaidCents      Int?
  depositRiskScore       Int?

  // relations
  Litter           Litter?
  Events           BreedingPlanEvent[]
  Waitlist         WaitlistEntry[]
  Shares           BreedingPlanShare[]
  TestResults      TestResult[]
  BreedingAttempts BreedingAttempt[]
  PregnancyChecks  PregnancyCheck[]
  Attachments      Attachment[]
  Parties          PlanParty[]

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([organizationId])
  @@index([damId])
  @@index([sireId])
  @@index([status])
  @@index([committedAt])
  @@index([expectedWeaned])
  @@index([expectedPlacementCompleted])
  @@index([expectedPlacementStart])
  @@index([placementStartDateActual])
  @@index([placementCompletedDateActual])
  @@index([expectedBirthDate])
  @@index([expectedCycleStart])
  @@index([expectedHormoneTestingStart])
  @@index([expectedBreedDate])
  @@index([cycleStartDateActual])
}

model ReproductiveCycle {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  femaleId Int
  female   Animal @relation(fields: [femaleId], references: [id], onDelete: Cascade)

  cycleStart         DateTime
  ovulation          DateTime?
  dueDate            DateTime?
  placementStartDate DateTime?

  status String?
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([femaleId])
  @@index([cycleStart])
}

model BreedingPlanShare {
  id           Int          @id @default(autoincrement())
  planId       Int
  plan         BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant       @relation("PlanShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant       @relation("PlanShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope   @default(BREED_PLAN)
  status       ShareStatus  @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([planId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding plug-ins
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlanEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // examples: CYCLE_OBSERVED, PROGESTERONE_TEST, BREEDING_ATTEMPT, PREGNANCY_CHECK, WEANING, NOTE, VACCINATION
  type String

  occurredAt DateTime
  label      String?
  notes      String?
  data       Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, type, occurredAt])
}

model TestResult {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  kind    String // PROGESTERONE, RELAXIN, BRUCELLOSIS, DNA_PANEL, etc.
  method  String?
  labName String?

  valueNumber    Float?
  valueText      String?
  units          String?
  referenceRange String?

  collectedAt DateTime
  resultAt    DateTime?
  notes       String?
  data        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([animalId])
  @@index([planId])
  @@index([kind, collectedAt])
}

model BreedingAttempt {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method      BreedingMethod
  attemptAt   DateTime?
  windowStart DateTime?
  windowEnd   DateTime?

  studOwnerContactId Int?
  studOwnerContact   Contact? @relation("StudOwnerContact", fields: [studOwnerContactId], references: [id], onDelete: SetNull)

  semenBatchId Int?

  success Boolean?
  notes   String?
  data    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId])
}

model PregnancyCheck {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method    PregnancyCheckMethod
  result    Boolean
  checkedAt DateTime
  notes     String?
  data      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, checkedAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group (Litter) + Waitlist
 * ────────────────────────────────────────────────────────────────────────────
 */

model Litter {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int          @unique
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  identifier     String?
  birthedStartAt DateTime?
  birthedEndAt   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  // Offspring Group timeline
  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  // Manual status override
  statusOverride       String?
  statusOverrideReason String?

  // Optional marketing helpers
  published     Boolean @default(false)
  coverImageUrl String?
  themeName     String?

  notes String?
  data  Json?

  Animals    Animal[]
  Waitlist   WaitlistEntry[]
  Attachment Attachment[]
  Events     LitterEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, weanedAt])
  @@index([tenantId, placementStartAt])
  @@index([tenantId, placementCompletedAt])
}

model WaitlistEntry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Association, null means global waitlist
  planId   Int?
  plan     BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)
  litterId Int?
  litter   Litter?       @relation(fields: [litterId], references: [id], onDelete: SetNull)

  // Buyer choice
  partyType      OwnerPartyType
  contactId      Int?
  contact        Contact?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  organizationId Int?
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Preferences
  speciesPref Species?
  breedPrefs  Json?
  sirePrefId  Int?
  sirePref    Animal?  @relation("WaitlistSirePref", fields: [sirePrefId], references: [id], onDelete: SetNull)
  damPrefId   Int?
  damPref     Animal?  @relation("WaitlistDamPref", fields: [damPrefId], references: [id], onDelete: SetNull)

  // Selection and finance refs
  status               WaitlistStatus @default(INQUIRY)
  priority             Int?
  depositInvoiceId     String?
  balanceInvoiceId     String?
  depositPaidAt        DateTime?
  depositRequiredCents Int?
  depositPaidCents     Int?
  balanceDueCents      Int?

  // Allocation to specific animal
  animalId Int?
  animal   Animal? @relation("WaitlistAllocation", fields: [animalId], references: [id], onDelete: SetNull)

  // Skip policy
  skipCount  Int?
  lastSkipAt DateTime?

  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  TagAssignment TagAssignment[]

  @@index([tenantId])
  @@index([planId])
  @@index([litterId])
  @@index([contactId])
  @@index([organizationId])
  @@index([tenantId, speciesPref])
  @@index([sirePrefId])
  @@index([damPrefId])
  @@index([animalId])
  @@index([tenantId, depositPaidAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Litter audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model LitterEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  litterId Int
  litter   Litter @relation(fields: [litterId], references: [id], onDelete: Cascade)

  // types: CHANGE, NOTE, STATUS_OVERRIDE, BUYER_MOVE
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([litterId, type, occurredAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Attachments, Parties, Counters
 * ────────────────────────────────────────────────────────────────────────────
 */

model Attachment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  kind            String
  storageProvider String
  storageKey      String
  filename        String
  mime            String
  bytes           Int

  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([planId])
  @@index([animalId])
  @@index([litterId])
  @@index([contactId])
}

model PlanParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  role      String // OWNER, COOWNER, STUD_OWNER, VET, HANDLER, GUARDIAN
  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  notes String?

  @@index([tenantId])
  @@index([planId])
}

model PlanCodeCounter {
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  year Int
  seq  Int @default(0)

  @@id([tenantId, year])
  @@index([tenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Generic, namespaced tenant settings
 * ────────────────────────────────────────────────────────────────────────────
 */

model TenantSetting {
  tenantId  Int
  namespace String
  version   Int     @default(1)
  data      Json
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, namespace])
  @@index([tenantId])
  @@index([namespace])
}
