generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum AnimalStatus {
  ACTIVE
  BREEDING
  UNAVAILABLE
  RETIRED
  DECEASED
  PROSPECT
}

enum Species {
  DOG
  CAT
  HORSE
}

enum Sex {
  FEMALE
  MALE
}

enum TagModule {
  CONTACT
  ORGANIZATION
  ANIMAL
}

enum OwnerPartyType {
  Organization
  Contact
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
  VIEWER
}

enum ShareScope {
  VIEW
  BREED_PLAN
}

enum ShareStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum VerificationPurpose {
  VERIFY_EMAIL
  RESET_PASSWORD
  INVITE
  OTHER
}

model User {
  id    String  @id @default(cuid())
  email String  @unique @db.Citext
  name  String?
  image String?

  // auth
  passwordHash      String?
  passwordUpdatedAt DateTime? // ← NEW: set whenever password changes
  isSuperAdmin      Boolean   @default(false)
  emailVerifiedAt   DateTime?

  // profile / contact fields (user-scoped)
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)
  street       String?
  street2      String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @db.Char(2)

  // optional link into a Contact row
  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // org/tenant membership
  memberships       Membership[]
  tenantMemberships TenantMembership[]
  defaultTenantId   Int?
  defaultTenant     Tenant?            @relation(fields: [defaultTenantId], references: [id], onDelete: SetNull)

  // auth ancillaries
  Passkey           Passkey[]
  RecoveryCode      RecoveryCode[]
  Session           Session[]
  VerificationToken VerificationToken[]

  // auth/activity timestamps
  lastLoginAt DateTime? // ← NEW: set on successful login

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contactId])
  @@index([defaultTenantId])
  @@index([phoneE164])
  @@index([whatsappE164])
  @@index([country])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  // legacy raw token (stop writing to this; keep nullable for cutover)
  token      String? @unique

  // new: store sha256(raw) base64url here
  tokenHash String @unique

  purpose VerificationPurpose @default(VERIFY_EMAIL)
  expires DateTime
  userId  String?
  User    User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@id([identifier, tokenHash])
  @@index([identifier, purpose])
}

model Passkey {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId String   @unique
  publicKey    String
  counter      Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model RecoveryCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String   @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Invitation {
  id             String         @id @default(cuid())
  email          String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  token          String         @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime       @default(now())
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organizationId])
}

model Tenant {
  id             Int                   @id @default(autoincrement())
  name           String
  slug           String?               @unique
  primaryEmail   String?
  memberships    TenantMembership[]
  organizations  Organization[]
  contacts       Contact[]
  animals        Animal[]
  billing        BillingAccount?
  sharesSent     AnimalShare[]         @relation("ShareFromTenant")
  sharesReceived AnimalShare[]         @relation("ShareToTenant")
  publicListings AnimalPublicListing[]
  User           User[]
  tags           Tag[]
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  @@index([name])
}

model TenantMembership {
  userId   String
  tenantId Int
  role     TenantRole @default(MEMBER)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([userId, tenantId])
  @@index([tenantId])
}

model BillingAccount {
  id               Int       @id @default(autoincrement())
  tenantId         Int       @unique
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider         String?
  customerId       String?
  subscriptionId   String?
  plan             String?
  status           String?
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Organization {
  id            Int             @id @default(autoincrement())
  tenantId      Int
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name          String
  email         String?
  phone         String?
  website       String?
  street        String?
  street2       String?
  city          String?
  state         String?
  zip           String?
  country       String?
  archived      Boolean         @default(false)
  contacts      Contact[]
  animals       Animal[]
  memberships   Membership[]
  customBreeds  CustomBreed[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  AnimalOwner   AnimalOwner[]
  TagAssignment TagAssignment[]
  Invitation    Invitation[]

  @@unique([id, tenantId])
  @@unique([tenantId, name])
  @@index([archived])
  @@index([name])
  @@index([tenantId])
}

model Membership {
  userId         String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([organizationId])
}

model Contact {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  tenant         Tenant        @relation(fields: [tenantId], references: [id])

  // Names
  display_name String
  first_name   String?
  last_name    String?
  nickname     String?

  // Contact info
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Address
  street  String?
  street2 String?
  city    String?
  state   String?
  zip     String?
  country String? @db.Char(2)

  // Relations
  tagAssignments   TagAssignment[]
  animalOwnerships AnimalOwner[]
  users            User[]

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email])
  @@index([organizationId])
  @@index([tenantId])
  @@index([display_name])
  @@index([archived])
  // helpful search indexes on names
  @@index([last_name])
  @@index([first_name])
  @@index([nickname])
}

model Animal {
  id               Int                        @id @default(autoincrement())
  tenantId         Int
  tenant           Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organizationId   Int?
  organization     Organization?              @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  name             String
  species          Species
  sex              Sex
  status           AnimalStatus               @default(ACTIVE)
  birthDate        DateTime?
  microchip        String?
  notes            String?
  breed            String?
  canonicalBreedId Int?
  customBreedId    Int?
  tagAssignments   TagAssignment[]
  owners           AnimalOwner[]
  registryIds      AnimalRegistryIdentifier[]
  shares           AnimalShare[]              @relation("ShareAnimal")
  publicListing    AnimalPublicListing?
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  archived         Boolean                    @default(false)

  @@unique([tenantId, microchip])
  @@index([organizationId])
  @@index([tenantId])
  @@index([species])
  @@index([status])
  @@index([archived])
}

model AnimalOwner {
  id             Int            @id @default(autoincrement())
  animalId       Int
  partyType      OwnerPartyType
  organizationId Int?
  contactId      Int?
  percent        Int
  isPrimary      Boolean        @default(false)
  animal         Animal         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  contact        Contact?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([animalId, organizationId])
  @@unique([animalId, contactId])
  @@index([animalId])
  @@index([organizationId])
  @@index([contactId])
}

model Registry {
  id          Int                        @id @default(autoincrement())
  name        String
  code        String?                    @unique
  url         String?
  country     String?
  species     Species?
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  identifiers AnimalRegistryIdentifier[]
}

model AnimalRegistryIdentifier {
  id                Int       @id @default(autoincrement())
  animalId          Int
  animal            Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  registryId        Int
  registry          Registry  @relation(fields: [registryId], references: [id], onDelete: Cascade)
  identifier        String
  registrarOfRecord String?
  issuedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([registryId, identifier])
  @@index([animalId])
  @@index([registryId])
}

model AnimalShare {
  id           Int         @id @default(autoincrement())
  animalId     Int
  animal       Animal      @relation("ShareAnimal", fields: [animalId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant      @relation("ShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant      @relation("ShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope  @default(VIEW)
  status       ShareStatus @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([animalId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

model AnimalPublicListing {
  id          Int      @id @default(autoincrement())
  animalId    Int      @unique
  animal      Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenantId    Int
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title       String?
  description String?
  isListed    Boolean  @default(false)
  visibility  String?
  urlSlug     String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

model Tag {
  id          Int             @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  module      TagModule
  color       String?
  assignments TagAssignment[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([tenantId, module, name])
  @@index([tenantId, module])
}

model TagAssignment {
  id             Int           @id @default(autoincrement())
  tagId          Int
  tag            Tag           @relation(fields: [tagId], references: [id], onDelete: Cascade)
  contactId      Int?
  contact        Contact?      @relation(fields: [contactId], references: [id], onDelete: SetNull)
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  animalId       Int?
  animal         Animal?       @relation(fields: [animalId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())

  @@unique([tagId, contactId])
  @@unique([tagId, organizationId])
  @@unique([tagId, animalId])
  @@index([contactId])
  @@index([organizationId])
  @@index([animalId])
}

model CustomBreed {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  species        Species
  name           String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, species, name])
  @@index([organizationId, species])
}
