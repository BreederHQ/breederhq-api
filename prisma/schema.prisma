generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Core enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum AnimalStatus {
  ACTIVE
  BREEDING
  UNAVAILABLE
  RETIRED
  DECEASED
  PROSPECT
}

enum Species {
  DOG
  CAT
  HORSE
  GOAT
  RABBIT
}

enum Sex {
  FEMALE
  MALE
}

enum TagModule {
  CONTACT
  ORGANIZATION
  ANIMAL
  WAITLIST_ENTRY
  OFFSPRING_GROUP
  OFFSPRING
}

enum OwnerPartyType {
  Organization
  Contact
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
  VIEWER
}

enum ShareScope {
  VIEW
  BREED_PLAN
}

enum ShareStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum VerificationPurpose {
  VERIFY_EMAIL
  RESET_PASSWORD
  INVITE
  OTHER
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding additions: enums
 * ────────────────────────────────────────────────────────────────────────────
 */

enum BreedingPlanStatus {
  PLANNING
  COMMITTED
  CYCLE_EXPECTED
  HORMONE_TESTING
  BRED
  PREGNANT
  BIRTHED
  WEANED
  PLACEMENT
  COMPLETE
  CANCELED
}

enum BreedingMethod {
  NATURAL
  AI_TCI
  AI_SI
  AI_FROZEN
}

enum PregnancyCheckMethod {
  PALPATION
  ULTRASOUND
  RELAXIN_TEST
  XRAY
  OTHER
}

enum WaitlistStatus {
  INQUIRY
  DEPOSIT_DUE
  DEPOSIT_PAID
  READY
  ALLOCATED
  COMPLETED
  CANCELED
}

/**
 * Offspring Group linking state
 */
enum OffspringLinkState {
  linked
  orphan
  pending
}

enum OffspringLinkReason {
  legacy_import
  rescue
  accidental
  third_party
  cobreeder
  placeholder
  historical
  other
}

/**
 * Offspring lifecycle
 */
enum OffspringStatus {
  NEWBORN
  ALIVE
  WEANED
  PLACED
  DECEASED
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Users & Auth
 * ────────────────────────────────────────────────────────────────────────────
 */

model User {
  id        String  @id @default(cuid())
  email     String  @unique @db.Citext
  name      String?
  firstName String?
  lastName  String?
  nickname  String?
  image     String?

  // auth
  passwordHash      String?
  passwordUpdatedAt DateTime?
  isSuperAdmin      Boolean   @default(false)
  emailVerifiedAt   DateTime?

  // profile / contact fields (user-scoped)
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)
  street       String?
  street2      String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @db.Char(2)

  // optional link into a Contact row
  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // org/tenant membership
  memberships       Membership[]
  tenantMemberships TenantMembership[]
  defaultTenantId   Int?
  defaultTenant     Tenant?            @relation(fields: [defaultTenantId], references: [id], onDelete: SetNull)

  // auth ancillaries
  Passkey           Passkey[]
  RecoveryCode      RecoveryCode[]
  Session           Session[]
  VerificationToken VerificationToken[]

  // auth/activity timestamps
  lastLoginAt DateTime?

  // breeding events authored
  BreedingPlanEvent BreedingPlanEvent[]

  // committed plans (optional backref)
  committedPlans BreedingPlan[] @relation("CommittedByUser")

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  Attachment          Attachment[]
  LitterEvent         LitterEvent[]
  OffspringGroupEvent OffspringGroupEvent[]
  OffspringEvent      OffspringEvent[]
  Task                Task[]
  HealthEvent         HealthEvent[]
  ContractParty       ContractParty[]

  @@index([contactId])
  @@index([defaultTenantId])
  @@index([phoneE164])
  @@index([whatsappE164])
  @@index([country])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String? @unique
  tokenHash  String  @unique

  purpose VerificationPurpose @default(VERIFY_EMAIL)
  expires DateTime
  userId  String?
  User    User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@id([identifier, tokenHash])
  @@index([identifier, purpose])
}

model Passkey {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId String   @unique
  publicKey    String
  counter      Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model RecoveryCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String   @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Invitation {
  id             String         @id @default(cuid())
  email          String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  token          String         @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime       @default(now())
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organizationId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Multi-tenancy & Orgs
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tenant {
  id           Int     @id @default(autoincrement())
  name         String
  slug         String? @unique
  primaryEmail String?

  memberships    TenantMembership[]
  organizations  Organization[]
  contacts       Contact[]
  animals        Animal[]
  billing        BillingAccount?
  sharesSent     AnimalShare[]         @relation("ShareFromTenant")
  sharesReceived AnimalShare[]         @relation("ShareToTenant")
  publicListings AnimalPublicListing[]
  User           User[]
  tags           Tag[]
  CustomBreed    CustomBreed[]

  // breeding additions
  breedingPlans      BreedingPlan[]
  reproductiveCycles ReproductiveCycle[]
  planSharesSent     BreedingPlanShare[] @relation("PlanShareFromTenant")
  planSharesReceived BreedingPlanShare[] @relation("PlanShareToTenant")
  planEvents         BreedingPlanEvent[]
  testResults        TestResult[]
  breedingAttempts   BreedingAttempt[]
  pregnancyChecks    PregnancyCheck[]
  litters            Litter[]
  offspringGroups    OffspringGroup[]
  offspring          Offspring[]
  waitlist           WaitlistEntry[]
  attachments        Attachment[]
  planParties        PlanParty[]
  planCodeCounters   PlanCodeCounter[]

  availabilityPrefs Json?

  // namespaced settings
  settings TenantSetting[]

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  LitterEvent            LitterEvent[]
  OffspringGroupEvent    OffspringGroupEvent[]
  OffspringEvent         OffspringEvent[]
  OffspringGroupBuyer    OffspringGroupBuyer[]
  Invoice                Invoice[]
  InvoiceLineItem        InvoiceLineItem[]
  Payment                Payment[]
  Campaign               Campaign[]
  CampaignAttribution    CampaignAttribution[]
  Task                   Task[]
  HealthEvent            HealthEvent[]
  Document               Document[]
  ContractTemplate       ContractTemplate[]
  Contract               Contract[]
  ContractParty          ContractParty[]
  SignatureEvent         SignatureEvent[]
  OffspringDocument      OffspringDocument[]
  OffspringContract      OffspringContract[]
  OffspringInvoiceLink   OffspringInvoiceLink[]
  accountingIntegrations AccountingIntegration[]

  @@index([name])
}

model TenantMembership {
  userId   String
  tenantId Int
  role     TenantRole @default(MEMBER)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([userId, tenantId])
  @@index([tenantId])
}

model BillingAccount {
  id               Int       @id @default(autoincrement())
  tenantId         Int       @unique
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider         String?
  customerId       String?
  subscriptionId   String?
  plan             String?
  status           String?
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Organization {
  id       Int     @id @default(autoincrement())
  tenantId Int
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name     String
  email    String?
  phone    String?
  website  String?
  street   String?
  street2  String?
  city     String?
  state    String?
  zip      String?
  country  String?
  archived Boolean @default(false)

  contacts         Contact[]
  animals          Animal[]     @relation("OrgAnimals")
  animalsPurchased Animal[]     @relation("AnimalBuyerOrganization")
  memberships      Membership[]

  createdCustomBreeds CustomBreed[]         @relation("CreatedByOrganization")
  groupBuyerLinks     OffspringGroupBuyer[] @relation("GroupBuyerOrganization")

  breedingPlans BreedingPlan[]

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  AnimalOwner        AnimalOwner[]
  TagAssignment      TagAssignment[]
  Invitation         Invitation[]
  PlanParty          PlanParty[]
  WaitlistEntry      WaitlistEntry[]
  Offspring          Offspring[]
  OffspringContracts OffspringContract[] @relation("OffspringContractBuyerOrg")
  Invoice            Invoice[]
  ContractParty      ContractParty[]

  externalProvider String?
  externalId       String?

  @@unique([id, tenantId])
  @@unique([tenantId, name])
  @@index([archived])
  @@index([name])
  @@index([tenantId])
}

model Membership {
  userId         String
  organizationId Int
  role           MembershipRole @default(MEMBER)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([organizationId])
}

model Contact {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  tenant         Tenant        @relation(fields: [tenantId], references: [id])

  // Names
  display_name String
  first_name   String?
  last_name    String?
  nickname     String?

  // Contact info
  email        String? @db.Citext
  phoneE164    String? @db.VarChar(32)
  whatsappE164 String? @db.VarChar(32)

  // Address
  street  String?
  street2 String?
  city    String?
  state   String?
  zip     String?
  country String? @db.Char(2)

  // Relations
  tagAssignments   TagAssignment[]
  animalOwnerships AnimalOwner[]
  users            User[]

  breedingAttemptsAsStudOwner BreedingAttempt[] @relation("StudOwnerContact")
  waitlistEntries             WaitlistEntry[]

  animalsPurchased Animal[] @relation("AnimalBuyerContact")

  archived           Boolean               @default(false)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  Attachment         Attachment[]
  PlanParty          PlanParty[]
  Offspring          Offspring[]
  OffspringContracts OffspringContract[]   @relation("OffspringContractBuyerContact")
  Invoice            Invoice[]
  ContractParty      ContractParty[]
  groupBuyerLinks    OffspringGroupBuyer[] @relation("GroupBuyerContact")

  externalProvider String?
  externalId       String?

  @@unique([tenantId, email])
  @@index([organizationId])
  @@index([tenantId])
  @@index([display_name])
  @@index([archived])
  @@index([last_name])
  @@index([first_name])
  @@index([nickname])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Animals & Ownership
 * ────────────────────────────────────────────────────────────────────────────
 */

model Animal {
  id             Int           @id @default(autoincrement())
  tenantId       Int
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organizationId Int?
  organization   Organization? @relation("OrgAnimals", fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)
  name           String
  species        Species
  sex            Sex
  status         AnimalStatus  @default(ACTIVE)
  birthDate      DateTime?
  microchip      String?
  notes          String?
  breed          String?

  photoUrl String? @db.Text

  canonicalBreedId Int?
  canonicalBreed   Breed? @relation(fields: [canonicalBreedId], references: [id], onDelete: SetNull)

  customBreedId Int?
  customBreed   CustomBreed? @relation(fields: [customBreedId, tenantId], references: [id, tenantId], onDelete: Restrict)

  reproductiveCycles  ReproductiveCycle[]
  breedingPlansAsDam  BreedingPlan[]      @relation("PlanDam")
  breedingPlansAsSire BreedingPlan[]      @relation("PlanSire")

  // legacy links
  litterId         Int?
  litter           Litter?         @relation(fields: [litterId], references: [id], onDelete: SetNull)
  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation("OffspringGroupPuppiesLegacy", fields: [offspringGroupId], references: [id], onDelete: SetNull)

  // parent backrefs to groups
  offspringGroupsAsDam  OffspringGroup[] @relation("OffspringDam")
  offspringGroupsAsSire OffspringGroup[] @relation("OffspringSire")

  // parent backrefs to individual offspring
  offspringAsDam  Offspring[] @relation("OffspringIndividualDam")
  offspringAsSire Offspring[] @relation("OffspringIndividualSire")

  waitlistAllocations WaitlistEntry[] @relation("WaitlistAllocation")
  waitlistSirePrefs   WaitlistEntry[] @relation("WaitlistSirePref")
  waitlistDamPrefs    WaitlistEntry[] @relation("WaitlistDamPref")

  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  buyerPartyType      OwnerPartyType?
  buyerContactId      Int?
  buyerContact        Contact?        @relation("AnimalBuyerContact", fields: [buyerContactId], references: [id], onDelete: SetNull)
  buyerOrganizationId Int?
  buyerOrganization   Organization?   @relation("AnimalBuyerOrganization", fields: [buyerOrganizationId], references: [id], onDelete: SetNull)
  priceCents          Int?
  depositCents        Int?
  saleInvoiceId       String?
  contractId          String?
  contractSignedAt    DateTime?
  paidInFullAt        DateTime?
  healthCertAt        DateTime?
  microchipAppliedAt  DateTime?
  pickupAt            DateTime?
  placedAt            DateTime?

  tagAssignments TagAssignment[]
  owners         AnimalOwner[]
  registryIds    AnimalRegistryIdentifier[]
  shares         AnimalShare[]              @relation("ShareAnimal")
  publicListing  AnimalPublicListing?
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  archived       Boolean                    @default(false)
  TestResult     TestResult[]
  Attachment     Attachment[]
  Offspring      Offspring[]                @relation("PromotedAnimal")

  @@unique([tenantId, microchip])
  @@index([organizationId])
  @@index([tenantId])
  @@index([species])
  @@index([status])
  @@index([archived])
  @@index([canonicalBreedId])
  @@index([tenantId, customBreedId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([tenantId, placedAt])
}

model AnimalOwner {
  id             Int            @id @default(autoincrement())
  animalId       Int
  partyType      OwnerPartyType
  organizationId Int?
  contactId      Int?
  percent        Int
  isPrimary      Boolean        @default(false)
  animal         Animal         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  contact        Contact?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([animalId, organizationId])
  @@unique([animalId, contactId])
  @@index([animalId])
  @@index([organizationId])
  @@index([contactId])
}

model Registry {
  id                Int                        @id @default(autoincrement())
  name              String
  code              String?                    @unique
  url               String?
  country           String?
  species           Species?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  identifiers       AnimalRegistryIdentifier[]
  BreedRegistryLink BreedRegistryLink[]
}

model AnimalRegistryIdentifier {
  id                Int       @id @default(autoincrement())
  animalId          Int
  animal            Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  registryId        Int
  registry          Registry  @relation(fields: [registryId], references: [id], onDelete: Cascade)
  identifier        String
  registrarOfRecord String?
  issuedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([registryId, identifier])
  @@index([animalId])
  @@index([registryId])
}

model AnimalShare {
  id           Int         @id @default(autoincrement())
  animalId     Int
  animal       Animal      @relation("ShareAnimal", fields: [animalId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant      @relation("ShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant      @relation("ShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope  @default(VIEW)
  status       ShareStatus @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([animalId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

model AnimalPublicListing {
  id          Int      @id @default(autoincrement())
  animalId    Int      @unique
  animal      Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  tenantId    Int
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title       String?
  description String?
  isListed    Boolean  @default(false)
  visibility  String?
  urlSlug     String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Tags
 * ────────────────────────────────────────────────────────────────────────────
 */

model Tag {
  id          Int             @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  module      TagModule
  color       String?
  assignments TagAssignment[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([tenantId, module, name])
  @@index([tenantId, module])
}

model TagAssignment {
  id    Int @id @default(autoincrement())
  tagId Int
  tag   Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: Cascade)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([tagId, contactId])
  @@unique([tagId, organizationId])
  @@unique([tagId, animalId])
  @@unique([tagId, waitlistEntryId])
  @@unique([tagId, offspringGroupId])
  @@unique([tagId, offspringId])
  @@index([contactId])
  @@index([organizationId])
  @@index([animalId])
  @@index([waitlistEntryId])
  @@index([offspringGroupId])
  @@index([offspringId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeds
 * ────────────────────────────────────────────────────────────────────────────
 */

model Breed {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  species   Species
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  registries BreedRegistryLink[]
  Animal     Animal[]

  @@index([species])
}

model BreedRegistryLink {
  breedId    Int
  registryId Int

  statusText  String?
  registryRef String?
  url         String?
  primary     Boolean?
  since       Int?
  notes       String?
  proofUrl    String?

  breed    Breed    @relation(fields: [breedId], references: [id], onDelete: Cascade)
  registry Registry @relation(fields: [registryId], references: [id], onDelete: Cascade)

  @@id([breedId, registryId])
  @@index([registryId])
}

model CustomBreed {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdByOrganizationId Int?
  createdByOrganization   Organization? @relation("CreatedByOrganization", fields: [createdByOrganizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  species     Species
  name        String
  composition Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Animal    Animal[]

  @@unique([id, tenantId])
  @@unique([tenantId, species, name])
  @@index([tenantId, species])
  @@index([tenantId, createdByOrganizationId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding core
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlan {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId, tenantId], references: [id, tenantId], onDelete: Restrict)

  code      String?
  name      String
  nickname  String?
  species   Species
  breedText String?

  damId  Int
  dam    Animal  @relation("PlanDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId Int?
  sire   Animal? @relation("PlanSire", fields: [sireId], references: [id], onDelete: SetNull)

  lockedCycleKey           String?
  lockedCycleStart         DateTime?
  lockedOvulationDate      DateTime?
  lockedDueDate            DateTime?
  lockedPlacementStartDate DateTime?

  expectedCycleStart          DateTime?
  expectedHormoneTestingStart DateTime?
  expectedBreedDate           DateTime?
  expectedBirthDate           DateTime?
  expectedWeaned              DateTime?
  expectedPlacementStart      DateTime?
  expectedPlacementCompleted  DateTime?

  cycleStartDateActual          DateTime?
  hormoneTestingStartDateActual DateTime?
  breedDateActual               DateTime?
  birthDateActual               DateTime?
  weanedDateActual              DateTime?
  placementStartDateActual      DateTime?
  placementCompletedDateActual  DateTime?
  completedDateActual           DateTime?

  status BreedingPlanStatus @default(PLANNING)
  notes  String?

  committedAt       DateTime?
  committedByUserId String?
  committedByUser   User?     @relation("CommittedByUser", fields: [committedByUserId], references: [id], onDelete: SetNull)

  depositsCommittedCents Int?
  depositsPaidCents      Int?
  depositRiskScore       Int?

  Litter           Litter?
  offspringGroup   OffspringGroup?
  Events           BreedingPlanEvent[]
  Waitlist         WaitlistEntry[]
  Shares           BreedingPlanShare[]
  TestResults      TestResult[]
  BreedingAttempts BreedingAttempt[]
  PregnancyChecks  PregnancyCheck[]
  Attachments      Attachment[]
  Parties          PlanParty[]

  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([organizationId])
  @@index([damId])
  @@index([sireId])
  @@index([status])
  @@index([committedAt])
  @@index([expectedWeaned])
  @@index([expectedPlacementCompleted])
  @@index([expectedPlacementStart])
  @@index([placementStartDateActual])
  @@index([placementCompletedDateActual])
  @@index([expectedBirthDate])
  @@index([expectedCycleStart])
  @@index([expectedHormoneTestingStart])
  @@index([expectedBreedDate])
  @@index([cycleStartDateActual])
}

model ReproductiveCycle {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  femaleId Int
  female   Animal @relation(fields: [femaleId], references: [id], onDelete: Cascade)

  cycleStart         DateTime
  ovulation          DateTime?
  dueDate            DateTime?
  placementStartDate DateTime?

  status String?
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([femaleId])
  @@index([cycleStart])
}

model BreedingPlanShare {
  id           Int          @id @default(autoincrement())
  planId       Int
  plan         BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  fromTenantId Int
  fromTenant   Tenant       @relation("PlanShareFromTenant", fields: [fromTenantId], references: [id], onDelete: Cascade)
  toTenantId   Int
  toTenant     Tenant       @relation("PlanShareToTenant", fields: [toTenantId], references: [id], onDelete: Cascade)
  scope        ShareScope   @default(BREED_PLAN)
  status       ShareStatus  @default(PENDING)
  message      String?
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([planId, toTenantId])
  @@index([fromTenantId])
  @@index([toTenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Breeding plug-ins
 * ────────────────────────────────────────────────────────────────────────────
 */

model BreedingPlanEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  type String

  occurredAt DateTime
  label      String?
  notes      String?
  data       Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, type, occurredAt])
}

model TestResult {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  kind    String
  method  String?
  labName String?

  valueNumber    Float?
  valueText      String?
  units          String?
  referenceRange String?

  collectedAt DateTime
  resultAt    DateTime?
  notes       String?
  data        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([animalId])
  @@index([planId])
  @@index([kind, collectedAt])
}

model BreedingAttempt {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method      BreedingMethod
  attemptAt   DateTime?
  windowStart DateTime?
  windowEnd   DateTime?

  studOwnerContactId Int?
  studOwnerContact   Contact? @relation("StudOwnerContact", fields: [studOwnerContactId], references: [id], onDelete: SetNull)

  semenBatchId Int?

  success Boolean?
  notes   String?
  data    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId])
}

model PregnancyCheck {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  method    PregnancyCheckMethod
  result    Boolean
  checkedAt DateTime
  notes     String?
  data      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([planId, checkedAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group, Offspring, legacy Litter, Waitlist
 * ────────────────────────────────────────────────────────────────────────────
 */

model OffspringGroup {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  linkState  OffspringLinkState   @default(linked)
  linkReason OffspringLinkReason?

  species Species
  damId   Int
  dam     Animal  @relation("OffspringDam", fields: [damId], references: [id], onDelete: Restrict)
  sireId  Int?
  sire    Animal? @relation("OffspringSire", fields: [sireId], references: [id], onDelete: SetNull)
  name    String?

  expectedBirthOn DateTime?
  actualBirthOn   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  published     Boolean @default(false)
  coverImageUrl String?
  themeName     String?

  notes String?
  data  Json?

  // children as Offspring, not Animals
  Offspring Offspring[] @relation("GroupOffspring")

  // legacy Animal linkage retained for compatibility
  AnimalsLegacy Animal[] @relation("OffspringGroupPuppiesLegacy")

  Waitlist        WaitlistEntry[]
  Tags            TagAssignment[]
  Events          OffspringGroupEvent[]
  Attachment      Attachment[]
  groupBuyerLinks OffspringGroupBuyer[] @relation("GroupBuyerGroup")

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  Invoice   Invoice[]
  Campaign  Campaign[]
  Task      Task[]
  Document  Document[]
  Contract  Contract[]

  @@unique([planId])
  @@index([tenantId])
  @@index([tenantId, species, expectedBirthOn])
  @@index([tenantId, damId, actualBirthOn])
  @@index([sireId])
  @@index([linkState])
  @@index([placementStartAt])
  @@index([placementCompletedAt])
}

model OffspringGroupBuyer {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  groupId Int
  group   OffspringGroup @relation("GroupBuyerGroup", fields: [groupId], references: [id], onDelete: Cascade)

  contactId Int?
  contact   Contact? @relation("GroupBuyerContact", fields: [contactId], references: [id], onDelete: SetNull)

  organizationId Int?
  organization   Organization? @relation("GroupBuyerOrganization", fields: [organizationId], references: [id], onDelete: SetNull)

  waitlistEntryId Int?
  waitlistEntry   WaitlistEntry? @relation("GroupBuyerWaitlistEntry", fields: [waitlistEntryId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, contactId])
  @@unique([groupId, organizationId])
  @@unique([groupId, waitlistEntryId])
  @@index([tenantId])
  @@index([groupId])
  @@index([contactId])
  @@index([organizationId])
  @@index([waitlistEntryId])
}

model Offspring {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  groupId Int
  group   OffspringGroup @relation("GroupOffspring", fields: [groupId], references: [id], onDelete: Cascade)

  // identity
  name    String?
  species Species
  breed   String?
  sex     Sex?
  bornAt  DateTime?
  diedAt  DateTime?
  status  OffspringStatus @default(NEWBORN)

  // parents as of creation time
  damId  Int?
  dam    Animal? @relation("OffspringIndividualDam", fields: [damId], references: [id], onDelete: SetNull)
  sireId Int?
  sire   Animal? @relation("OffspringIndividualSire", fields: [sireId], references: [id], onDelete: SetNull)

  // collar
  collarColorId    String?
  collarColorName  String?
  collarColorHex   String?
  collarAssignedAt DateTime?
  collarLocked     Boolean   @default(false)

  // buyer choice on Offspring
  buyerPartyType      OwnerPartyType?
  buyerContactId      Int?
  buyerContact        Contact?        @relation(fields: [buyerContactId], references: [id], onDelete: SetNull)
  buyerOrganizationId Int?
  buyerOrganization   Organization?   @relation(fields: [buyerOrganizationId], references: [id], onDelete: SetNull)

  // finance and placement
  priceCents       Int?
  depositCents     Int?
  contractId       String?
  contractSignedAt DateTime?
  paidInFullAt     DateTime?
  pickupAt         DateTime?
  placedAt         DateTime?

  // promotion link
  promotedAnimalId Int?
  promotedAnimal   Animal? @relation("PromotedAnimal", fields: [promotedAnimalId], references: [id], onDelete: SetNull)

  notes String?
  data  Json?

  Tags                TagAssignment[]
  Attachments         Attachment[]
  Events              OffspringEvent[]
  WaitlistAllocations WaitlistEntry[]  @relation("WaitlistAllocationOffspring")

  // finance, tasks, health, documents, contracts
  Invoices   Invoice[]
  Tasks      Task[]
  HealthLogs HealthEvent[]
  Documents  Document[]
  Contracts  Contract[]

  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  InvoiceLinks        OffspringInvoiceLink[]
  CampaignAttribution CampaignAttribution[]
  OffspringDocument   OffspringDocument[]
  OffspringContract   OffspringContract[]

  @@index([tenantId])
  @@index([groupId])
  @@index([tenantId, status])
  @@index([buyerContactId])
  @@index([buyerOrganizationId])
  @@index([placedAt])
  @@index([tenantId, damId])
  @@index([tenantId, sireId])
}

model OffspringEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  // NOTE, CHANGE, HEALTH, PROMOTION
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId, type, occurredAt])
}

/**
 * Legacy Litter retained
 */
model Litter {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int          @unique
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  identifier     String?
  birthedStartAt DateTime?
  birthedEndAt   DateTime?

  countBorn      Int?
  countLive      Int?
  countStillborn Int?
  countMale      Int?
  countFemale    Int?
  countWeaned    Int?
  countPlaced    Int?

  weanedAt             DateTime?
  placementStartAt     DateTime?
  placementCompletedAt DateTime?

  statusOverride       String?
  statusOverrideReason String?

  published     Boolean @default(false)
  coverImageUrl String?
  themeName     String?

  notes String?
  data  Json?

  Animals    Animal[]
  Waitlist   WaitlistEntry[]
  Attachment Attachment[]
  Events     LitterEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, weanedAt])
  @@index([tenantId, placementStartAt])
  @@index([tenantId, placementCompletedAt])
}

model WaitlistEntry {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  partyType      OwnerPartyType
  contactId      Int?
  contact        Contact?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  organizationId Int?
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  speciesPref Species?
  breedPrefs  Json?
  sirePrefId  Int?
  sirePref    Animal?  @relation("WaitlistSirePref", fields: [sirePrefId], references: [id], onDelete: SetNull)
  damPrefId   Int?
  damPref     Animal?  @relation("WaitlistDamPref", fields: [damPrefId], references: [id], onDelete: SetNull)

  status               WaitlistStatus @default(INQUIRY)
  priority             Int?
  depositInvoiceId     String?
  balanceInvoiceId     String?
  depositPaidAt        DateTime?
  depositRequiredCents Int?
  depositPaidCents     Int?
  balanceDueCents      Int?

  // legacy allocation to Animal
  animalId Int?
  animal   Animal? @relation("WaitlistAllocation", fields: [animalId], references: [id], onDelete: SetNull)

  // canonical allocation to Offspring
  offspringId Int?
  offspring   Offspring? @relation("WaitlistAllocationOffspring", fields: [offspringId], references: [id], onDelete: SetNull)

  groupBuyerLinks OffspringGroupBuyer[] @relation("GroupBuyerWaitlistEntry")

  skipCount  Int?
  lastSkipAt DateTime?

  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  TagAssignment TagAssignment[]

  @@index([tenantId])
  @@index([planId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([contactId])
  @@index([organizationId])
  @@index([tenantId, speciesPref])
  @@index([sirePrefId])
  @@index([damPrefId])
  @@index([animalId])
  @@index([tenantId, depositPaidAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Offspring Group audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model OffspringGroupEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringGroupId Int
  offspringGroup   OffspringGroup @relation(fields: [offspringGroupId], references: [id], onDelete: Cascade)

  // CHANGE, NOTE, STATUS_OVERRIDE, BUYER_MOVE, LINK, UNLINK
  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringGroupId, type, occurredAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Litter audit
 * ────────────────────────────────────────────────────────────────────────────
 */

model LitterEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  litterId Int
  litter   Litter @relation(fields: [litterId], references: [id], onDelete: Cascade)

  type       String
  occurredAt DateTime
  field      String?
  before     Json?
  after      Json?
  notes      String?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([litterId, type, occurredAt])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Attachments, Parties, Counters
 * ────────────────────────────────────────────────────────────────────────────
 */

model Attachment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int?
  plan   BreedingPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  animalId Int?
  animal   Animal? @relation(fields: [animalId], references: [id], onDelete: SetNull)

  litterId Int?
  litter   Litter? @relation(fields: [litterId], references: [id], onDelete: SetNull)

  offspringGroupId Int?
  offspringGroup   OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  kind            String
  storageProvider String
  storageKey      String
  filename        String
  mime            String
  bytes           Int

  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt         DateTime            @default(now())
  OffspringDocument OffspringDocument[]
  OffspringContract OffspringContract[]

  @@index([tenantId])
  @@index([planId])
  @@index([animalId])
  @@index([litterId])
  @@index([offspringGroupId])
  @@index([offspringId])
  @@index([contactId])
}

model PlanParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId Int
  plan   BreedingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  role      String
  contactId Int?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  notes String?

  @@index([tenantId])
  @@index([planId])
}

model PlanCodeCounter {
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  year Int
  seq  Int @default(0)

  @@id([tenantId, year])
  @@index([tenantId])
}

/**
 * ────────────────────────────────────────────────────────────────────────────
 * Generic, namespaced tenant settings
 * ────────────────────────────────────────────────────────────────────────────
 */

model TenantSetting {
  tenantId  Int
  namespace String
  version   Int     @default(1)
  data      Json
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, namespace])
  @@index([tenantId])
  @@index([namespace])
}

/**
 * Additive models: finance, marketing, tasks, health, documents, contracts
 */

enum FinanceScope {
  group
  offspring
  contact
  organization
  general
}

enum InvoiceStatus {
  draft
  open
  paid
  void
  uncollectible
  refunded
  cancelled
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
  disputed
  cancelled
}

enum CampaignChannel {
  email
  social
  ads
  marketplace
  website
  other
}

enum TaskScope {
  group
  offspring
}

enum TaskStatus {
  open
  in_progress
  done
  cancelled
}

enum HealthType {
  weight
  vaccine
  deworm
  vet_visit
  treatment
  other
}

enum DocumentScope {
  group
  offspring
  invoice
  contract
}

enum DocumentKind {
  generic
  health_certificate
  registration
  contract_pdf
  invoice_pdf
  photo
  other
}

enum SignatureProvider {
  internal
  docusign
  hellosign
  adobe
  other
}

enum ContractStatus {
  draft
  sent
  viewed
  signed
  declined
  voided
  expired
}

enum SignatureStatus {
  pending
  viewed
  signed
  declined
  voided
  expired
}

// ---------- Finance ----------
model Invoice {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope   FinanceScope
  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  // buyer
  contactId      Int?
  contact        Contact?      @relation(fields: [contactId], references: [id], onDelete: SetNull)
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  number       String?
  currency     String        @default("USD")
  amountCents  Int
  balanceCents Int
  depositCents Int?
  status       InvoiceStatus @default(draft)
  dueAt        DateTime?
  issuedAt     DateTime?
  paidAt       DateTime?
  voidedAt     DateTime?
  paymentTerms String?

  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?

  notes String?
  data  Json?

  LineItems InvoiceLineItem[]
  Payments  Payment[]
  Documents Document[]
  Contract  Contract?

  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  OffspringInvoiceLink OffspringInvoiceLink[]

  @@index([tenantId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status])
  @@index([contactId])
}

model InvoiceLineItem {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description   String
  qty           Int     @default(1)
  unitCents     Int
  discountCents Int?
  taxRate       Float?
  category      String?
  itemCode      String?
  totalCents    Int

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([invoiceId])
}

model Payment {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  status      PaymentStatus @default(pending)
  amountCents Int
  method      String?
  reference   String?
  paidAt      DateTime?

  externalProvider String?
  externalId       String?
  syncedAt         DateTime?
  lastSyncStatus   String?
  lastSyncError    String?

  notes String?
  data  Json?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([invoiceId])
  @@index([status])
}

// ---------- Marketing ----------
model Campaign {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringGroupId Int?
  group            OffspringGroup? @relation(fields: [offspringGroupId], references: [id], onDelete: SetNull)

  name      String
  channel   CampaignChannel
  startedAt DateTime?
  endedAt   DateTime?

  budgetCents Int?
  spendCents  Int?

  impressions  Int?
  clicks       Int?
  inquiries    Int?
  reservations Int?
  conversions  Int?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  notes String?
  data  Json?

  Attributions CampaignAttribution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringGroupId])
  @@index([channel])
}

model CampaignAttribution {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  campaignId Int
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  weight Float?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([campaignId])
  @@index([offspringId])
}

// ---------- Tasks ----------
model Task {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope TaskScope

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  title  String
  notes  String?
  dueAt  DateTime?
  status TaskStatus @default(open)

  assignedToUserId String?
  assignedToUser   User?   @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope, groupId])
  @@index([scope, offspringId])
  @@index([status, dueAt])
}

// ---------- Health ----------
model HealthEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  kind       HealthType
  occurredAt DateTime

  weightGrams Int?
  vaccineCode String?
  dose        String?
  vetClinic   String?
  result      String?
  notes       String?
  data        Json?

  recordedByUserId String?
  recordedByUser   User?   @relation(fields: [recordedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId, occurredAt])
  @@index([kind])
}

// ---------- Documents & Contracts ----------
model Document {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  scope DocumentScope
  kind  DocumentKind  @default(generic)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  invoiceId Int?     @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  contractId Int?
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  title       String
  storageKey  String?
  externalUrl String?
  mimeType    String?
  bytes       Int?
  sha256      String?
  data        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope, offspringId])
  @@index([scope, groupId])
  @@index([scope, invoiceId])
  @@index([scope, contractId])
  @@index([kind])
}

model ContractTemplate {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  body        String?
  storageKey  String?
  description String?

  isActive Boolean @default(true)
  data     Json?

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  Contract  Contract[]

  @@index([tenantId])
  @@index([isActive])
}

model Contract {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  templateId Int?
  template   ContractTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  offspringId Int?
  offspring   Offspring? @relation(fields: [offspringId], references: [id], onDelete: SetNull)

  groupId Int?
  group   OffspringGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  invoiceId Int?     @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  title  String
  status ContractStatus @default(draft)

  provider           SignatureProvider @default(internal)
  providerEnvelopeId String?
  providerDocId      String?

  issuedAt  DateTime?
  signedAt  DateTime?
  voidedAt  DateTime?
  expiresAt DateTime?

  documents Document[]
  parties   ContractParty[]
  events    SignatureEvent[]

  data Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([groupId])
  @@index([invoiceId])
  @@index([status])
  @@index([provider, providerEnvelopeId])
}

model ContractParty {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contractId Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  contactId      Int?
  contact        Contact?      @relation(fields: [contactId], references: [id], onDelete: SetNull)
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  role   String?
  email  String?
  name   String?
  signer Boolean @default(true)
  order  Int?

  status   SignatureStatus @default(pending)
  signedAt DateTime?

  providerRecipientId String?

  data Json?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  SignatureEvent SignatureEvent[]

  @@index([tenantId])
  @@index([contractId])
  @@index([status])
}

model SignatureEvent {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contractId Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  partyId Int?
  party   ContractParty? @relation(fields: [partyId], references: [id], onDelete: SetNull)

  status    SignatureStatus
  at        DateTime        @default(now())
  ipAddress String?
  userAgent String?
  message   String?
  data      Json?

  @@index([tenantId])
  @@index([contractId])
  @@index([partyId])
  @@index([status, at])
}

enum InvoiceRole {
  RESERVATION
  DEPOSIT
  FINAL
  MISC
}

enum EsignProvider {
  DOCUSIGN
  HELLOSIGN
  ADOBE
  OTHER
}

enum EsignStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  DECLINED
  EXPIRED
  VOIDED
}

model OffspringDocument {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  name       String
  templateId String?
  provider   EsignProvider?
  status     EsignStatus    @default(DRAFT)

  sentAt      DateTime?
  viewedAt    DateTime?
  completedAt DateTime?

  fileId Int?
  file   Attachment? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  metaJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([status])
}

model OffspringContract {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  title    String
  version  String?
  provider EsignProvider?
  status   EsignStatus    @default(DRAFT)

  sentAt   DateTime?
  viewedAt DateTime?
  signedAt DateTime?

  fileId Int?
  file   Attachment? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  buyerContactId      Int?
  buyerContact        Contact?      @relation("OffspringContractBuyerContact", fields: [buyerContactId], references: [id], onDelete: SetNull)
  buyerOrganizationId Int?
  buyerOrganization   Organization? @relation("OffspringContractBuyerOrg", fields: [buyerOrganizationId], references: [id], onDelete: SetNull)

  metaJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([offspringId])
  @@index([status])
}

model OffspringInvoiceLink {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offspringId Int
  offspring   Offspring @relation(fields: [offspringId], references: [id], onDelete: Cascade)

  invoiceId Int?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  role        InvoiceRole @default(MISC)
  amountCents Int?
  currency    String?

  externalProvider String?
  externalId       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([offspringId, invoiceId, role])
  @@index([tenantId])
  @@index([offspringId])
  @@index([invoiceId])
}

model AccountingIntegration {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider String // for example "quickbooks_online"
  realmId  String // external account or company id

  accessToken          String
  refreshToken         String
  accessTokenExpiresAt DateTime

  isActive       Boolean   @default(true)
  syncDirection  String    @default("outbound") // outbound, inbound, bidirectional
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastSyncError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, provider])
}
